[{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\actions\\notifications.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\api\\seed\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":153,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":153,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6985,6988],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6985,6988],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":183,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":183,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8223,8226],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8223,8226],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { createClient } from '@supabase/supabase-js'\r\nimport { NextResponse } from 'next/server'\r\n\r\n// Nombres y Apellidos para generar usuarios aleatorios\r\nconst NOMBRES = ['Juan', 'Pedro', 'Maria', 'Ana', 'Luis', 'Carlos', 'Jose', 'Marta', 'Lucia', 'Sofia', 'Miguel', 'David', 'Elena', 'Carmen', 'Pablo', 'Jorge', 'Raul', 'Daniel', 'Andres', 'Isabel']\r\nconst APELLIDOS = ['Garcia', 'Martinez', 'Lopez', 'Sanchez', 'Gonzalez', 'Rodriguez', 'Fernandez', 'Perez', 'Gomez', 'Ruiz', 'Diaz', 'Hernandez', 'Alvarez', 'Moreno', 'Munoz', 'Romero', 'Alonso', 'Gutierrez', 'Navarro', 'Torres']\r\n\r\nexport async function GET() {\r\n    try {\r\n        const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\r\n        const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\r\n\r\n        if (!supabaseServiceKey) {\r\n            return NextResponse.json({\r\n                error: 'SUPABASE_SERVICE_ROLE_KEY is missing. Cannot seed users securely.'\r\n            }, { status: 500 })\r\n        }\r\n\r\n        const supabase = createClient(supabaseUrl, supabaseServiceKey, {\r\n            auth: {\r\n                autoRefreshToken: false,\r\n                persistSession: false\r\n            }\r\n        })\r\n\r\n        const seedResults = {\r\n            usersCreated: 0,\r\n            cultosCreated: 0,\r\n            assignmentsCreated: 0\r\n        }\r\n\r\n        // 1. Crear Usuarios (Hermanos con pulpito=true y Miembros)\r\n        console.log('Seeding users...')\r\n        for (let i = 0; i < 20; i++) {\r\n            const nombre = NOMBRES[Math.floor(Math.random() * NOMBRES.length)]\r\n            const apellido = APELLIDOS[Math.floor(Math.random() * APELLIDOS.length)]\r\n            const email = `${nombre.toLowerCase()}.${apellido.toLowerCase()}${Math.floor(Math.random() * 1000)}@test.com`\r\n            const password = 'password123'\r\n            const isPulpito = Math.random() > 0.3 // 70% probabilidad de ser de p├║lpito\r\n            const rol = isPulpito ? (Math.random() > 0.8 ? 'ADMIN' : 'EDITOR') : 'MIEMBRO'\r\n\r\n            // Crear usuario Auth\r\n            const { data: authUser, error: authError } = await supabase.auth.admin.createUser({\r\n                email,\r\n                password,\r\n                email_confirm: true,\r\n                user_metadata: {\r\n                    nombre,\r\n                    apellidos: apellido,\r\n                    full_name: `${nombre} ${apellido}`,\r\n                }\r\n            })\r\n\r\n            if (authError) {\r\n                console.warn(`Error creating user ${email}:`, authError.message)\r\n                continue\r\n            }\r\n\r\n            if (authUser.user) {\r\n                // Actualizar perfil (Trigger deber├¡a haberlo creado, pero actualizamos rol y pulpito)\r\n                const { error: profileError } = await supabase\r\n                    .from('profiles')\r\n                    .update({\r\n                        nombre,\r\n                        apellidos: apellido,\r\n                        rol,\r\n                        pulpito: isPulpito,\r\n                        avatar_url: `https://api.dicebear.com/7.x/avataaars/svg?seed=${email}`\r\n                    })\r\n                    .eq('id', authUser.user.id)\r\n\r\n                if (!profileError) seedResults.usersCreated++\r\n            }\r\n        }\r\n\r\n        // 2. Generar Cultos (3 meses: mes pasado, actual, siguiente)\r\n        console.log('Seeding cultos...')\r\n        const today = new Date()\r\n        const monthsCheck = [-1, 0, 1] // Mes anterior, actual, siguiente\r\n\r\n        // Obtener IDs de usuarios de p├║lpito para asignar\r\n        const { data: pulpitoUsers } = await supabase\r\n            .from('profiles')\r\n            .select('id')\r\n            .eq('pulpito', true)\r\n\r\n        const pulpitoIds = pulpitoUsers?.map(u => u.id) || []\r\n\r\n        if (pulpitoIds.length > 0) {\r\n            for (const monthOffset of monthsCheck) {\r\n                const targetDate = new Date(today.getFullYear(), today.getMonth() + monthOffset, 1)\r\n                const month = targetDate.getMonth()\r\n                const year = targetDate.getFullYear()\r\n\r\n                // Generar d├¡as del mes\r\n                const daysInMonth = new Date(year, month + 1, 0).getDate()\r\n\r\n                for (let day = 1; day <= daysInMonth; day++) {\r\n                    const currentDate = new Date(year, month, day)\r\n                    const dayOfWeek = currentDate.getDay() // 0=Dom, 1=Lun...\r\n\r\n                    let tipoCultoId: number | null = null\r\n\r\n                    // Lunes (1) y S├íbado (6) -> Estudio (ID simulado, depende de tu DB real)\r\n                    // Martes (2), Mi├®rcoles (3), Viernes (5) -> Alabanza\r\n                    // Jueves (4), Domingo (0) -> Ense├▒anza\r\n\r\n                    // NOTA: Esto asume que los IDs son fijos o necesita buscarlos. \r\n                    // Para simplificar, asumiremos IDs est├índar o buscaremos por nombre si es posible, \r\n                    // pero insertaremos buscando por nombre primero.\r\n\r\n                    let tipoNombre = ''\r\n                    if (dayOfWeek === 1 || dayOfWeek === 6) tipoNombre = 'Estudio B├¡blico'\r\n                    else if (dayOfWeek === 2 || dayOfWeek === 3 || dayOfWeek === 5) tipoNombre = 'Alabanza'\r\n                    else if (dayOfWeek === 4 || dayOfWeek === 0) tipoNombre = 'Ense├▒anza'\r\n                    else continue // No hay culto\r\n\r\n                    // Buscar ID del tipo\r\n                    const { data: tipoData } = await supabase\r\n                        .from('culto_types')\r\n                        .select('id')\r\n                        .eq('name', tipoNombre)\r\n                        .single()\r\n\r\n                    if (!tipoData) continue\r\n                    tipoCultoId = tipoData.id\r\n\r\n                    // Crear Culto\r\n                    const fechaStr = currentDate.toISOString().split('T')[0]\r\n                    const hora = dayOfWeek === 0 ? '10:00' : '19:00' // Domingo 10am, resto 19pm\r\n\r\n                    // Upsert culto (evitar duplicados si ya existen)\r\n                    const { data: culto, error: cultoError } = await supabase\r\n                        .from('cultos')\r\n                        .upsert({\r\n                            fecha: fechaStr,\r\n                            hora,\r\n                            tipo_culto_id: tipoCultoId,\r\n                            actividades: [] // Inicializar vac├¡o\r\n                        }, { onConflict: 'fecha, hora' })\r\n                        .select()\r\n                        .single()\r\n\r\n                    if (culto && !cultoError) {\r\n                        seedResults.cultosCreated++\r\n\r\n                        // 3. Asignar Roles Aleatorios (si es fecha pasada o muy cercana)\r\n                        // Asignar aleatoriamente a uno de los ids disponibles\r\n                        const randomUser = () => pulpitoIds[Math.floor(Math.random() * pulpitoIds.length)]\r\n\r\n                        // Determinamos columnas a actualizar seg├║n tipo\r\n                        const updates: any = {}\r\n\r\n                        // Intro y Final (com├║n en Estudio y Alabanza)\r\n                        if (tipoNombre === 'Estudio B├¡blico' || tipoNombre === 'Alabanza') {\r\n                            updates.usuario_intro_id = randomUser()\r\n                            updates.usuario_final_id = randomUser()\r\n                        }\r\n\r\n                        // Ense├▒anza (Intro, Ense├▒anza, Testimonios)\r\n                        if (tipoNombre === 'Ense├▒anza') {\r\n                            updates.usuario_intro_id = randomUser()\r\n                            updates.usuario_ense├▒anza_id = randomUser()\r\n                            updates.usuario_testimonios_id = randomUser()\r\n                        }\r\n\r\n                        if (Object.keys(updates).length > 0) {\r\n                            await supabase\r\n                                .from('cultos')\r\n                                .update(updates)\r\n                                .eq('id', culto.id)\r\n\r\n                            seedResults.assignmentsCreated++\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return NextResponse.json({ success: true, results: seedResults })\r\n\r\n    } catch (error: any) {\r\n        return NextResponse.json({ error: error.message }, { status: 500 })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\auth\\callback\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\DashboardClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TrendingUp' is defined but never used.","line":12,"column":37,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":47},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isSameDay' is defined but never used.","line":13,"column":62,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":71},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":40,"column":17,"nodeType":"JSXOpeningElement","endLine":40,"endColumn":103},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'stats' is defined but never used.","line":74,"column":83,"nodeType":null,"messageId":"unusedVar","endLine":74,"endColumn":88},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is assigned a value but never used.","line":93,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":93,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * DashboardClient - IDMJI Gestor de P├║lpito\r\n * \r\n * Componente cliente principal con Dise├▒o Premium.\r\n * \r\n * @author Antigravity AI\r\n */\r\n\r\n'use client'\r\n\r\nimport { useState } from 'react'\r\nimport { Calendar, BookOpen, Users, TrendingUp, Clock, UserIcon, ChevronRight, ChevronLeft, MapPin } from 'lucide-react'\r\nimport { format, addWeeks, subWeeks, startOfWeek, endOfWeek, isSameDay } from 'date-fns'\r\nimport { es, ca } from 'date-fns/locale'\r\nimport Link from 'next/link'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/Card'\r\nimport { useI18n } from '@/lib/i18n/I18nProvider'\r\nimport { Culto, Profile } from '@/types/database'\r\nimport { getUserAssignments } from './cultos/actions'\r\nimport { toast } from 'sonner' // Ensure sonner is installed or remove if not\r\n\r\n// --- Sub-componentes ---\r\n\r\nfunction UserAvatar({ usuario, size = 'md' }: { usuario: Partial<Profile> | null | undefined, size?: 'sm' | 'md' | 'lg' }) {\r\n    if (!usuario) return null\r\n\r\n    const sizeClasses = {\r\n        sm: 'w-8 h-8 text-xs',\r\n        md: 'w-12 h-12 text-base', // Increased from 10\r\n        lg: 'w-16 h-16 text-lg',   // Increased from 14\r\n        xl: 'w-20 h-20 text-xl'    // New extra large size\r\n    }\r\n\r\n    const initials = `${usuario.nombre?.[0] || ''}${usuario.apellidos?.[0] || ''}`.toUpperCase()\r\n\r\n    return (\r\n        <div className={`relative ${sizeClasses[size]} rounded-full overflow-hidden shadow-md ring-2 ring-white/20 flex-shrink-0 bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold`}>\r\n            {usuario.avatar_url ? (\r\n                <img src={usuario.avatar_url} alt={initials} className=\"w-full h-full object-cover\" />\r\n            ) : (\r\n                <span>{initials}</span>\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n\r\nfunction AssignmentPill({ label, usuario }: { label: string, usuario: Partial<Profile> | null | undefined }) {\r\n    if (!usuario) return null\r\n    return (\r\n        <div className=\"flex items-center gap-3 p-3 bg-white/50 dark:bg-black/20 rounded-2xl border border-black/5 dark:border-white/5 backdrop-blur-sm\">\r\n            <UserAvatar usuario={usuario} size=\"md\" />\r\n            <div className=\"flex-1 min-w-0\">\r\n                <p className=\"text-[10px] text-blue-600 dark:text-blue-300 font-black uppercase tracking-wider mb-0.5\">{label}</p>\r\n                <p className=\"font-bold text-sm truncate text-slate-800 dark:text-slate-100\">\r\n                    {usuario.nombre} {usuario.apellidos?.split(' ')[0]}\r\n                </p>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n\r\ninterface DashboardClientProps {\r\n    user: Profile & { id: string }\r\n    culto: Culto | null\r\n    esHoy: boolean\r\n    initialAssignments: Culto[]\r\n    stats: {\r\n        totalCultos: number\r\n        totalLecturas: number\r\n    }\r\n}\r\n\r\nexport default function DashboardClient({ user, culto, esHoy, initialAssignments, stats }: DashboardClientProps) {\r\n    const { t, language } = useI18n()\r\n    const locale = language === 'ca-ES' ? ca : es\r\n\r\n    // State for assignments navigation\r\n    const [assignments, setAssignments] = useState<Culto[]>(initialAssignments)\r\n    const [currentWeekDate, setCurrentWeekDate] = useState(new Date())\r\n    const [isLoadingAssignments, setIsLoadingAssignments] = useState(false)\r\n\r\n    // Handlers for assignments navigation\r\n    const changeWeek = async (direction: 'prev' | 'next') => {\r\n        setIsLoadingAssignments(true)\r\n        const newDate = direction === 'next' ? addWeeks(currentWeekDate, 1) : subWeeks(currentWeekDate, 1)\r\n        setCurrentWeekDate(newDate)\r\n\r\n        const start = startOfWeek(newDate, { weekStartsOn: 1 })\r\n        const end = endOfWeek(newDate, { weekStartsOn: 1 })\r\n\r\n        try {\r\n            const { data, error } = await getUserAssignments(\r\n                user.id,\r\n                format(start, 'yyyy-MM-dd'),\r\n                format(end, 'yyyy-MM-dd')\r\n            )\r\n            if (data) setAssignments(data)\r\n        } catch (error) {\r\n            console.error(error)\r\n            toast.error(\"Error al cargar asignaciones\")\r\n        } finally {\r\n            setIsLoadingAssignments(false)\r\n        }\r\n    }\r\n\r\n    const weekLabel = `${format(startOfWeek(currentWeekDate, { weekStartsOn: 1 }), 'd MMM', { locale })} - ${format(endOfWeek(currentWeekDate, { weekStartsOn: 1 }), 'd MMM', { locale })}`\r\n\r\n    return (\r\n        <div className=\"space-y-4 md:space-y-8 animate-fade-in-up pb-20\">\r\n\r\n            {/* 1. Header Premium (Adaptive) */}\r\n            {/* Desktop Version */}\r\n            <div className=\"hidden md:flex relative overflow-hidden glass rounded-4xl p-12 shadow-2xl border-white/20 bg-gradient-to-br from-slate-50 to-blue-50/50 dark:from-slate-900 dark:to-slate-800 items-center justify-between\">\r\n                <div className=\"absolute top-0 right-0 w-[500px] h-[500px] bg-blue-500/10 rounded-full blur-[120px] -translate-y-1/2 translate-x-1/4\" />\r\n                <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }}>\r\n                    <h1 className=\"text-5xl font-black mb-4 text-slate-900 dark:text-white tracking-tighter\">\r\n                        {t('dashboard.welcome')}, <span className=\"text-blue-600 dark:text-blue-400\">{user.nombre}</span>\r\n                    </h1>\r\n                    <div className=\"flex items-center gap-3 text-slate-500 font-bold\">\r\n                        <Calendar className=\"w-5 h-5 text-blue-500\" />\r\n                        <span className=\"capitalize\">{format(new Date(), 'PPPP', { locale })}</span>\r\n                    </div>\r\n                </motion.div>\r\n\r\n                {/* Avatar Desktop con Link */}\r\n                <motion.div\r\n                    initial={{ opacity: 0, scale: 0.8 }}\r\n                    animate={{ opacity: 1, scale: 1 }}\r\n                    className=\"relative z-10\"\r\n                >\r\n                    <Link href=\"/dashboard/profile\">\r\n                        <UserAvatar usuario={user} size=\"xl\" />\r\n                    </Link>\r\n                </motion.div>\r\n            </div>\r\n\r\n            {/* Mobile Version (Compact Header) */}\r\n            <div className=\"md:hidden flex items-center justify-between px-2 pt-2\">\r\n                <div>\r\n                    <h1 className=\"text-2xl font-black text-slate-900 dark:text-white tracking-tight\">\r\n                        Hola, {user.nombre}\r\n                    </h1>\r\n                    <p className=\"text-xs font-bold text-slate-400 uppercase tracking-widest\">\r\n                        {format(new Date(), 'EEEE, d MMM', { locale })}\r\n                    </p>\r\n                </div>\r\n                <Link href=\"/dashboard/profile\">\r\n                    <UserAvatar usuario={user} size=\"md\" />\r\n                </Link>\r\n            </div>\r\n\r\n            {/* 2. Main Action Area: Next/Today Culto & Assignments */}\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n\r\n                {/* Left: Culto Card (Takes 2 cols on Desktop) */}\r\n                <div className=\"lg:col-span-2 space-y-6\">\r\n                    <AnimatePresence mode=\"wait\">\r\n                        {culto ? (\r\n                            <motion.div\r\n                                key={culto.id}\r\n                                initial={{ opacity: 0, scale: 0.95 }}\r\n                                animate={{ opacity: 1, scale: 1 }}\r\n                                className=\"relative group\"\r\n                            >\r\n                                <div className=\"absolute inset-0 bg-blue-600/20 blur-2xl rounded-[2.5rem] transform group-hover:scale-105 transition-transform duration-500 -z-10\" />\r\n                                <Card className=\"rounded-[2.5rem] border-none shadow-2xl overflow-hidden bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl\">\r\n                                    {/* Banner Superior */}\r\n                                    <div className={`h-2 w-full`} style={{ backgroundColor: culto.tipo_culto?.color || '#3b82f6' }} />\r\n\r\n                                    <CardContent className=\"p-6 md:p-8\">\r\n                                        {/* Badge de Estado */}\r\n                                        <div className=\"flex justify-between items-start mb-6\">\r\n                                            <div className={`px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-[0.2em] shadow-lg ${esHoy ? 'bg-red-500 text-white shadow-red-500/30' : 'bg-blue-600 text-white shadow-blue-500/30'}`}>\r\n                                                {esHoy ? 'CULTO DE HOY' : 'PR├ôXIMO CULTO'}\r\n                                            </div>\r\n                                            {!esHoy && (\r\n                                                <div className=\"text-right\">\r\n                                                    <p className=\"text-2xl font-black text-slate-300 dark:text-slate-600 leading-none\">\r\n                                                        {format(new Date(culto.fecha), 'd', { locale })}\r\n                                                    </p>\r\n                                                    <p className=\"text-[10px] font-bold text-slate-400 uppercase\">\r\n                                                        {format(new Date(culto.fecha), 'MMM', { locale })}\r\n                                                    </p>\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n\r\n                                        {/* Info Principal */}\r\n                                        <div className=\"mb-8\">\r\n                                            <h2 className=\"text-3xl md:text-4xl font-black text-slate-900 dark:text-white uppercase italic tracking-tighter mb-2\">\r\n                                                {culto.tipo_culto?.nombre}\r\n                                            </h2>\r\n                                            <div className=\"flex items-center gap-2 text-slate-500 font-bold mb-4\">\r\n                                                <Clock className=\"w-5 h-5 text-blue-500\" />\r\n                                                <span className=\"text-lg\">{culto.hora_inicio.slice(0, 5)}</span>\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        {/* Grid de Responsables (Compacto y Visual) */}\r\n                                        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3 mb-8\">\r\n                                            {culto.tipo_culto?.tiene_lectura_introduccion && (\r\n                                                <AssignmentPill label=\"Introducci├│n\" usuario={culto.usuario_intro} />\r\n                                            )}\r\n                                            {culto.tipo_culto?.tiene_ensenanza && (\r\n                                                <AssignmentPill label=\"Ense├▒anza\" usuario={culto.usuario_ensenanza} />\r\n                                            )}\r\n                                            {culto.tipo_culto?.tiene_lectura_finalizacion && (\r\n                                                <AssignmentPill label=\"Finalizaci├│n\" usuario={culto.usuario_finalizacion} />\r\n                                            )}\r\n                                            {culto.tipo_culto?.tiene_testimonios && (\r\n                                                <AssignmentPill label=\"Testimonios\" usuario={culto.usuario_testimonios} />\r\n                                            )}\r\n                                        </div>\r\n\r\n                                        {/* Bot├│n de Acci├│n */}\r\n                                        <Link href={`/dashboard/cultos/${culto.id}`} className=\"block w-full\">\r\n                                            <button className=\"w-full py-4 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-2xl font-black uppercase tracking-widest text-xs hover:scale-[1.02] active:scale-95 transition-all shadow-xl\">\r\n                                                Ver Detalles Completos\r\n                                            </button>\r\n                                        </Link>\r\n                                    </CardContent>\r\n                                </Card>\r\n                            </motion.div>\r\n                        ) : (\r\n                            <div className=\"glass rounded-[2.5rem] p-12 text-center border-dashed border-2 border-slate-200 dark:border-slate-800\">\r\n                                <p className=\"text-slate-400 font-bold\">No hay cultos programados pr├│ximamente.</p>\r\n                            </div>\r\n                        )}\r\n                    </AnimatePresence>\r\n                </div>\r\n\r\n                {/* Right: My Assignments (New Section) */}\r\n                <div className=\"lg:col-span-1\">\r\n                    <Card className=\"h-full rounded-[2.5rem] border-none shadow-xl bg-white/80 dark:bg-slate-900/80 backdrop-blur-md flex flex-col\">\r\n                        <CardHeader className=\"pb-2\">\r\n                            <CardTitle className=\"text-sm font-black uppercase tracking-widest text-slate-400 flex items-center gap-2\">\r\n                                <UserIcon className=\"w-4 h-4\" />\r\n                                Mis Asignaciones\r\n                            </CardTitle>\r\n                        </CardHeader>\r\n                        <CardContent className=\"flex-1 flex flex-col\">\r\n                            {/* Week Navigation */}\r\n                            <div className=\"flex items-center justify-between mb-6 bg-slate-100 dark:bg-slate-800 rounded-full p-1\">\r\n                                <button onClick={() => changeWeek('prev')} className=\"p-2 hover:bg-white dark:hover:bg-slate-700 rounded-full transition-all shadow-sm\">\r\n                                    <ChevronLeft className=\"w-4 h-4\" />\r\n                                </button>\r\n                                <span className=\"text-xs font-bold uppercase tracking-wider\">{weekLabel}</span>\r\n                                <button onClick={() => changeWeek('next')} className=\"p-2 hover:bg-white dark:hover:bg-slate-700 rounded-full transition-all shadow-sm\">\r\n                                    <ChevronRight className=\"w-4 h-4\" />\r\n                                </button>\r\n                            </div>\r\n\r\n                            {/* Assignments List */}\r\n                            <div className=\"flex-1 space-y-3 overflow-y-auto max-h-[400px] pr-2 custom-scrollbar\">\r\n                                {isLoadingAssignments ? (\r\n                                    <div className=\"flex justify-center py-8\"><div className=\"animate-spin w-6 h-6 border-2 border-blue-500 rounded-full border-t-transparent\" /></div>\r\n                                ) : assignments.length > 0 ? (\r\n                                    assignments.map((asg) => {\r\n                                        // Determine Role\r\n                                        const roles = []\r\n                                        if (asg.id_usuario_intro === user.id) roles.push('Intro')\r\n                                        if (asg.id_usuario_ensenanza === user.id) roles.push('Ense├▒anza')\r\n                                        if (asg.id_usuario_finalizacion === user.id) roles.push('Final')\r\n                                        if (asg.id_usuario_testimonios === user.id) roles.push('Testimonios')\r\n\r\n                                        return (\r\n                                            <Link key={asg.id} href={`/dashboard/cultos/${asg.id}`}>\r\n                                                <div className=\"p-4 rounded-2xl bg-slate-50 dark:bg-slate-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors border border-transparent hover:border-blue-200 dark:hover:border-blue-800 group\">\r\n                                                    <div className=\"flex justify-between items-start mb-2\">\r\n                                                        <div className=\"flex flex-col\">\r\n                                                            <span className=\"text-xs font-bold text-slate-400 uppercase\">{format(new Date(asg.fecha), 'EEE d', { locale })}</span>\r\n                                                            <span className=\"font-black text-slate-800 dark:text-slate-100\">{asg.tipo_culto?.nombre}</span>\r\n                                                        </div>\r\n                                                        <div className=\"w-2 h-2 rounded-full\" style={{ backgroundColor: asg.tipo_culto?.color }} />\r\n                                                    </div>\r\n                                                    <div className=\"flex flex-wrap gap-1\">\r\n                                                        {roles.map(r => (\r\n                                                            <span key={r} className=\"px-2 py-0.5 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-md text-[10px] font-bold uppercase tracking-wider\">\r\n                                                                {r}\r\n                                                            </span>\r\n                                                        ))}\r\n                                                    </div>\r\n                                                </div>\r\n                                            </Link>\r\n                                        )\r\n                                    })\r\n                                ) : (\r\n                                    <div className=\"text-center py-8 opacity-50\">\r\n                                        <Calendar className=\"w-8 h-8 mx-auto mb-2 text-slate-300\" />\r\n                                        <p className=\"text-xs font-medium\">Sin asignaciones esta semana</p>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </CardContent>\r\n                    </Card>\r\n                </div>\r\n            </div>\r\n\r\n            {/* 3. Quick Actions Grid (Restored & Improved) */}\r\n            <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-4\">\r\n                <QuickActionLink href=\"/dashboard/cultos\" icon={<Calendar className=\"text-blue-500\" />} title={t('dashboard.calendar')} />\r\n                <QuickActionLink href=\"/dashboard/lecturas\" icon={<BookOpen className=\"text-purple-500\" />} title={t('dashboard.lecturas')} />\r\n                <QuickActionLink href=\"/dashboard/festivos\" icon={<MapPin className=\"text-amber-500\" />} title=\"Festivos\" />\r\n                <QuickActionLink href=\"/dashboard/hermanos\" icon={<Users className=\"text-emerald-500\" />} title=\"Hermanos\" />\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n\r\nfunction QuickActionLink({ href, icon, title }: { href: string, icon: React.ReactNode, title: string }) {\r\n    return (\r\n        <Link href={href}>\r\n            <motion.div\r\n                whileTap={{ scale: 0.95 }}\r\n                className=\"bg-white dark:bg-slate-900 rounded-3xl p-6 shadow-lg border border-slate-100 dark:border-slate-800 flex flex-col items-center justify-center gap-3 text-center hover:shadow-xl transition-all\"\r\n            >\r\n                <div className=\"p-3 bg-slate-50 dark:bg-slate-800 rounded-2xl\">{icon}</div>\r\n                <span className=\"font-bold text-sm text-slate-700 dark:text-slate-200\">{title}</span>\r\n            </motion.div>\r\n        </Link>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\admin\\audit\\AuditClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'User' is defined but never used.","line":21,"column":57,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":61},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setTipos' is assigned a value but never used.","line":40,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":40,"endColumn":27},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\admin\\audit\\AuditClient.tsx:62:9\n  60 |\n  61 |     useEffect(() => {\n> 62 |         loadData()\n     |         ^^^^^^^^ Avoid calling setState() directly within an effect\n  63 |     }, [loadData])\n  64 |\n  65 |     // Reiniciar p├ígina al filtrar o buscar","line":62,"column":9,"nodeType":null,"endLine":62,"endColumn":17},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\admin\\audit\\AuditClient.tsx:67:9\n  65 |     // Reiniciar p├ígina al filtrar o buscar\n  66 |     useEffect(() => {\n> 67 |         setPage(1)\n     |         ^^^^^^^ Avoid calling setState() directly within an effect\n  68 |     }, [tipoFilter, debouncedSearch])\n  69 |\n  70 |     function getTipoColor(tipo: string): string {","line":67,"column":9,"nodeType":null,"endLine":67,"endColumn":16}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\n/**\r\n * AuditClient - IDMJI Gestor de P├║lpito\r\n * \r\n * Componente cliente para visualizar el historial de auditor├¡a del sistema.\r\n * Permite filtrar por tipo de movimiento, buscar por descripci├│n y exportar los datos.\r\n * \r\n * Caracter├¡sticas:\r\n * - Filtrado din├ímico por tipo de acci├│n.\r\n * - B├║squeda en tiempo real con debounce.\r\n * - Exportaci├│n a formato CSV.\r\n * - Dise├▒o Glassmorphism responsive con animaciones Framer Motion.\r\n * \r\n * @author Antigravity AI\r\n * @date 2025-12-24\r\n */\r\n\r\nimport { useState, useEffect, useCallback } from 'react'\r\nimport { getMovimientos, MovimientoData } from './actions'\r\nimport { FileText, ChevronLeft, ChevronRight, Calendar, User, Search, Download, RefreshCcw, LayoutList, Filter } from 'lucide-react'\r\nimport { format } from 'date-fns'\r\nimport { es, ca } from 'date-fns/locale'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport { useI18n } from '@/lib/i18n/I18nProvider'\r\nimport { Button } from '@/components/ui/Button'\r\nimport { useDebounce } from '@/hooks/use-debounce'\r\nimport * as XLSX from 'xlsx'\r\n\r\ninterface AuditClientProps {\r\n    initialData: MovimientoData[]\r\n    initialTotal: number\r\n    initialTipos: string[]\r\n}\r\n\r\nexport default function AuditClient({ initialData, initialTotal, initialTipos }: AuditClientProps) {\r\n    const { t, language } = useI18n()\r\n    const [movimientos, setMovimientos] = useState<MovimientoData[]>(initialData)\r\n    const [total, setTotal] = useState(initialTotal)\r\n    const [tipos, setTipos] = useState<string[]>(initialTipos)\r\n    const [page, setPage] = useState(1)\r\n    const [tipoFilter, setTipoFilter] = useState<string>('')\r\n    const [searchQuery, setSearchQuery] = useState('')\r\n    const [isLoading, setIsLoading] = useState(false)\r\n    const debouncedSearch = useDebounce(searchQuery, 500)\r\n\r\n    const limit = 20\r\n    const totalPages = Math.ceil(total / limit)\r\n    const dateLocale = language === 'ca-ES' ? ca : es\r\n\r\n    const loadData = useCallback(async () => {\r\n        setIsLoading(true)\r\n        const result = await getMovimientos(page, limit, tipoFilter || undefined, debouncedSearch || undefined)\r\n        if (result.success && result.data) {\r\n            setMovimientos(result.data.data)\r\n            setTotal(result.data.total)\r\n        }\r\n        setIsLoading(false)\r\n    }, [page, limit, tipoFilter, debouncedSearch])\r\n\r\n    useEffect(() => {\r\n        loadData()\r\n    }, [loadData])\r\n\r\n    // Reiniciar p├ígina al filtrar o buscar\r\n    useEffect(() => {\r\n        setPage(1)\r\n    }, [tipoFilter, debouncedSearch])\r\n\r\n    function getTipoColor(tipo: string): string {\r\n        switch (tipo.toLowerCase()) {\r\n            case 'asignacion':\r\n            case 'assignment': return 'bg-blue-500/10 text-blue-600 dark:text-blue-400'\r\n            case 'lectura':\r\n            case 'reading': return 'bg-emerald-500/10 text-emerald-600 dark:text-emerald-400'\r\n            case 'himno':\r\n            case 'hymn': return 'bg-indigo-500/10 text-indigo-600 dark:text-indigo-400'\r\n            case 'coro':\r\n            case 'chorus': return 'bg-rose-500/10 text-rose-600 dark:text-rose-400'\r\n            case 'culto': return 'bg-amber-500/10 text-amber-600 dark:text-amber-400'\r\n            default: return 'bg-slate-500/10 text-slate-600 dark:text-slate-400'\r\n        }\r\n    }\r\n\r\n    const exportToExcel = () => {\r\n        const headers = [\"Fecha\", \"Usuario\", \"Tipo\", \"Descripci├│n\", \"Culto\"]\r\n        const rows = movimientos.map(m => [\r\n            format(new Date(m.fecha_hora), \"dd/MM/yyyy HH:mm\"),\r\n            m.usuario ? `${m.usuario.nombre} ${m.usuario.apellidos}` : t('audit.system'),\r\n            m.tipo,\r\n            m.descripcion || \"\",\r\n            m.culto ? format(new Date(m.culto.fecha), \"dd/MM/yyyy\") : \"\"\r\n        ])\r\n\r\n        const worksheet = XLSX.utils.aoa_to_sheet([headers, ...rows])\r\n        const workbook = XLSX.utils.book_new()\r\n        XLSX.utils.book_append_sheet(workbook, worksheet, \"Auditor├¡a\")\r\n        \r\n        // Ajustar anchos de columna\r\n        const wscols = [\r\n            { wch: 20 },\r\n            { wch: 30 },\r\n            { wch: 15 },\r\n            { wch: 50 },\r\n            { wch: 15 }\r\n        ]\r\n        worksheet['!cols'] = wscols\r\n\r\n        XLSX.writeFile(workbook, `auditoria_idmji_${format(new Date(), \"yyyyMMdd\")}.xlsx`)\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-8 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12\">\r\n            {/* Header con estilo Premium */}\r\n            <motion.div \r\n                initial={{ opacity: 0, y: -20 }}\r\n                animate={{ opacity: 1, y: 0 }}\r\n                className=\"glass rounded-[2.5rem] p-8 md:p-10 flex flex-col lg:flex-row gap-8 justify-between items-center shadow-2xl relative overflow-visible z-50\"\r\n            >\r\n                <div className=\"absolute top-0 right-0 w-64 h-64 bg-primary/5 rounded-full -mr-32 -mt-32 blur-3xl pointer-events-none\" />\r\n                \r\n                <div className=\"flex items-center gap-6 relative z-10\">\r\n                    <div className=\"p-5 bg-gradient-to-br from-primary/20 to-accent/20 rounded-[1.5rem] shadow-inner-white\">\r\n                        <FileText className=\"w-8 h-8 text-primary\" />\r\n                    </div>\r\n                    <div>\r\n                        <h1 className=\"text-3xl md:text-4xl font-black tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-foreground to-foreground/70\">\r\n                            {t('audit.title')}\r\n                        </h1>\r\n                        <p className=\"text-muted-foreground font-medium mt-1\">\r\n                            {t('audit.desc')}\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"flex flex-wrap gap-3 w-full lg:w-auto relative z-10\">\r\n                    <Button\r\n                        onClick={exportToExcel}\r\n                        className=\"rounded-2xl h-14 px-8 font-black uppercase tracking-widest text-xs shadow-xl shadow-primary/20 hover:shadow-primary/40 bg-primary text-black dark:text-white hover:scale-105 transition-all duration-300 border-none\"\r\n                    >\r\n                        <Download className=\"w-5 h-5 mr-2\" />\r\n                        {t('audit.export')}\r\n                    </Button>\r\n                </div>\r\n            </motion.div>\r\n\r\n            {/* Filtros y B├║squeda */}\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-6 relative z-40\">\r\n                <motion.div \r\n                    initial={{ opacity: 0, x: -20 }}\r\n                    animate={{ opacity: 1, x: 0 }}\r\n                    transition={{ delay: 0.1 }}\r\n                    className=\"lg:col-span-3 glass rounded-[2rem] p-5 flex flex-col md:flex-row gap-5 shadow-xl border border-white/10\"\r\n                >\r\n                    <div className=\"relative flex-1 group\">\r\n                        <Search className=\"absolute left-5 top-1/2 -translate-y-1/2 text-muted-foreground w-5 h-5 group-focus-within:text-primary transition-colors\" />\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder={t('audit.searchPlaceholder')}\r\n                            className=\"w-full pl-14 pr-6 h-14 bg-muted/30 dark:bg-muted/10 rounded-2xl border-none outline-none focus:ring-2 focus:ring-primary/30 transition-all font-bold tracking-tight text-sm placeholder:font-medium\"\r\n                            value={searchQuery}\r\n                            onChange={(e) => setSearchQuery(e.target.value)}\r\n                        />\r\n                    </div>\r\n                    \r\n                    <div className=\"relative min-w-[240px] group\">\r\n                        <div className=\"absolute left-5 top-1/2 -translate-y-1/2 p-2 bg-primary/10 rounded-xl pointer-events-none group-focus-within:bg-primary/20 transition-all\">\r\n                            <Filter className=\"text-primary w-4 h-4\" />\r\n                        </div>\r\n                        <select\r\n                            className=\"w-full pl-16 pr-10 h-14 bg-white/80 dark:bg-muted/20 backdrop-blur-md rounded-2xl border-2 border-primary/20 outline-none appearance-none cursor-pointer focus:border-primary/50 focus:ring-4 focus:ring-primary/10 transition-all font-black uppercase tracking-widest text-[11px] text-primary shadow-sm\"\r\n                            value={tipoFilter}\r\n                            onChange={(e) => setPage(1) || setTipoFilter(e.target.value)}\r\n                        >\r\n                            <option value=\"\" className=\"font-bold text-foreground\">{t('audit.filterType')}</option>\r\n                            {tipos.map(t => (\r\n                                <option key={t} value={t} className=\"font-bold text-foreground\">{t.toUpperCase()}</option>\r\n                            ))}\r\n                        </select>\r\n                        <div className=\"absolute right-5 top-1/2 -translate-y-1/2 pointer-events-none\">\r\n                            <ChevronRight className=\"w-4 h-4 text-primary rotate-90\" />\r\n                        </div>\r\n                    </div>\r\n                </motion.div>\r\n\r\n                <motion.div \r\n                    initial={{ opacity: 0, x: 20 }}\r\n                    animate={{ opacity: 1, x: 0 }}\r\n                    transition={{ delay: 0.2 }}\r\n                    className=\"glass rounded-[2rem] p-6 flex items-center justify-between shadow-xl border border-white/10 group hover:border-primary/30 transition-all\"\r\n                >\r\n                    <div className=\"space-y-1\">\r\n                        <p className=\"text-[10px] font-black uppercase tracking-widest text-muted-foreground/60\">\r\n                            {t('audit.totalRecords')}\r\n                        </p>\r\n                        <span className=\"text-4xl font-black text-primary drop-shadow-md group-hover:scale-110 transition-transform block\">\r\n                            {total}\r\n                        </span>\r\n                    </div>\r\n                    <div className=\"p-4 bg-primary/10 rounded-2xl group-hover:bg-primary/20 transition-all\">\r\n                        <LayoutList className=\"w-8 h-8 text-primary\" />\r\n                    </div>\r\n                </motion.div>\r\n            </div>\r\n\r\n            {/* Tabla de Resultados */}\r\n            <motion.div \r\n                initial={{ opacity: 0, y: 20 }}\r\n                animate={{ opacity: 1, y: 0 }}\r\n                transition={{ delay: 0.3 }}\r\n                className=\"glass rounded-[2.5rem] overflow-hidden shadow-2xl border-none no-scrollbar\"\r\n            >\r\n                <div className=\"overflow-x-auto no-scrollbar\">\r\n                    <table className=\"w-full border-collapse\">\r\n                        <thead>\r\n                            <tr className=\"bg-muted/50 border-b border-border/20\">\r\n                                <th className=\"p-6 text-left text-[10px] font-black uppercase tracking-widest text-muted-foreground\">{t('audit.tableDate')}</th>\r\n                                <th className=\"p-6 text-left text-[10px] font-black uppercase tracking-widest text-muted-foreground\">{t('audit.tableUser')}</th>\r\n                                <th className=\"p-6 text-left text-[10px] font-black uppercase tracking-widest text-muted-foreground\">{t('audit.tableType')}</th>\r\n                                <th className=\"p-6 text-left text-[10px] font-black uppercase tracking-widest text-muted-foreground\">{t('audit.tableDescription')}</th>\r\n                                <th className=\"p-6 text-left text-[10px] font-black uppercase tracking-widest text-muted-foreground\">{t('audit.tableCulto')}</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody className=\"divide-y divide-border/10\">\r\n                            <AnimatePresence mode=\"popLayout\">\r\n                                {isLoading ? (\r\n                                    <motion.tr \r\n                                        initial={{ opacity: 0 }}\r\n                                        animate={{ opacity: 1 }}\r\n                                        exit={{ opacity: 0 }}\r\n                                    >\r\n                                        <td colSpan={5} className=\"p-20 text-center\">\r\n                                            <div className=\"flex flex-col items-center gap-4\">\r\n                                                <RefreshCcw className=\"w-10 h-10 text-primary/40 animate-spin\" />\r\n                                                <p className=\"text-muted-foreground font-medium animate-pulse\">{t('common.loading')}</p>\r\n                                            </div>\r\n                                        </td>\r\n                                    </motion.tr>\r\n                                ) : movimientos.length === 0 ? (\r\n                                    <motion.tr \r\n                                        initial={{ opacity: 0 }}\r\n                                        animate={{ opacity: 1 }}\r\n                                        exit={{ opacity: 0 }}\r\n                                    >\r\n                                        <td colSpan={5} className=\"p-20 text-center\">\r\n                                            <div className=\"flex flex-col items-center gap-4 opacity-40\">\r\n                                                <Search className=\"w-12 h-12\" />\r\n                                                <p className=\"text-xl font-bold\">{t('audit.noResults')}</p>\r\n                                            </div>\r\n                                        </td>\r\n                                    </motion.tr>\r\n                                ) : (\r\n                                    movimientos.map((m, index) => (\r\n                                        <motion.tr \r\n                                            key={m.id}\r\n                                            initial={{ opacity: 0, y: 10 }}\r\n                                            animate={{ opacity: 1, y: 0 }}\r\n                                            transition={{ delay: index * 0.03 }}\r\n                                            className=\"group hover:bg-primary/[0.02] transition-colors\"\r\n                                        >\r\n                                            <td className=\"p-6\">\r\n                                                <div className=\"flex items-center gap-3\">\r\n                                                    <div className=\"p-2 bg-muted/50 rounded-xl group-hover:bg-primary/10 transition-colors\">\r\n                                                        <Calendar className=\"w-4 h-4 text-muted-foreground group-hover:text-primary transition-colors\" />\r\n                                                    </div>\r\n                                                    <div>\r\n                                                        <p className=\"text-sm font-bold\">{format(new Date(m.fecha_hora), \"dd MMM yyyy\", { locale: dateLocale })}</p>\r\n                                                        <p className=\"text-[10px] text-muted-foreground font-medium\">{format(new Date(m.fecha_hora), \"HH:mm\")}</p>\r\n                                                    </div>\r\n                                                </div>\r\n                                            </td>\r\n                                            <td className=\"p-6\">\r\n                                                {m.usuario ? (\r\n                                                    <div className=\"flex items-center gap-3\">\r\n                                                        <div className=\"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center font-black text-[10px] text-primary\">\r\n                                                            {m.usuario.nombre[0]}{m.usuario.apellidos[0]}\r\n                                                        </div>\r\n                                                        <span className=\"text-sm font-bold\">{m.usuario.nombre} {m.usuario.apellidos}</span>\r\n                                                    </div>\r\n                                                ) : (\r\n                                                    <div className=\"flex items-center gap-3 opacity-60\">\r\n                                                        <div className=\"w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center\">\r\n                                                            <RefreshCcw className=\"w-4 h-4 text-slate-400\" />\r\n                                                        </div>\r\n                                                        <span className=\"text-sm font-medium italic\">{t('audit.system')}</span>\r\n                                                    </div>\r\n                                                )}\r\n                                            </td>\r\n                                            <td className=\"p-6\">\r\n                                                <span className={`px-3 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-widest ${getTipoColor(m.tipo)}`}>\r\n                                                    {m.tipo}\r\n                                                </span>\r\n                                            </td>\r\n                                            <td className=\"p-6\">\r\n                                                <p className=\"text-sm text-muted-foreground font-medium max-w-sm line-clamp-2\">\r\n                                                    {m.descripcion || '-'}\r\n                                                </p>\r\n                                            </td>\r\n                                            <td className=\"p-6\">\r\n                                                {m.culto ? (\r\n                                                    <div className=\"flex items-center gap-2\">\r\n                                                        <span className=\"w-1.5 h-1.5 rounded-full bg-primary animate-pulse\" />\r\n                                                        <span className=\"text-xs font-bold font-mono\">\r\n                                                            {format(new Date(m.culto.fecha), \"dd/MM/yyyy\")}\r\n                                                        </span>\r\n                                                    </div>\r\n                                                ) : (\r\n                                                    <span className=\"text-xs text-muted-foreground/40\">ÔÇö</span>\r\n                                                )}\r\n                                            </td>\r\n                                        </motion.tr>\r\n                                    ))\r\n                                )}\r\n                            </AnimatePresence>\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n\r\n                {/* Pagination Premium */}\r\n                {totalPages > 1 && (\r\n                    <div className=\"flex flex-col sm:flex-row items-center justify-between p-8 bg-muted/30 border-t border-border/10 gap-4\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <span className=\"text-xs font-black uppercase tracking-widest text-muted-foreground\">P├ígina</span>\r\n                            <div className=\"flex items-center justify-center w-8 h-8 bg-primary text-white rounded-lg font-black text-xs shadow-lg shadow-primary/30\">\r\n                                {page}\r\n                            </div>\r\n                            <span className=\"text-xs font-black uppercase tracking-widest text-muted-foreground\">de {totalPages}</span>\r\n                        </div>\r\n                        <div className=\"flex gap-3\">\r\n                            <Button\r\n                                onClick={() => setPage(p => Math.max(1, p - 1))}\r\n                                disabled={page === 1 || isLoading}\r\n                                variant=\"outline\"\r\n                                className=\"w-12 h-12 p-0 rounded-2xl hover:bg-primary hover:text-white transition-all duration-300 disabled:opacity-30 border-none shadow-lg\"\r\n                            >\r\n                                <ChevronLeft className=\"w-6 h-6\" />\r\n                            </Button>\r\n                            <Button\r\n                                onClick={() => setPage(p => Math.min(totalPages, p + 1))}\r\n                                disabled={page === totalPages || isLoading}\r\n                                variant=\"outline\"\r\n                                className=\"w-12 h-12 p-0 rounded-2xl hover:bg-primary hover:text-white transition-all duration-300 disabled:opacity-30 border-none shadow-lg\"\r\n                            >\r\n                                <ChevronRight className=\"w-6 h-6\" />\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </motion.div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\admin\\audit\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":59,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":59,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1590,1593],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1590,1593],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server'\r\n\r\nimport { createClient } from '@/lib/supabase/server'\r\nimport { ActionResponse } from '@/types/database'\r\n\r\nexport interface MovimientoData {\r\n    id: string\r\n    fecha_hora: string\r\n    id_usuario: string | null\r\n    tipo: string\r\n    descripcion: string | null\r\n    culto_id: string | null\r\n    usuario?: {\r\n        nombre: string\r\n        apellidos: string\r\n    }\r\n    culto?: {\r\n        fecha: string\r\n    }\r\n}\r\n\r\nexport async function getMovimientos(\r\n    page: number = 1,\r\n    limit: number = 20,\r\n    tipo?: string,\r\n    search?: string\r\n): Promise<ActionResponse<{ data: MovimientoData[], total: number }>> {\r\n    try {\r\n        const supabase = await createClient()\r\n        const offset = (page - 1) * limit\r\n\r\n        let query = supabase\r\n            .from('movimientos')\r\n            .select(`\r\n                id,\r\n                fecha_hora,\r\n                id_usuario,\r\n                tipo,\r\n                descripcion,\r\n                culto_id,\r\n                profiles!movimientos_id_usuario_fkey(nombre, apellidos),\r\n                cultos!movimientos_culto_id_fkey(fecha)\r\n            `, { count: 'exact' })\r\n\r\n        if (tipo) {\r\n            query = query.eq('tipo', tipo)\r\n        }\r\n\r\n        if (search) {\r\n            query = query.ilike('descripcion', `%${search}%`)\r\n        }\r\n\r\n        const { data, error, count } = await query\r\n            .order('fecha_hora', { ascending: false })\r\n            .range(offset, offset + limit - 1)\r\n\r\n        if (error) throw error\r\n\r\n        const formattedData: MovimientoData[] = (data || []).map((m: any) => ({\r\n            id: m.id,\r\n            fecha_hora: m.fecha_hora,\r\n            id_usuario: m.id_usuario,\r\n            tipo: m.tipo,\r\n            descripcion: m.descripcion,\r\n            culto_id: m.culto_id,\r\n            usuario: m.profiles ? {\r\n                nombre: m.profiles.nombre,\r\n                apellidos: m.profiles.apellidos\r\n            } : undefined,\r\n            culto: m.cultos ? {\r\n                fecha: m.cultos.fecha\r\n            } : undefined\r\n        }))\r\n\r\n        return {\r\n            success: true,\r\n            data: {\r\n                data: formattedData,\r\n                total: count || 0\r\n            }\r\n        }\r\n    } catch (error) {\r\n        console.error('Error fetching movimientos:', error)\r\n        return { success: false, error: 'Error al cargar movimientos' }\r\n    }\r\n}\r\n\r\nexport async function getMovimientosTipos(): Promise<ActionResponse<string[]>> {\r\n    try {\r\n        const supabase = await createClient()\r\n\r\n        const { data, error } = await supabase\r\n            .from('movimientos')\r\n            .select('tipo')\r\n            .order('tipo')\r\n\r\n        if (error) throw error\r\n\r\n        const tipos = [...new Set((data || []).map(m => m.tipo))].filter(Boolean)\r\n\r\n        return { success: true, data: tipos }\r\n    } catch (error) {\r\n        console.error('Error fetching tipos:', error)\r\n        return { success: false, error: 'Error al cargar tipos' }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\admin\\audit\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\admin\\stats\\StatsClient.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":191,"column":61,"nodeType":"JSXOpeningElement","endLine":191,"endColumn":148}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { UserStats, getParticipationStats, getBibleReadingStats, ReadingStats } from './actions'\r\nimport { Card } from '@/components/ui/Card'\r\nimport { Button } from '@/components/ui/Button'\r\nimport { BarChart, Search, ArrowUpDown, BookOpen, PieChart as PieChartIcon } from 'lucide-react'\r\nimport {\r\n    BarChart as ReBarChart,\r\n    Bar,\r\n    XAxis,\r\n    YAxis,\r\n    CartesianGrid,\r\n    Tooltip,\r\n    ResponsiveContainer,\r\n    PieChart,\r\n    Pie,\r\n    Cell\r\n} from 'recharts'\r\n\r\ninterface StatsClientProps {\r\n    initialStats: UserStats[]\r\n    currentYear: number\r\n}\r\n\r\nconst COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']\r\n\r\nexport default function StatsClient({ initialStats, currentYear }: StatsClientProps) {\r\n    const [stats, setStats] = useState<UserStats[]>(initialStats)\r\n    const [readingStats, setReadingStats] = useState<{ topReadings: ReadingStats[], readingsByType: ReadingStats[] } | null>(null)\r\n    const [year, setYear] = useState(currentYear)\r\n    const [isLoading, setIsLoading] = useState(false)\r\n    const [activeTab, setActiveTab] = useState<'pulpit' | 'bible'>('pulpit')\r\n    const [searchTerm, setSearchTerm] = useState('')\r\n    const [sortConfig, setSortConfig] = useState<{ key: keyof UserStats['stats'] | 'total' | 'nombre'; direction: 'asc' | 'desc' }>({ key: 'total', direction: 'desc' })\r\n\r\n    useEffect(() => {\r\n        const loadBibleStats = async () => {\r\n            const result = await getBibleReadingStats()\r\n            if (result.success && result.data) {\r\n                setReadingStats(result.data)\r\n            }\r\n        }\r\n        loadBibleStats()\r\n    }, [])\r\n\r\n    const years = Array.from({ length: 5 }, (_, i) => currentYear - 2 + i) // 2 years back, 2 years forward\r\n\r\n    const handleYearChange = async (newYear: string) => {\r\n        const y = parseInt(newYear)\r\n        setYear(y)\r\n        setIsLoading(true)\r\n        const result = await getParticipationStats(y)\r\n        if (result.success && result.data) {\r\n            setStats(result.data)\r\n        }\r\n        setIsLoading(false)\r\n    }\r\n\r\n    const handleSort = (key: keyof UserStats['stats'] | 'total' | 'nombre') => {\r\n        let direction: 'asc' | 'desc' = 'desc'\r\n        if (sortConfig.key === key && sortConfig.direction === 'desc') {\r\n            direction = 'asc'\r\n        }\r\n        setSortConfig({ key, direction })\r\n    }\r\n\r\n    const sortedStats = [...stats].sort((a, b) => {\r\n        if (sortConfig.key === 'nombre') {\r\n            const nameA = `${a.user.nombre} ${a.user.apellidos}`.toLowerCase()\r\n            const nameB = `${b.user.nombre} ${b.user.apellidos}`.toLowerCase()\r\n            return sortConfig.direction === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA)\r\n        }\r\n\r\n        const valA = sortConfig.key === 'total' ? a.total : a.stats[sortConfig.key as keyof typeof a.stats]\r\n        const valB = sortConfig.key === 'total' ? b.total : b.stats[sortConfig.key as keyof typeof b.stats]\r\n\r\n        return sortConfig.direction === 'asc' ? valA - valB : valB - valA\r\n    })\r\n\r\n    const filteredStats = sortedStats.filter(stat => {\r\n        const fullName = `${stat.user.nombre} ${stat.user.apellidos}`.toLowerCase()\r\n        return fullName.includes(searchTerm.toLowerCase())\r\n    })\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* Tabs */}\r\n            <div className=\"flex gap-2 p-1 bg-muted/30 rounded-xl w-fit\">\r\n                <Button\r\n                    variant={activeTab === 'pulpit' ? 'primary' : 'ghost'}\r\n                    onClick={() => setActiveTab('pulpit')}\r\n                    className=\"rounded-lg\"\r\n                >\r\n                    <BarChart className=\"w-4 h-4 mr-2\" />\r\n                    P├║lpito\r\n                </Button>\r\n                <Button\r\n                    variant={activeTab === 'bible' ? 'primary' : 'ghost'}\r\n                    onClick={() => setActiveTab('bible')}\r\n                    className=\"rounded-lg\"\r\n                >\r\n                    <BookOpen className=\"w-4 h-4 mr-2\" />\r\n                    Biblia\r\n                </Button>\r\n            </div>\r\n\r\n            {activeTab === 'pulpit' ? (\r\n                <>\r\n                    {/* Header / Filters */}\r\n                    <div className=\"glass rounded-2xl p-6 flex flex-col md:flex-row gap-4 justify-between items-center\">\r\n                        <div className=\"flex items-center gap-4\">\r\n                            <div className=\"p-3 bg-primary/10 rounded-xl\">\r\n                                <BarChart className=\"w-6 h-6 text-primary\" />\r\n                            </div>\r\n                            <div>\r\n                                <h1 className=\"text-2xl font-bold\">Estad├¡sticas de Participaci├│n</h1>\r\n                                <p className=\"text-muted-foreground text-sm\">Rotaci├│n de hermanos en p├║lpito</p>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"flex gap-4 w-full md:w-auto\">\r\n                            <div className=\"relative flex-1 md:w-64\">\r\n                                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\r\n                                <input\r\n                                    type=\"text\"\r\n                                    placeholder=\"Buscar hermano...\"\r\n                                    className=\"w-full pl-9 pr-4 py-2 bg-background/50 border border-input rounded-lg focus:ring-2 focus:ring-primary/20 outline-none\"\r\n                                    value={searchTerm}\r\n                                    onChange={(e) => setSearchTerm(e.target.value)}\r\n                                />\r\n                            </div>\r\n                            <select\r\n                                className=\"p-2 bg-background border border-input rounded-lg outline-none cursor-pointer hover:bg-muted/50 transition-colors\"\r\n                                value={year}\r\n                                onChange={(e) => handleYearChange(e.target.value)}\r\n                                disabled={isLoading}\r\n                            >\r\n                                {years.map(y => (\r\n                                    <option key={y} value={y}>{y}</option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Table */}\r\n                    <div className=\"glass rounded-2xl overflow-hidden\">\r\n                        <div className=\"overflow-x-auto\">\r\n                            <table className=\"w-full min-w-[600px]\">\r\n                                <thead>\r\n                                    <tr className=\"border-b border-border/50 bg-muted/20\">\r\n                                        <th className=\"text-left p-4 font-medium text-muted-foreground min-w-[150px] cursor-pointer hover:bg-muted/30 transition-colors sticky left-0 bg-background/80 backdrop-blur-sm\" onClick={() => handleSort('nombre')}>\r\n                                            <div className=\"flex items-center gap-1 md:gap-2 text-xs md:text-sm\">Hermano <ArrowUpDown className=\"w-3 h-3\" /></div>\r\n                                        </th>\r\n                                        <th className=\"text-center p-4 font-medium text-muted-foreground cursor-pointer hover:bg-muted/30 transition-colors\" onClick={() => handleSort('total')}>\r\n                                            <div className=\"flex items-center justify-center gap-1 text-xs md:text-sm\">Total <ArrowUpDown className=\"w-3 h-3\" /></div>\r\n                                        </th>\r\n                                        <th className=\"text-center p-4 font-medium text-green-600/80 cursor-pointer hover:bg-muted/30 transition-colors\" onClick={() => handleSort('introduccion')}>\r\n                                            <div className=\"flex items-center justify-center gap-1 text-xs md:text-sm\">Intro <ArrowUpDown className=\"w-3 h-3\" /></div>\r\n                                        </th>\r\n                                        <th className=\"text-center p-4 font-medium text-blue-600/80 cursor-pointer hover:bg-muted/30 transition-colors\" onClick={() => handleSort('finalizacion')}>\r\n                                            <div className=\"flex items-center justify-center gap-1 text-xs md:text-sm\">Final <ArrowUpDown className=\"w-3 h-3\" /></div>\r\n                                        </th>\r\n                                        <th className=\"text-center p-4 font-medium text-purple-600/80 cursor-pointer hover:bg-muted/30 transition-colors\" onClick={() => handleSort('ensenanza')}>\r\n                                            <div className=\"flex items-center justify-center gap-1 text-xs md:text-sm\"><span className=\"hidden sm:inline\">Ense├▒</span><span className=\"sm:hidden\">Ens</span> <ArrowUpDown className=\"w-3 h-3\" /></div>\r\n                                        </th>\r\n                                        <th className=\"text-center p-4 font-medium text-orange-600/80 cursor-pointer hover:bg-muted/30 transition-colors\" onClick={() => handleSort('testimonios')}>\r\n                                            <div className=\"flex items-center justify-center gap-1 text-xs md:text-sm\"><span className=\"hidden sm:inline\">Testimonios</span><span className=\"sm:hidden\">Test</span> <ArrowUpDown className=\"w-3 h-3\" /></div>\r\n                                        </th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody className=\"divide-y divide-border/30\">\r\n                                    {isLoading ? (\r\n                                        <tr>\r\n                                            <td colSpan={6} className=\"p-8 text-center text-muted-foreground animate-pulse\">\r\n                                                Cargando datos...\r\n                                            </td>\r\n                                        </tr>\r\n                                    ) : filteredStats.length === 0 ? (\r\n                                        <tr>\r\n                                            <td colSpan={6} className=\"p-8 text-center text-muted-foreground\">\r\n                                                No se encontraron registros\r\n                                            </td>\r\n                                        </tr>\r\n                                    ) : (\r\n                                        filteredStats.map((stat, i) => (\r\n                                            <tr key={stat.userId} className=\"hover:bg-muted/30 transition-colors\">\r\n                                                <td className=\"p-4\">\r\n                                                    <div className=\"flex items-center gap-3\">\r\n                                                        {stat.user.avatar_url ? (\r\n                                                            <img src={stat.user.avatar_url} alt=\"\" className=\"w-8 h-8 rounded-full object-cover\" />\r\n                                                        ) : (\r\n                                                            <div className=\"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary text-xs font-bold\">\r\n                                                                {stat.user.nombre?.[0]}{stat.user.apellidos?.[0]}\r\n                                                            </div>\r\n                                                        )}\r\n                                                        <div>\r\n                                                            <p className=\"font-medium text-foreground\">{stat.user.nombre} {stat.user.apellidos}</p>\r\n                                                            <p className=\"text-xs text-muted-foreground\">{i + 1}┬║ en ranking</p>\r\n                                                        </div>\r\n                                                    </div>\r\n                                                </td>\r\n                                                <td className=\"p-4 text-center font-bold text-lg\">{stat.total}</td>\r\n                                                <td className=\"p-4 text-center text-muted-foreground\">{stat.stats.introduccion > 0 ? stat.stats.introduccion : '-'}</td>\r\n                                                <td className=\"p-4 text-center text-muted-foreground\">{stat.stats.finalizacion > 0 ? stat.stats.finalizacion : '-'}</td>\r\n                                                <td className=\"p-4 text-center text-muted-foreground\">{stat.stats.ensenanza > 0 ? stat.stats.ensenanza : '-'}</td>\r\n                                                <td className=\"p-4 text-center text-muted-foreground\">{stat.stats.testimonios > 0 ? stat.stats.testimonios : '-'}</td>\r\n                                            </tr>\r\n                                        ))\r\n                                    )}\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n                    </div>\r\n                </>\r\n            ) : (\r\n                <>\r\n                    {/* Biblical Stats */}\r\n                    <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n                        {/* Most Read Bar Chart */}\r\n                        <Card className=\"p-6 glass\">\r\n                            <div className=\"flex items-center gap-3 mb-6\">\r\n                                <div className=\"p-2 bg-blue-500/10 rounded-lg\">\r\n                                    <BarChart className=\"w-5 h-5 text-blue-500\" />\r\n                                </div>\r\n                                <h3 className=\"font-bold text-lg\">Citas m├ís le├¡das</h3>\r\n                            </div>\r\n                            <div className=\"h-[300px] w-full\">\r\n                                <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                                    <ReBarChart data={readingStats?.topReadings || []}>\r\n                                        <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#88888820\" vertical={false} />\r\n                                        <XAxis\r\n                                            dataKey=\"label\"\r\n                                            tick={{ fontSize: 10 }}\r\n                                            interval={0}\r\n                                            angle={-45}\r\n                                            textAnchor=\"end\"\r\n                                            height={70}\r\n                                        />\r\n                                        <YAxis />\r\n                                        <Tooltip\r\n                                            contentStyle={{\r\n                                                backgroundColor: 'rgba(255, 255, 255, 0.9)',\r\n                                                borderRadius: '12px',\r\n                                                border: 'none',\r\n                                                boxShadow: '0 4px 12px rgba(0,0,0,0.1)'\r\n                                            }}\r\n                                        />\r\n                                        <Bar dataKey=\"count\" fill=\"#3b82f6\" radius={[4, 4, 0, 0]} />\r\n                                    </ReBarChart>\r\n                                </ResponsiveContainer>\r\n                            </div>\r\n                        </Card>\r\n\r\n                        {/* Types Pie Chart */}\r\n                        <Card className=\"p-6 glass\">\r\n                            <div className=\"flex items-center gap-3 mb-6\">\r\n                                <div className=\"p-2 bg-purple-500/10 rounded-lg\">\r\n                                    <PieChartIcon className=\"w-5 h-5 text-purple-500\" />\r\n                                </div>\r\n                                <h3 className=\"font-bold text-lg\">Lecturas por tipo</h3>\r\n                            </div>\r\n                            <div className=\"h-[300px] w-full\">\r\n                                <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                                    <PieChart>\r\n                                        <Pie\r\n                                            data={readingStats?.readingsByType || []}\r\n                                            cx=\"50%\"\r\n                                            cy=\"50%\"\r\n                                            innerRadius={60}\r\n                                            outerRadius={100}\r\n                                            paddingAngle={5}\r\n                                            dataKey=\"count\"\r\n                                            nameKey=\"label\"\r\n                                            label\r\n                                        >\r\n                                            {(readingStats?.readingsByType || []).map((entry, index) => (\r\n                                                <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />\r\n                                            ))}\r\n                                        </Pie>\r\n                                        <Tooltip />\r\n                                    </PieChart>\r\n                                </ResponsiveContainer>\r\n                            </div>\r\n                        </Card>\r\n                    </div>\r\n\r\n                    {/* Simple List (Table) for Mobile or simple view */}\r\n                    <div className=\"glass rounded-2xl overflow-hidden mt-6\">\r\n                        <div className=\"p-4 border-b border-border/50 bg-muted/20\">\r\n                            <h3 className=\"font-bold\">Ranking de Lecturas</h3>\r\n                        </div>\r\n                        <div className=\"p-4 space-y-4\">\r\n                            {(readingStats?.topReadings || []).map((reading, i) => (\r\n                                <div key={i} className=\"flex items-center justify-between p-3 bg-background/50 rounded-xl border border-border/10\">\r\n                                    <div className=\"flex items-center gap-3\">\r\n                                        <div className=\"w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary font-bold\">\r\n                                            {i + 1}\r\n                                        </div>\r\n                                        <span className=\"font-medium\">{reading.label}</span>\r\n                                    </div>\r\n                                    <span className=\"px-3 py-1 bg-primary/10 text-primary rounded-full text-sm font-bold\">\r\n                                        {reading.count} veces\r\n                                    </span>\r\n                                </div>\r\n                            ))}\r\n                            {(!readingStats?.topReadings || readingStats.topReadings.length === 0) && (\r\n                                <p className=\"text-center text-muted-foreground py-8\">No hay datos de lectura registrados a├║n.</p>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                </>\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\admin\\stats\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\admin\\stats\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\admin\\users\\UsersClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Shield' is defined but never used.","line":5,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'UserCheck' is defined but never used.","line":5,"column":33,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":42},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'RotateCw' is defined but never used.","line":5,"column":73,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":81},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertTriangle' is defined but never used.","line":5,"column":83,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":96},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'counts' is defined but never used.","line":23,"column":53,"nodeType":null,"messageId":"unusedVar","endLine":23,"endColumn":59},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":153,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":153,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6709,6712],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6709,6712],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":184,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":184,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7882,7885],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7882,7885],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":273,"column":41,"nodeType":"JSXOpeningElement","endLine":273,"endColumn":214},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":347,"column":41,"nodeType":"JSXOpeningElement","endLine":347,"endColumn":107},{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"img elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":347,"column":41,"nodeType":"JSXOpeningElement","endLine":347,"endColumn":107}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useState, useRef, useEffect } from 'react'\r\nimport { getUsers, createUser, updateUserFull, deleteUser, UserData } from './actions'\r\nimport { Users, Search, Shield, UserCheck, Trash2, Edit2, Plus, Camera, RotateCw, AlertTriangle, AlertCircle, X, Eye, EyeOff } from 'lucide-react'\r\nimport { toast } from 'sonner'\r\nimport { Button } from '@/components/ui/Button'\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from '@/components/ui/Dialog'\r\nimport { Input } from '@/components/ui/Input'\r\nimport { Label } from '@/components/ui/label'\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\r\nimport { Switch } from '@/components/ui/switch'\r\nimport AvatarEditor from '@/components/AvatarEditor'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport { useI18n } from '@/lib/i18n/I18nProvider'\r\n\r\ninterface UsersClientProps {\r\n    initialUsers: UserData[]\r\n    counts: { total: number, pulpito: number, admins: number }\r\n    availableRoles: string[]\r\n}\r\n\r\nexport default function UsersClient({ initialUsers, counts, availableRoles }: UsersClientProps) {\r\n    const { t } = useI18n()\r\n    const [users, setUsers] = useState<UserData[]>(initialUsers)\r\n    const defaultRole = availableRoles[0] || 'MIEMBRO'\r\n    const [searchTerm, setSearchTerm] = useState('')\r\n    const [isLoading, setIsLoading] = useState(false)\r\n    const [isCreateOpen, setIsCreateOpen] = useState(false)\r\n    const [isEditOpen, setIsEditOpen] = useState(false)\r\n    const [isDeleteOpen, setIsDeleteOpen] = useState(false)\r\n    const [selectedUser, setSelectedUser] = useState<UserData | null>(null)\r\n\r\n    // Form States\r\n    const [formData, setFormData] = useState({\r\n        nombre: '',\r\n        apellidos: '',\r\n        email: '',\r\n        email_contacto: '',\r\n        telefono: '',\r\n        password: '',\r\n        rol: defaultRole,\r\n        pulpito: false\r\n    })\r\n    const [avatarFile, setAvatarFile] = useState<Blob | null>(null)\r\n    const [avatarPreview, setAvatarPreview] = useState<string | null>(null)\r\n    const [isCropOpen, setIsCropOpen] = useState(false)\r\n    const [tempImageSrc, setTempImageSrc] = useState<string | null>(null)\r\n    const [showPassword, setShowPassword] = useState(false)\r\n\r\n    const fileInputRef = useRef<HTMLInputElement>(null)\r\n    const isAnyModalOpen = isCreateOpen || isEditOpen || isDeleteOpen || isCropOpen\r\n\r\n    // Asegurar que el scroll est├® habilitado cuando no hay modales abiertos\r\n    useEffect(() => {\r\n        if (!isAnyModalOpen) {\r\n            document.body.style.overflow = ''\r\n            document.documentElement.style.overflow = ''\r\n            document.body.style.touchAction = ''\r\n        }\r\n    }, [isAnyModalOpen])\r\n\r\n    // Filter Users\r\n    const filteredUsers = users.filter(u => {\r\n        const fullName = `${u.nombre} ${u.apellidos}`.toLowerCase()\r\n        const email = u.email?.toLowerCase() || ''\r\n        const search = searchTerm.toLowerCase()\r\n        return fullName.includes(search) || email.includes(search)\r\n    })\r\n\r\n    // Reset Form\r\n    const resetForm = () => {\r\n        setFormData({\r\n            nombre: '',\r\n            apellidos: '',\r\n            email: '',\r\n            email_contacto: '',\r\n            telefono: '',\r\n            password: '',\r\n            rol: defaultRole,\r\n            pulpito: false\r\n        })\r\n        setAvatarFile(null)\r\n        setAvatarPreview(null)\r\n        setTempImageSrc(null)\r\n        setShowPassword(false)\r\n        if (fileInputRef.current) fileInputRef.current.value = ''\r\n    }\r\n\r\n    // Handlers\r\n    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        if (e.target.files && e.target.files.length > 0) {\r\n            const file = e.target.files[0]\r\n            const reader = new FileReader()\r\n            reader.addEventListener('load', () => setTempImageSrc(reader.result?.toString() || null))\r\n            reader.readAsDataURL(file)\r\n            setIsCropOpen(true)\r\n        }\r\n    }\r\n\r\n    const handleCropSave = (croppedBlob: Blob) => {\r\n        setAvatarFile(croppedBlob)\r\n        setAvatarPreview(URL.createObjectURL(croppedBlob))\r\n        setIsCropOpen(false)\r\n    }\r\n\r\n    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {\r\n        e.preventDefault()\r\n        setIsLoading(true)\r\n\r\n        const formDataFromDom = new FormData(e.currentTarget)\r\n\r\n        try {\r\n            const data = new FormData()\r\n            // Usar valores del DOM preferiblemente, o fallback al estado\r\n            data.append('nombre', (formDataFromDom.get('nombre') as string) || formData.nombre)\r\n            data.append('apellidos', (formDataFromDom.get('apellidos') as string) || formData.apellidos)\r\n            data.append('rol', (formDataFromDom.get('rol') as string) || formData.rol)\r\n            data.append('pulpito', String(formData.pulpito))\r\n            data.append('email_contacto', (formDataFromDom.get('email_contacto') as string) || formData.email_contacto)\r\n            data.append('telefono', (formDataFromDom.get('telefono') as string) || formData.telefono)\r\n            if (avatarFile) data.append('avatar', avatarFile, 'avatar.jpg')\r\n\r\n            let result\r\n            if (selectedUser) {\r\n                // Edit Mode\r\n                data.append('id', selectedUser.id)\r\n                data.append('currentAvatarUrl', selectedUser.avatar_url || '')\r\n                result = await updateUserFull(data)\r\n            } else {\r\n                // Create Mode - Asegurar el dominio correcto\r\n                // Generar el email a partir del nombre para evitar problemas de sincronizaci├│n de estado\r\n                const nombreDom = (formDataFromDom.get('nombre') as string) || formData.nombre\r\n                const emailPrefix = nombreDom.toLowerCase().trim().replace(/\\s+/g, '.')\r\n                const fullEmail = `${emailPrefix}@idmjisabadell.org`\r\n                \r\n                console.log('Creating user with email:', fullEmail)\r\n                data.append('email', fullEmail)\r\n                data.append('password', (formDataFromDom.get('password') as string) || formData.password)\r\n                result = await createUser(data)\r\n            }\r\n\r\n            if (result.success) {\r\n                toast.success(selectedUser ? t('users.toast.updated') : t('users.toast.created'))\r\n                resetForm()\r\n                setIsCreateOpen(false)\r\n                setIsEditOpen(false)\r\n                const refresh = await getUsers()\r\n                if (refresh.success && refresh.data) setUsers(refresh.data)\r\n            } else {\r\n                toast.error(result.error)\r\n            }\r\n        } catch (err: any) {\r\n            console.error('handleSubmit error', err)\r\n            toast.error(err?.message || t('users.error.unexpectedSave'))\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }\r\n\r\n    const handleDelete = async () => {\r\n        if (!selectedUser) {\r\n            console.error('No user selected for deletion')\r\n            return\r\n        }\r\n        \r\n        console.log('handleDelete called for user:', selectedUser.id, selectedUser.email)\r\n        setIsLoading(true)\r\n        \r\n        try {\r\n            const result = await deleteUser(selectedUser.id)\r\n            console.log('deleteUser result:', result)\r\n            \r\n            if (result.success) {\r\n                console.log('User deleted successfully, updating UI')\r\n                toast.success(t('users.toast.deleted'))\r\n                setUsers(users.filter(u => u.id !== selectedUser.id))\r\n                setIsDeleteOpen(false)\r\n                setSelectedUser(null)\r\n            } else {\r\n                console.error('deleteUser failed:', result.error)\r\n                toast.error(result.error || t('users.error.deleteFailed'))\r\n            }\r\n        } catch (error: any) {\r\n            console.error('Exception in handleDelete:', error)\r\n            toast.error(error?.message || t('users.error.unexpectedDelete'))\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }\r\n\r\n    const openEdit = (user: UserData) => {\r\n        setSelectedUser(user)\r\n        setFormData({\r\n            nombre: user.nombre === t('users.defaults.noName') ? '' : user.nombre,\r\n            apellidos: user.apellidos === t('users.defaults.noLastName') ? '' : user.apellidos,\r\n            email: user.email || '',\r\n            email_contacto: user.email_contacto || '',\r\n            telefono: user.telefono || '',\r\n            password: '',\r\n            rol: user.rol,\r\n            pulpito: user.pulpito\r\n        })\r\n        setAvatarPreview(user.avatar_url)\r\n        setIsEditOpen(true)\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-8 animate-in fade-in duration-500 no-scrollbar\" data-page=\"users\">\r\n            {/* Header Actions */}\r\n            <div className=\"flex flex-col md:flex-row gap-4 justify-between items-start md:items-center bg-card/50 backdrop-blur-xl p-6 rounded-3xl border border-white/10 shadow-xl\">\r\n                <div>\r\n                    <h1 className=\"text-3xl font-black tracking-tight flex items-center gap-3\">\r\n                        <Users className=\"w-8 h-8 text-primary\" />\r\n                        {t('users.title')}\r\n                    </h1>\r\n                    <p className=\"text-muted-foreground mt-1 font-medium\">{t('users.desc')}</p>\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-3 w-full md:w-auto\">\r\n                    <Button\r\n                        onClick={() => { resetForm(); setIsCreateOpen(true) }}\r\n                        className=\"gap-2 rounded-xl font-bold bg-blue-600 hover:bg-blue-700 text-white shadow-lg shadow-blue-600/20\"\r\n                    >\r\n                        <Plus className=\"w-5 h-5\" />\r\n                        {t('users.new')}\r\n                    </Button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Search & Stats Bar */}\r\n            <div className=\"grid md:grid-cols-4 gap-4\">\r\n                <div className=\"md:col-span-2 relative group\">\r\n                    <div className=\"absolute inset-0 bg-blue-500/20 blur-xl opacity-0 group-hover:opacity-100 transition-opacity rounded-2xl\" />\r\n                    <div className=\"relative bg-card rounded-2xl border border-white/10 shadow-lg flex items-center px-4 h-14\">\r\n                        <Search className=\"w-5 h-5 text-muted-foreground mr-3\" />\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder={t('users.search')}\r\n                            className=\"bg-transparent border-none outline-none w-full text-foreground placeholder:text-muted-foreground/50 font-medium\"\r\n                            value={searchTerm}\r\n                            onChange={(e) => setSearchTerm(e.target.value)}\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"bg-card rounded-2xl border border-white/10 p-4 flex items-center justify-between shadow-lg\">\r\n                    <span className=\"text-muted-foreground font-medium text-sm\">{t('users.total')}</span>\r\n                    <span className=\"text-2xl font-black text-blue-500\">{users.length}</span>\r\n                </div>\r\n                <div className=\"bg-card rounded-2xl border border-white/10 p-4 flex items-center justify-between shadow-lg\">\r\n                    <span className=\"text-muted-foreground font-medium text-sm\">{t('users.admins')}</span>\r\n                    <span className=\"text-2xl font-black text-amber-500\">{users.filter(u => u.rol === 'ADMIN').length}</span>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Users Grid */}\r\n            <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4\">\r\n                <AnimatePresence>\r\n                    {filteredUsers.map((user) => (\r\n                        <motion.div\r\n                            key={user.id}\r\n                            initial={{ opacity: 0, scale: 0.95 }}\r\n                            animate={{ opacity: 1, scale: 1 }}\r\n                            exit={{ opacity: 0, scale: 0.95 }}\r\n                            layout\r\n                            className=\"group relative bg-card hover:bg-card/80 border border-white/5 hover:border-blue-500/30 rounded-3xl p-6 transition-all duration-300 hover:shadow-2xl hover:shadow-black/20\"\r\n                        >\r\n                            <div className=\"flex flex-col items-center text-center space-y-4\">\r\n                                <div className=\"relative\">\r\n                                    <div className=\"absolute inset-0 bg-blue-500/20 blur-xl rounded-full opacity-0 group-hover:opacity-100 transition-opacity\" />\r\n                                    {user.avatar_url ? (\r\n                                        <img src={user.avatar_url} alt=\"\" className=\"relative w-24 h-24 rounded-full object-cover border-4 border-card group-hover:border-blue-500/20 transition-colors shadow-xl\" />\r\n                                    ) : (\r\n                                        <div className=\"relative w-24 h-24 rounded-full bg-muted flex items-center justify-center text-2xl font-black text-muted-foreground border-4 border-card group-hover:border-blue-500/20 transition-colors shadow-xl\">\r\n                                            {user.nombre?.[0]}{user.apellidos?.[0]}\r\n                                        </div>\r\n                                    )}\r\n                                    <span className={`absolute bottom-1 right-1 px-2 py-0.5 rounded-full text-[10px] font-black border-2 border-card uppercase ${user.rol === 'ADMIN' ? 'bg-amber-500 text-black' :\r\n                                            user.rol === 'EDITOR' ? 'bg-blue-500 text-white' : 'bg-zinc-200 text-zinc-700'\r\n                                        }`}>\r\n                                        {user.rol}\r\n                                    </span>\r\n                                </div>\r\n\r\n                                <div className=\"space-y-1 w-full\">\r\n                                    <h3 className=\"font-bold text-lg leading-tight truncate px-2\">{user.nombre} {user.apellidos}</h3>\r\n                                    <p className=\"text-xs text-muted-foreground truncate px-2\">{user.email}</p>\r\n                                </div>\r\n\r\n                                <div className=\"flex items-center gap-2 pt-2 w-full\">\r\n                                    <Button\r\n                                        variant=\"outline\"\r\n                                        size=\"sm\"\r\n                                        onClick={() => openEdit(user)}\r\n                                        className=\"flex-1 rounded-xl h-9 font-bold bg-white/5 border-white/10 hover:bg-white/10\"\r\n                                    >\r\n                                        <Edit2 className=\"w-3.5 h-3.5 mr-2\" />\r\n                                        {t('common.edit')}\r\n                                    </Button>\r\n                                    <Button\r\n                                        variant=\"ghost\"\r\n                                        size=\"icon\"\r\n                                        onClick={() => { setSelectedUser(user); setIsDeleteOpen(true) }}\r\n                                        className=\"rounded-xl h-9 w-9 text-red-500/70 hover:text-red-500 hover:bg-red-500/10\"\r\n                                    >\r\n                                        <Trash2 className=\"w-4 h-4\" />\r\n                                    </Button>\r\n                                </div>\r\n                            </div>\r\n                        </motion.div>\r\n                    ))}\r\n                </AnimatePresence>\r\n            </div>\r\n\r\n            {/* Create/Edit Modal - LIGHT THEME */}\r\n            <Dialog open={isCreateOpen || isEditOpen} onOpenChange={(open) => { if (!open) { setIsCreateOpen(false); setIsEditOpen(false); } }}>\r\n                <DialogContent className=\"max-w-2xl bg-white border-zinc-200 p-0 gap-0 rounded-3xl shadow-2xl text-zinc-900 max-h-[90vh] overflow-y-auto no-scrollbar\">\r\n                    <div className=\"bg-zinc-50 p-6 border-b border-zinc-200 sticky top-0 z-10\">\r\n                        <div className=\"flex items-center justify-between gap-3\">\r\n                            <DialogTitle className=\"text-2xl font-black flex items-center gap-3 text-zinc-900\">\r\n                                {isEditOpen ? <Edit2 className=\"w-6 h-6 text-blue-600\" /> : <Plus className=\"w-6 h-6 text-blue-600\" />}\r\n                                {isEditOpen ? t('users.edit.title') : t('users.create.title')}\r\n                            </DialogTitle>\r\n                            <button\r\n                                onClick={() => { setIsCreateOpen(false); setIsEditOpen(false); resetForm(); }}\r\n                                className=\"text-zinc-500 hover:text-zinc-800 transition-colors p-1 rounded-lg hover:bg-zinc-100\"\r\n                                aria-label={t('common.close') || 'Cerrar'}\r\n                            >\r\n                                <X className=\"w-5 h-5\" />\r\n                            </button>\r\n                        </div>\r\n                        <DialogDescription className=\"text-zinc-500 mt-1\">\r\n                            {isEditOpen ? t('users.edit.desc') : t('users.create.desc')}\r\n                        </DialogDescription>\r\n                    </div>\r\n\r\n                    <form onSubmit={handleSubmit} className=\"p-6 space-y-6 bg-white\">\r\n                        <div className=\"flex flex-col md:flex-row gap-6\">\r\n                            {/* Avatar Section */}\r\n                            <div className=\"flex flex-col items-center space-y-4\">\r\n                                <div\r\n                                    className=\"relative w-32 h-32 rounded-full overflow-hidden border-4 border-zinc-100 hover:border-blue-500 transition-colors cursor-pointer group bg-zinc-100\"\r\n                                    onClick={() => fileInputRef.current?.click()}\r\n                                >\r\n                                    {avatarPreview ? (\r\n                                        <img src={avatarPreview} className=\"w-full h-full object-cover\" />\r\n                                    ) : (\r\n                                        <div className=\"w-full h-full flex items-center justify-center text-zinc-400 group-hover:text-blue-500 transition-colors\">\r\n                                            <Camera className=\"w-10 h-10\" />\r\n                                        </div>\r\n                                    )}\r\n                                    <div className=\"absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity\">\r\n                                        <span className=\"text-white text-xs font-bold uppercase tracking-widest\">{t('users.form.change')}</span>\r\n                                    </div>\r\n                                </div>\r\n                                <input\r\n                                    ref={fileInputRef}\r\n                                    type=\"file\"\r\n                                    accept=\"image/*\"\r\n                                    className=\"hidden\"\r\n                                    onChange={handleFileChange}\r\n                                />\r\n                                <Button type=\"button\" variant=\"outline\" size=\"sm\" onClick={() => fileInputRef.current?.click()} className=\"rounded-full text-xs text-zinc-600 border-zinc-200 hover:bg-zinc-50\">\r\n                                    {t('users.form.photo')}\r\n                                </Button>\r\n                            </div>\r\n\r\n                            {/* Form Fields */}\r\n                            <div className=\"flex-1 space-y-4\">\r\n                                <div className=\"grid grid-cols-2 gap-4\">\r\n                                    <div className=\"space-y-2\">\r\n                                        <Label htmlFor=\"nombre\" className=\"text-zinc-700\">{t('users.form.name')}</Label>\r\n                                        <Input\r\n                                            id=\"nombre\"\r\n                                            name=\"nombre\"\r\n                                            value={formData.nombre}\r\n                                            onChange={(e) => {\r\n                                                const newName = e.target.value\r\n                                                const emailPrefix = newName.toLowerCase().trim().replace(/\\s+/g, '.')\r\n                                                setFormData({ \r\n                                                    ...formData, \r\n                                                    nombre: newName,\r\n                                                    email: isCreateOpen ? emailPrefix : formData.email\r\n                                                })\r\n                                            }}\r\n                                            required\r\n                                            className=\"bg-white border-zinc-300 text-zinc-900 rounded-xl focus:ring-blue-500 focus:border-blue-500 placeholder:text-zinc-400\"\r\n                                        />\r\n                                    </div>\r\n                                    <div className=\"space-y-2\">\r\n                                        <Label htmlFor=\"apellidos\" className=\"text-zinc-700\">{t('users.form.lastName')}</Label>\r\n                                        <Input\r\n                                            id=\"apellidos\"\r\n                                            name=\"apellidos\"\r\n                                            value={formData.apellidos}\r\n                                            onChange={(e) => setFormData({ ...formData, apellidos: e.target.value })}\r\n                                            required\r\n                                            className=\"bg-white border-zinc-300 text-zinc-900 rounded-xl focus:ring-blue-500 focus:border-blue-500 placeholder:text-zinc-400\"\r\n                                        />\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <div className=\"space-y-2\">\r\n                                    <Label htmlFor=\"email\" className=\"text-zinc-700\">{t('users.form.email')}</Label>\r\n                                    {isCreateOpen ? (\r\n                                        <div className=\"flex items-center\">\r\n                                            <Input\r\n                                                id=\"email\"\r\n                                                name=\"email\"\r\n                                                type=\"text\"\r\n                                                value={formData.email}\r\n                                                readOnly\r\n                                                required\r\n                                                placeholder={t('users.form.emailPlaceholder')}\r\n                                                className=\"bg-zinc-50 border-zinc-300 text-zinc-500 rounded-xl rounded-r-none cursor-not-allowed focus:ring-0 focus:border-zinc-300 placeholder:text-zinc-400\"\r\n                                            />\r\n                                            <div className=\"bg-zinc-100 border border-l-0 border-zinc-300 rounded-r-xl px-4 py-2 text-zinc-600 font-medium flex items-center h-11\">\r\n                                                {t('users.form.emailDomain')}\r\n                                            </div>\r\n                                        </div>\r\n                                    ) : (\r\n                                        <Input\r\n                                            id=\"email\"\r\n                                            name=\"email\"\r\n                                            type=\"email\"\r\n                                            value={formData.email}\r\n                                            onChange={(e) => setFormData({ ...formData, email: e.target.value })}\r\n                                            required\r\n                                            disabled={true}\r\n                                            className=\"bg-white border-zinc-300 text-zinc-900 rounded-xl focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50 disabled:bg-zinc-100 placeholder:text-zinc-400\"\r\n                                        />\r\n                                    )}\r\n                                </div>\r\n\r\n                                {isCreateOpen && (\r\n                                    <div className=\"space-y-2\">\r\n                                        <Label htmlFor=\"password\" className=\"text-zinc-700\">{t('users.form.password')}</Label>\r\n                                        <div className=\"relative\">\r\n                                            <Input\r\n                                                id=\"password\"\r\n                                                name=\"password\"\r\n                                                type={showPassword ? 'text' : 'password'}\r\n                                                value={formData.password}\r\n                                                onChange={(e) => setFormData({ ...formData, password: e.target.value })}\r\n                                                required\r\n                                                minLength={6}\r\n                                                className=\"bg-white border-zinc-300 text-zinc-900 rounded-xl pr-12 focus:ring-blue-500 focus:border-blue-500 placeholder:text-zinc-400\"\r\n                                            />\r\n                                            <button\r\n                                                type=\"button\"\r\n                                                onClick={() => setShowPassword(!showPassword)}\r\n                                                className=\"absolute right-3 top-1/2 -translate-y-1/2 p-1.5 hover:bg-zinc-100 rounded-lg transition-colors text-zinc-500 hover:text-zinc-700\"\r\n                                                aria-label={showPassword ? t('users.form.hidePassword') : t('users.form.showPassword')}\r\n                                            >\r\n                                                {showPassword ? <EyeOff className=\"w-5 h-5\" /> : <Eye className=\"w-5 h-5\" />}\r\n                                            </button>\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n\r\n                                {/* Secci├│n de Contacto */}\r\n                                <div className=\"pt-2 space-y-4\">\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <div className=\"h-px flex-1 bg-zinc-100\" />\r\n                                        <span className=\"text-[10px] font-black uppercase tracking-widest text-zinc-400\">{t('users.form.contact')}</span>\r\n                                        <div className=\"h-px flex-1 bg-zinc-100\" />\r\n                                    </div>\r\n                                    <div className=\"grid grid-cols-2 gap-4\">\r\n                                        <div className=\"space-y-2\">\r\n                                            <Label htmlFor=\"email_contacto\" className=\"text-zinc-700\">{t('users.form.contactEmail')}</Label>\r\n                                            <Input\r\n                                                id=\"email_contacto\"\r\n                                                name=\"email_contacto\"\r\n                                                type=\"email\"\r\n                                                value={formData.email_contacto}\r\n                                                onChange={(e) => setFormData({ ...formData, email_contacto: e.target.value })}\r\n                                                placeholder=\"email@ejemplo.com\"\r\n                                                className=\"bg-white border-zinc-300 text-zinc-900 rounded-xl focus:ring-blue-500 focus:border-blue-500 placeholder:text-zinc-400\"\r\n                                            />\r\n                                        </div>\r\n                                        <div className=\"space-y-2\">\r\n                                            <Label htmlFor=\"telefono\" className=\"text-zinc-700\">{t('users.form.phone')}</Label>\r\n                                            <Input\r\n                                                id=\"telefono\"\r\n                                                name=\"telefono\"\r\n                                                type=\"tel\"\r\n                                                value={formData.telefono}\r\n                                                onChange={(e) => setFormData({ ...formData, telefono: e.target.value })}\r\n                                                placeholder=\"+34 000 000 000\"\r\n                                                className=\"bg-white border-zinc-300 text-zinc-900 rounded-xl focus:ring-blue-500 focus:border-blue-500 placeholder:text-zinc-400\"\r\n                                            />\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <div className=\"grid grid-cols-2 gap-4 pt-2\">\r\n                                    <div className=\"space-y-2\">\r\n                                        <Label className=\"text-zinc-700\">{t('users.form.role')}</Label>\r\n                                        <div className=\"[&>button]:bg-white [&>button]:border-zinc-300 [&>button]:text-zinc-900 [&>button]:h-10 [&>button]:rounded-xl\">\r\n                                            <Select value={formData.rol} onValueChange={(val) => setFormData({ ...formData, rol: val })}>\r\n                                                <SelectTrigger className=\"h-11 rounded-xl bg-white border-zinc-300 text-zinc-900 focus:ring-blue-500 focus:border-blue-500\">\r\n                                                    <SelectValue placeholder={t('users.form.selectRole') || 'Seleccionar rol'} />\r\n                                                </SelectTrigger>\r\n                                                <SelectContent className=\"min-w-[200px]\">\r\n                                                    {availableRoles.length === 0 && (\r\n                                                        <SelectItem value={defaultRole}>{defaultRole}</SelectItem>\r\n                                                    )}\r\n                                                    {availableRoles.map((role) => (\r\n                                                        <SelectItem key={role} value={role}>{role}</SelectItem>\r\n                                                    ))}\r\n                                                </SelectContent>\r\n                                            </Select>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    <div className={`flex items-center justify-between p-3 rounded-xl border min-h-[44px] mt-[26px] overflow-hidden transition-colors ${\r\n                                        formData.pulpito \r\n                                            ? 'border-blue-500/50 bg-blue-50' \r\n                                            : 'border-zinc-200 bg-zinc-50'\r\n                                    }`}>\r\n                                        <Label className={`cursor-pointer ${formData.pulpito ? 'text-blue-700 font-semibold' : 'text-zinc-700'}`} htmlFor=\"pulpito-switch\">{t('users.form.pulpit')}</Label>\r\n                                        <Switch\r\n                                            id=\"pulpito-switch\"\r\n                                            checked={formData.pulpito}\r\n                                            onCheckedChange={(checked) => setFormData({ ...formData, pulpito: checked })}\r\n                                            className=\"pulpito-blue\"\r\n                                        />\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <DialogFooter className=\"pt-4 border-t border-zinc-100\">\r\n                            <Button variant=\"ghost\" type=\"button\" onClick={() => { setIsCreateOpen(false); setIsEditOpen(false) }} className=\"text-zinc-500 hover:text-zinc-900 hover:bg-zinc-100\">\r\n                                {t('common.cancel')}\r\n                            </Button>\r\n                            <Button type=\"submit\" disabled={isLoading} className=\"bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl px-8 shadow-lg shadow-blue-600/20\">\r\n                                {isLoading ? t('common.loading') : t('users.form.save')}\r\n                            </Button>\r\n                        </DialogFooter>\r\n                    </form>\r\n                </DialogContent>\r\n            </Dialog>\r\n\r\n            {/* Confirm Delete Modal - LIGHT THEME */}\r\n            <Dialog open={isDeleteOpen} onOpenChange={setIsDeleteOpen}>\r\n                <DialogContent className=\"max-w-md bg-white border-zinc-200 rounded-3xl shadow-2xl text-zinc-900 overflow-hidden [&>*]:no-scrollbar\">\r\n                    <DialogHeader>\r\n                        <DialogTitle className=\"text-red-600 flex items-center gap-2\">\r\n                            <AlertCircle className=\"w-5 h-5\" />\r\n                            {t('users.delete.title')}\r\n                        </DialogTitle>\r\n                        <DialogDescription className=\"text-zinc-500\">\r\n                            {t('users.delete.desc')} <strong>{selectedUser?.nombre} {selectedUser?.apellidos}</strong>.\r\n                            <br /><br />\r\n                            {t('users.delete.irreversible')}\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n                    <DialogFooter>\r\n                        <Button variant=\"ghost\" onClick={() => setIsDeleteOpen(false)} className=\"text-zinc-500 hover:text-zinc-900 hover:bg-zinc-100\">{t('common.cancel')}</Button>\r\n                        <Button variant=\"destructive\" onClick={handleDelete} disabled={isLoading} className=\"font-bold rounded-xl bg-red-600 text-white hover:bg-red-700\">\r\n                            {isLoading ? t('common.loading') : t('users.delete.confirm')}\r\n                        </Button>\r\n                    </DialogFooter>\r\n                </DialogContent>\r\n            </Dialog>\r\n\r\n            {/* Avatar Editor Modal */}\r\n            {tempImageSrc && (\r\n                <AvatarEditor\r\n                    imageSrc={tempImageSrc}\r\n                    isOpen={isCropOpen}\r\n                    onClose={() => { setIsCropOpen(false); setTempImageSrc(null) }}\r\n                    onSave={handleCropSave}\r\n                />\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\admin\\users\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":83,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":83,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2757,2760],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2757,2760],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":160,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":160,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5556,5559],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5556,5559],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":313,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":313,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11763,11766],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11763,11766],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":395,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":395,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14842,14845],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14842,14845],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":544,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":544,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21724,21727],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21724,21727],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server'\r\n\r\nimport { createClient } from '@/lib/supabase/server'\r\nimport { createClient as createAdminClient } from '@supabase/supabase-js'\r\nimport { z } from 'zod'\r\nimport { ActionResponse } from '@/types/database'\r\nimport { revalidatePath } from 'next/cache'\r\n\r\n// Funci├│n para obtener cliente ADMIN (lazy initialization)\r\nfunction getSupabaseAdmin() {\r\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\r\n    const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_SERVICE_KEY\r\n\r\n    if (!supabaseUrl || !serviceRoleKey) {\r\n        const missing = []\r\n        if (!supabaseUrl) missing.push('NEXT_PUBLIC_SUPABASE_URL')\r\n        if (!serviceRoleKey) missing.push('SUPABASE_SERVICE_ROLE_KEY')\r\n        console.error(`Missing env vars: ${missing.join(', ')}`)\r\n        throw new Error(`Supabase configuration is missing: ${missing.join(', ')}. Please check .env.local`)\r\n    }\r\n\r\n    return createAdminClient(\r\n        supabaseUrl,\r\n        serviceRoleKey,\r\n        {\r\n            auth: {\r\n                autoRefreshToken: false,\r\n                persistSession: false\r\n            }\r\n        }\r\n    )\r\n}\r\n\r\nexport interface UserData {\r\n    id: string\r\n    nombre: string\r\n    apellidos: string\r\n    email: string | null\r\n    email_contacto: string | null\r\n    telefono: string | null\r\n    rol: string\r\n    pulpito: boolean\r\n    avatar_url: string | null\r\n    created_at: string\r\n}\r\n\r\nconst VALID_DOMAIN = '@idmjisabadell.org'\r\nconst FALLBACK_ROLES = ['ADMIN', 'EDITOR', 'MIEMBRO'] as const\r\n\r\nconst createSchema = z.object({\r\n    email: z.string().email(),\r\n    password: z.string().min(6),\r\n    nombre: z.string().min(1),\r\n    apellidos: z.string().min(1),\r\n    rol: z.string().min(1),\r\n    pulpito: z.boolean().optional().default(false),\r\n    email_contacto: z.string().email().optional().or(z.literal('')),\r\n    telefono: z.string().optional().or(z.literal(''))\r\n})\r\n\r\nconst updateSchema = z.object({\r\n    id: z.string().uuid(),\r\n    nombre: z.string().min(1),\r\n    apellidos: z.string().min(1),\r\n    rol: z.string().min(1),\r\n    pulpito: z.boolean().optional().default(false),\r\n    currentAvatarUrl: z.string().optional(),\r\n    email_contacto: z.string().email().optional().or(z.literal('')),\r\n    telefono: z.string().optional().or(z.literal(''))\r\n})\r\n\r\nexport async function getRoles(): Promise<ActionResponse<string[]>> {\r\n    try {\r\n        if (!await isAdmin()) return { success: false, error: 'No autorizado' }\r\n\r\n        const { data, error } = await getSupabaseAdmin()\r\n            .from('profiles')\r\n            .select('rol', { count: 'exact', head: false })\r\n            .not('rol', 'is', null)\r\n\r\n        if (error) throw error\r\n\r\n        const distinct = Array.from(new Set((data || []).map((r: any) => r.rol).filter(Boolean)))\r\n        const roles = distinct.length > 0 ? distinct : [...FALLBACK_ROLES]\r\n\r\n        return { success: true, data: roles }\r\n    } catch (error) {\r\n        console.error('Error fetching roles:', error)\r\n        return { success: false, error: 'Error al cargar roles' }\r\n    }\r\n}\r\n\r\nasync function ensureRoleAllowed(rol: string) {\r\n    const rolesResult = await getRoles()\r\n    const allowedRoles = rolesResult.success && rolesResult.data && rolesResult.data.length > 0\r\n        ? rolesResult.data\r\n        : [...FALLBACK_ROLES]\r\n\r\n    if (!allowedRoles.includes(rol)) {\r\n        throw new Error('Rol inv├ílido')\r\n    }\r\n}\r\n\r\n// Verificar si el usuario actual es ADMIN\r\nasync function isAdmin(): Promise<boolean> {\r\n    const supabase = await createClient()\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) return false\r\n\r\n    const { data: profile } = await supabase\r\n        .from('profiles')\r\n        .select('rol')\r\n        .eq('id', user.id)\r\n        .single()\r\n\r\n    return profile?.rol === 'ADMIN'\r\n}\r\n\r\nexport async function getUsers(): Promise<ActionResponse<UserData[]>> {\r\n    try {\r\n        if (!await isAdmin()) {\r\n            return { success: false, error: 'No autorizado' }\r\n        }\r\n\r\n        const supabase = await createClient()\r\n\r\n        // Obtener perfiles existentes (incluyen email de la tabla profiles)\r\n        const { data: profiles, error: profileError } = await supabase\r\n            .from('profiles')\r\n            .select('*')\r\n            .order('created_at', { ascending: false })\r\n\r\n        if (profileError) {\r\n            console.error('Profile error:', profileError)\r\n            throw new Error(`Error al obtener perfiles: ${profileError.message}`)\r\n        }\r\n\r\n        // Mapear perfiles a UserData\r\n        const enrichedUsers: UserData[] = (profiles || []).map(profile => ({\r\n            id: profile.id,\r\n            email: profile.email || null,\r\n            email_contacto: profile.email_contacto || null,\r\n            telefono: profile.telefono || null,\r\n            nombre: profile.nombre || 'Sin nombre',\r\n            apellidos: profile.apellidos || 'Sin apellidos',\r\n            rol: profile.rol || 'MIEMBRO',\r\n            pulpito: profile.pulpito || false,\r\n            avatar_url: profile.avatar_url || null,\r\n            created_at: profile.created_at || new Date().toISOString()\r\n        }))\r\n\r\n        // Ordenar por nombre (o email si no nombre)\r\n        enrichedUsers.sort((a, b) => {\r\n            const nameA = a.nombre !== 'Sin nombre' ? a.nombre : a.email || ''\r\n            const nameB = b.nombre !== 'Sin nombre' ? b.nombre : b.email || ''\r\n            return nameA.localeCompare(nameB)\r\n        })\r\n\r\n        return { success: true, data: enrichedUsers }\r\n    } catch (error: any) {\r\n        console.error('Error fetching users:', error)\r\n        const errorMessage = error?.message || 'Error al cargar usuarios'\r\n        return { success: false, error: errorMessage }\r\n    }\r\n}\r\n\r\nexport async function createUser(formData: FormData): Promise<ActionResponse<void>> {\r\n    try {\r\n        if (!await isAdmin()) return { success: false, error: 'No autorizado' }\r\n\r\n        let email = formData.get('email') as string\r\n        if (email && !email.includes('@')) {\r\n            email = `${email}${VALID_DOMAIN}`\r\n        }\r\n        console.log('--- DEBUG CREATE USER ---')\r\n        console.log('Final email for validation:', email)\r\n\r\n        const parsed = createSchema.safeParse({\r\n            email,\r\n            password: formData.get('password'),\r\n            nombre: formData.get('nombre'),\r\n            apellidos: formData.get('apellidos'),\r\n            rol: formData.get('rol'),\r\n            pulpito: formData.get('pulpito') === 'true',\r\n            email_contacto: formData.get('email_contacto'),\r\n            telefono: formData.get('telefono')\r\n        })\r\n\r\n        if (!parsed.success) {\r\n            console.error('Validation error createUser:', parsed.error.flatten().fieldErrors)\r\n            return { success: false, error: 'Datos inv├ílidos' }\r\n        }\r\n\r\n        const { email: validatedEmail, password, nombre, apellidos, rol, pulpito, email_contacto, telefono } = parsed.data\r\n        console.log('DEBUG: Parsed data successfully', validatedEmail)\r\n\r\n        const avatarFile = formData.get('avatar') as File | null\r\n\r\n        if (!validatedEmail.endsWith(VALID_DOMAIN)) {\r\n            console.error('DEBUG: Invalid domain', validatedEmail)\r\n            return { success: false, error: `El email debe terminar en ${VALID_DOMAIN}` }\r\n        }\r\n\r\n        await ensureRoleAllowed(rol)\r\n        console.log('DEBUG: Role allowed', rol)\r\n\r\n        // Verificar si el email ya existe en profiles\r\n        const { data: existingProfile } = await getSupabaseAdmin()\r\n            .from('profiles')\r\n            .select('id, email')\r\n            .eq('email', validatedEmail)\r\n            .maybeSingle()\r\n\r\n        if (existingProfile) {\r\n            console.error('DEBUG: Profile exists', validatedEmail)\r\n            return { success: false, error: 'Este email ya est├í registrado. No se pueden duplicar emails.' }\r\n        }\r\n\r\n        // Verificar tambi├®n en auth.users usando listUsers\r\n        const { data: { users: existingUsers } } = await getSupabaseAdmin().auth.admin.listUsers()\r\n        const emailExists = existingUsers?.some(u => u.email === validatedEmail)\r\n\r\n        if (emailExists) {\r\n            console.error('DEBUG: Auth user exists', validatedEmail)\r\n            return { success: false, error: 'Este email ya est├í registrado. No se pueden duplicar emails.' }\r\n        }\r\n\r\n        console.log('DEBUG: Proceeding to create auth user...')\r\n        // Crear display_name con nombre y apellidos\r\n        const displayName = `${nombre} ${apellidos}`.trim()\r\n        const fullName = displayName // Para compatibilidad\r\n\r\n        // 1. Crear usuario en Auth\r\n        const { data: authUser, error: createError } = await getSupabaseAdmin().auth.admin.createUser({\r\n            email: validatedEmail,\r\n            password,\r\n            email_confirm: true,\r\n            user_metadata: {\r\n                nombre,\r\n                apellidos,\r\n                full_name: fullName,\r\n                display_name: displayName\r\n            }\r\n        })\r\n\r\n        if (createError) {\r\n            console.error('Supabase auth.admin.createUser error:', createError)\r\n            throw new Error(createError.message || 'No se pudo crear el usuario (Auth)')\r\n        }\r\n        if (!authUser.user) throw new Error('No se pudo crear el usuario')\r\n\r\n        const userId = authUser.user.id\r\n        console.log('DEBUG: Auth user created successfully', userId)\r\n        let avatarUrl = null\r\n\r\n        // Actualizar user_metadata para asegurar que display_name y full_name est├®n correctos\r\n        try {\r\n            await getSupabaseAdmin().auth.admin.updateUserById(userId, {\r\n                user_metadata: {\r\n                    nombre,\r\n                    apellidos,\r\n                    full_name: fullName,\r\n                    display_name: displayName\r\n                }\r\n            })\r\n            console.log('Display name actualizado correctamente:', displayName)\r\n        } catch (updateError) {\r\n            console.warn('No se pudo actualizar display_name, continuando...', updateError)\r\n        }\r\n\r\n        // 2. Subir avatar si existe\r\n        if (avatarFile && avatarFile.size > 0) {\r\n            const fileExt = avatarFile.name.split('.').pop()\r\n            const fileName = `${userId}-${Date.now()}.${fileExt}`\r\n\r\n            const { error: uploadError } = await getSupabaseAdmin().storage\r\n                .from('avatars')\r\n                .upload(fileName, avatarFile, { contentType: avatarFile.type })\r\n\r\n            if (uploadError) {\r\n                console.error('Error uploading avatar:', uploadError)\r\n            } else {\r\n                const { data: publicUrl } = getSupabaseAdmin().storage\r\n                    .from('avatars')\r\n                    .getPublicUrl(fileName)\r\n                avatarUrl = publicUrl.publicUrl\r\n            }\r\n        }\r\n\r\n        // 3. Insertar/actualizar perfil (garantizar existencia)\r\n        const { error: profileError } = await getSupabaseAdmin()\r\n            .from('profiles')\r\n            .upsert({\r\n                id: userId,\r\n                email: validatedEmail,\r\n                nombre,\r\n                apellidos,\r\n                rol,\r\n                pulpito,\r\n                avatar_url: avatarUrl,\r\n                email_contacto: email_contacto || null,\r\n                telefono: telefono || null\r\n            }, { onConflict: 'id' })\r\n\r\n        if (profileError) {\r\n            console.error('Supabase upsert profile error:', profileError)\r\n            throw new Error(profileError.message || 'Error al guardar perfil')\r\n        }\r\n\r\n        revalidatePath('/dashboard/admin/users')\r\n        revalidatePath('/dashboard/hermanos')\r\n        return { success: true }\r\n    } catch (error: any) {\r\n        console.error('Error creating user:', error)\r\n        return { success: false, error: error.message || 'Error al crear usuario' }\r\n    }\r\n}\r\n\r\nexport async function updateUserFull(formData: FormData): Promise<ActionResponse<void>> {\r\n    try {\r\n        if (!await isAdmin()) return { success: false, error: 'No autorizado' }\r\n\r\n        const parsed = updateSchema.safeParse({\r\n            id: formData.get('id'),\r\n            nombre: formData.get('nombre'),\r\n            apellidos: formData.get('apellidos'),\r\n            rol: formData.get('rol'),\r\n            pulpito: formData.get('pulpito') === 'true',\r\n            currentAvatarUrl: formData.get('currentAvatarUrl') as string | undefined,\r\n            email_contacto: formData.get('email_contacto'),\r\n            telefono: formData.get('telefono')\r\n        })\r\n\r\n        if (!parsed.success) {\r\n            return { success: false, error: 'Datos inv├ílidos' }\r\n        }\r\n\r\n        const { id: userId, nombre, apellidos, rol, pulpito, currentAvatarUrl, email_contacto, telefono } = parsed.data\r\n        const avatarFile = formData.get('avatar') as File | null\r\n\r\n        await ensureRoleAllowed(rol)\r\n\r\n        let newAvatarUrl = currentAvatarUrl\r\n\r\n        // Gestionar Avatar\r\n        if (avatarFile && avatarFile.size > 0) {\r\n            // 1. Borrar anterior si existe\r\n            if (currentAvatarUrl) {\r\n                const parts = currentAvatarUrl.split('/')\r\n                const fileName = parts[parts.length - 1]\r\n                await getSupabaseAdmin().storage.from('avatars').remove([fileName])\r\n            }\r\n\r\n            // 2. Subir nuevo\r\n            const fileExt = avatarFile.name.split('.').pop()\r\n            const fileName = `${userId}-${Date.now()}.${fileExt}`\r\n\r\n            const { error: uploadError } = await getSupabaseAdmin().storage\r\n                .from('avatars')\r\n                .upload(fileName, avatarFile, { contentType: avatarFile.type, upsert: true })\r\n\r\n            if (uploadError) throw uploadError\r\n\r\n            const { data: publicUrl } = getSupabaseAdmin().storage\r\n                .from('avatars')\r\n                .getPublicUrl(fileName)\r\n\r\n            newAvatarUrl = publicUrl.publicUrl\r\n        }\r\n\r\n        // Actualizar tabla Profiles\r\n        const { error: updateError } = await getSupabaseAdmin()\r\n            .from('profiles')\r\n            .update({\r\n                nombre,\r\n                apellidos,\r\n                rol,\r\n                pulpito,\r\n                avatar_url: newAvatarUrl,\r\n                email_contacto: email_contacto || null,\r\n                telefono: telefono || null\r\n            })\r\n            .eq('id', userId)\r\n\r\n        if (updateError) throw updateError\r\n\r\n        // Actualizar metadatos de usuario (opcional pero recomendado)\r\n        await getSupabaseAdmin().auth.admin.updateUserById(userId, {\r\n            user_metadata: { nombre, apellidos }\r\n        })\r\n\r\n        revalidatePath('/dashboard/admin/users')\r\n        revalidatePath('/dashboard/hermanos')\r\n        return { success: true }\r\n    } catch (error: any) {\r\n        console.error('Error updating user:', error)\r\n        return { success: false, error: error.message || 'Error al actualizar usuario' }\r\n    }\r\n}\r\n\r\nexport async function deleteUser(userId: string): Promise<ActionResponse<void>> {\r\n    try {\r\n        console.log('deleteUser started for ID:', userId)\r\n        if (!await isAdmin()) {\r\n            console.error('User is not admin')\r\n            return { success: false, error: 'No autorizado' }\r\n        }\r\n\r\n        const supabaseAdmin = getSupabaseAdmin()\r\n        if (!supabaseAdmin) {\r\n            console.error('Supabase admin client not initialized')\r\n            return { success: false, error: 'Error interno: cliente Supabase no inicializado' }\r\n        }\r\n\r\n        // 1. Obtener info de avatar ANTES de eliminar cualquier cosa\r\n        let avatarUrl: string | null = null\r\n        try {\r\n            const { data: profile, error: profileFetchError } = await supabaseAdmin\r\n                .from('profiles')\r\n                .select('avatar_url')\r\n                .eq('id', userId)\r\n                .single()\r\n\r\n            if (profileFetchError && profileFetchError.code !== 'PGRST116') {\r\n                console.warn('Error fetching profile for avatar cleanup (continuing anyway):', profileFetchError.message)\r\n            } else if (profile?.avatar_url) {\r\n                avatarUrl = profile.avatar_url\r\n            }\r\n        } catch (err) {\r\n            console.warn('Failed to fetch profile for avatar cleanup (continuing anyway):', err)\r\n        }\r\n\r\n        // 2. Eliminar avatar de storage ANTES de eliminar el usuario/perfil\r\n        if (avatarUrl) {\r\n            try {\r\n                const parts = avatarUrl.split('/')\r\n                const fileName = parts[parts.length - 1]\r\n                const { error: storageError } = await supabaseAdmin.storage.from('avatars').remove([fileName])\r\n\r\n                if (storageError) {\r\n                    console.warn('Failed to delete avatar from storage (non-critical):', storageError.message)\r\n                } else {\r\n                    console.log('Avatar deleted successfully for user:', userId)\r\n                }\r\n            } catch (err) {\r\n                console.warn('Exception deleting avatar (non-critical):', err)\r\n            }\r\n        }\r\n\r\n        // 3. Eliminar usuario de Auth PRIMERO (el perfil se eliminar├í autom├íticamente por CASCADE)\r\n        console.log('Deleting auth user first for:', userId)\r\n        const { error: authError } = await supabaseAdmin.auth.admin.deleteUser(userId)\r\n\r\n        if (authError) {\r\n            console.error('Supabase auth.admin.deleteUser error:', authError)\r\n\r\n            // Si el error indica que el usuario no existe, verificar si el perfil tambi├®n se elimin├│\r\n            if (authError.message?.includes('not found') || authError.message?.includes('does not exist')) {\r\n                const { data: remainingProfile } = await supabaseAdmin\r\n                    .from('profiles')\r\n                    .select('id')\r\n                    .eq('id', userId)\r\n                    .single()\r\n\r\n                if (!remainingProfile) {\r\n                    console.log('User and profile already deleted')\r\n                    revalidatePath('/dashboard/admin/users')\r\n                    revalidatePath('/dashboard/hermanos')\r\n                    return { success: true }\r\n                }\r\n            }\r\n\r\n            // Si hay un error de base de datos, puede ser por claves for├íneas\r\n            // Intentar eliminar el perfil manualmente primero y luego Auth\r\n            if (authError.message?.includes('Database error')) {\r\n                console.log('Database error detected, trying to delete profile first, then auth')\r\n\r\n                const { error: profileDeleteError } = await supabaseAdmin\r\n                    .from('profiles')\r\n                    .delete()\r\n                    .eq('id', userId)\r\n\r\n                if (profileDeleteError && profileDeleteError.code !== 'PGRST116') {\r\n                    console.error('Error deleting profile:', profileDeleteError)\r\n                } else {\r\n                    console.log('Profile deleted manually, retrying auth delete')\r\n                }\r\n\r\n                // Reintentar eliminar de Auth despu├®s de eliminar el perfil\r\n                const { error: retryAuthError } = await supabaseAdmin.auth.admin.deleteUser(userId)\r\n\r\n                if (retryAuthError) {\r\n                    // Verificar si el perfil se elimin├│ al menos\r\n                    const { data: remainingProfile } = await supabaseAdmin\r\n                        .from('profiles')\r\n                        .select('id')\r\n                        .eq('id', userId)\r\n                        .single()\r\n\r\n                    if (!remainingProfile) {\r\n                        console.warn('Profile deleted but auth user deletion failed:', retryAuthError.message)\r\n                        // Considerar ├®xito parcial - el perfil se elimin├│\r\n                        revalidatePath('/dashboard/admin/users')\r\n                        revalidatePath('/dashboard/hermanos')\r\n                        return { success: true, error: `Perfil eliminado pero error al eliminar de Auth: ${retryAuthError.message}` }\r\n                    }\r\n\r\n                    throw new Error(`Error al eliminar usuario de Auth: ${retryAuthError.message}`)\r\n                } else {\r\n                    console.log('Auth user deleted successfully on retry')\r\n                }\r\n            } else {\r\n                // Otro tipo de error\r\n                throw new Error(`Error al eliminar usuario de Auth: ${authError.message}`)\r\n            }\r\n        }\r\n\r\n        // 4. Verificar que el perfil se elimin├│ autom├íticamente (deber├¡a por CASCADE)\r\n        console.log('Verifying profile was deleted by CASCADE')\r\n        const { data: remainingProfile } = await supabaseAdmin\r\n            .from('profiles')\r\n            .select('id')\r\n            .eq('id', userId)\r\n            .single()\r\n\r\n        if (remainingProfile) {\r\n            // Si el perfil a├║n existe, eliminarlo manualmente\r\n            console.log('Profile still exists, deleting manually')\r\n            const { error: profileDeleteError } = await supabaseAdmin\r\n                .from('profiles')\r\n                .delete()\r\n                .eq('id', userId)\r\n\r\n            if (profileDeleteError && profileDeleteError.code !== 'PGRST116') {\r\n                console.error('Error deleting remaining profile:', profileDeleteError)\r\n                throw new Error(`Usuario eliminado de Auth pero error al eliminar perfil: ${profileDeleteError.message}`)\r\n            }\r\n        }\r\n\r\n        console.log('User deleted successfully from both Auth and Profiles:', userId)\r\n        revalidatePath('/dashboard/admin/users')\r\n        revalidatePath('/dashboard/hermanos')\r\n        return { success: true }\r\n    } catch (error: any) {\r\n        console.error('Error in deleteUser action:', error)\r\n        const errorMessage = error?.message || 'Error desconocido al eliminar usuario'\r\n        return { success: false, error: errorMessage }\r\n    }\r\n}\r\n\r\nexport async function getUserCounts(): Promise<ActionResponse<{ total: number, pulpito: number, admins: number }>> {\r\n    try {\r\n        if (!await isAdmin()) return { success: false, error: 'No autorizado' }\r\n\r\n        const { count: total } = await getSupabaseAdmin().from('profiles').select('*', { count: 'exact', head: true })\r\n        const { count: pulpito } = await getSupabaseAdmin().from('profiles').select('*', { count: 'exact', head: true }).eq('pulpito', true)\r\n        const { count: admins } = await getSupabaseAdmin().from('profiles').select('*', { count: 'exact', head: true }).eq('rol', 'ADMIN')\r\n\r\n        return {\r\n            success: true,\r\n            data: {\r\n                total: total || 0,\r\n                pulpito: pulpito || 0,\r\n                admins: admins || 0\r\n            }\r\n        }\r\n    } catch (error) {\r\n        console.error('Error getting counts:', error)\r\n        return { success: false, error: 'Error al obtener conteos' }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\admin\\users\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\cultos\\CultosPageClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ChevronLeft' is defined but never used.","line":30,"column":63,"nodeType":null,"messageId":"unusedVar","endLine":30,"endColumn":74},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'toast' is defined but never used.","line":32,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":32,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'theme' is assigned a value but never used.","line":43,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":43,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":43,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1631,1634],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1631,1634],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'currentYear' is assigned a value but never used.","line":52,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":52,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'currentMonth' is assigned a value but never used.","line":53,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":53,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setShowSuccess' is assigned a value but never used.","line":56,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":56,"endColumn":39}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadHermanos' and 'selectedHermanos'. Either include them or remove the dependency array. You can also replace multiple useState variables with useReducer if 'setTempSelectedHermanos' needs the current value of 'selectedHermanos'.","line":92,"column":8,"nodeType":"ArrayExpression","endLine":92,"endColumn":27,"suggestions":[{"desc":"Update the dependencies array to be: [loadHermanos, selectedHermanos, showHermanosModal]","fix":{"range":[3685,3704],"text":"[loadHermanos, selectedHermanos, showHermanosModal]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadHermanos'. Either include it or remove the dependency array.","line":103,"column":8,"nodeType":"ArrayExpression","endLine":103,"endColumn":43,"suggestions":[{"desc":"Update the dependencies array to be: [hermanosSearch, loadHermanos, showHermanosModal]","fix":{"range":[4021,4056],"text":"[hermanosSearch, loadHermanos, showHermanosModal]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":1,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * CultosPageClient - IDMJI Gestor de P├║lpito\n * \n * Componente cliente para la gesti├│n del calendario mensual de cultos.\n * Permite visualizar los cultos programados, su estado y automatizar la \n * generaci├│n mensual basada en la configuraci├│n semanal.\n * \n * Caracter├¡sticas:\n * - Calendario interactivo con estados (Completos/Pendientes)\n * - Generaci├│n automatizada de cultos por mes\n * - Estad├¡sticas r├ípidas del mes seleccionado\n * - Feedback visual premium ante operaciones exitosas\n * - Soporte multiidioma (ES/CA)\n * - Dise├▒o responsivo con scrollbar invisible\n * \n * @author Antigravity AI\n * @date 2024-12-25\n */\n\n'use client'\n\nimport { useState, useEffect } from 'react'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport Calendar from '@/components/Calendar'\nimport { getCultosForMonth } from './actions'\nimport { getHermanos } from '../hermanos/actions'\nimport { Button } from '@/components/ui/Button'\nimport { Modal } from '@/components/ui/Modal'\nimport { Input } from '@/components/ui/Input'\nimport { Check, Calendar as CalendarIcon, CheckCircle, Clock, ChevronLeft, Sparkles, LayoutDashboard, AlertCircle, Users, Search, X } from 'lucide-react'\nimport { getCultoStatus } from '@/lib/utils/culto-helpers'\nimport { toast } from 'sonner'\nimport { useI18n } from '@/lib/i18n/I18nProvider'\nimport Link from 'next/link'\nimport { Culto } from '@/types/database'\nimport type { HermanoData } from '../hermanos/actions'\n\ninterface CultosPageClientProps {\n    initialCultos: Culto[]\n}\n\nexport default function CultosPageClient({ initialCultos }: CultosPageClientProps) {\n    const { t, theme } = useI18n() as any\n    const [isDark, setIsDark] = useState(false)\n\n    useEffect(() => {\n        setIsDark(document.documentElement.classList.contains('dark'))\n    }, [])\n\n    const [cultos, setCultos] = useState(initialCultos)\n\n    const [currentYear, setCurrentYear] = useState(new Date().getFullYear())\n    const [currentMonth, setCurrentMonth] = useState(new Date().getMonth())\n    const [view, setView] = useState<'month' | 'week' | 'day'>('month')\n    const [selectedDate, setSelectedDate] = useState(new Date())\n    const [showSuccess, setShowSuccess] = useState(false)\n    const [statusFilter, setStatusFilter] = useState<'all' | 'complete' | 'pending'>('all')\n    const [typeFilter, setTypeFilter] = useState<'all' | 'estudio' | 'alabanza' | 'ensenanza'>('all')\n    const [showFestivosOnly, setShowFestivosOnly] = useState(false)\n    const [selectedHermanos, setSelectedHermanos] = useState<string[]>([])\n    const [showHermanosModal, setShowHermanosModal] = useState(false)\n    const [hermanos, setHermanos] = useState<HermanoData[]>([])\n    const [hermanosSearch, setHermanosSearch] = useState('')\n\n\n\n    const handleMonthChange = async (year: number, month: number) => {\n        setCurrentYear(year)\n        setCurrentMonth(month)\n        setSelectedDate(new Date(year, month, 1))\n        const { data } = await getCultosForMonth(year, month)\n        setCultos(data || [])\n    }\n\n    const loadHermanos = async () => {\n        const result = await getHermanos(hermanosSearch || undefined)\n        if (result.success && result.data) {\n            setHermanos(result.data)\n        }\n    }\n\n    // Estado temporal para el modal (Draft State)\n    const [tempSelectedHermanos, setTempSelectedHermanos] = useState<string[]>([])\n\n    // Cargar hermanos y sincronizar estado temporal cuando se abre el modal\n    useEffect(() => {\n        if (showHermanosModal) {\n            setTempSelectedHermanos(selectedHermanos) // Inicializar con la selecci├│n actual\n            loadHermanos()\n        }\n        // eslint-disable-next-line react-hooks/exhaustive-deps\n    }, [showHermanosModal])\n\n    // B├║squeda con debounce\n    useEffect(() => {\n        if (showHermanosModal) {\n            const timeoutId = setTimeout(() => {\n                loadHermanos()\n            }, 300)\n            return () => clearTimeout(timeoutId)\n        }\n        // eslint-disable-next-line react-hooks/exhaustive-deps\n    }, [hermanosSearch, showHermanosModal])\n\n    const toggleHermano = (hermanoId: string) => {\n        console.log('Toggling hermano:', hermanoId)\n        setTempSelectedHermanos(prev =>\n            prev.includes(hermanoId)\n                ? prev.filter(id => id !== hermanoId)\n                : [...prev, hermanoId]\n        )\n    }\n\n    const applyHermanosFilter = () => {\n        console.log('Applying filter with:', tempSelectedHermanos)\n        setSelectedHermanos(tempSelectedHermanos)\n        setShowHermanosModal(false)\n    }\n\n    const getHermanoName = (hermanoId: string) => {\n        // Buscar en la lista actual o intentar mantener el nombre si ya no est├í en la lista (TODO: Idealmente tener un map cache)\n        const hermano = hermanos.find(h => h.id === hermanoId)\n        return hermano ? `${hermano.nombre || ''} ${hermano.apellidos || ''}`.trim() : 'Filtro Activo'\n    }\n\n    const totalCultos = cultos.length\n    const completeCultos = cultos.filter(c => getCultoStatus(c) === 'complete').length\n    const pendingCultos = cultos.filter(c => getCultoStatus(c) === 'pending').length\n\n    const filteredCultos = cultos.filter(c => {\n        // Filtro de Festivos\n        if (showFestivosOnly && !c.es_laborable_festivo) return false\n\n        // Filtro de Estado\n        if (statusFilter !== 'all') {\n            const status = getCultoStatus(c)\n            if (status !== statusFilter) return false\n        }\n\n        // Filtro de Tipo\n        if (typeFilter !== 'all') {\n            const nombre = c.tipo_culto?.nombre?.toLowerCase() || ''\n            if (typeFilter === 'estudio' && !nombre.includes('estudio')) return false\n            if (typeFilter === 'alabanza' && !nombre.includes('alabanza')) return false\n            if (typeFilter === 'ensenanza' && !nombre.includes('enfermedad') && !nombre.includes('ense├▒anza')) return false\n        }\n\n        // Filtro por Hermanos\n        if (selectedHermanos.length > 0) {\n            const hasSelectedHermano =\n                (c.id_usuario_intro && selectedHermanos.includes(c.id_usuario_intro)) ||\n                (c.id_usuario_ensenanza && selectedHermanos.includes(c.id_usuario_ensenanza)) ||\n                (c.id_usuario_finalizacion && selectedHermanos.includes(c.id_usuario_finalizacion)) ||\n                (c.id_usuario_testimonios && selectedHermanos.includes(c.id_usuario_testimonios))\n\n            if (!hasSelectedHermano) return false\n        }\n\n        return true\n    })\n\n    return (\n        <div className=\"max-w-7xl mx-auto space-y-10 pb-20 px-4 md:px-8 relative no-scrollbar\">\n            {/* Animaci├│n de ├ëxito Premium */}\n            <AnimatePresence>\n                {showSuccess && (\n                    <motion.div\n                        initial={{ opacity: 0 }}\n                        animate={{ opacity: 1 }}\n                        exit={{ opacity: 0 }}\n                        className=\"fixed inset-0 z-[1000] flex items-center justify-center bg-background/60 backdrop-blur-2xl pointer-events-none\"\n                    >\n                        <motion.div\n                            initial={{ scale: 0.5, rotate: -15, y: 50 }}\n                            animate={{ scale: 1, rotate: 0, y: 0 }}\n                            exit={{ scale: 1.5, opacity: 0 }}\n                            transition={{ type: 'spring', stiffness: 300, damping: 20 }}\n                            className=\"glass rounded-[3rem] p-16 shadow-[0_50px_100px_rgba(0,0,0,0.2)] flex flex-col items-center gap-8 border-2 border-primary/20 bg-white/80 dark:bg-black/80\"\n                        >\n                            <div className=\"relative\">\n                                <motion.div\n                                    animate={{ scale: [1, 1.2, 1], rotate: [0, 10, -10, 0] }}\n                                    transition={{ repeat: Infinity, duration: 2.5 }}\n                                    className=\"w-28 h-28 rounded-3xl bg-linear-to-br from-primary via-blue-600 to-accent flex items-center justify-center shadow-2xl shadow-primary/30\"\n                                >\n                                    <Check className=\"w-14 h-14 text-white\" strokeWidth={5} />\n                                </motion.div>\n                                <Sparkles className=\"absolute -top-6 -right-6 w-12 h-12 text-yellow-400 animate-pulse\" />\n                                <Sparkles className=\"absolute -bottom-4 -left-6 w-8 h-8 text-blue-400 animate-bounce delay-100\" />\n                            </div>\n                            <div className=\"text-center\">\n                                <h2 className=\"text-4xl font-black uppercase tracking-tighter mb-2\">\n                                    {t('calendar.success')}\n                                </h2>\n                                <p className=\"text-muted-foreground font-bold tracking-widest uppercase text-xs opacity-70\">\n                                    {t('calendar.total')}: {totalCultos}\n                                </p>\n                            </div>\n                        </motion.div>\n                    </motion.div>\n                )}\n            </AnimatePresence>\n\n            {/* Header / Breadcrumb */}\n            <div className=\"space-y-6\">\n                <motion.div\n                    initial={{ opacity: 0, x: -20 }}\n                    animate={{ opacity: 1, x: 0 }}\n                >\n                    <Link\n                        href=\"/dashboard\"\n                        className=\"inline-flex items-center gap-2.5 px-4 py-2 rounded-xl bg-muted/50 text-xs text-muted-foreground hover:text-primary hover:bg-primary/5 transition-all font-black uppercase tracking-widest group border border-border/50\"\n                    >\n                        <LayoutDashboard className=\"w-4 h-4 group-hover:-translate-x-1 transition-transform\" />\n                        {t('nav.dashboard')}\n                    </Link>\n                </motion.div>\n\n                <div className=\"flex flex-col lg:flex-row lg:items-end justify-between gap-8\">\n                    <div className=\"space-y-2\">\n                        <motion.h1\n                            initial={{ opacity: 0, y: 20 }}\n                            animate={{ opacity: 1, y: 0 }}\n                            className={`text-5xl md:text-6xl font-black tracking-tighter ${isDark ? 'text-white' : 'text-[#063b7a]'}`}\n                        >\n                            {t('calendar.title')}\n                        </motion.h1>\n                        <div className=\"text-muted-foreground font-bold tracking-wide flex items-center gap-2.5 uppercase text-xs opacity-80\">\n                            <div className=\"w-2 h-2 rounded-full bg-primary animate-pulse\" />\n                            {t('dashboard.calendarDesc')}\n                        </div>\n                    </div>\n\n\n                </div>\n            </div>\n\n            {/* Contenedor Principal: Calendario */}\n            <motion.div\n                initial={{ opacity: 0, y: 30 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: 0.2 }}\n                className=\"relative group\"\n            >\n                <div className=\"absolute -inset-4 bg-linear-to-r from-primary/10 via-accent/10 to-primary/10 rounded-[3rem] blur-3xl opacity-30 group-hover:opacity-60 transition duration-1000\" />\n                <div className=\"relative glass rounded-[3rem] p-4 md:p-8 overflow-hidden border border-white/20 dark:border-white/5 shadow-[0_30px_60px_rgba(0,0,0,0.12)]\">\n\n                    {/* Panel de Filtros Premium - Dise├▒o Compacto */}\n                    <div className=\"flex flex-col gap-4 mb-6\">\n                        {/* Fila 1: Vista y Estado */}\n                        <div className=\"flex flex-wrap items-center gap-3\">\n                            {/* Etiqueta Vista */}\n                            <span className=\"text-[9px] font-black uppercase tracking-widest text-muted-foreground/60 hidden sm:inline\">Vista:</span>\n\n                            {/* Selector de Vista - Compacto */}\n                            <div className=\"flex bg-muted/40 p-1 rounded-xl border border-border/30 shadow-sm\">\n                                <button\n                                    onClick={() => setView('month')}\n                                    className={`px-4 py-2 rounded-lg text-[9px] font-black uppercase tracking-wider transition-all ${view === 'month'\n                                        ? 'bg-blue-600 text-white shadow-md'\n                                        : 'text-muted-foreground hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600'\n                                        }`}\n                                >\n                                    Mes\n                                </button>\n                                <button\n                                    onClick={() => setView('week')}\n                                    className={`px-4 py-2 rounded-lg text-[9px] font-black uppercase tracking-wider transition-all ${view === 'week'\n                                        ? 'bg-blue-600 text-white shadow-md'\n                                        : 'text-muted-foreground hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600'\n                                        }`}\n                                >\n                                    Semana\n                                </button>\n                                <button\n                                    onClick={() => setView('day')}\n                                    className={`px-4 py-2 rounded-lg text-[9px] font-black uppercase tracking-wider transition-all ${view === 'day'\n                                        ? 'bg-blue-600 text-white shadow-md'\n                                        : 'text-muted-foreground hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600'\n                                        }`}\n                                >\n                                    D├¡a\n                                </button>\n                            </div>\n\n                            <div className=\"hidden sm:block w-px h-6 bg-border/50\" />\n\n                            {/* Etiqueta Estado */}\n                            <span className=\"text-[9px] font-black uppercase tracking-widest text-muted-foreground/60 hidden sm:inline\">Estado:</span>\n\n                            {/* Selector de Estado - Compacto */}\n                            <div className=\"flex bg-muted/40 p-1 rounded-xl border border-border/30 shadow-sm\">\n                                <button\n                                    onClick={() => setStatusFilter('all')}\n                                    className={`px-3 py-2 rounded-lg text-[9px] font-black uppercase tracking-wider transition-all ${statusFilter === 'all'\n                                        ? 'bg-slate-600 text-white shadow-md'\n                                        : 'text-muted-foreground hover:bg-slate-50 dark:hover:bg-slate-900/20 hover:text-slate-600'\n                                        }`}\n                                >\n                                    Todos\n                                </button>\n                                <button\n                                    onClick={() => setStatusFilter('complete')}\n                                    className={`px-3 py-2 rounded-lg text-[9px] font-black uppercase tracking-wider transition-all flex items-center gap-1 ${statusFilter === 'complete'\n                                        ? 'bg-emerald-600 text-white shadow-md'\n                                        : 'text-muted-foreground hover:bg-emerald-50 dark:hover:bg-emerald-900/20 hover:text-emerald-600'\n                                        }`}\n                                >\n                                    <CheckCircle className=\"w-3 h-3\" />\n                                    <span className=\"hidden md:inline\">Completos</span>\n                                </button>\n                                <button\n                                    onClick={() => setStatusFilter('pending')}\n                                    className={`px-3 py-2 rounded-lg text-[9px] font-black uppercase tracking-wider transition-all flex items-center gap-1 ${statusFilter === 'pending'\n                                        ? 'bg-amber-600 text-white shadow-md'\n                                        : 'text-muted-foreground hover:bg-amber-50 dark:hover:bg-amber-900/20 hover:text-amber-600'\n                                        }`}\n                                >\n                                    <Clock className=\"w-3 h-3\" />\n                                    <span className=\"hidden md:inline\">Pendientes</span>\n                                </button>\n                            </div>\n                        </div>\n\n                        {/* Fila 2: Tipo, Festivos y Hermanos */}\n                        <div className=\"flex flex-wrap items-center gap-3\">\n                            {/* Etiqueta Tipo */}\n                            <span className=\"text-[9px] font-black uppercase tracking-widest text-muted-foreground/60 hidden sm:inline\">Tipo:</span>\n\n                            {/* Selector de Tipo - Compacto */}\n                            <div className=\"flex bg-muted/40 p-1 rounded-xl border border-border/30 shadow-sm\">\n                                <button\n                                    onClick={() => setTypeFilter('all')}\n                                    className={`px-3 py-2 rounded-lg text-[9px] font-black uppercase tracking-wider transition-all ${typeFilter === 'all'\n                                        ? 'bg-indigo-600 text-white shadow-md'\n                                        : 'text-muted-foreground hover:bg-indigo-50 dark:hover:bg-indigo-900/20 hover:text-indigo-600'\n                                        }`}\n                                >\n                                    Todos\n                                </button>\n                                <button\n                                    onClick={() => setTypeFilter('estudio')}\n                                    className={`px-3 py-2 rounded-lg text-[9px] font-black uppercase tracking-wider transition-all ${typeFilter === 'estudio'\n                                        ? 'bg-emerald-600 text-white shadow-md'\n                                        : 'text-muted-foreground hover:bg-emerald-50 dark:hover:bg-emerald-900/20 hover:text-emerald-600'\n                                        }`}\n                                >\n                                    Estudio\n                                </button>\n                                <button\n                                    onClick={() => setTypeFilter('alabanza')}\n                                    className={`px-3 py-2 rounded-lg text-[9px] font-black uppercase tracking-wider transition-all ${typeFilter === 'alabanza'\n                                        ? 'bg-blue-600 text-white shadow-md'\n                                        : 'text-muted-foreground hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600'\n                                        }`}\n                                >\n                                    Alabanza\n                                </button>\n                                <button\n                                    onClick={() => setTypeFilter('ensenanza')}\n                                    className={`px-3 py-2 rounded-lg text-[9px] font-black uppercase tracking-wider transition-all ${typeFilter === 'ensenanza'\n                                        ? 'bg-purple-600 text-white shadow-md'\n                                        : 'text-muted-foreground hover:bg-purple-50 dark:hover:bg-purple-900/20 hover:text-purple-600'\n                                        }`}\n                                >\n                                    Ense├▒anza\n                                </button>\n                            </div>\n\n                            <div className=\"hidden sm:block w-px h-6 bg-border/50\" />\n\n                            {/* Bot├│n Festivos */}\n                            <button\n                                onClick={() => setShowFestivosOnly(!showFestivosOnly)}\n                                className={`px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-wider transition-all flex items-center gap-2 border ${showFestivosOnly\n                                    ? 'bg-amber-500 text-white shadow-lg shadow-amber-500/20 border-amber-600'\n                                    : 'bg-muted/40 text-muted-foreground hover:bg-amber-50 dark:hover:bg-amber-900/20 hover:text-amber-600 border-border/30'\n                                    }`}\n                            >\n                                <AlertCircle className={`w-3.5 h-3.5 ${showFestivosOnly ? 'text-white' : 'text-amber-500'}`} />\n                                Festivos\n                            </button>\n\n                            {/* Bot├│n Hermanos */}\n                            <button\n                                onClick={() => setShowHermanosModal(true)}\n                                className={`px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-wider transition-all flex items-center gap-2 border ${selectedHermanos.length > 0\n                                    ? 'bg-purple-600 text-white shadow-lg shadow-purple-500/20 border-purple-700'\n                                    : 'bg-muted/40 text-muted-foreground hover:bg-purple-50 dark:hover:bg-purple-900/20 hover:text-purple-600 border-border/30'\n                                    }`}\n                            >\n                                <Users className={`w-3.5 h-3.5 ${selectedHermanos.length > 0 ? 'text-white' : 'text-purple-500'}`} />\n                                Hermanos\n                                {selectedHermanos.length > 0 && (\n                                    <span className=\"px-1.5 py-0.5 bg-white/20 rounded-full text-[8px]\">\n                                        {selectedHermanos.length}\n                                    </span>\n                                )}\n                            </button>\n                        </div>\n                    </div>\n\n                    <Calendar\n                        events={filteredCultos}\n                        onMonthChange={handleMonthChange}\n                        view={view}\n                        selectedDate={selectedDate}\n                        onDateSelect={setSelectedDate}\n                    />\n\n                    {/* Mostrar mensaje si no hay resultados PERO solo si hay filtros activos, para no romper la navegaci├│n en meses vac├¡os */}\n                    {cultos.length > 0 && filteredCultos.length === 0 && (\n                        <div className=\"flex flex-col items-center justify-center py-10 text-center space-y-4\">\n                            <p className=\"text-sm text-muted-foreground font-medium\">\n                                No se encontraron eventos con los filtros actuales.\n                            </p>\n                            <Button\n                                variant=\"outline\"\n                                size=\"sm\"\n                                onClick={() => {\n                                    setStatusFilter('all')\n                                    setTypeFilter('all')\n                                    setShowFestivosOnly(false)\n                                    setSelectedHermanos([])\n                                }}\n                            >\n                                Limpiar Filtros\n                            </Button>\n                        </div>\n                    )}\n                </div>\n            </motion.div>\n\n            {/* Grid de Estad├¡sticas con Dise├▒o Premium */}\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6 lg:gap-8\">\n                {\n                    [\n                        { label: t('calendar.total'), value: totalCultos, icon: CalendarIcon, color: 'text-primary', bg: 'bg-primary/10', border: 'border-primary/20' },\n                        { label: t('calendar.complete'), value: completeCultos, icon: CheckCircle, color: 'text-emerald-500', bg: 'bg-emerald-500/10', border: 'border-emerald-500/20' },\n                        { label: t('calendar.pending'), value: pendingCultos, icon: Clock, color: 'text-amber-500', bg: 'bg-amber-500/10', border: 'border-amber-500/20' }\n                    ].map((stat, idx) => (\n                        <motion.div\n                            key={idx}\n                            initial={{ opacity: 0, y: 20 }}\n                            animate={{ opacity: 1, y: 0 }}\n                            transition={{ delay: 0.3 + idx * 0.1 }}\n                            className={`glass rounded-[2rem] p-8 border ${stat.border} group hover:scale-[1.02] transition-all shadow-xl relative overflow-hidden`}\n                        >\n                            <div className={`absolute top-0 right-0 w-32 h-32 ${stat.bg} rounded-full blur-3xl -mr-16 -mt-16 group-hover:scale-150 transition-transform duration-700`} />\n\n                            <div className=\"flex items-center gap-6 relative z-10\">\n                                <div className={`p-5 ${stat.bg} rounded-2xl group-hover:scale-110 group-hover:rotate-6 transition-all shadow-inner border border-white/10`}>\n                                    <stat.icon className={`w-8 h-8 ${stat.color}`} />\n                                </div>\n                                <div className=\"min-w-0\">\n                                    <p className=\"text-[10px] font-black uppercase tracking-[0.3em] text-muted-foreground/60 mb-1 leading-none\">\n                                        {stat.label}\n                                    </p>\n                                    <p className={`text-5xl font-black tracking-tighter ${stat.color} leading-none`}>\n                                        {stat.value}\n                                    </p>\n                                </div>\n                            </div>\n                        </motion.div>\n                    ))\n                }\n            </div>\n\n\n\n            {/* Modal de Selecci├│n de Hermanos */}\n            <Modal\n                isOpen={showHermanosModal}\n                onClose={() => setShowHermanosModal(false)}\n                title=\"Filtrar por Hermanos\"\n                size=\"lg\"\n            >\n                <div className=\"space-y-6 pt-6\">\n                    {/* B├║squeda */}\n                    <Input\n                        icon={<Search className=\"w-4 h-4\" />}\n                        placeholder=\"Buscar hermanos...\"\n                        value={hermanosSearch}\n                        onChange={(e) => setHermanosSearch(e.target.value)}\n                    />\n\n                    {/* Hermanos Seleccionados (Draft) */}\n                    {tempSelectedHermanos.length > 0 && (\n                        <div className=\"space-y-2\">\n                            <p className=\"text-[10px] font-black uppercase tracking-widest text-muted-foreground\">\n                                Seleccionados ({tempSelectedHermanos.length})\n                            </p>\n                            <div className=\"flex flex-wrap gap-2\">\n                                {tempSelectedHermanos.map(hermanoId => (\n                                    <div\n                                        key={hermanoId}\n                                        className=\"flex items-center gap-2 px-3 py-1.5 bg-purple-500/20 text-purple-700 dark:text-purple-300 rounded-xl text-[10px] font-bold\"\n                                    >\n                                        <span>{getHermanoName(hermanoId) || 'Hermano'}</span>\n                                        <button\n                                            onClick={() => toggleHermano(hermanoId)}\n                                            className=\"hover:bg-purple-500/30 rounded-full p-0.5\"\n                                        >\n                                            <X className=\"w-3 h-3\" />\n                                        </button>\n                                    </div>\n                                ))}\n                            </div>\n                        </div>\n                    )}\n\n                    {/* Lista de Hermanos */}\n                    <div className=\"space-y-2 max-h-[400px] overflow-y-auto\">\n                        {hermanos.length === 0 ? (\n                            <p className=\"text-center text-muted-foreground py-8 text-sm\">\n                                No se encontraron hermanos\n                            </p>\n                        ) : (\n                            hermanos.map(hermano => {\n                                const isSelected = tempSelectedHermanos.includes(hermano.id)\n                                const fullName = `${hermano.nombre || ''} ${hermano.apellidos || ''}`.trim() || hermano.email\n                                return (\n                                    <div\n                                        key={hermano.id}\n                                        onClick={() => toggleHermano(hermano.id)}\n                                        role=\"button\"\n                                        className={`w-full text-left p-4 rounded-2xl border transition-all cursor-pointer select-none ${isSelected\n                                            ? 'bg-purple-500/20 border-purple-500/50 shadow-lg'\n                                            : 'bg-muted/30 border-border/50 hover:bg-muted/50'\n                                            }`}\n                                    >\n                                        <div className=\"flex items-center justify-between pointer-events-none\">\n                                            <div className=\"flex-1 min-w-0\">\n                                                <p className=\"font-bold text-sm truncate\">{fullName}</p>\n                                                {hermano.email && (\n                                                    <p className=\"text-[10px] text-muted-foreground truncate mt-0.5\">\n                                                        {hermano.email}\n                                                    </p>\n                                                )}\n                                            </div>\n                                            {isSelected && (\n                                                <CheckCircle className=\"w-5 h-5 text-purple-600 shrink-0\" />\n                                            )}\n                                        </div>\n                                    </div>\n                                )\n                            })\n                        )}\n                    </div>\n\n                    {/* Botones de Acci├│n */}\n                    <div className=\"flex gap-4 pt-4 border-t border-border/50\">\n                        <Button\n                            onClick={() => {\n                                setTempSelectedHermanos([])\n                            }}\n                            variant=\"ghost\"\n                            className=\"flex-1 h-12 rounded-xl font-black uppercase tracking-widest text-[10px]\"\n                        >\n                            Limpiar\n                        </Button>\n                        <Button\n                            onClick={applyHermanosFilter}\n                            className=\"flex-1 h-12 rounded-xl font-black uppercase tracking-widest text-[10px] shadow-xl shadow-purple-500/20 border-b-4 border-purple-800 bg-purple-600 hover:bg-purple-700 text-white\"\n                        >\n                            Aplicar Filtro\n                        </Button>\n                    </div>\n                </div>\n            </Modal >\n        </div >\n    )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\cultos\\[id]\\CultoDetailClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":45,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1585,1588],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1585,1588],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":47,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1646,1649],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1646,1649],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":50,"column":8,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":11,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1727,1730],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1727,1730],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":126,"column":49,"nodeType":"JSXOpeningElement","endLine":126,"endColumn":145},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'userId' is defined but never used.","line":192,"column":52,"nodeType":null,"messageId":"unusedVar","endLine":192,"endColumn":58},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":208,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":208,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":229,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":229,"endColumn":23}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * CultoDetailClient - IDMJI Gestor de P├║lpito\r\n * \r\n * Componente cliente para ver y gestionar los detalles de un culto espec├¡fico.\r\n * Permite asignar hermanos a diferentes labores y gestionar lecturas/m├║sica.\r\n * \r\n * Caracter├¡sticas:\r\n * - Asignaci├│n de responsables con b├║squeda en tiempo real (Filtro P├║lpito)\r\n * - Gesti├│n de lecturas b├¡blicas con detecci├│n de repeticiones\r\n * - Planificaci├│n de himnos y coros\r\n * - Dise├▒o Glassmorphism premium responsivo\r\n * - Multiidioma (ES/CA)\r\n * \r\n * @author Antigravity AI\r\n * @date 2024-12-25\r\n */\r\n\r\n'use client'\r\n\r\nimport { useState } from 'react'\r\nimport { Calendar, Clock, User, BookOpen, Music, ChevronLeft, AlertCircle, CheckCircle, Sparkles } from 'lucide-react'\r\nimport { format } from 'date-fns'\r\nimport { es, ca } from 'date-fns/locale'\r\nimport { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/Card'\r\nimport UserSelector from '@/components/UserSelector'\r\nimport HimnoCoroSelector from '@/components/HimnoCoroSelector'\r\nimport BibleReadingManager from '@/components/BibleReadingManager'\r\nimport { updateAssignment, toggleFestivo } from './actions'\r\nimport { useI18n } from '@/lib/i18n/I18nProvider'\r\nimport Link from 'next/link'\r\nimport { toast } from 'sonner'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport { Culto } from '@/types/database'\r\n\r\ninterface CultoDetailClientProps {\r\n    culto: Culto\r\n    userId: string\r\n}\r\n\r\n/**\r\n * Componente interno para tarjetas de asignaci├│n reutilizables con dise├▒o premium\r\n */\r\ninterface AssignmentSectionProps {\r\n    label: string,\r\n    icon: any,\r\n    selectedUserId: string | null,\r\n    usuarioActual: any,\r\n    onSelect: (id: string | null) => void,\r\n    disabled: boolean,\r\n    t: any,\r\n    cultoId: string,\r\n}\r\n\r\n/**\r\n * Componente interno para tarjetas de asignaci├│n reutilizables con dise├▒o premium\r\n */\r\nfunction AssignmentSection({\r\n    label,\r\n    icon,\r\n    selectedUserId,\r\n    usuarioActual,\r\n    onSelect,\r\n    disabled,\r\n    t,\r\n    cultoId,\r\n}: AssignmentSectionProps) {\r\n    const [isEditing, setIsEditing] = useState(!selectedUserId)\r\n\r\n    return (\r\n        <motion.div\r\n            initial={{ opacity: 0, y: 20 }}\r\n            animate={{ opacity: 1, y: 0 }}\r\n            className={`h-full w-full min-w-0 ${isEditing ? 'relative z-[100]' : 'relative z-10'}`}\r\n        >\r\n            <Card className={`h-full w-full min-w-0 border-t-4 border-primary/40 glass group hover:border-primary transition-all duration-500 shadow-xl relative overflow-visible ${isEditing ? 'ring-4 ring-primary/30' : ''}`}>\r\n                <div className=\"absolute top-0 right-0 w-24 h-24 bg-primary/5 rounded-full blur-2xl -mr-12 -mt-12 group-hover:bg-primary/10 transition-colors\" />\r\n                \r\n                <CardHeader className=\"flex flex-row items-start justify-between pb-2 md:pb-3 shrink-0 gap-2\">\r\n                    <CardTitle icon={icon} className=\"text-primary font-black uppercase tracking-widest text-[10px] md:text-[11px] leading-tight\">\r\n                        {label}\r\n                    </CardTitle>\r\n                    {selectedUserId && !isEditing && (\r\n                        <button\r\n                            onClick={() => setIsEditing(true)}\r\n                            className=\"px-2 py-1 md:px-3 md:py-1.5 text-[8px] md:text-[9px] font-black uppercase tracking-widest bg-primary/10 text-primary rounded-xl hover:bg-primary hover:text-white transition-all shadow-sm shrink-0 mt-0.5\"\r\n                        >\r\n                            Modificar\r\n                        </button>\r\n                    )}\r\n                </CardHeader>\r\n                <CardContent className=\"p-2.5 md:p-3.5 flex-1 flex flex-col overflow-visible\">\r\n                    <div className=\"space-y-2.5 md:space-y-3.5 flex-1 flex flex-col overflow-visible\">\r\n                        <div className=\"shrink-0 relative z-[110]\">\r\n                            <UserSelector\r\n                                selectedUserId={selectedUserId}\r\n                                onSelect={(id) => {\r\n                                    onSelect(id)\r\n                                    if (id) setIsEditing(false)\r\n                                }}\r\n                                disabled={disabled}\r\n                                isEditing={isEditing}\r\n                                onEditChange={setIsEditing}\r\n                            />\r\n                        </div>\r\n                        \r\n                        <AnimatePresence mode=\"wait\">\r\n                            {usuarioActual ? (\r\n                                <motion.div \r\n                                    key={usuarioActual.id || `assigned-${label}`}\r\n                                    initial={{ opacity: 0, scale: 0.95 }}\r\n                                    animate={{ opacity: 1, scale: 1 }}\r\n                                    exit={{ opacity: 0, scale: 0.95 }}\r\n                                    className={`flex flex-col gap-3 p-3.5 md:p-4.5 rounded-[1.75rem] border shadow-inner relative overflow-hidden group/assigned transition-all flex-1 min-h-0 ${\r\n                                        isEditing \r\n                                            ? 'bg-muted/50 border-border opacity-60' \r\n                                            : 'bg-primary/5 border-primary/10'\r\n                                    }`}\r\n                                >\r\n                                    <div className=\"absolute inset-0 bg-linear-to-r from-primary/5 to-transparent opacity-0 group-hover/assigned:opacity-100 transition-opacity\" />\r\n                                    \r\n                                    <div className=\"flex items-center gap-3 relative z-10\">\r\n                                        <div className={`w-11 h-11 md:w-14 md:h-14 rounded-2xl flex items-center justify-center font-black text-xs md:text-sm lg:text-base border-2 shadow-lg shrink-0 ${\r\n                                            isEditing ? 'bg-muted border-border text-muted-foreground' : 'bg-primary/20 border-white/20 text-primary'\r\n                                        }`}>\r\n                                            {usuarioActual.avatar_url ? (\r\n                                                <img src={usuarioActual.avatar_url} alt=\"\" className=\"w-full h-full object-cover rounded-2xl\" />\r\n                                            ) : (\r\n                                                <span className=\"uppercase tracking-tighter\">{usuarioActual.nombre?.[0]}{usuarioActual.apellidos?.[0]}</span>\r\n                                            )}\r\n                                        </div>\r\n                                        <div className=\"relative z-10 min-w-0 flex-1\">\r\n                                            <p className={`text-[11px] md:text-sm lg:text-base xl:text-lg font-black uppercase tracking-tight leading-none whitespace-nowrap ${isEditing ? 'text-muted-foreground' : 'text-foreground'}`}>\r\n                                                {usuarioActual.nombre} {usuarioActual.apellidos}\r\n                                            </p>\r\n                                            <div className=\"flex items-center gap-2.5 mt-2\">\r\n                                                <div className=\"flex items-center gap-1.5\">\r\n                                                    <div className={`w-1.5 h-1.5 rounded-full animate-pulse shrink-0 ${isEditing ? 'bg-muted-foreground' : 'bg-emerald-500'}`} />\r\n                                                    <p className=\"text-[8px] md:text-[10px] lg:text-[11px] text-muted-foreground font-black uppercase tracking-widest leading-none\">\r\n                                                        {isEditing ? 'Modificando...' : 'Asignado'}\r\n                                                    </p>\r\n                                                </div>\r\n                                                {!isEditing && (\r\n                                                    <motion.div\r\n                                                        initial={{ scale: 0 }}\r\n                                                        animate={{ scale: 1 }}\r\n                                                        className=\"bg-emerald-500/20 p-0.5 rounded-full shadow-sm shadow-emerald-500/20\"\r\n                                                    >\r\n                                                        <CheckCircle className=\"w-3.5 h-3.5 md:w-4 md:h-4 text-emerald-500\" />\r\n                                                    </motion.div>\r\n                                                )}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    {/* Bloque de Lectura B├¡blica Integrado (Solo para Introducci├│n) */}\r\n                                    {label === t('culto.introduccion') && !isEditing && (\r\n                                        <motion.div \r\n                                            initial={{ opacity: 0, y: 10 }}\r\n                                            animate={{ opacity: 1, y: 0 }}\r\n                                            className=\"relative z-10 mt-1 pt-3 border-t border-primary/10\"\r\n                                        >\r\n                                            <BibleReadingManager\r\n                                                cultoId={cultoId}\r\n                                                userId={usuarioActual.id}\r\n                                                config={{\r\n                                                    tiene_lectura_introduccion: true,\r\n                                                    tiene_lectura_finalizacion: false\r\n                                                }}\r\n                                            />\r\n                                        </motion.div>\r\n                                    )}\r\n                                </motion.div>\r\n                            ) : !isEditing ? (\r\n                                <motion.div\r\n                                    key=\"unassigned\"\r\n                                    initial={{ opacity: 0 }}\r\n                                    animate={{ opacity: 1 }}\r\n                                    className=\"p-4 border-2 border-dashed border-muted-foreground/10 rounded-[1.5rem] flex flex-col items-center justify-center gap-2 opacity-50\"\r\n                                >\r\n                                    <User className=\"w-6 h-6 text-muted-foreground/30\" />\r\n                                    <p className=\"text-[9px] font-black uppercase tracking-widest text-muted-foreground/50 text-center\">Pendiente de asignar</p>\r\n                                </motion.div>\r\n                            ) : null}\r\n                        </AnimatePresence>\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n        </motion.div>\r\n    )\r\n}\r\n\r\nexport default function CultoDetailClient({ culto, userId }: CultoDetailClientProps) {\r\n    const { t, language } = useI18n()\r\n    const locale = language === 'ca-ES' ? ca : es\r\n    const [isUpdating, setIsUpdating] = useState(false)\r\n\r\n    const handleToggleFestivo = async () => {\r\n        setIsUpdating(true)\r\n        try {\r\n            const result = await toggleFestivo(culto.id, !!culto.es_laborable_festivo, culto.hora_inicio)\r\n            if (result.success) {\r\n                toast.success(culto.es_laborable_festivo ? 'Horario normal restaurado' : 'Horario festivo aplicado (-1h)', {\r\n                    icon: <Sparkles className=\"w-5 h-5 text-primary\" />\r\n                })\r\n            } else {\r\n                toast.error(result.error || 'Error al cambiar estado festivo')\r\n            }\r\n        } catch (error) {\r\n            toast.error('Error de conexi├│n')\r\n        } finally {\r\n            setIsUpdating(false)\r\n        }\r\n    }\r\n\r\n    const handleAssignment = async (\r\n        tipo: 'introduccion' | 'finalizacion' | 'ensenanza' | 'testimonios',\r\n        selectedUserId: string | null\r\n    ) => {\r\n        setIsUpdating(true)\r\n        try {\r\n            const result = await updateAssignment(culto.id, tipo, selectedUserId)\r\n            if (result.success) {\r\n                toast.success(t('common.success'), {\r\n                    icon: <CheckCircle className=\"w-5 h-5 text-emerald-500\" />\r\n                })\r\n            } else {\r\n                toast.error(result.error || t('common.error'))\r\n            }\r\n        } catch (error) {\r\n            toast.error('Error de conexi├│n')\r\n        } finally {\r\n            setIsUpdating(false)\r\n        }\r\n    }\r\n\r\n    const tipoCulto = culto.tipo_culto?.nombre || 'Culto'\r\n    const config = culto.tipo_culto || {}\r\n\r\n    return (\r\n        <div className=\"max-w-7xl 2xl:max-w-[1600px] mx-auto space-y-4 md:space-y-6 lg:space-y-8 pb-20 px-4 md:px-8 no-scrollbar w-full\">\r\n            {/* Header / Breadcrumb */}\r\n            <div className=\"space-y-4 md:space-y-6 w-full\">\r\n                <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }}>\r\n                    <Link\r\n                        href=\"/dashboard/cultos\"\r\n                        className=\"inline-flex items-center gap-3 px-5 py-2.5 rounded-2xl bg-muted/50 text-xs text-muted-foreground hover:text-primary hover:bg-primary/5 transition-all font-black uppercase tracking-widest group border border-border/50 shadow-sm\"\r\n                    >\r\n                        <ChevronLeft className=\"w-5 h-5 group-hover:-translate-x-1 transition-transform\" />\r\n                        {t('dashboard.calendar')}\r\n                    </Link>\r\n                </motion.div>\r\n\r\n                <motion.div \r\n                    initial={{ opacity: 0, y: 20 }}\r\n                    animate={{ opacity: 1, y: 0 }}\r\n                    className=\"glass rounded-[2.5rem] md:rounded-[3rem] p-3 md:p-4 lg:p-6 xl:p-8 shadow-2xl relative overflow-hidden border border-white/20 dark:border-white/5 w-full\"\r\n                >\r\n                    <div className=\"absolute top-0 right-0 w-96 h-96 bg-primary/10 rounded-full -mr-32 -mt-32 blur-3xl animate-pulse\" />\r\n                    \r\n                    <div className=\"relative z-10\">\r\n                        <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-8\">\r\n                            <div className=\"space-y-4\">\r\n                                <div className=\"flex items-center gap-4\">\r\n                                    <div\r\n                                        className=\"w-6 h-6 md:w-8 md:h-8 rounded-xl md:rounded-2xl shadow-2xl animate-bounce shrink-0\"\r\n                                        style={{ backgroundColor: config.color || '#4A90E2', boxShadow: `0 10px 25px -5px ${config.color || '#4A90E2'}40` }}\r\n                                    />\r\n                                    <h1 className=\"text-3xl md:text-5xl lg:text-6xl font-black tracking-tighter uppercase italic leading-none truncate py-1\">\r\n                                        {tipoCulto}\r\n                                    </h1>\r\n                                </div>\r\n\r\n                                <div className=\"flex flex-wrap items-center gap-6 md:gap-10\">\r\n                                    <div className=\"flex items-center gap-4 bg-white/40 dark:bg-black/20 backdrop-blur-md px-8 py-4 rounded-3xl border border-white/20 shadow-sm transition-all hover:bg-white/60 dark:hover:bg-black/30\">\r\n                                        <Calendar className=\"w-6 h-6 text-primary\" />\r\n                                        <div className=\"flex flex-col\">\r\n                                            <p className=\"text-[8px] font-black uppercase tracking-[0.2em] text-muted-foreground/60 leading-none mb-1\">Fecha del Culto</p>\r\n                                            <span className=\"text-base md:text-xl font-black uppercase tracking-tight\">\r\n                                                {format(new Date(culto.fecha), 'PPPP', { locale })}\r\n                                            </span>\r\n                                        </div>\r\n                                    </div>\r\n                                    \r\n                                    <div className=\"flex items-center gap-4 bg-white/40 dark:bg-black/20 backdrop-blur-md px-8 py-4 rounded-3xl border border-white/20 shadow-sm transition-all hover:bg-white/60 dark:hover:bg-black/30 font-black\">\r\n                                        <Clock className=\"w-6 h-6 text-primary\" />\r\n                                        <div className=\"flex flex-col\">\r\n                                            <p className=\"text-[8px] font-black uppercase tracking-[0.2em] text-muted-foreground/60 leading-none mb-1\">Hora Inicio</p>\r\n                                            <span className=\"text-base md:text-xl uppercase tracking-widest\">\r\n                                                {culto.hora_inicio.slice(0, 5)}\r\n                                            </span>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    {/* Toggle Festivo Premium */}\r\n                                    <div className=\"flex flex-col gap-2\">\r\n                                        <p className=\"text-[8px] font-black uppercase tracking-[0.2em] text-muted-foreground/60 ml-4 leading-none\">Estado de Jornada</p>\r\n                                        <button\r\n                                            onClick={handleToggleFestivo}\r\n                                            disabled={isUpdating}\r\n                                            className={`flex items-center gap-4 px-8 py-4 rounded-3xl border transition-all font-black group relative overflow-hidden h-full ${\r\n                                                culto.es_laborable_festivo \r\n                                                    ? 'bg-amber-500 text-white border-amber-600 shadow-xl shadow-amber-500/30 scale-105' \r\n                                                    : 'bg-white/40 dark:bg-black/20 backdrop-blur-md text-muted-foreground border-white/20 hover:border-amber-500/50 hover:bg-amber-50/10'\r\n                                            }`}\r\n                                        >\r\n                                            <div className={`absolute inset-0 bg-linear-to-r from-white/20 to-transparent -translate-x-full transition-transform duration-1000 ${culto.es_laborable_festivo ? 'group-hover:translate-x-full' : ''}`} />\r\n                                            <div className={`p-2 rounded-xl transition-colors ${culto.es_laborable_festivo ? 'bg-white/20' : 'bg-amber-500/10'}`}>\r\n                                                <AlertCircle className={`w-6 h-6 ${culto.es_laborable_festivo ? 'text-white' : 'text-amber-500'}`} />\r\n                                            </div>\r\n                                            <div className=\"flex flex-col items-start\">\r\n                                                <span className={`text-[10px] uppercase tracking-widest leading-none mb-1 ${culto.es_laborable_festivo ? 'text-white/80' : 'text-muted-foreground'}`}>\r\n                                                    {culto.es_laborable_festivo ? 'D├¡a Especial' : 'D├¡a Laborable'}\r\n                                                </span>\r\n                                                <span className=\"text-sm uppercase tracking-tight relative z-10 whitespace-nowrap\">\r\n                                                    {culto.es_laborable_festivo ? 'Festivo Aplicado' : 'Marcar como Festivo'}\r\n                                                </span>\r\n                                            </div>\r\n                                            {culto.es_laborable_festivo && (\r\n                                                <motion.div\r\n                                                    layoutId=\"festivo-sparkle\"\r\n                                                    className=\"ml-2\"\r\n                                                >\r\n                                                    <Sparkles className=\"w-5 h-5 text-white/70 animate-pulse\" />\r\n                                                </motion.div>\r\n                                            )}\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"hidden lg:block p-8 bg-primary/5 rounded-[2.5rem] border border-primary/10 shadow-inner\">\r\n                                <Sparkles className=\"w-12 h-12 text-primary opacity-20\" />\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </motion.div>\r\n            </div>\r\n\r\n            {/* Cuadr├¡cula de Contenido Responsiva */}\r\n            <div className=\"space-y-6 md:space-y-8 w-full\">\r\n                {/* Fila 1: Responsables (Dise├▒o Inteligente: Se expanden para ocupar el espacio) */}\r\n                <div className=\"flex flex-wrap gap-4 md:gap-6 w-full overflow-visible relative z-30\">\r\n                    {config.tiene_lectura_introduccion && (\r\n                        <div className=\"flex-1 min-w-[280px] lg:min-w-[340px] max-w-full\">\r\n                            <AssignmentSection\r\n                                label={t('culto.introduccion')}\r\n                                icon={<User className=\"w-5 h-5\" />}\r\n                                selectedUserId={culto.id_usuario_intro}\r\n                                usuarioActual={culto.usuario_intro}\r\n                                onSelect={(id) => handleAssignment('introduccion', id)}\r\n                                disabled={isUpdating}\r\n                                t={t}\r\n                                cultoId={culto.id}\r\n                            />\r\n                        </div>\r\n                    )}\r\n\r\n                    {config.tiene_ensenanza && (\r\n                        <div className=\"flex-1 min-w-[280px] lg:min-w-[340px] max-w-full\">\r\n                            <AssignmentSection\r\n                                label={t('culto.ensenanza')}\r\n                                icon={<BookOpen className=\"w-5 h-5\" />}\r\n                                selectedUserId={culto.id_usuario_ensenanza}\r\n                                usuarioActual={culto.usuario_ensenanza}\r\n                                onSelect={(id) => handleAssignment('ensenanza', id)}\r\n                                disabled={isUpdating}\r\n                                t={t}\r\n                                cultoId={culto.id}\r\n                            />\r\n                        </div>\r\n                    )}\r\n\r\n                    {config.tiene_testimonios && (\r\n                        <div className=\"flex-1 min-w-[280px] lg:min-w-[340px] max-w-full\">\r\n                            <AssignmentSection\r\n                                label={t('culto.testimonios')}\r\n                                icon={<User className=\"w-5 h-5\" />}\r\n                                selectedUserId={culto.id_usuario_testimonios}\r\n                                usuarioActual={culto.usuario_testimonios}\r\n                                onSelect={(id) => handleAssignment('testimonios', id)}\r\n                                disabled={isUpdating}\r\n                                t={t}\r\n                                cultoId={culto.id}\r\n                            />\r\n                        </div>\r\n                    )}\r\n\r\n                    {config.tiene_lectura_finalizacion && (\r\n                        <div className=\"flex-1 min-w-[280px] lg:min-w-[340px] max-w-full\">\r\n                            <AssignmentSection\r\n                                label={t('culto.finalizacion')}\r\n                                icon={<User className=\"w-5 h-5\" />}\r\n                                selectedUserId={culto.id_usuario_finalizacion}\r\n                                usuarioActual={culto.usuario_finalizacion}\r\n                                onSelect={(id) => handleAssignment('finalizacion', id)}\r\n                                disabled={isUpdating}\r\n                                t={t}\r\n                                cultoId={culto.id}\r\n                            />\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Fila 2: Lecturas y M├║sica */}\r\n                <div className=\"grid gap-4 md:gap-6 lg:gap-8 lg:grid-cols-12 w-full items-start\">\r\n                    {/* Columna Derecha: M├║sica (Bloque principal m├ís grande y detallado) */}\r\n                    {config.tiene_himnos_y_coros && (\r\n                        <motion.div \r\n                            initial={{ opacity: 0, x: 20 }} \r\n                            animate={{ opacity: 1, x: 0 }} \r\n                            transition={{ delay: 0.3 }} \r\n                            className=\"lg:col-span-12 w-full\"\r\n                        >\r\n                            <Card className=\"glass rounded-[2.5rem] border border-white/20 shadow-2xl w-full\">\r\n                                <CardHeader className=\"p-4 md:p-6 lg:p-8 border-b border-white/10 bg-accent/5\">\r\n                                    <div className=\"flex items-center justify-between\">\r\n                                        <CardTitle icon={<Music className=\"w-6 h-6 text-primary\" />} className=\"text-xl md:text-2xl font-black uppercase tracking-tighter\">\r\n                                            {t('dashboard.hymns')}\r\n                                        </CardTitle>\r\n                                        <div className=\"hidden sm:block bg-primary/5 px-4 py-2 rounded-2xl border border-primary/10\">\r\n                                            <p className=\"text-[10px] text-primary font-black uppercase tracking-widest leading-none\">\r\n                                                M├íximo 3 por categor├¡a\r\n                                            </p>\r\n                                        </div>\r\n                                    </div>\r\n                                </CardHeader>\r\n                                <CardContent className=\"p-4 md:p-5 lg:p-6\">\r\n                                    <HimnoCoroSelector cultoId={culto.id} />\r\n                                </CardContent>\r\n                            </Card>\r\n                        </motion.div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Bot├│n Finalizar Edici├│n */}\r\n            <motion.div \r\n                initial={{ opacity: 0, y: 20 }}\r\n                animate={{ opacity: 1, y: 0 }}\r\n                transition={{ delay: 0.4 }}\r\n                className=\"flex justify-center pt-8\"\r\n            >\r\n                <Link\r\n                    href=\"/dashboard/cultos\"\r\n                    className=\"h-16 px-12 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-black uppercase tracking-[0.2em] text-xs shadow-2xl shadow-blue-500/30 flex items-center justify-center gap-3 transition-all hover:scale-[1.05] active:scale-[0.95] border-b-4 border-blue-800\"\r\n                >\r\n                    <CheckCircle className=\"w-5 h-5\" />\r\n                    Finalizar y Guardar\r\n                </Link>\r\n            </motion.div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\cultos\\[id]\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":74,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":74,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2406,2409],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2406,2409],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server'\r\n\r\nimport { createClient } from '@/lib/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { sendNotificationToUser } from '@/app/actions/notifications'\r\nimport { format } from 'date-fns'\r\nimport { es } from 'date-fns/locale'\r\n\r\n/**\r\n * Mapeo de tipos de asignaci├│n a nombres legibles\r\n */\r\nconst tipoAsignacionLabels: Record<string, string> = {\r\n    introduccion: 'Introducci├│n',\r\n    finalizacion: 'Finalizaci├│n',\r\n    ensenanza: 'Ense├▒anza',\r\n    testimonios: 'Testimonios',\r\n}\r\n\r\n/**\r\n * Actualizar asignaci├│n de hermano en un culto\r\n * Tipos de asignaci├│n seg├║n tipo de culto:\r\n * - Estudio B├¡blico: introduccion, finalizacion\r\n * - Alabanza: introduccion, finalizacion\r\n * - Ense├▒anza: introduccion, ensenanza, testimonios (NO finalizacion)\r\n */\r\nexport async function updateAssignment(\r\n    cultoId: string,\r\n    tipoAsignacion: 'introduccion' | 'finalizacion' | 'ensenanza' | 'testimonios',\r\n    userId: string | null\r\n) {\r\n    const supabase = await createClient()\r\n\r\n    const fieldMap = {\r\n        introduccion: 'id_usuario_intro',\r\n        finalizacion: 'id_usuario_finalizacion',\r\n        ensenanza: 'id_usuario_ensenanza',\r\n        testimonios: 'id_usuario_testimonios',\r\n    }\r\n\r\n    const field = fieldMap[tipoAsignacion]\r\n\r\n    const { error } = await supabase\r\n        .from('cultos')\r\n        .update({ [field]: userId })\r\n        .eq('id', cultoId)\r\n\r\n    if (error) {\r\n        return { error: error.message }\r\n    }\r\n\r\n    // Registrar en movimientos\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (user) {\r\n        await supabase.from('movimientos').insert({\r\n            id_usuario: user.id,\r\n            tipo: 'cambio_asignacion',\r\n            descripcion: `Cambio de ${tipoAsignacion} en culto`,\r\n            culto_id: cultoId,\r\n        })\r\n    }\r\n\r\n    // ========== ENVIAR NOTIFICACI├ôN AL USUARIO ASIGNADO ==========\r\n    if (userId) {\r\n        try {\r\n            // Obtener datos del culto para el mensaje\r\n            const { data: culto } = await supabase\r\n                .from('cultos')\r\n                .select('fecha, hora_inicio, tipo_culto:culto_types(nombre)')\r\n                .eq('id', cultoId)\r\n                .single()\r\n\r\n            if (culto) {\r\n                const fechaFormateada = format(new Date(culto.fecha), \"EEEE d 'de' MMMM\", { locale: es })\r\n                const tipoCulto = (culto.tipo_culto as any)?.nombre || 'Culto'\r\n                const tipoLabel = tipoAsignacionLabels[tipoAsignacion] || tipoAsignacion\r\n\r\n                await sendNotificationToUser(\r\n                    userId,\r\n                    '┬íNueva Asignaci├│n!',\r\n                    `${tipoLabel} - ${tipoCulto} del ${fechaFormateada} a las ${culto.hora_inicio}`,\r\n                    `/dashboard/cultos/${cultoId}`\r\n                )\r\n            }\r\n        } catch (notifError) {\r\n            // No bloquear si falla la notificaci├│n\r\n            console.error('Error enviando notificaci├│n de asignaci├│n:', notifError)\r\n        }\r\n    }\r\n\r\n    revalidatePath(`/dashboard/cultos/${cultoId}`)\r\n    return { success: true }\r\n}\r\n\r\n/**\r\n * Toggle del estado festivo laborable con ajuste autom├ítico de horario\r\n */\r\nexport async function toggleFestivo(cultoId: string, currentStatus: boolean, currentHora: string) {\r\n    const supabase = await createClient()\r\n\r\n    // Calcular nueva hora: -1h si pasa a festivo, +1h si vuelve a normal\r\n    const [h, m] = currentHora.split(':').map(Number)\r\n    const newH = currentStatus ? (h + 1) % 24 : (h - 1 + 24) % 24\r\n    const newHora = `${String(newH).padStart(2, '0')}:${String(m).padStart(2, '0')}`\r\n\r\n    const { error } = await supabase\r\n        .from('cultos')\r\n        .update({\r\n            es_laborable_festivo: !currentStatus,\r\n            hora_inicio: newHora\r\n        })\r\n        .eq('id', cultoId)\r\n\r\n    if (error) {\r\n        return { error: error.message }\r\n    }\r\n\r\n    // Registrar en movimientos\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (user) {\r\n        await supabase.from('movimientos').insert({\r\n            id_usuario: user.id,\r\n            tipo: 'cambio_festivo',\r\n            descripcion: `Cambio de estado festivo en culto. Nueva hora: ${newHora}`,\r\n            culto_id: cultoId,\r\n        })\r\n    }\r\n\r\n    revalidatePath(`/dashboard/cultos/${cultoId}`)\r\n    revalidatePath('/dashboard/cultos')\r\n    return { success: true }\r\n}\r\n\r\n/**\r\n * Buscar hermanos con pulpito = true para asignaciones\r\n */\r\nexport async function searchProfiles(query: string = '') {\r\n    const supabase = await createClient()\r\n\r\n    let dbQuery = supabase\r\n        .from('profiles')\r\n        .select('id, nombre, apellidos, avatar_url, pulpito')\r\n        .eq('pulpito', true)\r\n        .order('nombre', { ascending: true })\r\n\r\n    if (query) {\r\n        dbQuery = dbQuery.or(`nombre.ilike.%${query}%,apellidos.ilike.%${query}%`)\r\n    }\r\n\r\n    const { data, error } = await dbQuery.limit(20)\r\n\r\n    if (error) {\r\n        return { error: error.message }\r\n    }\r\n\r\n    return { data }\r\n}\r\n\r\n/**\r\n * Obtener detalles completos de un culto\r\n */\r\nexport async function getCultoDetails(cultoId: string) {\r\n    const supabase = await createClient()\r\n\r\n    const { data, error } = await supabase\r\n        .from('cultos')\r\n        .select(`\r\n      *,\r\n      tipo_culto:culto_types(*),\r\n      usuario_intro:profiles!id_usuario_intro(id, nombre, apellidos, avatar_url),\r\n      usuario_finalizacion:profiles!id_usuario_finalizacion(id, nombre, apellidos, avatar_url),\r\n      usuario_ensenanza:profiles!id_usuario_ensenanza(id, nombre, apellidos, avatar_url),\r\n      usuario_testimonios:profiles!id_usuario_testimonios(id, nombre, apellidos, avatar_url)\r\n    `)\r\n        .eq('id', cultoId)\r\n        .single()\r\n\r\n    if (error) {\r\n        return { error: error.message }\r\n    }\r\n\r\n    return { data }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\cultos\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\cultos\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isWithinInterval' is defined but never used.","line":15,"column":71,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":87},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":61,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2163,2166],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2163,2166],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Cultos Server Actions - IDMJI Gestor de P├║lpito\r\n * \r\n * Acciones para la gesti├│n de cultos: generaci├│n mensual, creaci├│n manual\r\n * y obtenci├│n de datos con filtros.\r\n * \r\n * @author Antigravity AI\r\n * @date 2024-12-25\r\n */\r\n\r\n'use server'\r\n\r\nimport { createClient } from '@/lib/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { eachDayOfInterval, endOfMonth, getDay, startOfMonth, format, isWithinInterval } from 'date-fns'\r\n\r\n/**\r\n * Genera autom├íticamente los cultos de un mes bas├índose en el calendario semanal\r\n * y las reglas de festivos laborables.\r\n * \r\n * @param date Fecha del mes a generar\r\n */\r\nexport async function generateCultosForMonth(date: Date) {\r\n    const supabase = await createClient()\r\n\r\n    const start = startOfMonth(date)\r\n    const end = endOfMonth(date)\r\n    const days = eachDayOfInterval({ start, end })\r\n\r\n    // 1. Verificar si ya existen cultos generados para este mes para evitar duplicados\r\n    const { data: existingCultos } = await supabase\r\n        .from('cultos')\r\n        .select('id')\r\n        .gte('fecha', format(start, 'yyyy-MM-dd'))\r\n        .lte('fecha', format(end, 'yyyy-MM-dd'))\r\n        .limit(1)\r\n\r\n    if (existingCultos && existingCultos.length > 0) {\r\n        return { success: false, error: 'Ya existen cultos generados para este mes.' }\r\n    }\r\n\r\n    // 2. Obtener configuraciones base\r\n    const { data: schedules } = await supabase.from('culto_schedules').select('*')\r\n    const scheduleMap = new Map(schedules?.map(s => [s.day_of_week, s]))\r\n\r\n    // 3. Obtener festivos del mes para aplicar regla de horario (1h antes)\r\n    const { data: festivos } = await supabase\r\n        .from('festivos')\r\n        .select('fecha, tipo')\r\n        .gte('fecha', format(start, 'yyyy-MM-dd'))\r\n        .lte('fecha', format(end, 'yyyy-MM-dd'))\r\n        .eq('tipo', 'laborable_festivo')\r\n\r\n    const laborablesFestivos = new Set(festivos?.map(f => f.fecha))\r\n\r\n    const cultosToInsert = []\r\n\r\n    for (const day of days) {\r\n        const dayOfWeek = getDay(day) // 0=Dom, 1=Lun...\r\n        const fechaStr = format(day, 'yyyy-MM-dd')\r\n        const schedule = scheduleMap.get(dayOfWeek as any)\r\n\r\n        if (schedule) {\r\n            let horaInicio = schedule.default_time.slice(0, 5) // HH:mm\r\n            let esLaborableFestivo = false\r\n\r\n            // Regla MVP 5.2: Solo de lunes a viernes si es laborable_festivo, restar 1 hora\r\n            if (dayOfWeek >= 1 && dayOfWeek <= 5 && laborablesFestivos.has(fechaStr) && schedule.affected_by_laborable_festivo) {\r\n                const [h, m] = horaInicio.split(':').map(Number)\r\n                horaInicio = `${String(h - 1).padStart(2, '0')}:${String(m).padStart(2, '0')}`\r\n                esLaborableFestivo = true\r\n            }\r\n\r\n            cultosToInsert.push({\r\n                fecha: fechaStr,\r\n                hora_inicio: horaInicio,\r\n                tipo_culto_id: schedule.tipo_culto_id,\r\n                estado: 'planeado',\r\n                es_laborable_festivo: esLaborableFestivo\r\n            })\r\n        }\r\n    }\r\n\r\n    if (cultosToInsert.length > 0) {\r\n        const { error } = await supabase.from('cultos').insert(cultosToInsert)\r\n        if (error) {\r\n            console.error('Error al insertar cultos:', error)\r\n            return { success: false, error: 'Error al guardar los cultos en la base de datos.' }\r\n        }\r\n    }\r\n\r\n    revalidatePath('/dashboard/cultos')\r\n    return { success: true, count: cultosToInsert.length }\r\n}\r\n\r\n/**\r\n * Genera todos los cultos para un a├▒o entero (ej: 2026)\r\n * Se usa para pre-generar datos por defecto.\r\n */\r\nexport async function generateYear(year: number) {\r\n    let totals = 0\r\n    const errors = []\r\n\r\n    for (let month = 0; month < 12; month++) {\r\n        const date = new Date(year, month, 1) // 1st of each month\r\n        const result = await generateCultosForMonth(date)\r\n        if (result.error) {\r\n            errors.push({ month: month + 1, error: result.error })\r\n        } else if (result.count) {\r\n            totals += result.count\r\n        }\r\n    }\r\n\r\n    revalidatePath('/dashboard/cultos')\r\n    return { success: errors.length === 0, total: totals, errors }\r\n}\r\n\r\n/**\r\n * Crea un culto de forma manual (excepci├│n)\r\n */\r\nexport async function createCulto(formData: FormData) {\r\n    const supabase = await createClient()\r\n\r\n    const fecha = formData.get('fecha') as string\r\n    const hora = formData.get('hora') as string\r\n    const tipoId = formData.get('tipo_id')\r\n\r\n    const { error } = await supabase.from('cultos').insert({\r\n        fecha,\r\n        hora_inicio: hora,\r\n        tipo_culto_id: tipoId,\r\n        estado: 'planeado'\r\n    })\r\n\r\n    if (error) return { error: error.message }\r\n\r\n    revalidatePath('/dashboard/cultos')\r\n    return { success: true }\r\n}\r\n\r\n/**\r\n * Obtiene los cultos de un mes con toda la informaci├│n de asignaciones relacionada\r\n */\r\nexport async function getCultosForMonth(year: number, month: number) {\r\n    const supabase = await createClient()\r\n\r\n    const start = format(new Date(year, month, 1), 'yyyy-MM-dd')\r\n    const end = format(endOfMonth(new Date(year, month, 1)), 'yyyy-MM-dd')\r\n\r\n    const { data, error } = await supabase\r\n        .from('cultos')\r\n        .select(`\r\n            *,\r\n            tipo_culto:culto_types(*),\r\n            usuario_intro:profiles!id_usuario_intro(nombre, apellidos),\r\n            usuario_finalizacion:profiles!id_usuario_finalizacion(nombre, apellidos),\r\n            usuario_ensenanza:profiles!id_usuario_ensenanza(nombre, apellidos),\r\n            usuario_testimonios:profiles!id_usuario_testimonios(nombre, apellidos)\r\n        `)\r\n        .gte('fecha', start)\r\n        .lte('fecha', end)\r\n        .order('fecha', { ascending: true })\r\n\r\n    if (error) {\r\n        console.error('Error fetching cultos:', error)\r\n        return { error: error.message }\r\n    }\r\n\r\n    return { data }\r\n}\r\n\r\n/**\r\n * Obtiene las asignaciones espec├¡ficas de un usuario en un rango de fechas.\r\n */\r\nexport async function getUserAssignments(userId: string, startStr: string, endStr: string) {\r\n    const supabase = await createClient()\r\n\r\n    const { data, error } = await supabase\r\n        .from('cultos')\r\n        .select(`\r\n            *,\r\n            tipo_culto:culto_types(nombre, color)\r\n        `)\r\n        .gte('fecha', startStr)\r\n        .lte('fecha', endStr)\r\n        .or(`id_usuario_intro.eq.${userId},id_usuario_ensenanza.eq.${userId},id_usuario_finalizacion.eq.${userId},id_usuario_testimonios.eq.${userId}`)\r\n        .order('fecha', { ascending: true })\r\n\r\n    if (error) {\r\n        console.error('Error fetching user assignments:', error)\r\n        return { error: error.message }\r\n    }\r\n\r\n    return { data }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\cultos\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\festivos\\FestivosPageClient.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\festivos\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\festivos\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\hermanos\\HermanosClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Card' is defined but never used.","line":21,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardContent' is defined but never used.","line":21,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DialogHeader' is defined but never used.","line":27,"column":33,"nodeType":null,"messageId":"unusedVar","endLine":27,"endColumn":45},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DialogTitle' is defined but never used.","line":27,"column":47,"nodeType":null,"messageId":"unusedVar","endLine":27,"endColumn":58},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DialogDescription' is defined but never used.","line":27,"column":60,"nodeType":null,"messageId":"unusedVar","endLine":27,"endColumn":77},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":79,"column":21,"nodeType":"JSXOpeningElement","endLine":83,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isLoading' is assigned a value but never used.","line":101,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":101,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setIsLoading' is assigned a value but never used.","line":101,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":101,"endColumn":35},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":228,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":228,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10610,10613],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10610,10613],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * HermanosClient - IDMJI Gestor de P├║lpito\r\n * \r\n * Componente cliente para visualizar el directorio de hermanos de p├║lpito.\r\n * Permite buscar por nombre, apellidos o email y ver estad├¡sticas de asignaci├│n.\r\n * \r\n * Caracter├¡sticas:\r\n * - Buscado en tiempo real con debounce\r\n * - Tarjetas de perfil detalladas con roles resaltados\r\n * - Estad├¡sticas r├ípidas de participaci├│n\r\n * - Soporte multiidioma (ES/CA)\r\n * \r\n * @author Antigravity AI\r\n * @date 2024-12-18\r\n */\r\n\r\n'use client'\r\n\r\nimport { useState, useEffect, useMemo } from 'react'\r\nimport { Search, Users, ChevronLeft, ShieldCheck, Mail, Sparkles, Award, CheckCircle2, XCircle, X } from 'lucide-react'\r\nimport { Card, CardContent } from '@/components/ui/Card'\r\nimport { useI18n } from '@/lib/i18n/I18nProvider'\r\nimport Link from 'next/link'\r\nimport { Profile } from '@/types/database'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport { cn } from '@/lib/utils'\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/Dialog'\r\n\r\ninterface HermanosClientProps {\r\n    initialHermanos: Profile[]\r\n    stats: { pulpito: number; total: number }\r\n}\r\n\r\n/**\r\n * Componente para mostrar el avatar con iniciales y degradado din├ímico\r\n */\r\nfunction HermanoAvatar({ hermano, size = \"md\" }: { hermano: Profile, size?: \"sm\" | \"md\" | \"lg\" | \"xl\" }) {\r\n    const initials = `${hermano.nombre?.[0] || ''}${hermano.apellidos?.[0] || ''}`.toUpperCase() || '?'\r\n\r\n    // Generar un degradado basado en el nombre para que siempre sea el mismo para el mismo hermano\r\n    const getGradient = (name: string) => {\r\n        const colors = [\r\n            'from-blue-500 to-cyan-400',\r\n            'from-purple-500 to-pink-400',\r\n            'from-emerald-500 to-teal-400',\r\n            'from-orange-500 to-amber-400',\r\n            'from-indigo-500 to-purple-400',\r\n            'from-rose-500 to-orange-400'\r\n        ]\r\n        let hash = 0\r\n        for (let i = 0; i < name.length; i++) {\r\n            hash = name.charCodeAt(i) + ((hash << 5) - hash)\r\n        }\r\n        return colors[Math.abs(hash) % colors.length]\r\n    }\r\n\r\n    const gradientClass = getGradient(hermano.nombre || 'Desconocido')\r\n\r\n    const sizeClasses = {\r\n        sm: \"w-12 h-12 rounded-xl\",\r\n        md: \"w-16 h-16 rounded-2xl\",\r\n        lg: \"w-24 h-24 rounded-3xl\",\r\n        xl: \"w-40 h-40 rounded-[2.5rem]\"\r\n    }\r\n\r\n    return (\r\n        <div className=\"relative group/avatar\">\r\n            <div className={cn(\r\n                \"absolute inset-0 blur-md opacity-0 group-hover/avatar:opacity-40 transition-opacity\",\r\n                sizeClasses[size],\r\n                hermano.avatar_url ? \"bg-primary\" : \"bg-gradient-to-br \" + gradientClass\r\n            )} />\r\n            <div className={cn(\r\n                \"relative border-2 border-white/20 overflow-hidden flex items-center justify-center shadow-lg transition-transform duration-300 group-hover/avatar:scale-105\",\r\n                sizeClasses[size],\r\n                !hermano.avatar_url && \"bg-gradient-to-br \" + gradientClass\r\n            )}>\r\n                {hermano.avatar_url ? (\r\n                    <img\r\n                        src={hermano.avatar_url}\r\n                        alt={hermano.nombre || 'Avatar'}\r\n                        className=\"w-full h-full object-cover\"\r\n                    />\r\n                ) : (\r\n                    <span className={cn(\r\n                        \"font-black text-white tracking-tighter drop-shadow-sm\",\r\n                        size === \"sm\" ? \"text-lg\" : size === \"md\" ? \"text-xl\" : size === \"lg\" ? \"text-3xl\" : \"text-5xl\"\r\n                    )}>\r\n                        {initials}\r\n                    </span>\r\n                )}\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n\r\nexport default function HermanosClient({ initialHermanos, stats }: HermanosClientProps) {\r\n    const { t } = useI18n()\r\n    const [hermanos, setHermanos] = useState<Profile[]>(initialHermanos)\r\n    const [searchTerm, setSearchTerm] = useState('')\r\n    const [isLoading, setIsLoading] = useState(false)\r\n    const [filterRole, setFilterRole] = useState<'ALL' | 'ADMIN' | 'EDITOR' | 'VIEWER'>('ALL')\r\n    const [selectedHermano, setSelectedHermano] = useState<Profile | null>(null)\r\n    const [isModalOpen, setIsModalOpen] = useState(false)\r\n\r\n    const openDetails = (hermano: Profile) => {\r\n        setSelectedHermano(hermano)\r\n        setIsModalOpen(true)\r\n    }\r\n\r\n    // Filtrado local para m├íxima velocidad\r\n    const filteredHermanos = useMemo(() => {\r\n        return hermanos.filter(h => {\r\n            const fullName = `${h.nombre || ''} ${h.apellidos || ''}`.toLowerCase()\r\n            const email = (h.email || '').toLowerCase()\r\n            const search = searchTerm.toLowerCase()\r\n\r\n            const matchesSearch = !searchTerm ||\r\n                fullName.includes(search) ||\r\n                email.includes(search)\r\n\r\n            const matchesRole = filterRole === 'ALL' || h.rol === filterRole\r\n\r\n            return matchesSearch && matchesRole\r\n        })\r\n    }, [hermanos, searchTerm, filterRole])\r\n\r\n    // Efecto para sincronizar con el servidor si es necesario (ej. si initialHermanos cambia)\r\n    useEffect(() => {\r\n        setHermanos(initialHermanos)\r\n    }, [initialHermanos])\r\n\r\n    /**\r\n     * Resalta el t├®rmino buscado\r\n     */\r\n    function highlightText(text: string | null, search: string) {\r\n        if (!text || !search.trim()) return text || ''\r\n        const regex = new RegExp(`(${search.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')})`, 'gi')\r\n        const parts = text.split(regex)\r\n        return parts.map((part, index) =>\r\n            regex.test(part)\r\n                ? <strong key={index} className=\"text-primary font-black bg-primary/10 px-0.5 rounded\">{part}</strong>\r\n                : part\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div className=\"max-w-7xl mx-auto space-y-10 pb-20 px-4 md:px-6 no-scrollbar\" data-page=\"hermanos\">\r\n            {/* Breadcrumb Mejorado */}\r\n            <motion.div\r\n                initial={{ opacity: 0, x: -20 }}\r\n                animate={{ opacity: 1, x: 0 }}\r\n                className=\"flex items-center justify-between\"\r\n            >\r\n                <Link\r\n                    href=\"/dashboard\"\r\n                    className=\"inline-flex items-center gap-2 text-sm font-bold text-muted-foreground hover:text-primary transition-all group px-4 py-2 rounded-xl hover:bg-primary/5\"\r\n                >\r\n                    <ChevronLeft className=\"w-4 h-4 group-hover:-translate-x-1 transition-transform\" />\r\n                    {t('dashboard.title')}\r\n                </Link>\r\n\r\n                <div className=\"hidden sm:flex items-center gap-2 text-xs font-black text-muted-foreground/40 uppercase tracking-[0.2em]\">\r\n                    <Sparkles className=\"w-3 h-3 text-primary\" />\r\n                    IDMJI Sabadell\r\n                </div>\r\n            </motion.div>\r\n\r\n            {/* Header Modernizado */}\r\n            <div className=\"flex flex-col xl:flex-row gap-8 justify-between items-start xl:items-end\">\r\n                <div className=\"space-y-4 max-w-2xl\">\r\n                    <motion.h1\r\n                        initial={{ opacity: 0, y: 20 }}\r\n                        animate={{ opacity: 1, y: 0 }}\r\n                        className=\"text-5xl md:text-7xl font-black tracking-tight leading-none\"\r\n                    >\r\n                        {t('hermanos.title').split(' ')[0]}\r\n                        <span className=\"block text-transparent bg-clip-text bg-gradient-to-r from-primary via-accent to-primary animate-gradient-x\">\r\n                            {t('hermanos.title').split(' ').slice(1).join(' ')}\r\n                        </span>\r\n                    </motion.h1>\r\n                    <motion.p\r\n                        initial={{ opacity: 0, y: 10 }}\r\n                        animate={{ opacity: 1, y: 0 }}\r\n                        transition={{ delay: 0.1 }}\r\n                        className=\"text-lg md:text-xl text-muted-foreground font-medium flex items-center gap-3\"\r\n                    >\r\n                        <span className=\"w-10 h-[2px] bg-primary/30 hidden sm:block\" />\r\n                        {t('hermanos.desc')}\r\n                    </motion.p>\r\n                </div>\r\n\r\n                {/* Buscador */}\r\n                <motion.div\r\n                    initial={{ opacity: 0, scale: 0.95 }}\r\n                    animate={{ opacity: 1, scale: 1 }}\r\n                    transition={{ delay: 0.2 }}\r\n                    className=\"w-full xl:w-96 group\"\r\n                >\r\n                    <div className=\"absolute inset-0 bg-primary/20 rounded-2xl blur-xl group-focus-within:bg-primary/30 transition-all opacity-0 group-focus-within:opacity-100\" />\r\n                    <div className=\"relative glass border border-white/10 rounded-2xl flex items-center px-5 h-16 shadow-2xl focus-within:border-primary transition-all\">\r\n                        <Search className=\"w-5 h-5 text-primary/50 mr-3 group-focus-within:text-primary transition-colors\" />\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder={t('hermanos.searchPlaceholder')}\r\n                            className=\"w-full bg-transparent border-none outline-none font-bold placeholder:text-muted-foreground/30 text-foreground text-lg\"\r\n                            value={searchTerm}\r\n                            onChange={(e) => setSearchTerm(e.target.value)}\r\n                        />\r\n                    </div>\r\n                </motion.div>\r\n            </div>\r\n\r\n            {/* Listado con Animaci├│n Stagger */}\r\n            <div className=\"space-y-6\">\r\n                <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 px-2\">\r\n                    <h2 className=\"text-sm font-black uppercase tracking-[0.3em] text-muted-foreground/60 flex items-center gap-2\">\r\n                        <Users className=\"w-4 h-4\" />\r\n                        {t('hermanos.showing')\r\n                            .replace('{count}', filteredHermanos.length.toString())\r\n                            .replace('{plural}', filteredHermanos.length !== 1 ? 's' : '')}\r\n                    </h2>\r\n\r\n                    <div className=\"flex items-center gap-2 overflow-x-auto pb-2 sm:pb-0 no-scrollbar w-full sm:w-auto -mx-2 sm:mx-0 px-2 sm:px-0\">\r\n                        {['ALL', 'ADMIN', 'EDITOR'].map((role) => (\r\n                            <button\r\n                                key={role}\r\n                                onClick={() => setFilterRole(role as any)}\r\n                                className={cn(\r\n                                    \"px-5 py-3 sm:px-4 sm:py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all border-2 whitespace-nowrap min-w-[80px] sm:min-w-0 flex items-center justify-center\",\r\n                                    filterRole === role\r\n                                        ? \"bg-foreground text-background border-foreground shadow-lg\"\r\n                                        : \"bg-white/60 dark:bg-white/5 border-zinc-300 dark:border-white/10 text-zinc-700 dark:text-muted-foreground hover:bg-white/80 dark:hover:bg-white/10 backdrop-blur-md\"\r\n                                )}\r\n                            >\r\n                                {role === 'ALL' ? t('hermanos.filterAll') : role}\r\n                            </button>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n\r\n                <AnimatePresence mode=\"popLayout\">\r\n                    {filteredHermanos.length === 0 ? (\r\n                        <motion.div\r\n                            initial={{ opacity: 0, y: 20 }}\r\n                            animate={{ opacity: 1, y: 0 }}\r\n                            exit={{ opacity: 0, scale: 0.9 }}\r\n                            className=\"flex flex-col items-center justify-center py-40 glass rounded-[3rem] border-dashed border-2 border-white/5\"\r\n                        >\r\n                            <div className=\"relative\">\r\n                                <Search className=\"w-24 h-24 text-primary/10\" />\r\n                                <motion.div\r\n                                    animate={{ rotate: 360 }}\r\n                                    transition={{ duration: 10, repeat: Infinity, ease: \"linear\" }}\r\n                                    className=\"absolute -top-2 -right-2 w-8 h-8 rounded-full bg-accent/20 flex items-center justify-center\"\r\n                                >\r\n                                    <Sparkles className=\"w-4 h-4 text-accent\" />\r\n                                </motion.div>\r\n                            </div>\r\n                            <p className=\"mt-6 text-2xl font-black tracking-tight text-muted-foreground/40 uppercase\">\r\n                                {t('hermanos.noResults')}\r\n                            </p>\r\n                        </motion.div>\r\n                    ) : (\r\n                        <div className=\"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4 md:gap-6\">\r\n                            {filteredHermanos.map((hermano, index) => (\r\n                                <motion.div\r\n                                    layout\r\n                                    key={hermano.id}\r\n                                    initial={{ opacity: 0, y: 20 }}\r\n                                    animate={{ opacity: 1, y: 0 }}\r\n                                    exit={{ opacity: 0, scale: 0.9 }}\r\n                                    transition={{ delay: index * 0.03, duration: 0.4 }}\r\n                                    className=\"group relative cursor-pointer\"\r\n                                    onClick={() => openDetails(hermano)}\r\n                                >\r\n                                    {/* Fondo de tarjeta con hover glow */}\r\n                                    <div className={cn(\r\n                                        \"absolute inset-0 rounded-[2rem] blur-xl transition-all opacity-0 group-hover:opacity-10\",\r\n                                        hermano.rol === 'ADMIN' ? 'bg-red-500' : 'bg-primary'\r\n                                    )} />\r\n\r\n                                    <div className=\"relative h-full glass border border-white/10 rounded-[2rem] p-5 hover:bg-white/5 dark:hover:bg-muted/30 transition-all duration-500 hover:shadow-xl hover:shadow-primary/5 hover:-translate-y-1.5 flex flex-col items-center text-center overflow-hidden\">\r\n\r\n                                        {/* Decoraci├│n superior */}\r\n                                        <div className=\"absolute top-0 right-0 p-4 opacity-[0.03] group-hover:opacity-10 transition-opacity\">\r\n                                            {hermano.rol === 'ADMIN' ? <ShieldCheck className=\"w-12 h-12\" /> : <Award className=\"w-12 h-12\" />}\r\n                                        </div>\r\n\r\n                                        {/* Avatar Component Compacto */}\r\n                                        <HermanoAvatar hermano={hermano} size=\"sm\" />\r\n\r\n                                        {/* Info Hermano Compacta */}\r\n                                        <div className=\"mt-4 space-y-1 w-full\">\r\n                                            <h3 className=\"text-sm font-black tracking-tight uppercase leading-tight truncate\">\r\n                                                {highlightText(hermano.nombre, searchTerm)}\r\n                                            </h3>\r\n                                            <p className=\"text-[10px] font-bold text-primary/80 uppercase truncate\">\r\n                                                {highlightText(hermano.apellidos, searchTerm)}\r\n                                            </p>\r\n\r\n                                            <div className=\"pt-2 flex flex-wrap justify-center gap-1\">\r\n                                                <span className={cn(\r\n                                                    \"px-2 py-0.5 text-[8px] font-black uppercase tracking-widest rounded-full border shadow-sm\",\r\n                                                    hermano.rol === 'ADMIN'\r\n                                                        ? 'bg-red-500/10 text-red-500 border-red-500/20'\r\n                                                        : 'bg-primary/10 text-primary border-primary/20'\r\n                                                )}>\r\n                                                    {hermano.rol}\r\n                                                </span>\r\n\r\n                                                {hermano.pulpito && (\r\n                                                    <div className=\"flex items-center gap-1 px-2 py-0.5 bg-emerald-500/10 text-emerald-500 border border-emerald-500/20 rounded-full text-[8px] font-black uppercase tracking-widest\">\r\n                                                        <CheckCircle2 className=\"w-2 h-2\" />\r\n                                                        P├║lpito\r\n                                                    </div>\r\n                                                )}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                </motion.div>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                </AnimatePresence>\r\n            </div>\r\n\r\n            {/* Modal de Detalles */}\r\n            <Dialog open={isModalOpen} onOpenChange={setIsModalOpen}>\r\n                <DialogContent className=\"max-w-md p-0 overflow-visible bg-background border-none shadow-none\">\r\n                    {selectedHermano && (\r\n                        <div className=\"relative glass border border-white/10 rounded-[3rem] p-8 md:p-10 shadow-[0_30px_100px_rgba(0,0,0,0.5)] overflow-hidden\">\r\n                            {/* Glow de fondo */}\r\n                            <div className={cn(\r\n                                \"absolute -top-24 -right-24 w-64 h-64 blur-[100px] opacity-20 rounded-full\",\r\n                                selectedHermano.rol === 'ADMIN' ? 'bg-red-500' : 'bg-primary'\r\n                            )} />\r\n\r\n                            <button\r\n                                onClick={() => setIsModalOpen(false)}\r\n                                className=\"absolute top-6 right-6 w-10 h-10 rounded-full glass border border-white/10 flex items-center justify-center text-muted-foreground hover:text-foreground transition-all hover:scale-110 z-10\"\r\n                            >\r\n                                <X className=\"w-5 h-5\" />\r\n                            </button>\r\n\r\n                            <div className=\"flex flex-col items-center text-center space-y-6\">\r\n                                <HermanoAvatar hermano={selectedHermano} size=\"xl\" />\r\n\r\n                                <div className=\"space-y-2\">\r\n                                    <h2 className=\"text-3xl md:text-4xl font-black tracking-tighter uppercase leading-none\">\r\n                                        {selectedHermano.nombre}\r\n                                        <span className=\"block text-primary\">\r\n                                            {selectedHermano.apellidos}\r\n                                        </span>\r\n                                    </h2>\r\n                                    <div className=\"flex items-center justify-center gap-2 pt-2\">\r\n                                        <span className={cn(\r\n                                            \"px-4 py-1 text-[10px] font-black uppercase tracking-[0.2em] rounded-full border shadow-sm\",\r\n                                            selectedHermano.rol === 'ADMIN'\r\n                                                ? 'bg-red-500/10 text-red-500 border-red-500/20'\r\n                                                : 'bg-primary/10 text-primary border-primary/20'\r\n                                        )}>\r\n                                            {selectedHermano.rol}\r\n                                        </span>\r\n                                        {selectedHermano.pulpito && (\r\n                                            <div className=\"flex items-center gap-1.5 px-4 py-1 bg-emerald-500/10 text-emerald-500 border border-emerald-500/20 rounded-full text-[10px] font-black uppercase tracking-widest\">\r\n                                                <CheckCircle2 className=\"w-3 h-3\" />\r\n                                                Acceso P├║lpito\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <div className=\"w-full space-y-4 pt-6\">\r\n                                    {/* Secci├│n de Contacto */}\r\n                                    <div className=\"space-y-3\">\r\n                                        <div className=\"flex items-center gap-2 px-2\">\r\n                                            <div className=\"h-px flex-1 bg-white/5\" />\r\n                                            <span className=\"text-[10px] font-black uppercase tracking-widest text-muted-foreground/40\">{t('hermanos.contactInfo')}</span>\r\n                                            <div className=\"h-px flex-1 bg-white/5\" />\r\n                                        </div>\r\n\r\n                                        <div className=\"grid grid-cols-1 gap-3\">\r\n                                            {/* Tel├®fono */}\r\n                                            {selectedHermano.telefono ? (\r\n                                                <a\r\n                                                    href={`tel:${selectedHermano.telefono}`}\r\n                                                    className=\"glass border border-white/5 rounded-2xl p-4 flex items-center gap-4 group hover:bg-primary/10 hover:border-primary/20 transition-all\"\r\n                                                >\r\n                                                    <div className=\"w-12 h-12 rounded-xl bg-emerald-500/10 flex items-center justify-center text-emerald-500 group-hover:scale-110 transition-transform\">\r\n                                                        <CheckCircle2 className=\"w-5 h-5\" /> {/* Reemplazar con Phone si estuviera disponible, o usar Lucide Phone */}\r\n                                                    </div>\r\n                                                    <div className=\"text-left\">\r\n                                                        <p className=\"text-[10px] font-black text-muted-foreground/40 uppercase tracking-widest\">{t('users.form.phone')}</p>\r\n                                                        <p className=\"font-bold text-lg\">{selectedHermano.telefono}</p>\r\n                                                    </div>\r\n                                                </a>\r\n                                            ) : (\r\n                                                <div className=\"glass border border-white/5 rounded-2xl p-4 opacity-40 flex items-center gap-4\">\r\n                                                    <div className=\"w-12 h-12 rounded-xl bg-zinc-500/10 flex items-center justify-center text-zinc-500\">\r\n                                                        <XCircle className=\"w-5 h-5\" />\r\n                                                    </div>\r\n                                                    <div className=\"text-left\">\r\n                                                        <p className=\"text-[10px] font-black text-muted-foreground/40 uppercase tracking-widest\">{t('users.form.phone')}</p>\r\n                                                        <p className=\"font-bold\">N/A</p>\r\n                                                    </div>\r\n                                                </div>\r\n                                            )}\r\n\r\n                                            {/* Email de Contacto */}\r\n                                            {selectedHermano.email_contacto ? (\r\n                                                <a\r\n                                                    href={`mailto:${selectedHermano.email_contacto}`}\r\n                                                    className=\"glass border border-white/5 rounded-2xl p-4 flex items-center gap-4 group hover:bg-primary/10 hover:border-primary/20 transition-all\"\r\n                                                >\r\n                                                    <div className=\"w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center text-primary group-hover:scale-110 transition-transform\">\r\n                                                        <Mail className=\"w-5 h-5\" />\r\n                                                    </div>\r\n                                                    <div className=\"text-left\">\r\n                                                        <p className=\"text-[10px] font-black text-muted-foreground/40 uppercase tracking-widest\">{t('users.form.contactEmail')}</p>\r\n                                                        <p className=\"font-bold truncate max-w-[200px]\">{selectedHermano.email_contacto}</p>\r\n                                                    </div>\r\n                                                </a>\r\n                                            ) : (\r\n                                                <div className=\"glass border border-white/5 rounded-2xl p-4 opacity-40 flex items-center gap-4\">\r\n                                                    <div className=\"w-12 h-12 rounded-xl bg-zinc-500/10 flex items-center justify-center text-zinc-500\">\r\n                                                        <Mail className=\"w-5 h-5\" />\r\n                                                    </div>\r\n                                                    <div className=\"text-left\">\r\n                                                        <p className=\"text-[10px] font-black text-muted-foreground/40 uppercase tracking-widest\">{t('users.form.contactEmail')}</p>\r\n                                                        <p className=\"font-bold\">N/A</p>\r\n                                                    </div>\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    {/* Informaci├│n de Sistema */}\r\n                                    <div className=\"grid grid-cols-2 gap-4 pt-4\">\r\n                                        <div className=\"glass border border-white/5 rounded-2xl p-4 text-center\">\r\n                                            <p className=\"text-[10px] font-black text-muted-foreground/40 uppercase tracking-widest mb-1\">{t('hermanos.registeredSince')}</p>\r\n                                            <p className=\"font-bold text-sm\">\r\n                                                {new Date(selectedHermano.created_at).toLocaleDateString(undefined, { year: 'numeric', month: 'short' })}\r\n                                            </p>\r\n                                        </div>\r\n                                        <div className=\"glass border border-white/5 rounded-2xl p-4 text-center\">\r\n                                            <p className=\"text-[10px] font-black text-muted-foreground/40 uppercase tracking-widest mb-1\">Email Acceso</p>\r\n                                            <p className=\"font-bold text-[10px] truncate opacity-60\">\r\n                                                {selectedHermano.email}\r\n                                            </p>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </DialogContent>\r\n            </Dialog>\r\n\r\n            {/* Stats Flotantes Mejoradas */}\r\n            <motion.div\r\n                initial={{ opacity: 0, y: 50 }}\r\n                animate={{ opacity: 1, y: 0 }}\r\n                transition={{ delay: 0.5 }}\r\n                className=\"fixed bottom-8 left-1/2 -translate-x-1/2 z-50 px-8 py-5 glass border border-white/20 rounded-[2.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.3)] flex items-center gap-12 backdrop-blur-2xl\"\r\n            >\r\n                <div className=\"flex items-center gap-4 group cursor-default\">\r\n                    <div className=\"w-12 h-12 rounded-2xl bg-primary/10 flex items-center justify-center text-primary group-hover:scale-110 transition-transform\">\r\n                        <Award className=\"w-6 h-6\" />\r\n                    </div>\r\n                    <div>\r\n                        <p className=\"text-2xl font-black leading-none\">{stats.pulpito}</p>\r\n                        <p className=\"text-[10px] font-black uppercase tracking-widest text-muted-foreground/60\">{t('hermanos.statsPulpito')}</p>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"w-[1px] h-10 bg-white/10\" />\r\n\r\n                <div className=\"flex items-center gap-4 group cursor-default\">\r\n                    <div className=\"w-12 h-12 rounded-2xl bg-accent/10 flex items-center justify-center text-accent group-hover:scale-110 transition-transform\">\r\n                        <Users className=\"w-6 h-6\" />\r\n                    </div>\r\n                    <div>\r\n                        <p className=\"text-2xl font-black leading-none\">{stats.total}</p>\r\n                        <p className=\"text-[10px] font-black uppercase tracking-widest text-muted-foreground/60\">{t('hermanos.statsTotal')}</p>\r\n                    </div>\r\n                </div>\r\n            </motion.div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\hermanos\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\hermanos\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\himnario\\HimnarioClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\himnario\\HimnarioClient.tsx:157:13\n  155 |     useEffect(() => {\n  156 |         if (!isCalcModalOpen) {\n> 157 |             setIsDragging(false)\n      |             ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  158 |             setDragY(0)\n  159 |             setTouchStart(null)\n  160 |             setTouchEnd(null)","line":157,"column":13,"nodeType":null,"endLine":157,"endColumn":26},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":237,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":237,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9480,9483],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9480,9483],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * HimnarioClient - IDMJI Gestor de P├║lpito\r\n * \r\n * Componente cliente para explorar el cat├ílogo de himnos y coros.\r\n * Permite filtrar por tipo, n├║mero o t├¡tulo y visualizar duraciones.\r\n * \r\n * Caracter├¡sticas:\r\n * - Cambio de pesta├▒as (Himnos/Coros) con animaciones fluidas\r\n * - Buscador en tiempo real\r\n * - Lista optimizada con duraciones y numeraci├│n visual\r\n * - Soporte multiidioma (ES/CA)\r\n * \r\n * @author Antigravity AI\r\n * @date 2024-12-18\r\n */\r\n\r\n'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport { getHimnos, getCoros } from './actions'\r\nimport { Music, Search, Clock, ChevronLeft, Sparkles, AudioLines, Plus } from 'lucide-react'\r\nimport { Card, CardContent } from '@/components/ui/Card'\r\nimport { useI18n } from '@/lib/i18n/I18nProvider'\r\nimport Link from 'next/link'\r\nimport { Himno, Coro } from '@/types/database'\r\nimport HimnoCoroSelector from '@/components/HimnoCoroSelector'\r\n\r\ninterface HimnarioClientProps {\r\n    initialHimnos: Himno[]\r\n    initialCoros: Coro[]\r\n    counts: { himnos: number, coros: number }\r\n}\r\n\r\nexport default function HimnarioClient({ initialHimnos, initialCoros, counts }: HimnarioClientProps) {\r\n    const { t } = useI18n()\r\n    const [himnos, setHimnos] = useState<Himno[]>(initialHimnos)\r\n    const [coros, setCoros] = useState<Coro[]>(initialCoros)\r\n    const [activeTab, setActiveTab] = useState<'himnos' | 'coros'>('himnos')\r\n    const [searchTerm, setSearchTerm] = useState('')\r\n    const [isLoading, setIsLoading] = useState(false)\r\n    const [isCalcModalOpen, setIsCalcModalOpen] = useState(false)\r\n    const [touchStart, setTouchStart] = useState<{ x: number; y: number } | null>(null)\r\n    const [touchEnd, setTouchEnd] = useState<{ x: number; y: number } | null>(null)\r\n    const [dragY, setDragY] = useState(0)\r\n    const [isDragging, setIsDragging] = useState(false)\r\n\r\n    // Efecto para recarga de datos con debounce\r\n    useEffect(() => {\r\n        /**\r\n         * Carga los datos filtrados bas├índose en la pesta├▒a y b├║squeda\r\n         */\r\n        async function loadData() {\r\n            if (!searchTerm && activeTab === 'himnos' && himnos.length === initialHimnos.length) return\r\n            if (!searchTerm && activeTab === 'coros' && coros.length === initialCoros.length) return\r\n\r\n            setIsLoading(true)\r\n\r\n            if (activeTab === 'himnos') {\r\n                const result = await getHimnos(searchTerm || undefined)\r\n                if (result.success && result.data) {\r\n                    setHimnos(result.data)\r\n                }\r\n            } else {\r\n                const result = await getCoros(searchTerm || undefined)\r\n                if (result.success && result.data) {\r\n                    setCoros(result.data)\r\n                }\r\n            }\r\n\r\n            setIsLoading(false)\r\n        }\r\n\r\n        const timer = setTimeout(() => {\r\n            loadData()\r\n        }, 300)\r\n        return () => clearTimeout(timer)\r\n    }, [searchTerm, activeTab, himnos.length, coros.length, initialHimnos.length, initialCoros.length])\r\n\r\n    // Bloquear scroll del body cuando modal de calculadora est├í abierto\r\n    useEffect(() => {\r\n        if (isCalcModalOpen && window.innerWidth < 1024) {\r\n            const originalOverflow = document.body.style.overflow\r\n            document.body.style.overflow = 'hidden'\r\n            return () => {\r\n                document.body.style.overflow = originalOverflow\r\n            }\r\n        }\r\n    }, [isCalcModalOpen])\r\n\r\n    // Gestos t├íctiles mejorados para cerrar modal (swipe down con arrastre visual)\r\n    const minSwipeDistance = 80 // Aumentado para mejor control\r\n    const closeThreshold = 150 // Distancia para cerrar autom├íticamente\r\n\r\n    const handleDragStart = (e: React.TouchEvent | React.MouseEvent) => {\r\n        if ('touches' in e) {\r\n            setTouchStart({\r\n                x: e.touches[0].clientX,\r\n                y: e.touches[0].clientY\r\n            })\r\n        } else {\r\n            setTouchStart({\r\n                x: e.clientX,\r\n                y: e.clientY\r\n            })\r\n        }\r\n        setIsDragging(true)\r\n        setDragY(0)\r\n    }\r\n\r\n    const handleDragMove = (e: React.TouchEvent | React.MouseEvent) => {\r\n        if (!touchStart) return\r\n\r\n        let currentY: number\r\n        if ('touches' in e) {\r\n            currentY = e.touches[0].clientY\r\n        } else {\r\n            currentY = e.clientY\r\n        }\r\n\r\n        const deltaY = currentY - touchStart.y\r\n\r\n        // Solo permitir arrastre hacia abajo\r\n        if (deltaY > 0) {\r\n            setDragY(deltaY)\r\n            setTouchEnd({\r\n                x: touchStart.x,\r\n                y: currentY\r\n            })\r\n        }\r\n    }\r\n\r\n    const handleDragEnd = () => {\r\n        if (!touchStart || !touchEnd) {\r\n            setIsDragging(false)\r\n            setDragY(0)\r\n            return\r\n        }\r\n\r\n        const distanceY = touchEnd.y - touchStart.y\r\n\r\n        // Cerrar si se arrastra m├ís del umbral o m├ís del m├¡nimo\r\n        if (distanceY > closeThreshold || (distanceY > minSwipeDistance && isDragging)) {\r\n            setIsCalcModalOpen(false)\r\n        }\r\n\r\n        // Resetear estados\r\n        setIsDragging(false)\r\n        setDragY(0)\r\n        setTouchStart(null)\r\n        setTouchEnd(null)\r\n    }\r\n\r\n    // Resetear drag cuando el modal se cierra\r\n    useEffect(() => {\r\n        if (!isCalcModalOpen) {\r\n            setIsDragging(false)\r\n            setDragY(0)\r\n            setTouchStart(null)\r\n            setTouchEnd(null)\r\n        }\r\n    }, [isCalcModalOpen])\r\n\r\n    /**\r\n     * Formatea segundos a formato MM:SS\r\n     */\r\n    function formatDuration(seconds: number): string {\r\n        const mins = Math.floor(seconds / 60)\r\n        const secs = seconds % 60\r\n        return `${mins}:${secs.toString().padStart(2, '0')}`\r\n    }\r\n\r\n    /**\r\n     * Resalta el t├®rmino de b├║squeda en los t├¡tulos\r\n     */\r\n    function highlightText(text: string, search: string) {\r\n        if (!search.trim()) return text\r\n\r\n        const regex = new RegExp(`(${search.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')})`, 'gi')\r\n        const parts = text.split(regex)\r\n\r\n        return parts.map((part, index) =>\r\n            regex.test(part)\r\n                ? <strong key={index} className=\"text-primary font-black bg-primary/10 px-0.5 rounded shadow-sm\">{part}</strong>\r\n                : part\r\n        )\r\n    }\r\n\r\n    const currentData = activeTab === 'himnos' ? himnos : coros\r\n\r\n    return (\r\n        <div className=\"max-w-6xl mx-auto space-y-8 pb-12 px-4\">\r\n            {/* Breadcrumb y Header */}\r\n            <div className=\"space-y-4\">\r\n                <Link\r\n                    href=\"/dashboard\"\r\n                    className=\"inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-primary transition-colors font-bold group\"\r\n                >\r\n                    <ChevronLeft className=\"w-4 h-4 group-hover:-translate-x-1 transition-transform\" />\r\n                    {t('dashboard.title')}\r\n                </Link>\r\n\r\n                <div className=\"flex flex-col lg:flex-row gap-8 justify-between items-start lg:items-center\">\r\n                    <div className=\"space-y-2\">\r\n                        <h1 className=\"text-4xl lg:text-5xl font-black bg-linear-to-br from-primary via-accent to-primary bg-clip-text text-transparent tracking-tight\">\r\n                            {t('himnario.title')}\r\n                        </h1>\r\n                        <p className=\"text-muted-foreground font-medium flex items-center gap-2\">\r\n                            <Sparkles className=\"w-4 h-4 text-accent\" />\r\n                            {t('himnario.desc')}\r\n                        </p>\r\n                    </div>\r\n\r\n                    <div className=\"relative w-full lg:w-96 group\">\r\n                        <div className=\"absolute inset-0 bg-primary/20 rounded-2xl blur-xl group-focus-within:bg-primary/30 transition-all opacity-0 group-focus-within:opacity-100\" />\r\n                        <div className=\"relative bg-white dark:bg-zinc-800 border border-gray-300 dark:border-zinc-600 rounded-2xl flex items-center px-4 h-14 shadow-lg focus-within:border-blue-500 transition-all\">\r\n                            <Search className=\"w-5 h-5 text-gray-400 dark:text-zinc-500 mr-3\" />\r\n                            <input\r\n                                type=\"text\"\r\n                                placeholder={t('himnario.searchPlaceholder')}\r\n                                className=\"w-full bg-transparent border-none outline-none font-bold placeholder:text-gray-400 dark:placeholder:text-zinc-500 text-gray-900 dark:text-white\"\r\n                                value={searchTerm}\r\n                                onChange={(e) => setSearchTerm(e.target.value)}\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"flex p-1.5 bg-white dark:bg-zinc-800 rounded-2xl w-fit mx-auto sm:mx-0 shadow-lg border border-gray-200 dark:border-zinc-700\">\r\n                {[\r\n                    { id: 'himnos', label: t('himnario.tabsHimnos'), icon: Music, count: counts.himnos },\r\n                    { id: 'coros', label: t('himnario.tabsCoros'), icon: AudioLines, count: counts.coros }\r\n                ].map((tab) => (\r\n                    <button\r\n                        key={tab.id}\r\n                        onClick={() => setActiveTab(tab.id as any)}\r\n                        className={`flex items-center gap-3 px-6 py-3 rounded-xl font-black transition-all ${activeTab === tab.id\r\n                            ? 'bg-blue-600 text-white shadow-lg'\r\n                            : 'text-gray-500 dark:text-zinc-400 hover:bg-gray-100 dark:hover:bg-zinc-700'\r\n                            }`}\r\n                    >\r\n                        <tab.icon className=\"w-5 h-5\" />\r\n                        <span className=\"uppercase tracking-widest text-xs\">{tab.label}</span>\r\n                        <span className={`text-[10px] px-2 py-0.5 rounded-full ${activeTab === tab.id\r\n                            ? 'bg-white/20 text-white'\r\n                            : 'bg-gray-200 dark:bg-zinc-600 text-gray-600 dark:text-zinc-300'\r\n                            }`}>\r\n                            {tab.count}\r\n                        </span>\r\n                    </button>\r\n                ))}\r\n            </div>\r\n\r\n            <div className=\"grid lg:grid-cols-12 gap-8\">\r\n                {/* List Table */}\r\n                <div className=\"lg:col-span-7\">\r\n                    <Card className=\"rounded-[2.5rem] border-none shadow-2xl overflow-hidden min-h-[500px] h-full flex flex-col\">\r\n                        <CardContent className=\"p-0 flex flex-col flex-1 overflow-hidden\">\r\n                            <div className=\"overflow-x-hidden overflow-y-auto no-scrollbar max-w-full flex-1\">\r\n                                <table className=\"w-full table-fixed\">\r\n                                    <thead>\r\n                                        <tr className=\"bg-muted/30 border-b border-border/50 text-left\">\r\n                                            <th className=\"hidden sm:table-cell px-8 py-6 text-xs font-black uppercase tracking-[0.2em] text-muted-foreground w-24\">\r\n                                                {t('himnario.tableNumber')}\r\n                                            </th>\r\n                                            <th className=\"px-6 sm:px-8 py-6 text-xs font-black uppercase tracking-[0.2em] text-muted-foreground w-full\">\r\n                                                {t('himnario.tableTitle')}\r\n                                            </th>\r\n                                            <th className=\"hidden sm:table-cell px-8 py-6 text-xs font-black uppercase tracking-[0.2em] text-muted-foreground text-right w-32\">\r\n                                                {t('himnario.tableDuration')}\r\n                                            </th>\r\n                                        </tr>\r\n                                    </thead>\r\n                                    <tbody className=\"divide-y divide-border/30\">\r\n                                        <AnimatePresence mode=\"wait\">\r\n                                            {isLoading ? (\r\n                                                <motion.tr\r\n                                                    key=\"loading\"\r\n                                                    initial={{ opacity: 0 }}\r\n                                                    animate={{ opacity: 1 }}\r\n                                                    exit={{ opacity: 0 }}\r\n                                                >\r\n                                                    <td colSpan={3} className=\"py-40 text-center\">\r\n                                                        <div className=\"flex flex-col items-center gap-4\">\r\n                                                            <div className=\"w-12 h-12 border-4 border-primary/20 border-t-primary rounded-full animate-spin\" />\r\n                                                            <p className=\"font-bold text-muted-foreground animate-pulse uppercase tracking-widest text-xs\">\r\n                                                                {t('common.loading')}\r\n                                                            </p>\r\n                                                        </div>\r\n                                                    </td>\r\n                                                </motion.tr>\r\n                                            ) : currentData.length === 0 ? (\r\n                                                <motion.tr\r\n                                                    key=\"empty\"\r\n                                                    initial={{ opacity: 0 }}\r\n                                                    animate={{ opacity: 1 }}\r\n                                                    exit={{ opacity: 0 }}\r\n                                                >\r\n                                                    <td colSpan={3} className=\"py-40 text-center\">\r\n                                                        <div className=\"flex flex-col items-center gap-4 opacity-30\">\r\n                                                            <Music className=\"w-20 h-20\" />\r\n                                                            <p className=\"font-black text-xl tracking-tight uppercase italic text-muted-foreground\">\r\n                                                                {t('himnario.noResults')}\r\n                                                            </p>\r\n                                                        </div>\r\n                                                    </td>\r\n                                                </motion.tr>\r\n                                            ) : (\r\n                                                currentData.map((item, index) => (\r\n                                                    <motion.tr\r\n                                                        key={item.id}\r\n                                                        initial={{ opacity: 0, y: 10 }}\r\n                                                        animate={{ opacity: 1, y: 0 }}\r\n                                                        transition={{ delay: index * 0.02 }}\r\n                                                        className=\"group hover:bg-muted/20 transition-all cursor-pointer border-b border-border/10 last:border-0\"\r\n                                                    >\r\n                                                        <td className=\"hidden sm:table-cell px-8 py-6\">\r\n                                                            <div className=\"w-12 h-12 rounded-2xl bg-linear-to-br from-[#0660c6] to-blue-500 flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-blue-500/20 group-hover:scale-110 group-hover:rotate-6 transition-all\">\r\n                                                                {item.numero}\r\n                                                            </div>\r\n                                                        </td>\r\n                                                        <td className=\"px-6 sm:px-8 py-5 sm:py-6 break-words\">\r\n                                                            <div className=\"flex flex-col gap-1 max-w-full\">\r\n                                                                <div className=\"flex items-center gap-2 sm:hidden mb-1\">\r\n                                                                    <span className=\"text-[10px] font-black tracking-widest text-white bg-blue-500 px-2 py-0.5 rounded-full uppercase\">\r\n                                                                        #{item.numero}\r\n                                                                    </span>\r\n                                                                    <span className=\"text-[10px] text-muted-foreground flex items-center gap-1\">\r\n                                                                        <Clock className=\"w-3 h-3\" />\r\n                                                                        {formatDuration(item.duracion_segundos || 0)}\r\n                                                                    </span>\r\n                                                                </div>\r\n                                                                <p className=\"font-black text-base sm:text-lg tracking-tight uppercase group-hover:text-primary transition-colors leading-tight text-foreground\">\r\n                                                                    {highlightText(item.titulo, searchTerm)}\r\n                                                                </p>\r\n                                                            </div>\r\n                                                        </td>\r\n                                                        <td className=\"hidden sm:table-cell px-8 py-6 text-right\">\r\n                                                            <div className=\"inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-muted/50 text-muted-foreground font-black text-xs group-hover:bg-primary/10 group-hover:text-primary transition-colors\">\r\n                                                                <Clock className=\"w-3.5 h-3.5\" />\r\n                                                                {formatDuration(item.duracion_segundos || 0)}\r\n                                                            </div>\r\n                                                        </td>\r\n                                                    </motion.tr>\r\n                                                ))\r\n                                            )}\r\n                                        </AnimatePresence>\r\n                                    </tbody>\r\n                                </table>\r\n                            </div>\r\n                        </CardContent>\r\n\r\n                        {/* Footer del Listado */}\r\n                        {!isLoading && currentData.length > 0 && (\r\n                            <div className=\"px-8 py-6 bg-muted/30 text-xs font-black uppercase tracking-[0.2em] text-muted-foreground text-center sm:text-left flex items-center justify-between\">\r\n                                <span>\r\n                                    {t('himnario.showing')\r\n                                        .replace('{count}', currentData.length.toString())\r\n                                        .replace('{type}', activeTab === 'himnos' ? t('himnario.tabsHimnos') : t('himnario.tabsCoros'))}\r\n                                </span>\r\n                                <div className=\"flex items-center gap-2\">\r\n                                    <div className=\"w-2 h-2 rounded-full bg-emerald-500 animate-pulse\" />\r\n                                    <span className=\"text-[10px]\">Real-time DB Sync</span>\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n                    </Card>\r\n                </div>\r\n\r\n                {/* Sidebar Calculator (Desktop Only) */}\r\n                <div className=\"hidden lg:block lg:col-span-5\">\r\n                    <div className=\"sticky top-6 max-h-[calc(100vh-4rem)] overflow-y-auto no-scrollbar\">\r\n                        <Card className=\"rounded-[2.5rem] border-none shadow-2xl bg-white/80 dark:bg-white/5 backdrop-blur-xl border border-white/20 dark:border-white/10 overflow-hidden\">\r\n                            <CardContent className=\"p-8 space-y-6\">\r\n                                <div className=\"space-y-2\">\r\n                                    <h3 className=\"text-xl font-black tracking-tighter flex items-center gap-3 text-foreground uppercase italic\">\r\n                                        <Clock className=\"w-6 h-6 text-primary\" />\r\n                                        {t('himnario.calculator')}\r\n                                    </h3>\r\n                                    <p className=\"text-[10px] text-muted-foreground font-black uppercase tracking-widest\">\r\n                                        {t('himnario.calculatorDesc')}\r\n                                    </p>\r\n                                </div>\r\n\r\n                                <HimnoCoroSelector\r\n                                    maxHimnos={10}\r\n                                    maxCoros={10}\r\n                                    className=\"bg-transparent\"\r\n                                />\r\n                            </CardContent>\r\n                        </Card>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Mobile Calculator FAB - Visible with solid blue */}\r\n            <motion.button\r\n                initial={{ scale: 0, opacity: 0 }}\r\n                animate={{ scale: 1, opacity: 1 }}\r\n                whileHover={{ scale: 1.1 }}\r\n                whileTap={{ scale: 0.9 }}\r\n                onClick={() => setIsCalcModalOpen(true)}\r\n                className=\"lg:hidden fixed bottom-6 right-6 w-16 h-16 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl shadow-2xl shadow-blue-500/40 flex items-center justify-center z-50 border-2 border-white/30\"\r\n            >\r\n                <div className=\"relative\">\r\n                    <Clock className=\"w-7 h-7\" />\r\n                    <div className=\"absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full border-2 border-white animate-pulse\" />\r\n                </div>\r\n            </motion.button>\r\n\r\n            {/* Mobile Calculator Modal */}\r\n            <AnimatePresence>\r\n                {isCalcModalOpen && (\r\n                    <div className=\"fixed inset-0 z-[110] lg:hidden flex items-end sm:items-center justify-center\">\r\n                        <motion.div\r\n                            initial={{ opacity: 0 }}\r\n                            animate={{ opacity: 1 }}\r\n                            exit={{ opacity: 0 }}\r\n                            className=\"absolute inset-0 bg-black/70 backdrop-blur-md\"\r\n                            onClick={() => setIsCalcModalOpen(false)}\r\n                        />\r\n                        <motion.div\r\n                            initial={{ y: '100%' }}\r\n                            animate={{ \r\n                                y: isDragging ? dragY : 0,\r\n                                opacity: isDragging ? 1 - (dragY / 400) : 1\r\n                            }}\r\n                            exit={{ y: '100%' }}\r\n                            transition={{ \r\n                                type: isDragging ? 'tween' : 'spring', \r\n                                damping: 25, \r\n                                stiffness: 200,\r\n                                duration: isDragging ? 0 : undefined\r\n                            }}\r\n                            style={{ \r\n                                transform: isDragging ? `translateY(${dragY}px)` : undefined \r\n                            }}\r\n                            className=\"relative bg-white dark:bg-zinc-900 w-full sm:max-w-xl h-[90vh] sm:h-auto sm:max-h-[85vh] rounded-t-[2rem] sm:rounded-[2rem] p-5 sm:p-8 shadow-2xl overflow-hidden border border-gray-200 dark:border-zinc-700\"\r\n                            onTouchStart={handleDragStart}\r\n                            onTouchMove={handleDragMove}\r\n                            onTouchEnd={handleDragEnd}\r\n                            onMouseDown={handleDragStart}\r\n                            onMouseMove={handleDragMove}\r\n                            onMouseUp={handleDragEnd}\r\n                        >\r\n                            {/* ├ürea de arrastre mejorada - toda la parte superior es arrastrable */}\r\n                            <div \r\n                                className=\"relative sm:hidden\"\r\n                                onTouchStart={handleDragStart}\r\n                                onTouchMove={handleDragMove}\r\n                                onTouchEnd={handleDragEnd}\r\n                                onMouseDown={handleDragStart}\r\n                                onMouseMove={handleDragMove}\r\n                                onMouseUp={handleDragEnd}\r\n                            >\r\n                                {/* Drag handle mejorado con feedback visual */}\r\n                                <div \r\n                                    className={`mx-auto mb-4 transition-all duration-200 ${\r\n                                        isDragging ? 'scale-110' : 'scale-100'\r\n                                    }`}\r\n                                >\r\n                                    <div \r\n                                        className={`w-12 h-1.5 rounded-full mx-auto cursor-grab active:cursor-grabbing transition-all duration-200 ${\r\n                                            isDragging \r\n                                                ? dragY > closeThreshold \r\n                                                    ? 'bg-red-500 w-16 shadow-lg shadow-red-500/50' \r\n                                                    : 'bg-blue-500 w-14 shadow-lg shadow-blue-500/50'\r\n                                                : 'bg-gray-300 dark:bg-zinc-600'\r\n                                        }`}\r\n                                    />\r\n                                </div>\r\n                                \r\n                                {/* Indicador visual de arrastre */}\r\n                                {isDragging && dragY > 20 && (\r\n                                    <motion.div\r\n                                        initial={{ opacity: 0, y: -10 }}\r\n                                        animate={{ opacity: 1, y: 0 }}\r\n                                        className=\"absolute -top-10 left-1/2 transform -translate-x-1/2 text-xs font-black text-center whitespace-nowrap z-10\"\r\n                                    >\r\n                                        {dragY > closeThreshold ? (\r\n                                            <span className=\"text-red-500 bg-white dark:bg-zinc-900 px-3 py-1 rounded-full shadow-lg\">\r\n                                                Suelta para cerrar\r\n                                            </span>\r\n                                        ) : (\r\n                                            <span className=\"text-blue-500 bg-white dark:bg-zinc-900 px-3 py-1 rounded-full shadow-lg\">\r\n                                                Sigue arrastrando...\r\n                                            </span>\r\n                                        )}\r\n                                    </motion.div>\r\n                                )}\r\n                            </div>\r\n\r\n                            <div className=\"flex items-center justify-between mb-6\">\r\n                                <div className=\"space-y-1\">\r\n                                    <h2 className=\"text-xl sm:text-2xl font-black tracking-tighter text-gray-900 dark:text-white uppercase italic\">Calculadora</h2>\r\n                                    <p className=\"text-[10px] text-gray-500 dark:text-zinc-400 font-black uppercase tracking-widest\">Gesti├│n de tiempos</p>\r\n                                </div>\r\n                                <button\r\n                                    onClick={() => setIsCalcModalOpen(false)}\r\n                                    className=\"p-2.5 bg-gray-100 dark:bg-zinc-800 rounded-xl text-gray-600 dark:text-zinc-400 hover:bg-red-500 hover:text-white transition-all\"\r\n                                >\r\n                                    <Plus className=\"w-5 h-5 rotate-45\" />\r\n                                </button>\r\n                            </div>\r\n\r\n                            <div className=\"overflow-y-auto max-h-[calc(90vh-140px)] sm:max-h-[60vh] no-scrollbar pb-6\">\r\n                                <HimnoCoroSelector\r\n                                    maxHimnos={10}\r\n                                    maxCoros={10}\r\n                                />\r\n                            </div>\r\n                        </motion.div>\r\n                    </div>\r\n                )}\r\n            </AnimatePresence>\r\n        </div>\r\n    )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\himnario\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\himnario\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\himnos\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":163,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":163,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4362,4365],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4362,4365],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server'\r\n\r\nimport { createClient } from '@/lib/supabase/server'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { Himno, Coro, PlanHimnoCoro, ActionResponse } from '@/types/database'\r\n\r\n/**\r\n * Buscar himnos por n├║mero o t├¡tulo\r\n */\r\nexport async function searchHimnos(query: string): Promise<ActionResponse<Himno[]>> {\r\n    const supabase = await createClient()\r\n\r\n    const isNumber = /^\\d+$/.test(query)\r\n\r\n    let searchQuery = supabase\r\n        .from('himnos')\r\n        .select('*')\r\n        .limit(20)\r\n\r\n    if (isNumber) {\r\n        searchQuery = searchQuery.eq('numero', parseInt(query))\r\n    } else {\r\n        searchQuery = searchQuery.ilike('titulo', `%${query}%`)\r\n    }\r\n\r\n    const { data, error } = await searchQuery\r\n\r\n    if (error) {\r\n        return { error: error.message }\r\n    }\r\n\r\n    return { data: data as Himno[] }\r\n}\r\n\r\n/**\r\n * Buscar coros por n├║mero o t├¡tulo\r\n */\r\nexport async function searchCoros(query: string): Promise<ActionResponse<Coro[]>> {\r\n    const supabase = await createClient()\r\n\r\n    const isNumber = /^\\d+$/.test(query)\r\n\r\n    let searchQuery = supabase\r\n        .from('coros')\r\n        .select('*')\r\n        .limit(20)\r\n\r\n    if (isNumber) {\r\n        searchQuery = searchQuery.eq('numero', parseInt(query))\r\n    } else {\r\n        searchQuery = searchQuery.ilike('titulo', `%${query}%`)\r\n    }\r\n\r\n    const { data, error } = await searchQuery\r\n\r\n    if (error) {\r\n        return { error: error.message }\r\n    }\r\n\r\n    return { data: data as Coro[] }\r\n}\r\n\r\n/**\r\n * A├▒adir himno o coro a un culto\r\n */\r\nexport async function addHimnoCoro(\r\n    cultoId: string,\r\n    tipo: 'himno' | 'coro',\r\n    itemId: number,\r\n    orden: number\r\n): Promise<ActionResponse> {\r\n    const supabase = await createClient()\r\n\r\n    // Verificar l├¡mites (3 himnos + 3 coros)\r\n    const { data: existing } = await supabase\r\n        .from('plan_himnos_coros')\r\n        .select('tipo')\r\n        .eq('culto_id', cultoId)\r\n\r\n    const himnosCount = existing?.filter(e => e.tipo === 'himno').length || 0\r\n    const corosCount = existing?.filter(e => e.tipo === 'coro').length || 0\r\n\r\n    if (tipo === 'himno' && himnosCount >= 3) {\r\n        return { error: 'M├íximo 3 himnos permitidos' }\r\n    }\r\n\r\n    if (tipo === 'coro' && corosCount >= 3) {\r\n        return { error: 'M├íximo 3 coros permitidos' }\r\n    }\r\n\r\n    const { error } = await supabase\r\n        .from('plan_himnos_coros')\r\n        .insert({\r\n            culto_id: cultoId,\r\n            tipo,\r\n            himno_id: tipo === 'himno' ? itemId : null,\r\n            coro_id: tipo === 'coro' ? itemId : null,\r\n            orden,\r\n        })\r\n\r\n    if (error) {\r\n        return { error: error.message }\r\n    }\r\n\r\n    // Registrar en movimientos\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (user) {\r\n        await supabase.from('movimientos').insert({\r\n            id_usuario: user.id,\r\n            tipo: 'cambio_himnos_coros',\r\n            descripcion: `A├▒adido ${tipo} al culto`,\r\n            culto_id: cultoId,\r\n        })\r\n    }\r\n\r\n    revalidatePath(`/dashboard/cultos/${cultoId}`)\r\n    return { success: true }\r\n}\r\n\r\n/**\r\n * Eliminar himno o coro de un culto\r\n */\r\nexport async function removeHimnoCoro(planId: string, cultoId: string): Promise<ActionResponse> {\r\n    const supabase = await createClient()\r\n\r\n    const { error } = await supabase\r\n        .from('plan_himnos_coros')\r\n        .delete()\r\n        .eq('id', planId)\r\n\r\n    if (error) {\r\n        return { error: error.message }\r\n    }\r\n\r\n    revalidatePath(`/dashboard/cultos/${cultoId}`)\r\n    return { success: true }\r\n}\r\n\r\n/**\r\n * Obtener himnos y coros de un culto\r\n */\r\nexport async function getHimnosCorosByCulto(cultoId: string): Promise<ActionResponse<PlanHimnoCoro[]>> {\r\n    const supabase = await createClient()\r\n\r\n    const { data, error } = await supabase\r\n        .from('plan_himnos_coros')\r\n        .select(`\r\n            id,\r\n            culto_id,\r\n            tipo,\r\n            orden,\r\n            himno:himnos(id, numero, titulo, duracion_segundos),\r\n            coro:coros(id, numero, titulo, duracion_segundos)\r\n        `)\r\n        .eq('culto_id', cultoId)\r\n        .order('orden', { ascending: true })\r\n\r\n    if (error) {\r\n        return { error: error.message }\r\n    }\r\n\r\n    // Mapear para mantener compatibilidad con la interfaz item_id\r\n    const mappedData = (data as any[])?.map(item => ({\r\n        ...item,\r\n        item_id: item.tipo === 'himno' ? item.himno?.id : item.coro?.id\r\n    }))\r\n\r\n    return { data: mappedData as PlanHimnoCoro[] }\r\n}\r\n\r\n/**\r\n * Actualizar el orden de los himnos y coros de un culto\r\n */\r\nexport async function updateHimnosCorosOrder(\r\n    cultoId: string,\r\n    items: { id: string; orden: number }[]\r\n): Promise<ActionResponse> {\r\n    const supabase = await createClient()\r\n\r\n    // Actualizar cada item con su nuevo orden\r\n    for (const item of items) {\r\n        const { error } = await supabase\r\n            .from('plan_himnos_coros')\r\n            .update({ orden: item.orden })\r\n            .eq('id', item.id)\r\n            .eq('culto_id', cultoId)\r\n\r\n        if (error) {\r\n            return { error: error.message }\r\n        }\r\n    }\r\n\r\n    // Registrar en movimientos\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (user) {\r\n        await supabase.from('movimientos').insert({\r\n            id_usuario: user.id,\r\n            tipo: 'cambio_himnos_coros',\r\n            descripcion: 'Reordenado himnos y coros',\r\n            culto_id: cultoId,\r\n        })\r\n    }\r\n\r\n    revalidatePath(`/dashboard/cultos/${cultoId}`)\r\n    return { success: true }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\layout.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\layout.tsx:124:13\n  122 |     useEffect(() => {\n  123 |         if (isMobileMenuOpen) {\n> 124 |             setIsMobileMenuOpen(false)\n      |             ^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  125 |         }\n  126 |     }, [pathname])\n  127 |","line":124,"column":13,"nodeType":null,"endLine":124,"endColumn":32},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'isMobileMenuOpen'. Either include it or remove the dependency array.","line":126,"column":8,"nodeType":"ArrayExpression","endLine":126,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [isMobileMenuOpen, pathname]","fix":{"range":[4563,4573],"text":"[isMobileMenuOpen, pathname]"}}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":535,"column":29,"nodeType":"JSXOpeningElement","endLine":539,"endColumn":31}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * DashboardLayout - IDMJI Gestor de P├║lpito\r\n * \r\n * Layout principal de la aplicaci├│n autenticada. Proporciona la navegaci├│n\r\n * lateral (sidebar), el marco responsivo y la integraci├│n de temas/idiomas.\r\n * \r\n * Caracter├¡sticas:\r\n * - Sidebar colapsable en desktop y off-canvas en mobile\r\n * - Navegaci├│n inteligente con estados activos resaltados\r\n * - Soporte multiidioma din├ímico (ES/CA)\r\n * - Dise├▒o ultra-premium con Glassmorphism y micro-interacciones\r\n * \r\n * @author Antigravity AI\r\n * @date 2024-12-18\r\n */\r\n\r\n'use client'\r\n\r\nimport React, { useState, useEffect } from 'react'\r\nimport Link from 'next/link'\r\nimport { usePathname } from 'next/navigation'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport {\r\n    LayoutDashboard,\r\n    Calendar,\r\n    BookOpen,\r\n    Music,\r\n    Users,\r\n    BarChart,\r\n    LogOut,\r\n    Menu,\r\n    FileText,\r\n    UserCog,\r\n    ChevronRight,\r\n    Search,\r\n    Globe,\r\n    Moon,\r\n    Sun\r\n} from 'lucide-react'\r\nimport { createClient } from '@/lib/supabase/client'\r\nimport { useRouter } from 'next/navigation'\r\nimport { useI18n } from '@/lib/i18n/I18nProvider'\r\nimport { useTheme } from '@/lib/theme/ThemeProvider'\r\nimport { TranslationKey, Language } from '@/lib/i18n/translations'\r\nimport Image from 'next/image'\r\n\r\nexport default function DashboardLayout({\r\n    children,\r\n}: {\r\n    children: React.ReactNode\r\n}) {\r\n    const { t, language, setLanguage } = useI18n()\r\n    const { isDark, toggleTheme } = useTheme()\r\n    const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false)\r\n    const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false)\r\n    const [userProfile, setUserProfile] = useState<{\r\n        nombre: string | null\r\n        apellidos: string | null\r\n        avatar_url: string | null\r\n        email: string | null\r\n        rol: string | null\r\n    } | null>(null)\r\n    const pathname = usePathname()\r\n    const router = useRouter()\r\n    const supabase = createClient()\r\n\r\n    // Ocultar scrollbar en p├íginas espec├¡ficas\r\n    useEffect(() => {\r\n        const shouldHideScrollbar = pathname?.includes('/admin/users') || pathname?.includes('/hermanos') || pathname?.includes('/profile')\r\n        if (shouldHideScrollbar) {\r\n            document.documentElement.classList.add('no-scrollbar')\r\n            document.body.classList.add('no-scrollbar')\r\n        } else {\r\n            document.documentElement.classList.remove('no-scrollbar')\r\n            document.body.classList.remove('no-scrollbar')\r\n        }\r\n        return () => {\r\n            document.documentElement.classList.remove('no-scrollbar')\r\n            document.body.classList.remove('no-scrollbar')\r\n        }\r\n    }, [pathname])\r\n\r\n    // Fetch user profile on mount\r\n    useEffect(() => {\r\n        async function fetchUserProfile() {\r\n            const { data: { user } } = await supabase.auth.getUser()\r\n            if (user) {\r\n                const { data: profile } = await supabase\r\n                    .from('profiles')\r\n                    .select('nombre, apellidos, avatar_url, rol')\r\n                    .eq('id', user.id)\r\n                    .single()\r\n\r\n                setUserProfile({\r\n                    nombre: profile?.nombre || null,\r\n                    apellidos: profile?.apellidos || null,\r\n                    avatar_url: profile?.avatar_url || null,\r\n                    email: user.email || null,\r\n                    rol: profile?.rol || null\r\n                })\r\n            }\r\n        }\r\n        fetchUserProfile()\r\n    }, [supabase])\r\n\r\n    // Configuraci├│n din├ímica de items del sidebar con i18n\r\n    const sidebarItems = [\r\n        { icon: LayoutDashboard, label: t('nav.dashboard'), href: '/dashboard' },\r\n        { icon: Calendar, label: t('nav.cultos'), href: '/dashboard/cultos' },\r\n        { icon: BookOpen, label: t('nav.lecturas'), href: '/dashboard/lecturas' },\r\n        { icon: Music, label: t('nav.himnario'), href: '/dashboard/himnario' },\r\n        { icon: Users, label: t('nav.hermanos'), href: '/dashboard/hermanos' },\r\n        // Items de administraci├│n (solo para ADMIN)\r\n        ...(userProfile?.rol === 'ADMIN' ? [\r\n            { icon: BarChart, label: t('nav.stats'), href: '/dashboard/admin/stats' },\r\n            { icon: UserCog, label: t('nav.users'), href: '/dashboard/admin/users' },\r\n            { icon: FileText, label: t('nav.audit'), href: '/dashboard/admin/audit' },\r\n        ] : [])\r\n    ]\r\n\r\n    // Cerrar men├║ m├│vil al cambiar de ruta\r\n    useEffect(() => {\r\n        if (isMobileMenuOpen) {\r\n            setIsMobileMenuOpen(false)\r\n        }\r\n    }, [pathname])\r\n\r\n    // Cerrar men├║ m├│vil al redimensionar a desktop\r\n    useEffect(() => {\r\n        const handleResize = () => {\r\n            if (window.innerWidth >= 768) {\r\n                setIsMobileMenuOpen(false)\r\n            }\r\n        }\r\n        window.addEventListener('resize', handleResize)\r\n        return () => window.removeEventListener('resize', handleResize)\r\n    }, [])\r\n\r\n    // Bloquear scroll del body cuando sidebar m├│vil est├í abierto\r\n    useEffect(() => {\r\n        if (isMobileMenuOpen && window.innerWidth < 768) {\r\n            const originalOverflow = document.body.style.overflow\r\n            document.body.style.overflow = 'hidden'\r\n            return () => {\r\n                document.body.style.overflow = originalOverflow\r\n            }\r\n        }\r\n    }, [isMobileMenuOpen])\r\n\r\n    // Gestos t├íctiles para abrir/cerrar sidebar m├│vil\r\n    const [touchStartX, setTouchStartX] = useState<number | null>(null)\r\n    const [touchCurrentX, setTouchCurrentX] = useState<number | null>(null)\r\n    const [isSwiping, setIsSwiping] = useState(false)\r\n\r\n    const minSwipeDistance = 50\r\n    const edgeThreshold = 30 // Umbral para detectar swipe desde el borde izquierdo\r\n\r\n    const handleTouchStart = (e: React.TouchEvent) => {\r\n        const clientX = e.targetTouches[0].clientX\r\n        setTouchStartX(clientX)\r\n        setTouchCurrentX(clientX)\r\n        \r\n        // Si tocamos cerca del borde izquierdo y el men├║ est├í cerrado, activamos el modo swiping\r\n        if (clientX < edgeThreshold && !isMobileMenuOpen) {\r\n            setIsSwiping(true)\r\n        } else if (isMobileMenuOpen) {\r\n            // Si el men├║ ya est├í abierto, permitimos el swiping para cerrarlo\r\n            setIsSwiping(true)\r\n        }\r\n    }\r\n\r\n    const handleTouchMove = (e: React.TouchEvent) => {\r\n        setTouchCurrentX(e.targetTouches[0].clientX)\r\n    }\r\n\r\n    const handleTouchEnd = () => {\r\n        if (!touchStartX || !touchCurrentX) {\r\n            setIsSwiping(false)\r\n            return\r\n        }\r\n\r\n        const distanceX = touchCurrentX - touchStartX\r\n        \r\n        // L├│gica para abrir (swipe de izquierda a derecha)\r\n        if (!isMobileMenuOpen && distanceX > minSwipeDistance && touchStartX < edgeThreshold) {\r\n            setIsMobileMenuOpen(true)\r\n        }\r\n        \r\n        // L├│gica para cerrar (swipe de derecha a izquierda)\r\n        if (isMobileMenuOpen && distanceX < -minSwipeDistance) {\r\n            setIsMobileMenuOpen(false)\r\n        }\r\n\r\n        setIsSwiping(false)\r\n        setTouchStartX(null)\r\n        setTouchCurrentX(null)\r\n    }\r\n\r\n    // Calcular el desplazamiento din├ímico para el efecto elegante\r\n    const dragOffset = isSwiping && touchStartX !== null && touchCurrentX !== null\r\n        ? Math.max(-300, Math.min(0, (isMobileMenuOpen ? 0 : -300) + (touchCurrentX - touchStartX)))\r\n        : isMobileMenuOpen ? 0 : -300\r\n\r\n    /**\r\n     * Maneja el cierre de sesi├│n de forma segura\r\n     */\r\n    async function handleSignOut() {\r\n        await supabase.auth.signOut()\r\n        router.push('/login')\r\n        router.refresh()\r\n    }\r\n\r\n    return (\r\n        <div \r\n            className=\"min-h-screen bg-background selection:bg-primary/20 selection:text-primary overflow-x-hidden no-scrollbar\"\r\n            onTouchStart={handleTouchStart}\r\n            onTouchMove={handleTouchMove}\r\n            onTouchEnd={handleTouchEnd}\r\n        >\r\n            {/* Area de detecci├│n de gestos en el borde izquierdo (Trigger Zone) */}\r\n            <div className=\"fixed left-0 top-0 w-6 h-full z-[120] md:hidden pointer-events-none\" />\r\n\r\n            {/* Mesh Gradient Background */}\r\n            <div className=\"fixed inset-0 overflow-hidden -z-10 pointer-events-none\">\r\n                <div className=\"absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-primary/10 rounded-full blur-[120px]\" />\r\n                <div className=\"absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-accent/10 rounded-full blur-[120px]\" />\r\n            </div>\r\n\r\n            {/* Mobile Overlay */}\r\n            <AnimatePresence>\r\n                {(isMobileMenuOpen || (isSwiping && touchStartX !== null && touchStartX < edgeThreshold)) && (\r\n                    <motion.div\r\n                        initial={{ opacity: 0 }}\r\n                        animate={{ opacity: 1 }}\r\n                        exit={{ opacity: 0 }}\r\n                        className=\"fixed inset-0 bg-black/40 backdrop-blur-sm z-100 md:hidden\"\r\n                        onClick={() => setIsMobileMenuOpen(false)}\r\n                    />\r\n                )}\r\n            </AnimatePresence>\r\n\r\n            {/* Sidebars (Mobile & Desktop) */}\r\n            <AnimatePresence>\r\n                {(isMobileMenuOpen || isSwiping) && (\r\n                    <motion.aside\r\n                        initial={{ x: -300 }}\r\n                        animate={{ x: dragOffset }}\r\n                        exit={{ x: -300 }}\r\n                        transition={isSwiping ? { type: 'tween', duration: 0.1 } : { type: 'spring', damping: 25, stiffness: 200 }}\r\n                        className=\"fixed left-0 top-0 h-full w-[300px] z-110 flex flex-col md:hidden shadow-2xl\"\r\n                    >\r\n                        <SidebarContent\r\n                            isSidebarCollapsed={isSidebarCollapsed}\r\n                            setIsSidebarCollapsed={setIsSidebarCollapsed}\r\n                            sidebarItems={sidebarItems}\r\n                            pathname={pathname}\r\n                            handleSignOut={handleSignOut}\r\n                            t={t}\r\n                            language={language}\r\n                            setLanguage={setLanguage}\r\n                            isDark={isDark}\r\n                            toggleTheme={toggleTheme}\r\n                            userProfile={userProfile}\r\n                        />\r\n                    </motion.aside>\r\n                )}\r\n            </AnimatePresence>\r\n\r\n            <motion.aside\r\n                initial={false}\r\n                animate={{ width: isSidebarCollapsed ? 96 : 280 }}\r\n                className=\"hidden md:flex fixed left-0 top-0 h-full border-r border-border/50 flex-col z-50 shadow-sm\"\r\n            >\r\n                <SidebarContent\r\n                    isSidebarCollapsed={isSidebarCollapsed}\r\n                    setIsSidebarCollapsed={setIsSidebarCollapsed}\r\n                    sidebarItems={sidebarItems}\r\n                    pathname={pathname}\r\n                    handleSignOut={handleSignOut}\r\n                    t={t}\r\n                    language={language}\r\n                    setLanguage={setLanguage}\r\n                    isDark={isDark}\r\n                    toggleTheme={toggleTheme}\r\n                    userProfile={userProfile}\r\n                />\r\n            </motion.aside>\r\n\r\n            {/* Main Area */}\r\n            <main\r\n                className={`min-h-screen transition-all duration-500 ease-in-out ${isSidebarCollapsed ? 'md:ml-24' : 'md:ml-[280px]'\r\n                    } ${pathname?.includes('/admin/users') || pathname?.includes('/hermanos') || pathname?.includes('/profile') ? 'no-scrollbar' : ''}`}\r\n            >\r\n                {/* Mobile Floating Header (Glassmorphism) */}\r\n                <header className=\"sticky top-4 z-90 md:hidden px-4\">\r\n                    <div className=\"glass rounded-4xl border border-white/20 p-4 flex items-center justify-between shadow-xl\">\r\n                        <button\r\n                            onClick={() => setIsMobileMenuOpen(true)}\r\n                            className=\"p-3 bg-primary/10 rounded-2xl text-primary\"\r\n                        >\r\n                            <Menu size={20} />\r\n                        </button>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <div className=\"relative w-8 h-8 rounded-xl overflow-hidden shadow-lg border border-white/20\">\r\n                                <Image\r\n                                    src=\"/logo.jpg\"\r\n                                    alt=\"IDMJI Logo\"\r\n                                    width={32}\r\n                                    height={32}\r\n                                    className=\"w-full h-full object-cover\"\r\n                                />\r\n                            </div>\r\n                            <span className=\"font-black italic text-sm tracking-tighter text-[#063b7a]\">IDMJI Sabadell</span>\r\n                        </div>\r\n                        <button className=\"p-3 bg-muted rounded-2xl\">\r\n                            <Search size={20} className=\"text-muted-foreground\" />\r\n                        </button>\r\n                    </div>\r\n                </header>\r\n\r\n                {/* Page Content with Entrance Animation */}\r\n                <div className={`p-6 md:p-10 lg:p-12 max-w-7xl mx-auto ${pathname?.includes('/admin/users') || pathname?.includes('/hermanos') ? 'no-scrollbar' : ''}`}>\r\n                    <motion.div\r\n                        key={pathname}\r\n                        initial={{ opacity: 0, y: 10 }}\r\n                        animate={{ opacity: 1, y: 0 }}\r\n                        transition={{ duration: 0.4, ease: 'easeOut' }}\r\n                    >\r\n                        {children}\r\n                    </motion.div>\r\n                </div>\r\n            </main>\r\n        </div>\r\n    )\r\n}\r\n\r\n/**\r\n * SidebarContent - Subcomponente estable para el Sidebar\r\n */\r\ninterface NavItem {\r\n    icon: React.ElementType\r\n    label: string\r\n    href: string\r\n}\r\n\r\ninterface SidebarContentProps {\r\n    isSidebarCollapsed: boolean\r\n    setIsSidebarCollapsed: (collapsed: boolean) => void\r\n    sidebarItems: NavItem[]\r\n    pathname: string\r\n    handleSignOut: () => void\r\n    t: (key: TranslationKey) => string\r\n    language: Language\r\n    setLanguage: (lang: Language) => void\r\n    isDark: boolean\r\n    toggleTheme: () => void\r\n    userProfile: {\r\n        nombre: string | null\r\n        apellidos: string | null\r\n        avatar_url: string | null\r\n        email: string | null\r\n        rol: string | null\r\n    } | null\r\n}\r\n\r\nfunction SidebarContent({\r\n    isSidebarCollapsed,\r\n    setIsSidebarCollapsed,\r\n    sidebarItems,\r\n    pathname,\r\n    handleSignOut,\r\n    t,\r\n    language,\r\n    setLanguage,\r\n    isDark,\r\n    toggleTheme,\r\n    userProfile\r\n}: SidebarContentProps) {\r\n    return (\r\n        <div className=\"flex flex-col h-full bg-[#063b7a] dark:bg-black/95 backdrop-blur-xl border-r border-white/10\">\r\n            {/* Logo Area */}\r\n            {/* Logo Area */}\r\n            <div className={`py-8 flex flex-col ${isSidebarCollapsed ? 'items-center px-4' : 'px-8'} border-b border-border/10 gap-6`}>\r\n                {/* Logo Section */}\r\n                {!isSidebarCollapsed ? (\r\n                    <motion.div\r\n                        initial={{ opacity: 0, y: -10 }}\r\n                        animate={{ opacity: 1, y: 0 }}\r\n                        className=\"flex items-center gap-4\"\r\n                    >\r\n                        <div className=\"relative w-12 h-12\">\r\n                            <div className=\"absolute inset-0 bg-primary/20 blur-lg rounded-2xl animate-pulse\" />\r\n                            <Image\r\n                                src=\"/logo.jpg\"\r\n                                alt=\"IDMJI Logo\"\r\n                                width={48}\r\n                                height={48}\r\n                                className=\"relative rounded-2xl shadow-2xl border border-white/20\"\r\n                            />\r\n                        </div>\r\n                        <div className=\"flex flex-col\">\r\n                            <span className=\"text-xl font-black tracking-tighter uppercase italic text-white leading-none\">\r\n                                IDMJI Sabadell\r\n                            </span>\r\n                            <span className=\"text-[10px] font-bold text-white/60 tracking-[0.2em] uppercase mt-1\">\r\n                                Gestor de P├║lpito\r\n                            </span>\r\n                        </div>\r\n                    </motion.div>\r\n                ) : (\r\n                    <Image\r\n                        src=\"/logo.jpg\"\r\n                        alt=\"IDMJI Logo\"\r\n                        width={44}\r\n                        height={44}\r\n                        className=\"rounded-xl shadow-xl hover:scale-110 transition-transform cursor-pointer\"\r\n                    />\r\n                )}\r\n\r\n                {/* Controls (Language & Theme) */}\r\n                {!isSidebarCollapsed && (\r\n                    <div className=\"flex items-center gap-2 w-full\">\r\n                        <motion.button\r\n                            whileHover={{ scale: 1.02 }}\r\n                            whileTap={{ scale: 0.98 }}\r\n                            onClick={() => setLanguage(language === 'es-ES' ? 'ca-ES' : 'es-ES')}\r\n                            className=\"flex-1 flex items-center justify-center gap-2.5 px-4 py-3 rounded-2xl bg-white/10 hover:bg-white/20 border border-white/10 transition-all text-[10px] font-black text-white shadow-sm\"\r\n                        >\r\n                            <Globe className=\"w-4 h-4 text-blue-300\" />\r\n                            <span className=\"tracking-widest\">{language === 'es-ES' ? 'ESPA├æOL' : 'CATAL├Ç'}</span>\r\n                        </motion.button>\r\n\r\n                        <motion.button\r\n                            whileHover={{ scale: 1.05 }}\r\n                            whileTap={{ scale: 0.95 }}\r\n                            onClick={toggleTheme}\r\n                            className=\"flex items-center justify-center w-11 h-11 rounded-2xl bg-white/10 hover:bg-white/20 border border-white/10 transition-all text-white shadow-sm\"\r\n                        >\r\n                            {isDark ? (\r\n                                <Sun className=\"w-4.5 h-4.5 text-amber-400 animate-spin-slow\" />\r\n                            ) : (\r\n                                <Moon className=\"w-4.5 h-4.5 text-blue-200\" />\r\n                            )}\r\n                        </motion.button>\r\n\r\n                        <motion.button\r\n                            whileHover={{ scale: 1.05 }}\r\n                            whileTap={{ scale: 0.95 }}\r\n                            onClick={() => setIsSidebarCollapsed(true)}\r\n                            className=\"hidden md:flex items-center justify-center w-11 h-11 rounded-2xl hover:bg-muted/50 transition-colors text-muted-foreground hover:text-primary\"\r\n                        >\r\n                            <Menu size={18} />\r\n                        </motion.button>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Collapsed state controls */}\r\n                {isSidebarCollapsed && (\r\n                    <div className=\"flex flex-col gap-4\">\r\n                        <motion.button\r\n                            onClick={() => setIsSidebarCollapsed(false)}\r\n                            className=\"p-3 hover:bg-white/10 rounded-xl transition-colors text-white/70 hover:text-white shadow-sm\"\r\n                            whileHover={{ scale: 1.1 }}\r\n                        >\r\n                            <Menu size={20} />\r\n                        </motion.button>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Navigation */}\r\n            <nav className=\"flex-1 py-8 px-4 space-y-2 overflow-y-auto no-scrollbar\">\r\n                {sidebarItems.map((item: NavItem, index: number) => {\r\n                    const isActive = pathname === item.href\r\n                    return (\r\n                        <motion.div\r\n                            key={item.href}\r\n                            initial={{ opacity: 0, x: -10 }}\r\n                            animate={{ opacity: 1, x: 0 }}\r\n                            transition={{ delay: index * 0.05 }}\r\n                        >\r\n                            <Link\r\n                                href={item.href}\r\n                                className={`flex items-center gap-4 px-5 py-4 rounded-[1.25rem] transition-all duration-300 group relative overflow-hidden ${isActive\r\n                                    ? 'text-black shadow-2xl shadow-black/10'\r\n                                    : 'text-white/60 hover:text-white'\r\n                                    }`}\r\n                            >\r\n                                {/* Active background with Glow */}\r\n                                {isActive && (\r\n                                    <motion.div\r\n                                        layoutId=\"activeTab\"\r\n                                        className=\"absolute inset-0 bg-white/95 backdrop-blur-md -z-10\"\r\n                                        initial={false}\r\n                                        transition={{ type: 'spring', stiffness: 400, damping: 30 }}\r\n                                    />\r\n                                )}\r\n\r\n                                {/* Hover effect for non-active */}\r\n                                {!isActive && (\r\n                                    <div className=\"absolute inset-0 bg-primary/10 opacity-0 group-hover:opacity-100 transition-opacity -z-10 blur-xl\" />\r\n                                )}\r\n\r\n                                <item.icon\r\n                                    size={22}\r\n                                    className={`${isActive ? 'text-black scale-110' : 'group-hover:text-white group-hover:scale-110 transition-all duration-300'}`}\r\n                                />\r\n\r\n                                {!isSidebarCollapsed && (\r\n                                    <span className={`font-black text-xs tracking-widest uppercase flex-1 ${isActive ? 'text-black' : ''}`}>\r\n                                        {item.label}\r\n                                    </span>\r\n                                )}\r\n\r\n                                {isActive && !isSidebarCollapsed && (\r\n                                    <motion.div layoutId=\"arrow\" initial={{ x: -10 }} animate={{ x: 0 }}>\r\n                                        <ChevronRight size={16} className=\"text-black/50\" />\r\n                                    </motion.div>\r\n                                )}\r\n                            </Link>\r\n                        </motion.div>\r\n                    )\r\n                })}\r\n            </nav>\r\n\r\n            {/* Footer / User Profile Area */}\r\n            <div className=\"p-4 border-t border-white/10 space-y-3\">\r\n                {/* User Profile */}\r\n                {userProfile && (\r\n                    <Link\r\n                        href=\"/dashboard/profile\"\r\n                        className={`flex items-center gap-3 p-3 rounded-2xl bg-white/5 hover:bg-white/10 transition-all ${isSidebarCollapsed ? 'justify-center' : ''}`}\r\n                    >\r\n                        {userProfile.avatar_url ? (\r\n                            <img\r\n                                src={userProfile.avatar_url}\r\n                                alt=\"\"\r\n                                className=\"w-10 h-10 rounded-xl object-cover border-2 border-white/20\"\r\n                            />\r\n                        ) : (\r\n                            <div className=\"w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center text-white font-bold text-sm border-2 border-white/20\">\r\n                                {userProfile.nombre?.[0]}{userProfile.apellidos?.[0]}\r\n                            </div>\r\n                        )}\r\n                        {!isSidebarCollapsed && (\r\n                            <div className=\"flex-1 min-w-0\">\r\n                                <p className=\"text-sm font-bold text-white truncate\">\r\n                                    {userProfile.nombre} {userProfile.apellidos}\r\n                                </p>\r\n                                <p className=\"text-[10px] text-white/50 truncate\">\r\n                                    {userProfile.email}\r\n                                </p>\r\n                            </div>\r\n                        )}\r\n                    </Link>\r\n                )}\r\n\r\n                {/* Logout button */}\r\n                <motion.button\r\n                    onClick={handleSignOut}\r\n                    className={`flex items-center gap-3 px-4 py-3 w-full rounded-2xl text-red-300 hover:text-red-100 hover:bg-red-500/20 transition-all group font-bold text-sm ${isSidebarCollapsed ? 'justify-center' : ''}`}\r\n                    whileHover={{ x: isSidebarCollapsed ? 0 : 5 }}\r\n                    whileTap={{ scale: 0.98 }}\r\n                >\r\n                    <LogOut size={20} className=\"group-hover:rotate-12 transition-transform\" />\r\n                    {!isSidebarCollapsed && <span>{t('nav.logout')}</span>}\r\n                </motion.button>\r\n\r\n                {/* Versi├│n de la Aplicaci├│n */}\r\n                {!isSidebarCollapsed && (\r\n                    <div className=\"pt-2 mt-2 border-t border-white/5\">\r\n                        <p className=\"text-[9px] font-black uppercase tracking-[0.3em] text-white/30 text-center\">\r\n                            v1.0 ÔÇó IDMJI Sabadell\r\n                        </p>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\lecturas\\LecturasPageClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SearchXIcon' is defined but never used.","line":318,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":318,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * LecturasPageClient - IDMJI Gestor de P├║lpito\r\n * \r\n * Componente cliente para el historial general de lecturas b├¡blicas.\r\n * Permite filtrar por lecturas repetidas, paginaci├│n y visualizaci├│n detallada.\r\n * \r\n * Caracter├¡sticas:\r\n * - Listado cronol├│gico de lecturas\r\n * - Filtro din├ímico de lecturas repetidas (resaltado en rojo)\r\n * - Paginaci├│n integrada con URL\r\n * - Soporte multiidioma (ES/CA)\r\n * \r\n * @author Antigravity AI\r\n * @date 2024-12-18\r\n */\r\n\r\n'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { BookOpen, AlertCircle, ChevronLeft, ChevronRight, History, Calendar, Search as SearchIcon, XCircle } from 'lucide-react'\r\nimport { format } from 'date-fns'\r\nimport { es, ca } from 'date-fns/locale'\r\nimport { useRouter, useSearchParams, usePathname } from 'next/navigation'\r\nimport { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/Card'\r\nimport { Button } from '@/components/ui/Button'\r\nimport { useI18n } from '@/lib/i18n/I18nProvider'\r\nimport { LecturaBiblica } from '@/types/database'\r\nimport Link from 'next/link'\r\n\r\n// Extendemos el tipo para incluir los JOINS de la consulta\r\ninterface LecturaExt extends LecturaBiblica {\r\n    culto: {\r\n        fecha: string\r\n        tipo_culto: {\r\n            nombre: string\r\n        }\r\n    }\r\n    lector: {\r\n        nombre: string\r\n        apellidos: string\r\n    }\r\n}\r\n\r\ninterface LecturasPageClientProps {\r\n    initialLecturas: LecturaExt[]\r\n    initialTotalPages: number\r\n    initialPage: number\r\n}\r\n\r\n/**\r\n * Formatea la cita b├¡blica de forma legible\r\n */\r\nfunction formatCita(lectura: LecturaExt) {\r\n    if (lectura.capitulo_inicio === lectura.capitulo_fin && lectura.versiculo_inicio === lectura.versiculo_fin) {\r\n        return `${lectura.libro} ${lectura.capitulo_inicio}:${lectura.versiculo_inicio}`\r\n    }\r\n    if (lectura.capitulo_inicio === lectura.capitulo_fin) {\r\n        return `${lectura.libro} ${lectura.capitulo_inicio}:${lectura.versiculo_inicio}-${lectura.versiculo_fin}`\r\n    }\r\n    return `${lectura.libro} ${lectura.capitulo_inicio}:${lectura.versiculo_inicio} - ${lectura.capitulo_fin}:${lectura.versiculo_fin}`\r\n}\r\n\r\nexport default function LecturasPageClient({\r\n    initialLecturas,\r\n    initialTotalPages,\r\n    initialPage\r\n}: LecturasPageClientProps) {\r\n    const { t, language } = useI18n()\r\n    const locale = language === 'ca-ES' ? ca : es\r\n    const router = useRouter()\r\n    const pathname = usePathname()\r\n    const searchParams = useSearchParams()\r\n\r\n    // Estado derivado de URL\r\n    const soloRepetidas = searchParams.get('soloRepetidas') === 'true'\r\n    const [searchTerm, setSearchTerm] = useState(searchParams.get('search') || '')\r\n\r\n    // Debounce search update\r\n    useEffect(() => {\r\n        const timer = setTimeout(() => {\r\n            const params = new URLSearchParams(searchParams)\r\n            if (searchTerm) {\r\n                params.set('search', searchTerm)\r\n            } else {\r\n                params.delete('search')\r\n            }\r\n            params.set('page', '1') // Reset page on search\r\n            router.push(`${pathname}?${params.toString()}`)\r\n        }, 500)\r\n\r\n        return () => clearTimeout(timer)\r\n    }, [searchTerm, searchParams, pathname, router])\r\n\r\n    const updateFilter = (newSoloRepetidas: boolean) => {\r\n        const params = new URLSearchParams(searchParams)\r\n        if (newSoloRepetidas) {\r\n            params.set('soloRepetidas', 'true')\r\n        } else {\r\n            params.delete('soloRepetidas')\r\n        }\r\n        params.set('page', '1')\r\n        router.push(`${pathname}?${params.toString()}`)\r\n    }\r\n\r\n    const changePage = (newPage: number) => {\r\n        const params = new URLSearchParams(searchParams)\r\n        params.set('page', newPage.toString())\r\n        router.push(`${pathname}?${params.toString()}`)\r\n    }\r\n\r\n    return (\r\n        <div className=\"max-w-6xl mx-auto space-y-8 pb-12 animate-in fade-in duration-500\">\r\n            {/* Header y Filtros */}\r\n            <div className=\"px-4 md:px-6 py-6 bg-card/30 backdrop-blur-md border-b border-white/5 sticky top-0 z-30 transition-all rounded-b-3xl -mx-2 md:mx-0 shadow-sm\">\r\n                <div className=\"space-y-6\">\r\n                    <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\r\n                        <div className=\"flex items-center gap-3\">\r\n                            <Link\r\n                                href=\"/dashboard\"\r\n                                className=\"inline-flex items-center justify-center w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 text-muted-foreground hover:text-primary transition-colors ring-1 ring-white/10\"\r\n                            >\r\n                                <ChevronLeft className=\"w-5 h-5\" />\r\n                            </Link>\r\n                            <div>\r\n                                <h1 className=\"text-2xl md:text-3xl font-black text-foreground tracking-tight\">\r\n                                    {t('lecturas.title')}\r\n                                </h1>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex flex-col md:flex-row items-stretch md:items-center gap-3\">\r\n                        {/* Buscador Premium */}\r\n                        <div className=\"relative group flex-1 max-w-lg\">\r\n                            <div className=\"absolute inset-0 bg-blue-500/10 blur-lg rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-500\" />\r\n                            <div className=\"relative flex items-center bg-card border border-white/10 shadow-lg rounded-xl h-12 focus-within:ring-2 focus-within:ring-blue-500/50 focus-within:border-blue-500/50 transition-all overflow-hidden\">\r\n                                <SearchIcon className=\"w-5 h-5 text-muted-foreground ml-3 shrink-0 group-focus-within:text-blue-500 transition-colors\" />\r\n                                <input\r\n                                    type=\"text\"\r\n                                    placeholder={t('lecturas.searchPlaceholder') || \"Buscar por libro (ej. Mateo, Salmos)...\"}\r\n                                    className=\"w-full bg-transparent border-none outline-none px-3 text-base font-medium placeholder:text-muted-foreground/60 h-full text-foreground\"\r\n                                    value={searchTerm}\r\n                                    onChange={(e) => setSearchTerm(e.target.value)}\r\n                                />\r\n                                {searchTerm && (\r\n                                    <button\r\n                                        onClick={() => setSearchTerm('')}\r\n                                        className=\"p-2 mr-1 text-muted-foreground hover:text-red-500 hover:bg-red-500/10 rounded-lg transition-all\"\r\n                                    >\r\n                                        <XCircle className=\"w-5 h-5\" />\r\n                                    </button>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Separador m├│vil */}\r\n                        <div className=\"h-px bg-white/10 md:hidden w-full my-1\" />\r\n\r\n                        {/* Filtro Toggle Mejorado */}\r\n                        <button\r\n                            onClick={() => updateFilter(!soloRepetidas)}\r\n                            className={`relative overflow-hidden h-12 px-6 rounded-xl border font-bold text-sm tracking-wide transition-all duration-300 flex items-center justify-center gap-2 group md:w-auto w-full ${soloRepetidas\r\n                                    ? 'bg-red-600 border-red-500 text-white shadow-lg shadow-red-600/20'\r\n                                    : 'bg-card hover:bg-accent/50 border-white/10 text-muted-foreground hover:text-foreground hover:border-white/20'\r\n                                }`}\r\n                        >\r\n                            <span className={`flex items-center justify-center w-5 h-5 rounded-full ${soloRepetidas ? 'bg-white/20' : 'bg-muted/50'} group-hover:scale-110 transition-transform`}>\r\n                                <AlertCircle className={`w-3.5 h-3.5 ${soloRepetidas ? 'text-white' : 'text-muted-foreground'}`} />\r\n                            </span>\r\n                            <span className=\"uppercase text-xs\">{soloRepetidas ? t('lecturas.filterRepeated') : t('lecturas.filterAll')}</span>\r\n\r\n                            {/* Indicador de estado */}\r\n                            {soloRepetidas && (\r\n                                <span className=\"absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent translate-x-[-100%] animate-[shimmer_2s_infinite]\" />\r\n                            )}\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Listado Principal */}\r\n            <Card className=\"mx-2 md:mx-6 overflow-hidden border border-white/5 shadow-2xl bg-card/40 backdrop-blur-xl ring-1 ring-white/5 rounded-3xl\">\r\n                <CardHeader className=\"border-b border-white/5 bg-white/[0.02] py-6 px-6 md:px-8\">\r\n                    <CardTitle className=\"text-xl md:text-2xl flex items-center gap-3\">\r\n                        <div className=\"p-2.5 rounded-xl bg-blue-500/10 text-blue-500\">\r\n                            <History className=\"w-6 h-6\" />\r\n                        </div>\r\n                        {t('lecturas.history')}\r\n                        {searchTerm && (\r\n                            <span className=\"text-sm font-medium text-muted-foreground ml-2 px-3 py-1 rounded-full bg-white/5 border border-white/5\">\r\n                                Resultados para &quot;{searchTerm}&quot;\r\n                            </span>\r\n                        )}\r\n                    </CardTitle>\r\n                </CardHeader>\r\n                <CardContent className=\"p-0\">\r\n                    <div className=\"divide-y divide-white/5\">\r\n                        {initialLecturas.length === 0 ? (\r\n                            <div className=\"flex flex-col items-center justify-center py-32 text-center space-y-6 px-4\">\r\n                                <div className=\"p-6 rounded-full bg-muted/5 ring-1 ring-white/10\">\r\n                                    <SearchIcon className=\"w-12 h-12 text-muted-foreground/30\" />\r\n                                </div>\r\n                                <div className=\"space-y-2 max-w-sm\">\r\n                                    <h3 className=\"text-lg font-bold text-foreground\">\r\n                                        {searchTerm ? 'Sin coincidencias' : t('lecturas.noResults')}\r\n                                    </h3>\r\n                                    <p className=\"text-muted-foreground text-sm leading-relaxed\">\r\n                                        {searchTerm\r\n                                            ? `No hemos encontrado lecturas del libro \"${searchTerm}\". Intenta con otro nombre.`\r\n                                            : t('lecturas.noResultsDesc') || \"A├║n no hay lecturas registradas en el historial.\"}\r\n                                    </p>\r\n                                </div>\r\n                                {searchTerm && (\r\n                                    <Button\r\n                                        variant=\"outline\"\r\n                                        onClick={() => setSearchTerm('')}\r\n                                        className=\"rounded-full px-6 border-white/10 hover:bg-white/5\"\r\n                                    >\r\n                                        Limpiar b├║squeda\r\n                                    </Button>\r\n                                )}\r\n                            </div>\r\n                        ) : (\r\n                            initialLecturas.map((lectura: LecturaExt) => (\r\n                                <div\r\n                                    key={lectura.id}\r\n                                    className={`group relative p-6 transition-all hover:bg-muted/30 ${lectura.es_repetida ? 'bg-red-500/[0.03]' : ''\r\n                                        }`}\r\n                                >\r\n                                    {/* Indicador de repetida lateral */}\r\n                                    {lectura.es_repetida && (\r\n                                        <div className=\"absolute left-0 top-0 bottom-0 w-1.5 bg-red-500 shadow-[2px_0_10px_rgba(239,68,68,0.3)]\" />\r\n                                    )}\r\n\r\n                                    <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-6\">\r\n                                        <div className=\"flex items-start gap-4\">\r\n                                            <div className={`mt-1 p-3 rounded-2xl shadow-sm ${lectura.es_repetida\r\n                                                ? 'bg-red-100 text-red-600 dark:bg-red-900/30'\r\n                                                : 'bg-primary/10 text-primary'\r\n                                                }`}>\r\n                                                {lectura.es_repetida ? <AlertCircle size={24} /> : <BookOpen size={24} />}\r\n                                            </div>\r\n                                            <div className=\"space-y-1\">\r\n                                                <h3 className={`text-2xl font-black tracking-tight ${lectura.es_repetida ? 'text-red-600' : ''}`}>\r\n                                                    {formatCita(lectura)}\r\n                                                </h3>\r\n                                                <div className=\"flex flex-wrap items-center gap-x-3 gap-y-1 text-sm font-medium text-muted-foreground\">\r\n                                                    <span className=\"text-foreground font-bold flex items-center gap-1\">\r\n                                                        <UserIcon className=\"w-3 h-3\" />\r\n                                                        {lectura.lector.nombre} {lectura.lector.apellidos}\r\n                                                    </span>\r\n                                                    <span className=\"opacity-30\">ÔÇó</span>\r\n                                                    <span className=\"flex items-center gap-1\">\r\n                                                        <Calendar className=\"w-3 h-3\" />\r\n                                                        {lectura.culto.tipo_culto.nombre} ({format(new Date(lectura.culto.fecha), 'PP', { locale })})\r\n                                                    </span>\r\n                                                </div>\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        <div className=\"flex items-center gap-3\">\r\n                                            <span className={`px-4 py-1.5 rounded-full text-xs font-black uppercase tracking-widest shadow-sm ${lectura.tipo_lectura === 'introduccion'\r\n                                                ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300'\r\n                                                : 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-300'\r\n                                                }`}>\r\n                                                {lectura.tipo_lectura === 'introduccion' ? t('cultos.intro') : t('cultos.finalizacion')}\r\n                                            </span>\r\n\r\n                                            {lectura.es_repetida && (\r\n                                                <span className=\"flex items-center gap-1 bg-red-600 text-white px-3 py-1.5 rounded-full text-[10px] font-black uppercase tracking-tighter animate-pulse shadow-lg shadow-red-500/20\">\r\n                                                    REPETIDA\r\n                                                </span>\r\n                                            )}\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            ))\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Paginaci├│n Mejorada */}\r\n                    {initialTotalPages > 1 && (\r\n                        <div className=\"p-8 bg-muted/10 border-t border-border/50 flex flex-col sm:flex-row items-center justify-between gap-6\">\r\n                            <p className=\"text-sm font-bold text-muted-foreground uppercase tracking-widest\">\r\n                                {t('lecturas.pageOf')\r\n                                    .replace('{current}', initialPage.toString())\r\n                                    .replace('{total}', initialTotalPages.toString())}\r\n                            </p>\r\n\r\n                            <div className=\"flex items-center gap-3\">\r\n                                <Button\r\n                                    variant=\"outline\"\r\n                                    className=\"rounded-xl font-bold px-6 h-12 glass border-border/50 hover:bg-primary hover:text-white hover:border-primary transition-all active:scale-95\"\r\n                                    disabled={initialPage <= 1}\r\n                                    onClick={() => changePage(initialPage - 1)}\r\n                                >\r\n                                    <ChevronLeft className=\"w-5 h-5 mr-1\" />\r\n                                    {t('lecturas.previous')}\r\n                                </Button>\r\n                                <Button\r\n                                    variant=\"outline\"\r\n                                    className=\"rounded-xl font-bold px-6 h-12 glass border-border/50 hover:bg-primary hover:text-white hover:border-primary transition-all active:scale-95\"\r\n                                    disabled={initialPage >= initialTotalPages}\r\n                                    onClick={() => changePage(initialPage + 1)}\r\n                                >\r\n                                    {t('lecturas.next')}\r\n                                    <ChevronRight className=\"w-5 h-5 ml-1\" />\r\n                                </Button>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </CardContent>\r\n            </Card>\r\n        </div>\r\n    )\r\n}\r\n\r\nfunction SearchXIcon({ className }: { className?: string }) {\r\n    return (\r\n        <svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" strokeWidth={1.5} stroke=\"currentColor\" className={className}>\r\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607ZM10.5 7.5v6m3-3h-6\" />\r\n        </svg>\r\n    )\r\n}\r\n\r\nfunction UserIcon({ className }: { className?: string }) {\r\n    return (\r\n        <svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" strokeWidth={2} stroke=\"currentColor\" className={className}>\r\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z\" />\r\n        </svg>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\lecturas\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":50,"column":120,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":123,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1832,1835],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1832,1835],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":282,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":282,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8149,8152],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8149,8152],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":321,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":321,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9381,9384],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9381,9384],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":336,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":336,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9912,9915],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9912,9915],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server'\r\n\r\nimport { createClient } from '@/lib/supabase/server'\r\nimport { revalidatePath, unstable_noStore as noStore } from 'next/cache'\r\n\r\n/**\r\n * Crear o actualizar lectura b├¡blica\r\n */\r\nexport async function saveLectura(\r\n    cultoId: string,\r\n    tipoLectura: 'introduccion' | 'finalizacion',\r\n    libro: string,\r\n    capituloInicio: number,\r\n    versiculoInicio: number,\r\n    capituloFin: number | null,\r\n    versiculoFin: number | null,\r\n    userId: string\r\n) {\r\n    noStore()\r\n    const supabase = await createClient()\r\n\r\n    // 1. Verificar si ya existe una lectura de este TIPO para este CULTO\r\n    // Si existe, la actualizamos en lugar de insertar una nueva\r\n    const { data: existenteMismoTipo } = await supabase\r\n        .from('lecturas_biblicas')\r\n        .select('id')\r\n        .eq('culto_id', cultoId)\r\n        .eq('tipo_lectura', tipoLectura)\r\n        .limit(1)\r\n        .single()\r\n\r\n    // 2. Buscar si esta CITAS ya existe en otro culto (detecci├│n de repetida)\r\n    const { data: existenteCita } = await supabase\r\n        .from('lecturas_biblicas')\r\n        .select('id, created_at, culto_id, id_usuario_lector, cultos!inner(fecha)')\r\n        .eq('libro', libro)\r\n        .eq('capitulo_inicio', capituloInicio)\r\n        .eq('versiculo_inicio', versiculoInicio)\r\n        .eq('capitulo_fin', capituloFin || capituloInicio)\r\n        .eq('versiculo_fin', versiculoFin || versiculoInicio)\r\n        .eq('es_repetida', false)\r\n        .limit(1)\r\n        .single()\r\n\r\n    if (existenteCita && (!existenteMismoTipo || existenteCita.id !== existenteMismoTipo.id)) {\r\n        return {\r\n            requiresConfirmation: true,\r\n            existingReading: {\r\n                id: existenteCita.id,\r\n                fecha: Array.isArray(existenteCita.cultos) ? existenteCita.cultos[0]?.fecha : (existenteCita.cultos as any)?.fecha,\r\n                lector: existenteCita.id_usuario_lector,\r\n            }\r\n        }\r\n    }\r\n\r\n    const lecturaData = {\r\n        culto_id: cultoId,\r\n        tipo_lectura: tipoLectura,\r\n        libro,\r\n        capitulo_inicio: capituloInicio,\r\n        versiculo_inicio: versiculoInicio,\r\n        capitulo_fin: capituloFin || capituloInicio,\r\n        versiculo_fin: versiculoFin || versiculoInicio,\r\n        id_usuario_lector: userId,\r\n        es_repetida: false,\r\n        lectura_original_id: null,\r\n    }\r\n\r\n    let result\r\n    if (existenteMismoTipo) {\r\n        // Actualizar existente\r\n        result = await supabase\r\n            .from('lecturas_biblicas')\r\n            .update(lecturaData)\r\n            .eq('id', existenteMismoTipo.id)\r\n            .select()\r\n            .single()\r\n    } else {\r\n        // Insertar nueva\r\n        result = await supabase\r\n            .from('lecturas_biblicas')\r\n            .insert(lecturaData)\r\n            .select()\r\n            .single()\r\n    }\r\n\r\n    if (result.error) {\r\n        return { error: result.error.message }\r\n    }\r\n\r\n    revalidatePath(`/dashboard/cultos/${cultoId}`)\r\n    return { success: true, data: result.data }\r\n}\r\n\r\n/**\r\n * Confirmar lectura repetida\r\n */\r\nexport async function confirmRepeatedLectura(\r\n    cultoId: string,\r\n    tipoLectura: 'introduccion' | 'finalizacion',\r\n    libro: string,\r\n    capituloInicio: number,\r\n    versiculoInicio: number,\r\n    capituloFin: number | null,\r\n    versiculoFin: number | null,\r\n    userId: string,\r\n    lecturaOriginalId: string\r\n) {\r\n    const supabase = await createClient()\r\n\r\n    // Verificar si ya existe una para actualizar\r\n    const { data: existente } = await supabase\r\n        .from('lecturas_biblicas')\r\n        .select('id')\r\n        .eq('culto_id', cultoId)\r\n        .eq('tipo_lectura', tipoLectura)\r\n        .limit(1)\r\n        .single()\r\n\r\n    const lecturaData = {\r\n        culto_id: cultoId,\r\n        tipo_lectura: tipoLectura,\r\n        libro,\r\n        capitulo_inicio: capituloInicio,\r\n        versiculo_inicio: versiculoInicio,\r\n        capitulo_fin: capituloFin || capituloInicio,\r\n        versiculo_fin: versiculoFin || versiculoInicio,\r\n        id_usuario_lector: userId,\r\n        es_repetida: true,\r\n        lectura_original_id: lecturaOriginalId,\r\n    }\r\n\r\n    let result\r\n    if (existente) {\r\n        result = await supabase\r\n            .from('lecturas_biblicas')\r\n            .update(lecturaData)\r\n            .eq('id', existente.id)\r\n            .select()\r\n            .single()\r\n    } else {\r\n        result = await supabase\r\n            .from('lecturas_biblicas')\r\n            .insert(lecturaData)\r\n            .select()\r\n            .single()\r\n    }\r\n\r\n    if (result.error) {\r\n        return { error: result.error.message }\r\n    }\r\n\r\n    revalidatePath(`/dashboard/cultos/${cultoId}`)\r\n    return { success: true, data: result.data }\r\n}\r\n\r\n/**\r\n * Eliminar lectura b├¡blica\r\n */\r\nexport async function deleteLectura(id: string, cultoId?: string) {\r\n    noStore()\r\n    const supabase = await createClient()\r\n    const { error } = await supabase\r\n        .from('lecturas_biblicas')\r\n        .delete()\r\n        .eq('id', id)\r\n\r\n    if (error) {\r\n        return { error: error.message }\r\n    }\r\n\r\n    if (cultoId) {\r\n        revalidatePath(`/dashboard/cultos/${cultoId}`)\r\n    }\r\n\r\n    return { success: true }\r\n}\r\n\r\n/**\r\n * Obtener lecturas de un culto\r\n */\r\nexport async function getLecturasByCulto(cultoId: string) {\r\n    noStore()\r\n    const supabase = await createClient()\r\n\r\n    console.log('Buscando lecturas para culto:', cultoId)\r\n\r\n    const { data, error } = await supabase\r\n        .from('lecturas_biblicas')\r\n        .select('*') // Primero intentamos sin joins para descartar problemas de relaci├│n\r\n        .eq('culto_id', cultoId)\r\n        .order('tipo_lectura', { ascending: true })\r\n\r\n    if (error) {\r\n        console.error('Error en query lecturas:', error)\r\n        return { error: error.message }\r\n    }\r\n\r\n    console.log('Lecturas encontradas (raw):', data?.length)\r\n\r\n    // Si hay datos, intentamos cargar los lectores por separado o con join si es seguro\r\n    if (data && data.length > 0) {\r\n        const { data: dataWithLector, error: errorLector } = await supabase\r\n            .from('lecturas_biblicas')\r\n            .select(`\r\n                *,\r\n                lector:profiles!id_usuario_lector(nombre, apellidos)\r\n            `)\r\n            .eq('culto_id', cultoId)\r\n            .order('tipo_lectura', { ascending: true })\r\n\r\n        if (!errorLector) return { data: dataWithLector }\r\n    }\r\n\r\n    return { data: data || [] }\r\n}\r\n\r\n/**\r\n * Obtener todas las lecturas (para p├ígina de lecturas)\r\n */\r\nexport async function getAllLecturas(\r\n    page: number = 1,\r\n    limit: number = 20,\r\n    filters?: {\r\n        startDate?: string\r\n        endDate?: string\r\n        tipoCulto?: string\r\n        tipoLectura?: string\r\n        soloRepetidas?: boolean\r\n        search?: string\r\n    }\r\n) {\r\n    const supabase = await createClient()\r\n\r\n    let query = supabase\r\n        .from('lecturas_biblicas')\r\n        .select(`\r\n      *,\r\n      culto:cultos!inner(fecha, tipo_culto:culto_types(nombre)),\r\n      lector:profiles!id_usuario_lector(nombre, apellidos)\r\n    `, { count: 'exact' })\r\n        .order('created_at', { ascending: false })\r\n\r\n    if (filters?.search) {\r\n        const searchTerm = filters.search.trim()\r\n        console.log('Searching lecturas with term:', searchTerm)\r\n        // B├║squeda insensible a may├║sculas/min├║sculas parcial en 'libro'\r\n        query = query.ilike('libro', `%${searchTerm}%`)\r\n    }\r\n\r\n    if (filters?.soloRepetidas) {\r\n        query = query.eq('es_repetida', true)\r\n    }\r\n\r\n    if (filters?.tipoLectura) {\r\n        query = query.eq('tipo_lectura', filters.tipoLectura)\r\n    }\r\n\r\n    // Pagination\r\n    const from = (page - 1) * limit\r\n    const to = from + limit - 1\r\n\r\n    const { data, error, count } = await query.range(from, to)\r\n\r\n    if (error) {\r\n        return { error: error.message }\r\n    }\r\n\r\n    return {\r\n        data,\r\n        count: count || 0,\r\n        totalPages: count ? Math.ceil(count / limit) : 0\r\n    }\r\n}\r\n\r\n/**\r\n * Obtener lista de libros de la Biblia\r\n */\r\nexport async function getBibliaLibros() {\r\n    try {\r\n        const supabase = await createClient()\r\n        let allRows: any[] = []\r\n        let hasMore = true\r\n        let from = 0\r\n        const step = 400 // Paso peque├▒o para asegurar bypass de l├¡mites\r\n\r\n        while (hasMore) {\r\n            const to = from + step - 1\r\n            const { data, error } = await supabase\r\n                .from('biblia')\r\n                .select('*')\r\n                .order('orden', { ascending: true })\r\n                .order('capitulo', { ascending: true })\r\n                .range(from, to)\r\n\r\n            if (error) {\r\n                console.error(`Error en rango ${from}-${to}:`, error)\r\n                return { error: error.message }\r\n            }\r\n\r\n            if (data && data.length > 0) {\r\n                allRows = [...allRows, ...data]\r\n                if (data.length < step) {\r\n                    hasMore = false\r\n                } else {\r\n                    from += step\r\n                }\r\n            } else {\r\n                hasMore = false\r\n            }\r\n\r\n            // L├¡mite de seguridad\r\n            if (allRows.length > 3000) hasMore = false\r\n        }\r\n\r\n        if (allRows.length === 0) {\r\n            return { data: [] }\r\n        }\r\n\r\n        // Agregamos por libro de forma robusta\r\n        const booksMap = new Map<string, any>()\r\n\r\n        allRows.forEach((row) => {\r\n            const libroNombre = row.libro.trim()\r\n            if (!booksMap.has(libroNombre)) {\r\n                booksMap.set(libroNombre, {\r\n                    id: row.orden,\r\n                    nombre: libroNombre,\r\n                    testamento: row.testamento,\r\n                    abreviatura: row.abreviatura,\r\n                    capitulos: []\r\n                })\r\n            }\r\n\r\n            const book = booksMap.get(libroNombre)\r\n            if (!book.capitulos.some((c: any) => c.n === row.capitulo)) {\r\n                book.capitulos.push({\r\n                    n: row.capitulo,\r\n                    v: row.num_versiculos\r\n                })\r\n            }\r\n        })\r\n\r\n        const finalData = Array.from(booksMap.values()).sort((a, b) => a.id - b.id)\r\n        return { data: finalData }\r\n    } catch (err) {\r\n        console.error('Excepci├│n en getBibliaLibros:', err)\r\n        return { error: 'Error interno del servidor' }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\lecturas\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'count' is assigned a value but never used.","line":20,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getAllLecturas } from './actions'\r\nimport LecturasPageClient from './LecturasPageClient'\r\nimport { unstable_noStore as noStore } from 'next/cache'\r\n\r\n// Forzar renderizado din├ímico para que los searchParams siempre se lean frescos\r\nexport const dynamic = 'force-dynamic'\r\n\r\ninterface Props {\r\n    searchParams: Promise<{ [key: string]: string | string[] | undefined }>\r\n}\r\n\r\nexport default async function LecturasPage({ searchParams }: Props) {\r\n    noStore() // Disable caching so searches always work\r\n\r\n    const params = await searchParams\r\n    const page = Number(params['page']) || 1\r\n    const soloRepetidas = params['soloRepetidas'] === 'true'\r\n    const search = typeof params['search'] === 'string' ? params['search'] : undefined\r\n\r\n    const { data: lecturas, count, totalPages } = await getAllLecturas(page, 20, {\r\n        soloRepetidas,\r\n        search\r\n    })\r\n\r\n    return (\r\n        <LecturasPageClient\r\n            initialLecturas={lecturas || []}\r\n            initialTotalPages={totalPages || 1}\r\n            initialPage={page}\r\n        />\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\profile\\ProfileClient.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":191,"column":45,"nodeType":"JSXOpeningElement","endLine":191,"endColumn":124}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * ProfileClient - IDMJI Gestor de P├║lpito\r\n * \r\n * Componente cliente para la gesti├│n integral del perfil del usuario.\r\n * Fusiona perfil y configuraci├│n en una sola interfaz premium.\r\n * \r\n * Caracter├¡sticas:\r\n * - Edici├│n de datos personales (Nombre, Apellidos)\r\n * - Sincronizaci├│n de datos de contacto (Email, Tel├®fono)\r\n * - Gesti├│n de Avatar con recorte, zoom y rotaci├│n\r\n * - Preferencias de aplicaci├│n (Modo Oscuro, Notificaciones)\r\n * - Dise├▒o Glassmorphism ultra-premium y 100% responsivo\r\n * \r\n * @author Antigravity AI\r\n * @date 2024-12-23\r\n */\r\n\r\n'use client'\r\n\r\nimport { useState, useRef } from 'react'\r\nimport { motion } from 'framer-motion'\r\nimport { \r\n    User, Mail, Phone, Shield, Moon, Globe, Sun, \r\n    Camera, Loader2, Sparkles, UserCircle, \r\n    Calendar, Save, AlertCircle, Trash2\r\n} from 'lucide-react'\r\nimport { useI18n } from '@/lib/i18n/I18nProvider'\r\nimport { useTheme } from '@/lib/theme/ThemeProvider'\r\nimport { Profile } from '@/types/database'\r\nimport { Card, CardContent } from '@/components/ui/Card'\r\nimport { Input } from '@/components/ui/Input'\r\nimport { Label } from '@/components/ui/label'\r\nimport { Button } from '@/components/ui/Button'\r\nimport { Dialog, DialogContent, DialogHeader, DialogFooter, DialogTitle, DialogDescription } from '@/components/ui/Dialog'\r\nimport { toast } from 'sonner'\r\nimport { updateProfile, uploadAvatar, deleteAvatar } from './actions'\r\nimport AvatarEditor from '@/components/AvatarEditor'\r\nimport { obtenerIniciales } from '@/lib/helpers'\r\n\r\ninterface ProfileClientProps {\r\n    profile: Profile | null\r\n    email: string\r\n}\r\n\r\nexport default function ProfileClient({ profile, email }: ProfileClientProps) {\r\n    const { t, language, setLanguage } = useI18n()\r\n    const { isDark, toggleTheme } = useTheme()\r\n    \r\n    // Form States\r\n    const [formData, setFormData] = useState({\r\n        nombre: profile?.nombre || '',\r\n        apellidos: profile?.apellidos || '',\r\n        email_contacto: profile?.email_contacto || '',\r\n        telefono: profile?.telefono || ''\r\n    })\r\n    const [isLoading, setIsLoading] = useState(false)\r\n    const [isSaving, setIsSaving] = useState(false)\r\n\r\n    // Avatar States\r\n    const [avatarPreview, setAvatarPreview] = useState<string | null>(profile?.avatar_url || null)\r\n    const [isCropOpen, setIsCropOpen] = useState(false)\r\n    const [tempImageSrc, setTempImageSrc] = useState<string | null>(null)\r\n    const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false)\r\n    const fileInputRef = useRef<HTMLInputElement>(null)\r\n\r\n    // Handlers\r\n    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const { name, value } = e.target\r\n        setFormData(prev => ({ ...prev, [name]: value }))\r\n    }\r\n\r\n    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        if (e.target.files && e.target.files.length > 0) {\r\n            const file = e.target.files[0]\r\n            const reader = new FileReader()\r\n            reader.addEventListener('load', () => setTempImageSrc(reader.result?.toString() || null))\r\n            reader.readAsDataURL(file)\r\n            setIsCropOpen(true)\r\n        }\r\n    }\r\n\r\n    const handleCropSave = async (croppedBlob: Blob) => {\r\n        setIsLoading(true)\r\n        try {\r\n            const data = new FormData()\r\n            data.append('avatar', croppedBlob, 'avatar.jpg')\r\n            \r\n            const result = await uploadAvatar(data)\r\n            if (result.success && result.data) {\r\n                setAvatarPreview(result.data)\r\n                toast.success(t('profile.avatarSuccess'))\r\n            } else {\r\n                toast.error(result.error || 'Error al subir avatar')\r\n            }\r\n        } catch (error) {\r\n            console.error(error)\r\n            toast.error('Error inesperado al subir avatar')\r\n        } finally {\r\n            setIsLoading(false)\r\n            setIsCropOpen(false)\r\n            setTempImageSrc(null)\r\n        }\r\n    }\r\n\r\n    const handleDeleteAvatar = async () => {\r\n        if (!avatarPreview) return\r\n        \r\n        setIsDeleteDialogOpen(false)\r\n        setIsLoading(true)\r\n        try {\r\n            const result = await deleteAvatar()\r\n            if (result.success) {\r\n                setAvatarPreview(null)\r\n                toast.success('Avatar eliminado correctamente')\r\n            } else {\r\n                toast.error(result.error || 'Error al eliminar avatar')\r\n            }\r\n        } catch (error) {\r\n            console.error(error)\r\n            toast.error('Error inesperado al eliminar avatar')\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault()\r\n        setIsSaving(true)\r\n        \r\n        try {\r\n            const result = await updateProfile(formData)\r\n            if (result.success) {\r\n                toast.success(t('profile.saveSuccess'))\r\n            } else {\r\n                toast.error(result.error || 'Error al actualizar perfil')\r\n            }\r\n        } catch (error: unknown) {\r\n            console.error(error)\r\n            toast.error(error instanceof Error ? error.message : 'Error inesperado')\r\n        } finally {\r\n            setIsSaving(false)\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"max-w-5xl mx-auto space-y-8 pb-12 px-4 no-scrollbar\">\r\n            {/* Header con Animaci├│n */}\r\n            <div className=\"space-y-2\">\r\n                <motion.div \r\n                    initial={{ opacity: 0, y: -20 }}\r\n                    animate={{ opacity: 1, y: 0 }}\r\n                    className=\"flex items-center gap-3\"\r\n                >\r\n                    <div className=\"p-2 bg-primary/10 rounded-xl\">\r\n                        <UserCircle className=\"w-6 h-6 text-primary\" />\r\n                    </div>\r\n                    <h1 className=\"text-4xl lg:text-5xl font-black bg-gradient-to-br from-primary via-accent to-primary bg-clip-text text-transparent tracking-tight\">\r\n                        {t('profile.title')}\r\n                    </h1>\r\n                </motion.div>\r\n                <motion.p \r\n                    initial={{ opacity: 0 }}\r\n                    animate={{ opacity: 1 }}\r\n                    transition={{ delay: 0.1 }}\r\n                    className=\"text-muted-foreground font-medium flex items-center gap-2\"\r\n                >\r\n                    <Sparkles className=\"w-4 h-4 text-accent\" />\r\n                    {t('profile.desc')}\r\n                </motion.p>\r\n            </div>\r\n\r\n            <form onSubmit={handleSubmit} className=\"grid gap-8 lg:grid-cols-3\">\r\n                {/* Panel Lateral: Avatar y Rol */}\r\n                <motion.div\r\n                    initial={{ opacity: 0, x: -20 }}\r\n                    animate={{ opacity: 1, x: 0 }}\r\n                    transition={{ delay: 0.2 }}\r\n                    className=\"lg:col-span-1 space-y-6\"\r\n                >\r\n                    <Card className=\"rounded-[2.5rem] border-none shadow-2xl group glass\">\r\n                        <CardContent className=\"p-8 text-center space-y-6 overflow-visible\">\r\n                            {/* Avatar Editable */}\r\n                            <div className=\"relative mx-auto w-44 h-44 group/avatar\">\r\n                                <div className=\"absolute inset-0 bg-primary/20 rounded-full blur-2xl group-hover/avatar:bg-primary/40 transition-all\" />\r\n                                <div \r\n                                    className=\"relative w-full h-full rounded-full bg-gradient-to-br from-primary via-accent to-primary p-1 shadow-xl cursor-pointer hover:scale-105 transition-transform\"\r\n                                    onClick={() => fileInputRef.current?.click()}\r\n                                >\r\n                                    <div className=\"w-full h-full rounded-full bg-background flex items-center justify-center overflow-hidden border-4 border-background relative\">\r\n                                        {avatarPreview ? (\r\n                                            <img src={avatarPreview} alt=\"Avatar\" className=\"w-full h-full object-cover\" />\r\n                                        ) : (\r\n                                            <div className={`w-full h-full flex flex-col items-center justify-center ${isDark ? 'bg-gradient-to-br from-primary via-accent to-primary' : 'bg-gradient-to-br from-blue-200 via-blue-100 to-blue-200'}`}>\r\n                                                <span className={`text-5xl font-black tracking-tighter drop-shadow-sm ${isDark ? 'text-white' : 'text-black'}`}>\r\n                                                    {obtenerIniciales(formData.nombre, formData.apellidos) || 'U'}\r\n                                                </span>\r\n                                            </div>\r\n                                        )}\r\n                                        \r\n                                        {/* Overlay de Edici├│n */}\r\n                                        <div className=\"absolute inset-0 bg-black/40 opacity-0 group-hover/avatar:opacity-100 flex flex-col items-center justify-center transition-opacity\">\r\n                                            <Camera className=\"w-8 h-8 text-white mb-2\" />\r\n                                            <span className=\"text-[10px] font-black text-white uppercase tracking-widest\">{t('users.form.change')}</span>\r\n                                        </div>\r\n                                        \r\n                                        {isLoading && (\r\n                                            <div className=\"absolute inset-0 bg-black/60 flex items-center justify-center\">\r\n                                                <Loader2 className=\"w-8 h-8 text-white animate-spin\" />\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                                <input \r\n                                    ref={fileInputRef}\r\n                                    type=\"file\"\r\n                                    accept=\"image/*\"\r\n                                    className=\"hidden\"\r\n                                    onChange={handleFileChange}\r\n                                />\r\n                                \r\n                                {/* Bot├│n Eliminar Avatar - Solo visible cuando hay avatar */}\r\n                                {avatarPreview && !isLoading && (\r\n                                    <button\r\n                                        type=\"button\"\r\n                                        onClick={(e) => {\r\n                                            e.stopPropagation()\r\n                                            setIsDeleteDialogOpen(true)\r\n                                        }}\r\n                                        className=\"absolute -bottom-2 left-1/2 -translate-x-1/2 px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white text-[10px] font-black uppercase tracking-widest rounded-xl shadow-lg transition-all flex items-center gap-1.5 z-10\"\r\n                                    >\r\n                                        <Trash2 className=\"w-3 h-3\" />\r\n                                        Eliminar\r\n                                    </button>\r\n                                )}\r\n                            </div>\r\n\r\n                            <div className=\"space-y-2\">\r\n                                <h2 className=\"text-2xl font-black tracking-tight truncate\">\r\n                                    {formData.nombre} {formData.apellidos}\r\n                                </h2>\r\n                                <div className=\"inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-primary/10 text-primary border border-primary/20\">\r\n                                    <Shield className=\"w-3.5 h-3.5\" />\r\n                                    <span className=\"text-[10px] font-black uppercase tracking-widest\">{profile?.rol || 'MIEMBRO'}</span>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Info de Acceso (Lectura) */}\r\n                            <div className=\"pt-4 border-t border-border/50 space-y-4\">\r\n                                <div className=\"flex items-center gap-2 text-left\">\r\n                                    <div className=\"p-2 bg-muted rounded-xl\">\r\n                                        <Calendar className=\"w-4 h-4 text-muted-foreground\" />\r\n                                    </div>\r\n                                    <div>\r\n                                        <p className=\"text-[10px] font-black text-muted-foreground uppercase tracking-widest\">{t('profile.registeredAt')}</p>\r\n                                        <p className=\"text-sm font-bold\">\r\n                                            {profile?.created_at ? new Date(profile.created_at).toLocaleDateString(language === 'es-ES' ? 'es' : 'ca') : 'ÔÇö'}\r\n                                        </p>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </CardContent>\r\n                    </Card>\r\n                </motion.div>\r\n\r\n                {/* Panel Principal: Formulario */}\r\n                <motion.div\r\n                    initial={{ opacity: 0, x: 20 }}\r\n                    animate={{ opacity: 1, x: 0 }}\r\n                    transition={{ delay: 0.3 }}\r\n                    className=\"lg:col-span-2 space-y-8\"\r\n                >\r\n                    {/* Secci├│n: Datos Personales */}\r\n                    <Card className=\"rounded-[2.5rem] border-none shadow-xl glass\">\r\n                        <CardContent className=\"p-8 space-y-8 overflow-visible\">\r\n                            <div>\r\n                                <h3 className=\"text-xl font-black uppercase tracking-tighter flex items-center gap-3\">\r\n                                    <div className=\"p-2 bg-primary/10 rounded-xl\">\r\n                                        <User className=\"w-5 h-5 text-primary\" />\r\n                                    </div>\r\n                                    {t('profile.info')}\r\n                                </h3>\r\n                            </div>\r\n\r\n                            <div className=\"grid gap-6 md:grid-cols-2\">\r\n                                <div className=\"space-y-2\">\r\n                                    <Label htmlFor=\"nombre\" className=\"text-[10px] font-black uppercase tracking-widest text-muted-foreground ml-1\">\r\n                                        {t('profile.firstName')}\r\n                                    </Label>\r\n                                    <Input\r\n                                        id=\"nombre\"\r\n                                        name=\"nombre\"\r\n                                        value={formData.nombre}\r\n                                        onChange={handleInputChange}\r\n                                        required\r\n                                        className=\"h-14 rounded-2xl bg-white/5 border-border/50 focus:ring-2 focus:ring-primary/50 font-bold px-5\"\r\n                                    />\r\n                                </div>\r\n                                <div className=\"space-y-2\">\r\n                                    <Label htmlFor=\"apellidos\" className=\"text-[10px] font-black uppercase tracking-widest text-muted-foreground ml-1\">\r\n                                        {t('profile.lastName')}\r\n                                    </Label>\r\n                                    <Input\r\n                                        id=\"apellidos\"\r\n                                        name=\"apellidos\"\r\n                                        value={formData.apellidos}\r\n                                        onChange={handleInputChange}\r\n                                        required\r\n                                        className=\"h-14 rounded-2xl bg-white/5 border-border/50 focus:ring-2 focus:ring-primary/50 font-bold px-5\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n\r\n                                {/* Secci├│n de Contacto */}\r\n                                <div className=\"pt-4 space-y-6\">\r\n                                    <div className=\"flex items-center gap-2 px-2\">\r\n                                        <div className=\"h-px flex-1 bg-white/5\" />\r\n                                        <span className=\"text-[10px] font-black text-muted-foreground/40 uppercase tracking-widest\">\r\n                                            {t('profile.contactInfo')}\r\n                                        </span>\r\n                                        <div className=\"h-px flex-1 bg-white/5\" />\r\n                                    </div>\r\n\r\n                                <div className=\"grid gap-6 md:grid-cols-2\">\r\n                                    <div className=\"space-y-2\">\r\n                                        <Label htmlFor=\"email_contacto\" className=\"text-[10px] font-black uppercase tracking-widest text-muted-foreground ml-1\">\r\n                                            {t('profile.contactEmail')}\r\n                                        </Label>\r\n                                        <div className=\"relative\">\r\n                                            <Mail className=\"absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground/50\" />\r\n                                            <Input\r\n                                                id=\"email_contacto\"\r\n                                                name=\"email_contacto\"\r\n                                                type=\"email\"\r\n                                                value={formData.email_contacto}\r\n                                                onChange={handleInputChange}\r\n                                                placeholder=\"email@ejemplo.com\"\r\n                                                className=\"h-14 rounded-2xl bg-white/5 border-border/50 focus:ring-2 focus:ring-primary/50 font-bold pl-12 pr-5\"\r\n                                            />\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"space-y-2\">\r\n                                        <Label htmlFor=\"telefono\" className=\"text-[10px] font-black uppercase tracking-widest text-muted-foreground ml-1\">\r\n                                            {t('profile.phone')}\r\n                                        </Label>\r\n                                        <div className=\"relative\">\r\n                                            <Phone className=\"absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground/50\" />\r\n                                            <Input\r\n                                                id=\"telefono\"\r\n                                                name=\"telefono\"\r\n                                                type=\"tel\"\r\n                                                value={formData.telefono}\r\n                                                onChange={handleInputChange}\r\n                                                placeholder=\"+34 600 000 000\"\r\n                                                className=\"h-14 rounded-2xl bg-white/5 border-border/50 focus:ring-2 focus:ring-primary/50 font-bold pl-12 pr-5\"\r\n                                            />\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* Bot├│n Guardar Centrado */}\r\n                                <div className=\"flex justify-center pt-6\">\r\n                                    <Button \r\n                                        type=\"submit\" \r\n                                        disabled={isSaving}\r\n                                        className={`rounded-2xl px-8 py-3 font-black uppercase tracking-widest text-xs h-12 shadow-xl border-2 text-white hover:shadow-2xl disabled:opacity-50 disabled:cursor-not-allowed transition-all ${\r\n                                            isDark \r\n                                                ? 'bg-primary border-primary/50 hover:bg-primary/90 shadow-primary/40' \r\n                                                : 'bg-blue-600 border-blue-700 hover:bg-blue-700 shadow-blue-500/50'\r\n                                        }`}\r\n                                    >\r\n                                        {isSaving ? <Loader2 className=\"w-5 h-5 animate-spin mr-2 text-white\" /> : <Save className=\"w-5 h-5 mr-2 text-white\" />}\r\n                                        <span className=\"text-white font-black\">{t('common.save')}</span>\r\n                                    </Button>\r\n                                </div>\r\n                            </div>\r\n                        </CardContent>\r\n                    </Card>\r\n\r\n                    {/* Secci├│n: Cuenta y Preferencias */}\r\n                    <div className=\"grid gap-8 md:grid-cols-2\">\r\n                        {/* Cuenta de Acceso (Lectura) */}\r\n                        <Card className=\"rounded-[2.5rem] border-none shadow-xl glass\">\r\n                            <CardContent className=\"p-8 space-y-6 overflow-visible\">\r\n                                <h3 className=\"text-lg font-black uppercase tracking-tighter flex items-center gap-3\">\r\n                                    <div className=\"p-2 bg-amber-500/10 rounded-xl\">\r\n                                        <Shield className=\"w-5 h-5 text-amber-500\" />\r\n                                    </div>\r\n                                    {t('profile.account')}\r\n                                </h3>\r\n\r\n                                <div className=\"space-y-4\">\r\n                                    <div className=\"p-4 rounded-2xl bg-muted/30 border border-border/50 relative overflow-hidden group\">\r\n                                        <div className=\"absolute right-3 top-3 px-2 py-1 bg-muted rounded-lg text-[8px] font-black uppercase tracking-widest text-muted-foreground\">\r\n                                            {t('profile.readOnly')}\r\n                                        </div>\r\n                                        <Label className=\"text-[10px] font-black uppercase tracking-widest text-muted-foreground ml-1\">\r\n                                            {t('profile.loginEmail')}\r\n                                        </Label>\r\n                                        <p className=\"font-bold text-sm truncate mt-1\">{email}</p>\r\n                                    </div>\r\n                                    \r\n                                    <div className=\"flex items-center gap-2 p-3 bg-blue-500/5 rounded-2xl border border-blue-500/10 text-blue-600 dark:text-blue-400\">\r\n                                        <AlertCircle className=\"w-4 h-4 shrink-0\" />\r\n                                        <p className=\"text-[10px] font-bold leading-tight\">\r\n                                            El email de inicio de sesi├│n es gestionado por el administrador para garantizar la seguridad.\r\n                                        </p>\r\n                                    </div>\r\n                                </div>\r\n                            </CardContent>\r\n                        </Card>\r\n\r\n                        {/* Preferencias de Aplicaci├│n */}\r\n                        <Card className=\"rounded-[2.5rem] border-none shadow-xl glass\">\r\n                            <CardContent className=\"p-8 space-y-6 overflow-visible\">\r\n                                <h3 className=\"text-lg font-black uppercase tracking-tighter flex items-center gap-3\">\r\n                                    <div className=\"p-2 bg-accent/10 rounded-xl\">\r\n                                        <Sparkles className=\"w-5 h-5 text-accent\" />\r\n                                    </div>\r\n                                    {t('profile.preferences')}\r\n                                </h3>\r\n\r\n                                <div className=\"space-y-4\">\r\n                                    {/* Selector de Tema */}\r\n                                    <div className=\"flex items-center justify-between p-4 rounded-2xl bg-muted/30 border border-border/50\">\r\n                                        <div className=\"flex items-center gap-3\">\r\n                                            <div className=\"p-2 bg-background rounded-xl shadow-sm\">\r\n                                                {isDark ? <Moon className=\"w-4 h-4 text-primary\" /> : <Sun className=\"w-4 h-4 text-amber-500\" />}\r\n                                            </div>\r\n                                            <div>\r\n                                                <p className=\"font-bold text-xs uppercase tracking-tight\">{t('profile.darkMode')}</p>\r\n                                                <p className=\"text-[10px] text-muted-foreground font-medium\">{t('profile.darkModeDesc')}</p>\r\n                                            </div>\r\n                                        </div>\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            onClick={toggleTheme}\r\n                                            className={`relative w-12 h-7 rounded-full transition-colors duration-300 ${isDark ? 'bg-primary' : 'bg-zinc-300'}`}\r\n                                        >\r\n                                            <motion.div\r\n                                                className=\"absolute top-1 left-1 w-5 h-5 bg-white rounded-full shadow-md\"\r\n                                                animate={{ x: isDark ? 20 : 0 }}\r\n                                                transition={{ type: 'spring', stiffness: 500, damping: 30 }}\r\n                                            />\r\n                                        </button>\r\n                                    </div>\r\n\r\n                                    {/* Selector de Idioma */}\r\n                                    <div className=\"flex flex-col gap-3 p-4 rounded-2xl bg-muted/30 border border-border/50\">\r\n                                        <div className=\"flex items-center justify-center gap-2\">\r\n                                            <div className=\"p-2 bg-background rounded-xl shadow-sm\">\r\n                                                <Globe className=\"w-4 h-4 text-blue-500\" />\r\n                                            </div>\r\n                                            <p className=\"font-bold text-xs uppercase tracking-tight\">{t('profile.language')}</p>\r\n                                        </div>\r\n                                        <div className={`flex gap-1 p-1 rounded-xl shadow-inner justify-center ${isDark ? 'bg-muted/50' : 'bg-muted/30'}`}>\r\n                                            <button\r\n                                                type=\"button\"\r\n                                                onClick={() => setLanguage('es-ES')}\r\n                                                className={`px-3 py-1.5 rounded-lg text-xs font-black transition-all ${\r\n                                                    language === 'es-ES' \r\n                                                        ? isDark \r\n                                                            ? 'bg-primary text-white shadow-lg shadow-primary/40' \r\n                                                            : 'bg-blue-600 text-white shadow-lg shadow-blue-500/40'\r\n                                                        : isDark\r\n                                                            ? 'bg-transparent text-muted-foreground hover:bg-muted/50 hover:text-foreground'\r\n                                                            : 'bg-white text-foreground hover:bg-muted/50 shadow-sm'\r\n                                                }`}\r\n                                            >\r\n                                                ES\r\n                                            </button>\r\n                                            <button\r\n                                                type=\"button\"\r\n                                                onClick={() => setLanguage('ca-ES')}\r\n                                                className={`px-3 py-1.5 rounded-lg text-xs font-black transition-all ${\r\n                                                    language === 'ca-ES' \r\n                                                        ? isDark \r\n                                                            ? 'bg-primary text-white shadow-lg shadow-primary/40' \r\n                                                            : 'bg-blue-600 text-white shadow-lg shadow-blue-500/40'\r\n                                                        : isDark\r\n                                                            ? 'bg-transparent text-muted-foreground hover:bg-muted/50 hover:text-foreground'\r\n                                                            : 'bg-white text-foreground hover:bg-muted/50 shadow-sm'\r\n                                                }`}\r\n                                            >\r\n                                                CA\r\n                                            </button>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            </CardContent>\r\n                        </Card>\r\n                    </div>\r\n\r\n                    {/* Notificaciones Push */}\r\n                    {/* <Card className=\"rounded-[2.5rem] border-none shadow-xl glass overflow-hidden\">\r\n                        <CardContent className=\"p-8\">\r\n                            <PushNotificationToggle />\r\n                        </CardContent>\r\n                    </Card> */}\r\n                </motion.div>\r\n            </form>\r\n\r\n            {/* Modal de Edici├│n de Avatar */}\r\n            {tempImageSrc && (\r\n                <AvatarEditor\r\n                    imageSrc={tempImageSrc}\r\n                    isOpen={isCropOpen}\r\n                    onClose={() => { setIsCropOpen(false); setTempImageSrc(null) }}\r\n                    onSave={handleCropSave}\r\n                />\r\n            )}\r\n\r\n            {/* Di├ílogo de Confirmaci├│n para Eliminar Avatar */}\r\n            <Dialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>\r\n                <DialogContent className=\"rounded-2xl border-none shadow-2xl glass p-0 overflow-hidden\">\r\n                    <DialogHeader className=\"p-6 pb-4\">\r\n                        <div className=\"flex items-center gap-3 mb-2\">\r\n                            <div className=\"p-2 bg-red-500/10 rounded-xl\">\r\n                                <Trash2 className=\"w-5 h-5 text-red-500\" />\r\n                            </div>\r\n                            <DialogTitle className=\"text-xl font-black uppercase tracking-tight\">\r\n                                Eliminar Avatar\r\n                            </DialogTitle>\r\n                        </div>\r\n                        <DialogDescription className=\"text-sm text-muted-foreground\">\r\n                            ┬┐Est├ís seguro de que deseas eliminar tu foto de perfil? Esta acci├│n no se puede deshacer y se eliminar├í permanentemente del sistema.\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n                    <DialogFooter className=\"p-6 pt-0 gap-2\">\r\n                        <Button\r\n                            variant=\"outline\"\r\n                            onClick={() => setIsDeleteDialogOpen(false)}\r\n                            className=\"rounded-xl\"\r\n                        >\r\n                            Cancelar\r\n                        </Button>\r\n                        <Button\r\n                            variant=\"destructive\"\r\n                            onClick={handleDeleteAvatar}\r\n                            disabled={isLoading}\r\n                            className=\"rounded-xl bg-red-500 hover:bg-red-600 text-white\"\r\n                        >\r\n                            {isLoading ? (\r\n                                <>\r\n                                    <Loader2 className=\"w-4 h-4 animate-spin mr-2\" />\r\n                                    Eliminando...\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    <Trash2 className=\"w-4 h-4 mr-2\" />\r\n                                    Eliminar\r\n                                </>\r\n                            )}\r\n                        </Button>\r\n                    </DialogFooter>\r\n                </DialogContent>\r\n            </Dialog>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\profile\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":89,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3040,3043],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3040,3043],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":173,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":173,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6241,6244],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6241,6244],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":239,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":239,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8582,8585],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8582,8585],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Perfil Actions - IDMJI Gestor de P├║lpito\r\n * \r\n * L├│gica del servidor para la gesti├│n de perfiles y avatares.\r\n * Implementa limpieza autom├ítica de storage y sincronizaci├│n de datos.\r\n * \r\n * Caracter├¡sticas:\r\n * - Actualizaci├│n de perfil con validaci├│n Zod\r\n * - Subida de avatar con limpieza de archivos antiguos\r\n * - Revalidaci├│n de rutas afectadas (hermanos, users, profile)\r\n * \r\n * @author Antigravity AI\r\n * @date 2024-12-23\r\n */\r\n\r\n'use server'\r\n\r\nimport { createClient } from '@/lib/supabase/server'\r\nimport { ActionResponse } from '@/types/database'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { z } from 'zod'\r\n\r\n// Esquema de validaci├│n para la actualizaci├│n del perfil\r\nconst updateProfileSchema = z.object({\r\n    nombre: z.string().min(1, 'El nombre es obligatorio'),\r\n    apellidos: z.string().min(1, 'Los apellidos son obligatorios'),\r\n    email_contacto: z.string().email('Email de contacto inv├ílido').optional().or(z.literal('')).nullable(),\r\n    telefono: z.string().optional().or(z.literal('')).nullable()\r\n})\r\n\r\n/**\r\n * Actualiza los datos del perfil del usuario actual.\r\n * Sincroniza nombre, apellidos, email de contacto y tel├®fono.\r\n * \r\n * @param updates Datos a actualizar\r\n * @returns Promesa con la respuesta de la acci├│n\r\n */\r\nexport async function updateProfile(\r\n    updates: { \r\n        nombre: string, \r\n        apellidos: string, \r\n        email_contacto?: string | null, \r\n        telefono?: string | null \r\n    }\r\n): Promise<ActionResponse<void>> {\r\n    try {\r\n        const supabase = await createClient()\r\n\r\n        const { data: { user } } = await supabase.auth.getUser()\r\n        if (!user) return { success: false, error: 'No autenticado' }\r\n\r\n        // Validar datos con Zod\r\n        const parsed = updateProfileSchema.safeParse(updates)\r\n        if (!parsed.success) {\r\n            const errorMsg = parsed.error.errors[0]?.message || 'Datos inv├ílidos'\r\n            return { success: false, error: errorMsg }\r\n        }\r\n\r\n        const { error } = await supabase\r\n            .from('profiles')\r\n            .update({\r\n                nombre: updates.nombre,\r\n                apellidos: updates.apellidos,\r\n                email_contacto: updates.email_contacto || null,\r\n                telefono: updates.telefono || null\r\n            })\r\n            .eq('id', user.id)\r\n\r\n        if (error) throw error\r\n\r\n        const fullName = `${updates.nombre} ${updates.apellidos}`.trim()\r\n        \r\n        // Actualizar metadatos del usuario en Auth\r\n        await supabase.auth.updateUser({\r\n            data: { \r\n                nombre: updates.nombre,\r\n                apellidos: updates.apellidos,\r\n                full_name: fullName,\r\n                display_name: fullName\r\n            }\r\n        })\r\n\r\n        // Revalidar rutas afectadas para reflejar los cambios al instante\r\n        revalidatePath('/dashboard/profile')\r\n        revalidatePath('/dashboard/hermanos')\r\n        revalidatePath('/dashboard/admin/users')\r\n\r\n        return { success: true }\r\n    } catch (error: any) {\r\n        console.error('Error updating profile:', error)\r\n        return { success: false, error: error.message || 'Error al actualizar perfil' }\r\n    }\r\n}\r\n\r\n/**\r\n * Sube un nuevo avatar y elimina el anterior del Storage para optimizar espacio.\r\n * \r\n * @param formData FormData con el archivo 'avatar'\r\n * @returns Promesa con la URL del nuevo avatar\r\n */\r\nexport async function uploadAvatar(formData: FormData): Promise<ActionResponse<string>> {\r\n    try {\r\n        const supabase = await createClient()\r\n\r\n        const { data: { user } } = await supabase.auth.getUser()\r\n        if (!user) return { success: false, error: 'No autenticado' }\r\n\r\n        const file = formData.get('avatar') as File\r\n        if (!file) return { success: false, error: 'No se proporcion├│ archivo' }\r\n\r\n        // 1. Obtener el perfil actual para identificar el avatar antiguo\r\n        const { data: profile } = await supabase\r\n            .from('profiles')\r\n            .select('avatar_url')\r\n            .eq('id', user.id)\r\n            .single()\r\n\r\n        // 2. Generar nombre ├║nico y subir nuevo archivo\r\n        const fileExt = file.name.split('.').pop()\r\n        const fileName = `${user.id}-${Date.now()}.${fileExt}`\r\n        const filePath = `${fileName}`\r\n\r\n        const { error: uploadError } = await supabase.storage\r\n            .from('avatars')\r\n            .upload(filePath, file, { \r\n                upsert: true,\r\n                contentType: file.type\r\n            })\r\n\r\n        if (uploadError) throw uploadError\r\n\r\n        const { data: { publicUrl } } = supabase.storage\r\n            .from('avatars')\r\n            .getPublicUrl(filePath)\r\n\r\n        // 3. Limpieza: Borrar el avatar antiguo del storage si exist├¡a uno diferente\r\n        if (profile?.avatar_url) {\r\n            try {\r\n                const urlParts = profile.avatar_url.split('/')\r\n                const oldFileName = urlParts[urlParts.length - 1]\r\n                \r\n                // Solo borrar si el nombre del archivo es diferente al nuevo\r\n                if (oldFileName && oldFileName !== fileName) {\r\n                    await supabase.storage\r\n                        .from('avatars')\r\n                        .remove([oldFileName])\r\n                    console.log('Avatar antiguo eliminado del storage:', oldFileName)\r\n                }\r\n            } catch (deleteError) {\r\n                console.warn('No se pudo eliminar el avatar antiguo (no cr├¡tico):', deleteError)\r\n            }\r\n        }\r\n\r\n        // 4. Actualizar la referencia en el perfil del usuario\r\n        const { error: updateError } = await supabase\r\n            .from('profiles')\r\n            .update({ avatar_url: publicUrl })\r\n            .eq('id', user.id)\r\n\r\n        if (updateError) throw updateError\r\n\r\n        // Sincronizar tambi├®n con metadatos de auth\r\n        await supabase.auth.updateUser({\r\n            data: { avatar_url: publicUrl }\r\n        })\r\n\r\n        // Revalidar rutas para actualizar la UI globalmente\r\n        revalidatePath('/dashboard/profile')\r\n        revalidatePath('/dashboard/hermanos')\r\n        revalidatePath('/dashboard/admin/users')\r\n\r\n        return { success: true, data: publicUrl }\r\n    } catch (error: any) {\r\n        console.error('Error uploading avatar:', error)\r\n        return { success: false, error: error.message || 'Error al subir avatar' }\r\n    }\r\n}\r\n\r\n/**\r\n * Elimina el avatar del usuario del Storage y actualiza el perfil.\r\n * \r\n * @returns Promesa con la respuesta de la acci├│n\r\n */\r\nexport async function deleteAvatar(): Promise<ActionResponse<void>> {\r\n    try {\r\n        const supabase = await createClient()\r\n\r\n        const { data: { user } } = await supabase.auth.getUser()\r\n        if (!user) return { success: false, error: 'No autenticado' }\r\n\r\n        // 1. Obtener el perfil actual para identificar el avatar a eliminar\r\n        const { data: profile } = await supabase\r\n            .from('profiles')\r\n            .select('avatar_url')\r\n            .eq('id', user.id)\r\n            .single()\r\n\r\n        if (!profile?.avatar_url) {\r\n            return { success: false, error: 'No hay avatar para eliminar' }\r\n        }\r\n\r\n        // 2. Extraer el nombre del archivo de la URL\r\n        const urlParts = profile.avatar_url.split('/')\r\n        const fileName = urlParts[urlParts.length - 1]\r\n\r\n        // 3. Eliminar el archivo del Storage\r\n        if (fileName) {\r\n            const { error: deleteError } = await supabase.storage\r\n                .from('avatars')\r\n                .remove([fileName])\r\n\r\n            if (deleteError) {\r\n                console.warn('Error al eliminar del storage (continuando):', deleteError)\r\n                // Continuamos aunque falle la eliminaci├│n del storage\r\n            } else {\r\n                console.log('Avatar eliminado del storage:', fileName)\r\n            }\r\n        }\r\n\r\n        // 4. Actualizar el perfil para eliminar la referencia al avatar\r\n        const { error: updateError } = await supabase\r\n            .from('profiles')\r\n            .update({ avatar_url: null })\r\n            .eq('id', user.id)\r\n\r\n        if (updateError) throw updateError\r\n\r\n        // 5. Actualizar tambi├®n los metadatos de auth\r\n        await supabase.auth.updateUser({\r\n            data: { avatar_url: null }\r\n        })\r\n\r\n        // 6. Revalidar rutas para actualizar la UI globalmente\r\n        revalidatePath('/dashboard/profile')\r\n        revalidatePath('/dashboard/hermanos')\r\n        revalidatePath('/dashboard/admin/users')\r\n\r\n        return { success: true }\r\n    } catch (error: any) {\r\n        console.error('Error deleting avatar:', error)\r\n        return { success: false, error: error.message || 'Error al eliminar avatar' }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\profile\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\dashboard\\template.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\forgot-password\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'redirect' is defined but never used.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server'\r\n\r\nimport { createClient } from '@/lib/supabase/server'\r\nimport { redirect } from 'next/navigation'\r\n\r\nexport async function resetPassword(formData: FormData) {\r\n    const supabase = await createClient()\r\n\r\n    const email = formData.get('email') as string\r\n\r\n    const { error } = await supabase.auth.resetPasswordForEmail(email, {\r\n        redirectTo: `${process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'}/auth/callback?next=/dashboard/profile/reset-password`,\r\n    })\r\n\r\n    if (error) {\r\n        return { error: error.message }\r\n    }\r\n\r\n    return { success: 'Revisa tu email para continuar' }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\forgot-password\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\login\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\login\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ChevronRight' is defined but never used.","line":19,"column":41,"nodeType":null,"messageId":"unusedVar","endLine":19,"endColumn":53},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":101,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":101,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * P├ígina de Login - IDMJI Gestor de P├║lpito\r\n * \r\n * Caracter├¡sticas:\r\n * - Login como p├ígina principal (no hay registro p├║blico)\r\n * - Selector de idioma (ES/CA)\r\n * - Toggle modo oscuro\r\n * - Visibilidad de contrase├▒a\r\n * - Recordar credenciales (localStorage)\r\n * - Logo y textos configurables desde Supabase\r\n * - Dise├▒o glassmorphism con animaciones\r\n */\r\n\r\n'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { useRouter } from 'next/navigation'\r\nimport { motion } from 'framer-motion'\r\nimport { Eye, EyeOff, Globe, Moon, Sun, ChevronRight, LogIn } from 'lucide-react'\r\nimport { login, getPublicConfig } from './actions'\r\nimport { useI18n } from '@/lib/i18n/I18nProvider'\r\nimport { useTheme } from '@/lib/theme/ThemeProvider'\r\nimport Image from 'next/image'\r\n\r\nexport default function LoginPage() {\r\n    const router = useRouter()\r\n    const { t, language, setLanguage } = useI18n()\r\n    const { isDark, toggleTheme } = useTheme()\r\n\r\n    // Estados del formulario\r\n    const [config, setConfig] = useState({\r\n        title: 'IDMJI Gestor de P├║lpito',\r\n        subtitle: 'Iglesia de Dios Ministerial de Jesucristo Internacional',\r\n        location: 'Sabadell, Espa├▒a',\r\n        colorClass: 'from-primary to-accent'\r\n    })\r\n\r\n    useEffect(() => {\r\n        getPublicConfig().then(data => {\r\n            if (data) {\r\n                setConfig({\r\n                    title: data.app_name || 'IDMJI Gestor de P├║lpito',\r\n                    subtitle: data.church_name || 'Iglesia de Dios Ministerial de Jesucristo Internacional',\r\n                    location: data.church_location || 'Sabadell, Espa├▒a',\r\n                    colorClass: data.login_title_color || 'from-primary to-accent'\r\n                })\r\n            }\r\n        })\r\n    }, [])\r\n\r\n    const [email, setEmail] = useState('')\r\n    const [password, setPassword] = useState('')\r\n    const [showPassword, setShowPassword] = useState(false)\r\n    const [rememberMe, setRememberMe] = useState(false)\r\n    const [isLoading, setIsLoading] = useState(false)\r\n    const [error, setError] = useState('')\r\n\r\n    // Cargar credenciales guardadas al montar\r\n    useEffect(() => {\r\n        const savedEmail = localStorage.getItem('idmji_email')\r\n        const savedPassword = localStorage.getItem('idmji_password')\r\n        const savedRemember = localStorage.getItem('idmji_remember') === 'true'\r\n\r\n        if (savedRemember && savedEmail && savedPassword) {\r\n            setEmail(savedEmail)\r\n            setPassword(savedPassword)\r\n            setRememberMe(true)\r\n        }\r\n    }, [])\r\n\r\n    // Manejar submit del formulario\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault()\r\n        setError('')\r\n        setIsLoading(true)\r\n\r\n        try {\r\n            const formData = new FormData()\r\n            formData.append('email', email)\r\n            formData.append('password', password)\r\n\r\n            const result = await login(formData)\r\n\r\n            if (result?.error) {\r\n                setError(result.error)\r\n            } else if (result?.success) {\r\n                // Guardar credenciales si \"recordar\" est├í activo\r\n                if (rememberMe) {\r\n                    localStorage.setItem('idmji_email', email)\r\n                    localStorage.setItem('idmji_password', password)\r\n                    localStorage.setItem('idmji_remember', 'true')\r\n                } else {\r\n                    localStorage.removeItem('idmji_email')\r\n                    localStorage.removeItem('idmji_password')\r\n                    localStorage.removeItem('idmji_remember')\r\n                }\r\n\r\n                router.push('/dashboard')\r\n                router.refresh()\r\n            }\r\n        } catch (err) {\r\n            setError('Error al iniciar sesi├│n')\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"min-h-screen flex items-center justify-center p-4 relative overflow-hidden\">\r\n            {/* Fondo con gradiente animado */}\r\n            <div className=\"absolute inset-0 gradient-mesh opacity-30\" />\r\n            <div className=\"absolute inset-0 bg-linear-to-br from-primary/10 via-transparent to-accent/10\" />\r\n\r\n            {/* Contenedor Principal Centrado (Envuelve controles y card para que est├®n apilados) */}\r\n            <div className=\"flex flex-col items-center w-full max-w-md relative z-10\">\r\n\r\n                {/* Controles de idioma y tema (Ahora para todos los dispositivos: Arriba y Centrado) */}\r\n                <motion.div\r\n                    initial={{ y: -20, opacity: 0 }}\r\n                    animate={{ y: 0, opacity: 1 }}\r\n                    transition={{ delay: 0.1 }}\r\n                    className=\"flex gap-4 mb-6 z-50 pointer-events-auto\"\r\n                >\r\n                    <motion.button\r\n                        whileHover={{ scale: 1.05, translateY: -2 }}\r\n                        whileTap={{ scale: 0.95 }}\r\n                        onClick={() => setLanguage(language === 'es-ES' ? 'ca-ES' : 'es-ES')}\r\n                        className=\"glass px-4 py-2.5 rounded-2xl hover:bg-white/30 transition-all font-bold shadow-lg backdrop-blur-md border-white/20 flex items-center gap-2 group text-foreground\"\r\n                    >\r\n                        <Globe className=\"w-5 h-5 group-hover:text-primary transition-colors\" />\r\n                        <span className=\"text-sm font-black tracking-wide\">\r\n                            {language === 'es-ES' ? 'ES' : 'CA'}\r\n                        </span>\r\n                    </motion.button>\r\n\r\n                    <motion.button\r\n                        whileHover={{ scale: 1.05, translateY: -2 }}\r\n                        whileTap={{ scale: 0.95 }}\r\n                        onClick={toggleTheme}\r\n                        className=\"glass px-4 py-2.5 rounded-2xl hover:bg-white/30 transition-all shadow-lg backdrop-blur-md border-white/20 flex items-center gap-2 group\"\r\n                    >\r\n                        {isDark ? (\r\n                            <Sun className=\"w-5 h-5 text-amber-400 group-hover:rotate-90 transition-transform duration-500\" />\r\n                        ) : (\r\n                            <Moon className=\"w-5 h-5 text-indigo-400 group-hover:-rotate-12 transition-transform duration-500\" />\r\n                        )}\r\n                    </motion.button>\r\n                </motion.div>\r\n\r\n                {/* Card de login */}\r\n                <motion.div\r\n                    initial={{ opacity: 0, y: 20 }}\r\n                    animate={{ opacity: 1, y: 0 }}\r\n                    transition={{ duration: 0.5 }}\r\n                    className=\"glass rounded-4xl p-8 md:p-12 w-full relative shadow-2xl border-white/20\"\r\n                >\r\n                    {/* Logo m├ís grande */}\r\n                    <motion.div\r\n                        initial={{ scale: 0.8, opacity: 0 }}\r\n                        animate={{ scale: 1, opacity: 1 }}\r\n                        transition={{ delay: 0.2, duration: 0.5 }}\r\n                        className=\"flex justify-center mb-4\"\r\n                    >\r\n                        <div className=\"relative w-48 h-48\">\r\n                            <Image\r\n                                src=\"/logo.jpg\"\r\n                                alt=\"Logo IDMJI\"\r\n                                fill\r\n                                sizes=\"(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw\"\r\n                                className=\"object-contain rounded-2xl\"\r\n                                priority\r\n                            />\r\n                        </div>\r\n                    </motion.div>\r\n\r\n\r\n\r\n\r\n                    {/* T├¡tulo configurable desde Supabase */}\r\n                    <motion.div\r\n                        initial={{ opacity: 0 }}\r\n                        animate={{ opacity: 1 }}\r\n                        transition={{ delay: 0.3 }}\r\n                        className=\"text-center mb-8\"\r\n                    >\r\n                        <h1 className={`text-3xl font-bold mb-2 bg-linear-to-r ${config.colorClass} bg-clip-text text-transparent`}>\r\n                            {config.title}\r\n                        </h1>\r\n                        <p className=\"text-sm text-muted-foreground\">\r\n                            {config.subtitle}\r\n                        </p>\r\n                        <p className=\"text-xs text-muted-foreground\">\r\n                            {config.location}\r\n                        </p>\r\n                    </motion.div>\r\n\r\n                    {/* Formulario */}\r\n                    <form onSubmit={handleSubmit} className=\"space-y-6\">\r\n                        {/* Email */}\r\n                        <motion.div\r\n                            initial={{ x: -20, opacity: 0 }}\r\n                            animate={{ x: 0, opacity: 1 }}\r\n                            transition={{ delay: 0.4 }}\r\n                        >\r\n                            <label className=\"block text-sm font-medium mb-2\">\r\n                                {t('login.email')}\r\n                            </label>\r\n                            <input\r\n                                type=\"email\"\r\n                                value={email}\r\n                                onChange={(e) => setEmail(e.target.value)}\r\n                                required\r\n                                className=\"w-full bg-background/50 border border-border rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary/50 transition-all\"\r\n                                placeholder=\"ejemplo@idmji.org\"\r\n                            />\r\n                        </motion.div>\r\n\r\n                        {/* Contrase├▒a */}\r\n                        <motion.div\r\n                            initial={{ x: -20, opacity: 0 }}\r\n                            animate={{ x: 0, opacity: 1 }}\r\n                            transition={{ delay: 0.5 }}\r\n                        >\r\n                            <label className=\"block text-sm font-medium mb-2\">\r\n                                {t('login.password')}\r\n                            </label>\r\n                            <div className=\"relative\">\r\n                                <input\r\n                                    type={showPassword ? 'text' : 'password'}\r\n                                    value={password}\r\n                                    onChange={(e) => setPassword(e.target.value)}\r\n                                    required\r\n                                    className=\"w-full bg-background/50 border border-border rounded-xl px-4 py-3 pr-12 outline-none focus:ring-2 focus:ring-primary/50 transition-all\"\r\n                                    placeholder=\"ÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇó\"\r\n                                />\r\n                                <button\r\n                                    type=\"button\"\r\n                                    onClick={() => setShowPassword(!showPassword)}\r\n                                    className=\"absolute right-3 top-1/2 -translate-y-1/2 p-2 hover:bg-muted rounded-lg transition-colors\"\r\n                                >\r\n                                    {showPassword ? <EyeOff className=\"w-5 h-5\" /> : <Eye className=\"w-5 h-5\" />}\r\n                                </button>\r\n                            </div>\r\n                        </motion.div>\r\n\r\n                        {/* Recordar credenciales */}\r\n                        <motion.div\r\n                            initial={{ x: -20, opacity: 0 }}\r\n                            animate={{ x: 0, opacity: 1 }}\r\n                            transition={{ delay: 0.6 }}\r\n                            className=\"flex items-center gap-2\"\r\n                        >\r\n                            <input\r\n                                type=\"checkbox\"\r\n                                id=\"remember\"\r\n                                checked={rememberMe}\r\n                                onChange={(e) => setRememberMe(e.target.checked)}\r\n                                className=\"w-4 h-4 rounded border-border text-primary focus:ring-primary/50\"\r\n                            />\r\n                            <label htmlFor=\"remember\" className=\"text-sm cursor-pointer\">\r\n                                Recordar credenciales\r\n                            </label>\r\n                        </motion.div>\r\n\r\n                        {/* Error */}\r\n                        {error && (\r\n                            <motion.div\r\n                                initial={{ opacity: 0, y: -10 }}\r\n                                animate={{ opacity: 1, y: 0 }}\r\n                                className=\"p-3 bg-red-500/10 border border-red-500/30 rounded-xl text-red-600 text-sm\"\r\n                            >\r\n                                {error}\r\n                            </motion.div>\r\n                        )}\r\n\r\n                        {/* Bot├│n de login */}\r\n                        <motion.button\r\n                            initial={{ opacity: 0, y: 10 }}\r\n                            animate={{ opacity: 1, y: 0 }}\r\n                            transition={{ delay: 0.7 }}\r\n                            whileHover={{ scale: 1.02, translateY: -2 }}\r\n                            whileTap={{ scale: 0.98 }}\r\n                            type=\"submit\"\r\n                            disabled={isLoading}\r\n                            className=\"w-full h-14 relative group overflow-hidden rounded-2xl font-black text-white bg-[#0660c6] transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-2xl shadow-blue-500/40 border border-white/20\"\r\n                        >\r\n                            <div className=\"absolute inset-0 bg-linear-to-r from-[#0660c6] via-[#2563eb] to-[#0660c6] bg-size-[200%_100%] group-hover:bg-[100%_0] transition-all duration-700\" />\r\n                            <span className=\"relative z-10 flex items-center justify-center gap-3 tracking-[0.15em] uppercase text-sm text-white font-black drop-shadow-sm\">\r\n                                {isLoading ? (\r\n                                    <>\r\n                                        <div className=\"w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin\" />\r\n                                        {t('common.loading')}\r\n                                    </>\r\n                                ) : (\r\n                                    <>\r\n                                        <LogIn className=\"w-5 h-5\" strokeWidth={3} />\r\n                                        {t('login.submit')}\r\n                                    </>\r\n                                )}\r\n                            </span>\r\n                        </motion.button>\r\n                    </form>\r\n                </motion.div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\app\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\AssignmentsManager.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[316,319],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[316,319],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":12,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[340,343],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[340,343],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":13,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[367,370],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[367,370],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport UserSelector from '@/components/UserSelector'\r\nimport { updateAssignment } from '@/app/dashboard/cultos/[id]/actions'\r\nimport { useState } from 'react'\r\nimport { useRouter } from 'next/navigation'\r\n\r\ninterface AssignmentsManagerProps {\r\n    cultoId: string\r\n    assignments: {\r\n        intro: any\r\n        ensenanza: any\r\n        finalizacion: any\r\n    }\r\n}\r\n\r\nexport function AssignmentsManager({ cultoId, assignments }: AssignmentsManagerProps) {\r\n    const router = useRouter()\r\n    const [isEditing, setIsEditing] = useState(false)\r\n\r\n    async function handleUpdate(field: 'introduccion' | 'finalizacion' | 'ensenanza' | 'testimonios', userId: string | null) {\r\n        await updateAssignment(cultoId, field, userId)\r\n        router.refresh()\r\n    }\r\n\r\n    if (!isEditing) {\r\n        return (\r\n            <div className=\"space-y-4\">\r\n                <div className=\"p-4 rounded-xl bg-background/50 border border-border\">\r\n                    <label className=\"text-sm text-muted-foreground block mb-1\">Introducci├│n</label>\r\n                    <div className=\"font-medium\">\r\n                        {assignments.intro ? `${assignments.intro.nombre} ${assignments.intro.apellidos}` : 'Sin asignar'}\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"p-4 rounded-xl bg-background/50 border border-border\">\r\n                    <label className=\"text-sm text-muted-foreground block mb-1\">Ense├▒anza / Predicaci├│n</label>\r\n                    <div className=\"font-medium\">\r\n                        {assignments.ensenanza ? `${assignments.ensenanza.nombre} ${assignments.ensenanza.apellidos}` : 'Sin asignar'}\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"p-4 rounded-xl bg-background/50 border border-border\">\r\n                    <label className=\"text-sm text-muted-foreground block mb-1\">Finalizaci├│n</label>\r\n                    <div className=\"font-medium\">\r\n                        {assignments.finalizacion ? `${assignments.finalizacion.nombre} ${assignments.finalizacion.apellidos}` : 'Sin asignar'}\r\n                    </div>\r\n                </div>\r\n\r\n                <button\r\n                    onClick={() => setIsEditing(true)}\r\n                    className=\"w-full py-2 rounded-xl border border-primary/20 text-primary hover:bg-primary/5 transition-colors font-medium\"\r\n                >\r\n                    Editar Asignaciones\r\n                </button>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-4 animate-fade-in\">\r\n            <div className=\"space-y-2\">\r\n                <label className=\"text-sm font-medium\">Introducci├│n</label>\r\n                <UserSelector\r\n                    selectedUserId={assignments.intro?.id || null}\r\n                    onSelect={(userId) => handleUpdate('introduccion', userId)}\r\n                />\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n                <label className=\"text-sm font-medium\">Ense├▒anza / Predicaci├│n</label>\r\n                <UserSelector\r\n                    selectedUserId={assignments.ensenanza?.id || null}\r\n                    onSelect={(userId) => handleUpdate('ensenanza', userId)}\r\n                />\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n                <label className=\"text-sm font-medium\">Finalizaci├│n</label>\r\n                <UserSelector\r\n                    selectedUserId={assignments.finalizacion?.id || null}\r\n                    onSelect={(userId) => handleUpdate('finalizacion', userId)}\r\n                />\r\n            </div>\r\n\r\n            <button\r\n                onClick={() => setIsEditing(false)}\r\n                className=\"w-full py-2 rounded-xl bg-primary text-white hover:bg-primary/90 transition-colors font-medium\"\r\n            >\r\n                Terminar Edici├│n\r\n            </button>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\AvatarEditor.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[882,885],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[882,885],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":24,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[949,952],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[949,952],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":24,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[973,976],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[973,976],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport React, { useState, useCallback } from 'react'\r\nimport Cropper from 'react-easy-crop'\r\nimport { Slider } from '@/components/ui/slider'\r\nimport { Button } from '@/components/ui/Button'\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/Dialog'\r\nimport { ZoomIn, ZoomOut, RotateCw, Check, X } from 'lucide-react'\r\nimport { getCroppedImg } from '@/lib/utils/canvasUtils'\r\n\r\ninterface AvatarEditorProps {\r\n    imageSrc: string\r\n    isOpen: boolean\r\n    onClose: () => void\r\n    onSave: (file: Blob) => void\r\n}\r\n\r\nexport default function AvatarEditor({ imageSrc, isOpen, onClose, onSave }: AvatarEditorProps) {\r\n    const [crop, setCrop] = useState({ x: 0, y: 0 })\r\n    const [zoom, setZoom] = useState(1)\r\n    const [rotation, setRotation] = useState(0)\r\n    const [croppedAreaPixels, setCroppedAreaPixels] = useState<any>(null)\r\n\r\n    const onCropComplete = useCallback((croppedArea: any, croppedAreaPixels: any) => {\r\n        setCroppedAreaPixels(croppedAreaPixels)\r\n    }, [])\r\n\r\n    const handleSave = async () => {\r\n        try {\r\n            const croppedImage = await getCroppedImg(imageSrc, croppedAreaPixels, rotation)\r\n            if (croppedImage) {\r\n                onSave(croppedImage)\r\n                onClose()\r\n            }\r\n        } catch (e) {\r\n            console.error(e)\r\n        }\r\n    }\r\n\r\n    return (\r\n        <Dialog open={isOpen} onOpenChange={onClose}>\r\n            <DialogContent className=\"max-w-xl bg-zinc-950 border-zinc-800 text-white\">\r\n                <DialogHeader>\r\n                    <DialogTitle>Editar Foto de Perfil</DialogTitle>\r\n                </DialogHeader>\r\n\r\n                <div className=\"relative w-full h-[400px] bg-black rounded-xl overflow-hidden mt-4\">\r\n                    <Cropper\r\n                        image={imageSrc}\r\n                        crop={crop}\r\n                        zoom={zoom}\r\n                        rotation={rotation}\r\n                        aspect={1}\r\n                        onCropChange={setCrop}\r\n                        onCropComplete={onCropComplete}\r\n                        onZoomChange={setZoom}\r\n                        onRotationChange={setRotation}\r\n                        cropShape=\"round\"\r\n                        showGrid={false}\r\n                    />\r\n                </div>\r\n\r\n                <div className=\"space-y-6 mt-6\">\r\n                    {/* Controles de Zoom */}\r\n                    <div className=\"space-y-2\">\r\n                        <div className=\"flex justify-between text-xs text-zinc-400\">\r\n                            <span className=\"flex items-center gap-1\"><ZoomOut size={14} /> Zoom</span>\r\n                            <span className=\"flex items-center gap-1\"><ZoomIn size={14} /></span>\r\n                        </div>\r\n                        <Slider\r\n                            value={[zoom]}\r\n                            min={1}\r\n                            max={3}\r\n                            step={0.1}\r\n                            onValueChange={(value) => setZoom(value[0])}\r\n                            className=\"w-full\"\r\n                        />\r\n                    </div>\r\n\r\n                    {/* Controles de Rotaci├│n */}\r\n                    <div className=\"space-y-2\">\r\n                        <div className=\"flex justify-between text-xs text-zinc-400\">\r\n                            <span className=\"flex items-center gap-1\"><RotateCw size={14} /> Rotaci├│n</span>\r\n                            <span>{rotation}┬░</span>\r\n                        </div>\r\n                        <Slider\r\n                            value={[rotation]}\r\n                            min={0}\r\n                            max={360}\r\n                            step={90}\r\n                            onValueChange={(value) => setRotation(value[0])}\r\n                            className=\"w-full\"\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                <DialogFooter className=\"mt-6 flex gap-2\">\r\n                    <Button variant=\"outline\" onClick={onClose} className=\"flex-1 gap-2\">\r\n                        <X size={16} /> Cancelar\r\n                    </Button>\r\n                    <Button onClick={handleSave} className=\"flex-1 gap-2 bg-blue-600 hover:bg-blue-700\">\r\n                        <Check size={16} /> Guardar Cambios\r\n                    </Button>\r\n                </DialogFooter>\r\n            </DialogContent>\r\n        </Dialog>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\BibleReadingManager.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'History' is defined but never used.","line":20,"column":33,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":40},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":49,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1578,1581],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1578,1581],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":119,"column":95,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":98,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5823,5826],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5823,5826],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":224,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":224,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":266,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":266,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":291,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":291,"endColumn":23}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * BibleReadingManager - IDMJI Gestor de P├║lpito\r\n * \r\n * Gestiona la selecci├│n y visualizaci├│n de lecturas b├¡blicas para un culto.\r\n * Incluye l├│gica de detecci├│n de lecturas repetidas y avisos al usuario.\r\n * \r\n * Caracter├¡sticas:\r\n * - Historial de lecturas del culto\r\n * - Selector de citas con validaci├│n de repetici├│n\r\n * - Modal de confirmaci├│n para lecturas repetidas\r\n * - Soporte multiidioma (ES/CA)\r\n * \r\n * @author Antigravity AI\r\n * @date 2024-12-25\r\n */\r\n\r\n'use client'\r\n\r\nimport { useState, useEffect, useCallback } from 'react'\r\nimport { BookOpen, AlertCircle, History, Plus, Edit2, Trash2, CheckCircle2, Loader2 } from 'lucide-react'\r\nimport { format } from 'date-fns'\r\nimport { es, ca } from 'date-fns/locale'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport { useI18n } from '@/lib/i18n/I18nProvider'\r\nimport { Modal } from '@/components/ui/Modal'\r\nimport { LecturaBiblica } from '@/types/database'\r\nimport BibleSelector from '@/components/BibleSelector'\r\nimport { saveLectura, confirmRepeatedLectura, getLecturasByCulto, deleteLectura } from '@/app/dashboard/lecturas/actions'\r\nimport { toast } from 'sonner'\r\n\r\ninterface BibleReadingManagerProps {\r\n    cultoId: string\r\n    userId: string\r\n    config: {\r\n        tiene_lectura_introduccion: boolean\r\n        tiene_lectura_finalizacion: boolean\r\n    }\r\n}\r\n\r\ninterface RepetitionData {\r\n    libro: string\r\n    capInicio: number\r\n    versInicio: number\r\n    capFin: number\r\n    versFin: number\r\n    originalId: string\r\n    existingReading: {\r\n        fecha: string\r\n        [key: string]: any\r\n    }\r\n}\r\n\r\ninterface ReadingItemProps {\r\n    lectura: LecturaBiblica\r\n    onEdit: (tipo: 'introduccion' | 'finalizacion') => void\r\n    onDelete: (id: string) => void\r\n}\r\n\r\nfunction ReadingItem({ lectura, onEdit, onDelete }: ReadingItemProps) {\r\n    return (\r\n        <motion.div\r\n            layout\r\n            initial={{ opacity: 0, scale: 0.95 }}\r\n            animate={{ opacity: 1, scale: 1 }}\r\n            exit={{ opacity: 0, scale: 0.95 }}\r\n            className={`p-3.5 md:p-4.5 rounded-[1.75rem] border shadow-inner relative overflow-hidden group/reading transition-all ${\r\n                lectura.es_repetida\r\n                    ? 'bg-red-500/5 border-red-500/20'\r\n                    : 'bg-primary/5 border-primary/10'\r\n            }`}\r\n        >\r\n            <div className=\"absolute inset-0 bg-linear-to-r from-primary/5 to-transparent opacity-0 group-hover/reading:opacity-100 transition-opacity\" />\r\n            \r\n            <div className=\"flex flex-col gap-3 relative z-10\">\r\n                <div className=\"flex items-center gap-3\">\r\n                    <div className={`w-10 h-10 md:w-12 md:h-12 rounded-2xl flex items-center justify-center border-2 shadow-lg shrink-0 ${\r\n                        lectura.es_repetida ? 'bg-red-500/20 border-white/20 text-red-600' : 'bg-primary/20 border-white/20 text-primary'\r\n                    }`}>\r\n                        <BookOpen className=\"w-5 h-5 md:w-6 md:h-6\" />\r\n                    </div>\r\n                    <div className=\"min-w-0 flex-1\">\r\n                        <div className=\"flex items-center gap-2 mb-1\">\r\n                            <p className=\"text-[9px] md:text-[10px] text-muted-foreground font-black uppercase tracking-widest leading-none\">\r\n                                {lectura.tipo_lectura === 'introduccion' ? 'Lectura Introducci├│n' : 'Lectura Final'}\r\n                            </p>\r\n                            {lectura.es_repetida && (\r\n                                <div className=\"flex items-center gap-1 text-red-600 font-black text-[7px] uppercase bg-red-500/10 px-1.5 py-0.5 rounded-full border border-red-500/20 shrink-0\">\r\n                                    <AlertCircle className=\"w-2.5 h-2.5\" />\r\n                                    <span>Repetida</span>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                        <p className={`text-sm md:text-base lg:text-lg font-black uppercase tracking-tight mt-1 leading-none whitespace-nowrap break-normal ${lectura.es_repetida ? 'text-red-600' : 'text-foreground'}`}>\r\n                            {lectura.libro} {lectura.capitulo_inicio}:{lectura.versiculo_inicio}\r\n                            {lectura.capitulo_fin !== lectura.capitulo_inicio || lectura.versiculo_fin !== lectura.versiculo_inicio\r\n                                ? ` - ${lectura.capitulo_fin}:${lectura.versiculo_fin}`\r\n                                : ''}\r\n                        </p>\r\n                        <div className=\"flex items-center gap-1.5 mt-2\">\r\n                            <div className=\"flex items-center gap-1\">\r\n                                <div className=\"w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse shrink-0\" />\r\n                                <p className=\"text-[8px] md:text-[9px] lg:text-[10px] text-muted-foreground font-black uppercase tracking-widest leading-none\">\r\n                                    Registrada\r\n                                </p>\r\n                            </div>\r\n                            <motion.div\r\n                                initial={{ scale: 0 }}\r\n                                animate={{ scale: 1 }}\r\n                                className=\"bg-emerald-500/20 p-0.5 rounded-full\"\r\n                            >\r\n                                <CheckCircle2 className=\"w-3.5 h-3.5 text-emerald-500\" />\r\n                            </motion.div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                \r\n                <div className=\"grid grid-cols-2 gap-2.5 pt-3 border-t border-primary/10\">\r\n                    <button\r\n                        onClick={(e) => { e.stopPropagation(); onEdit(lectura.tipo_lectura as any); }}\r\n                        className=\"flex items-center justify-center gap-2 py-2.5 rounded-xl bg-white dark:bg-slate-800 text-muted-foreground hover:text-primary hover:bg-primary/5 transition-all shadow-sm border border-border/50 group/btn\"\r\n                    >\r\n                        <Edit2 className=\"w-3.5 h-3.5 group-hover/btn:scale-110 transition-transform\" />\r\n                        <span className=\"text-[9px] font-black uppercase tracking-widest\">Modificar</span>\r\n                    </button>\r\n                    <button\r\n                        onClick={(e) => { e.stopPropagation(); onDelete(lectura.id); }}\r\n                        className=\"flex items-center justify-center gap-2 py-2.5 rounded-xl bg-white dark:bg-slate-800 text-muted-foreground hover:text-red-600 hover:bg-red-50 transition-all shadow-sm border border-border/50 group/btn\"\r\n                    >\r\n                        <Trash2 className=\"w-3.5 h-3.5 group-hover/btn:scale-110 transition-transform\" />\r\n                        <span className=\"text-[9px] font-black uppercase tracking-widest\">Eliminar</span>\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </motion.div>\r\n    )\r\n}\r\n\r\nexport default function BibleReadingManager({ cultoId, userId, config }: BibleReadingManagerProps) {\r\n    const { t, language } = useI18n()\r\n    const [lecturas, setLecturas] = useState<LecturaBiblica[]>([])\r\n    const [isLoading, setIsLoading] = useState(true)\r\n    const [isActionLoading, setIsActionLoading] = useState(false)\r\n    const [isModalOpen, setIsModalOpen] = useState(false)\r\n    const [activeTipo, setActiveTipo] = useState<'introduccion' | 'finalizacion' | null>(null)\r\n    const [deleteConfirmId, setDeleteConfirmId] = useState<string | null>(null)\r\n\r\n    // Estado para confirmaci├│n de repetici├│n\r\n    const [repetitionData, setRepetitionData] = useState<RepetitionData | null>(null)\r\n\r\n    // Cargar lecturas actuales\r\n    const loadLecturas = useCallback(async () => {\r\n        setIsLoading(true)\r\n        try {\r\n            const { data, error } = await getLecturasByCulto(cultoId)\r\n            if (error) {\r\n                console.error('Error cargando lecturas:', error)\r\n                toast.error('Error al cargar lecturas')\r\n            } else if (data) {\r\n                console.log('Lecturas cargadas:', data)\r\n                setLecturas(data)\r\n            }\r\n        } catch (error) {\r\n            console.error('Error fatal cargando lecturas:', error)\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }, [cultoId])\r\n\r\n    useEffect(() => {\r\n        loadLecturas()\r\n    }, [loadLecturas])\r\n\r\n    const handleSelectCita = async (\r\n        libro: string,\r\n        capInicio: number,\r\n        versInicio: number,\r\n        capFin?: number,\r\n        versFin?: number\r\n    ) => {\r\n        if (!activeTipo) return\r\n\r\n        setIsActionLoading(true)\r\n        try {\r\n            const result = await saveLectura(\r\n                cultoId,\r\n                activeTipo,\r\n                libro,\r\n                capInicio,\r\n                versInicio,\r\n                capFin || capInicio,\r\n                versFin || versInicio,\r\n                userId\r\n            )\r\n\r\n            if (result.requiresConfirmation) {\r\n                setRepetitionData({\r\n                    libro,\r\n                    capInicio,\r\n                    versInicio,\r\n                    capFin: capFin || capInicio,\r\n                    versFin: versFin || versInicio,\r\n                    originalId: result.existingReading.id,\r\n                    existingReading: result.existingReading\r\n                })\r\n            } else if (result.success) {\r\n                toast.success(t('common.success'))\r\n                // Actualizaci├│n optimista del estado local\r\n                if (result.data) {\r\n                    setLecturas(prev => {\r\n                        const exists = prev.findIndex(l => l.id === result.data.id)\r\n                        if (exists !== -1) {\r\n                            const newLecturas = [...prev]\r\n                            newLecturas[exists] = result.data\r\n                            return newLecturas\r\n                        }\r\n                        return [...prev, result.data].sort((a, b) => a.tipo_lectura.localeCompare(b.tipo_lectura))\r\n                    })\r\n                }\r\n                setIsModalOpen(false)\r\n                // loadLecturas() // Ya lo actualizamos optim├¡sticamente\r\n            } else if (result.error) {\r\n                toast.error(result.error)\r\n            }\r\n        } catch (error) {\r\n            toast.error('Error al guardar la lectura')\r\n        } finally {\r\n            setIsActionLoading(false)\r\n        }\r\n    }\r\n\r\n    const handleConfirmRepetida = async () => {\r\n        if (!repetitionData || !activeTipo) return\r\n\r\n        setIsActionLoading(true)\r\n        try {\r\n            const result = await confirmRepeatedLectura(\r\n                cultoId,\r\n                activeTipo,\r\n                repetitionData.libro,\r\n                repetitionData.capInicio,\r\n                repetitionData.versInicio,\r\n                repetitionData.capFin,\r\n                repetitionData.versFin,\r\n                userId,\r\n                repetitionData.originalId\r\n            )\r\n\r\n            if (result.success) {\r\n                toast.success('Lectura guardada como repetida')\r\n                if (result.data) {\r\n                    setLecturas(prev => {\r\n                        const exists = prev.findIndex(l => l.id === result.data.id)\r\n                        if (exists !== -1) {\r\n                            const newLecturas = [...prev]\r\n                            newLecturas[exists] = result.data\r\n                            return newLecturas\r\n                        }\r\n                        return [...prev, result.data].sort((a, b) => a.tipo_lectura.localeCompare(b.tipo_lectura))\r\n                    })\r\n                }\r\n                setRepetitionData(null)\r\n                setIsModalOpen(false)\r\n            } else {\r\n                toast.error(result.error || 'Error al confirmar')\r\n            }\r\n        } catch (error) {\r\n            toast.error('Error de conexi├│n')\r\n        } finally {\r\n            setIsActionLoading(false)\r\n        }\r\n    }\r\n\r\n    const handleDelete = async (id: string) => {\r\n        setIsActionLoading(true)\r\n        try {\r\n            // Optimismo: Eliminar de la UI primero para evitar el \"flash\"\r\n            const currentLecturas = [...lecturas]\r\n            setLecturas(prev => prev.filter(l => l.id !== id))\r\n            \r\n            const result = await deleteLectura(id, cultoId)\r\n            \r\n            if (result.success) {\r\n                toast.success('Lectura eliminada')\r\n                // No llamamos a loadLecturas() inmediatamente para evitar el flash\r\n                // El revalidatePath del servidor se encargar├í de la sincronizaci├│n real\r\n            } else {\r\n                // Revertir si falla\r\n                setLecturas(currentLecturas)\r\n                toast.error(result.error || 'Error al eliminar')\r\n            }\r\n        } catch (error) {\r\n            toast.error('Error de conexi├│n')\r\n        } finally {\r\n            setIsActionLoading(false)\r\n            setDeleteConfirmId(null)\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-6 h-full flex flex-col\">\r\n            {/* Bloque vac├¡o con bot├│n centrado */}\r\n            <div className=\"flex-1 space-y-4\">\r\n                {isLoading ? (\r\n                    <div className=\"p-12 flex flex-col items-center justify-center gap-4 opacity-50\">\r\n                        <Loader2 className=\"w-8 h-8 text-primary animate-spin\" />\r\n                        <p className=\"text-xs font-black uppercase tracking-widest text-muted-foreground\">Cargando lecturas...</p>\r\n                    </div>\r\n                ) : lecturas.length > 0 ? (\r\n                    <div className=\"grid gap-4 grid-cols-1\">\r\n                        <AnimatePresence mode=\"popLayout\">\r\n                            {lecturas.map((lectura, idx) => (\r\n                                <ReadingItem \r\n                                    key={lectura.id || `lectura-${lectura.tipo_lectura}-${idx}`} \r\n                                    lectura={lectura} \r\n                                    onEdit={(tipo) => { setActiveTipo(tipo); setIsModalOpen(true); }}\r\n                                    onDelete={(id) => setDeleteConfirmId(id)}\r\n                                />\r\n                            ))}\r\n                        </AnimatePresence>\r\n                    </div>\r\n                ) : (\r\n                    <motion.div\r\n                        key=\"empty-state\"\r\n                        initial={{ opacity: 0, y: 10 }}\r\n                        animate={{ opacity: 1, y: 0 }}\r\n                        className=\"p-10 border-2 border-dashed border-primary/20 rounded-[2rem] flex flex-col items-center justify-center gap-6 bg-primary/5 group/empty hover:border-primary/40 transition-all cursor-pointer\"\r\n                        onClick={() => {\r\n                            if (config.tiene_lectura_introduccion) {\r\n                                setActiveTipo('introduccion');\r\n                                setIsModalOpen(true);\r\n                            } else if (config.tiene_lectura_finalizacion) {\r\n                                setActiveTipo('finalizacion');\r\n                                setIsModalOpen(true);\r\n                            }\r\n                        }}\r\n                    >\r\n                        <div className=\"w-16 h-16 rounded-3xl bg-primary/10 flex items-center justify-center group-hover/empty:scale-110 transition-transform shadow-inner\">\r\n                            <Plus className=\"w-8 h-8 text-primary\" />\r\n                        </div>\r\n                        <div className=\"text-center space-y-2\">\r\n                            <p className=\"text-[11px] font-black uppercase tracking-[0.2em] text-primary\">\r\n                                A├▒adir Lectura\r\n                            </p>\r\n                            <p className=\"text-[9px] font-medium uppercase tracking-widest text-muted-foreground/60\">\r\n                                No hay lecturas registradas\r\n                            </p>\r\n                        </div>\r\n                    </motion.div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Botones de acci├│n inteligentes - Solo se muestran si NO hay lecturas o para a├▒adir el tipo faltante */}\r\n            <div className=\"flex flex-wrap gap-3 md:gap-4 pt-4 border-t border-border/50 shrink-0\">\r\n                {lecturas.length > 0 && config.tiene_lectura_introduccion && !lecturas.some(l => l.tipo_lectura === 'introduccion') && (\r\n                    <motion.button\r\n                        key=\"btn-add-intro\"\r\n                        whileHover={{ scale: 1.02 }}\r\n                        whileTap={{ scale: 0.98 }}\r\n                        onClick={() => { setActiveTipo('introduccion'); setIsModalOpen(true); }}\r\n                        className=\"flex-1 min-w-[140px] flex items-center justify-center gap-3 h-14 rounded-2xl font-black uppercase tracking-widest text-[9px] md:text-[10px] transition-all shadow-xl bg-black dark:bg-white text-white dark:text-black hover:brightness-110 border-none\"\r\n                    >\r\n                        <Plus className=\"w-4 h-4\" />\r\n                        A├▒adir Lectura\r\n                    </motion.button>\r\n                )}\r\n                {lecturas.length > 0 && config.tiene_lectura_finalizacion && !lecturas.some(l => l.tipo_lectura === 'finalizacion') && (\r\n                    <motion.button\r\n                        key=\"btn-add-final\"\r\n                        whileHover={{ scale: 1.02 }}\r\n                        whileTap={{ scale: 0.98 }}\r\n                        onClick={() => { setActiveTipo('finalizacion'); setIsModalOpen(true); }}\r\n                        className=\"flex-1 min-w-[140px] flex items-center justify-center gap-3 h-14 rounded-2xl font-black uppercase tracking-widest text-[9px] md:text-[10px] transition-all shadow-xl bg-black dark:bg-white text-white dark:text-black hover:brightness-110 border-none\"\r\n                    >\r\n                        <Plus className=\"w-4 h-4\" />\r\n                        A├▒adir Lectura Final\r\n                    </motion.button>\r\n                )}\r\n            </div>\r\n\r\n            {/* Modal de confirmaci├│n de eliminaci├│n */}\r\n            <Modal\r\n                isOpen={!!deleteConfirmId}\r\n                onClose={() => setDeleteConfirmId(null)}\r\n                title=\"Confirmar eliminaci├│n\"\r\n                size=\"sm\"\r\n                keyPrefix=\"delete-reading\"\r\n            >\r\n                <div className=\"p-4 space-y-6\">\r\n                    <div className=\"flex flex-col items-center text-center space-y-4\">\r\n                        <div className=\"w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center text-red-600\">\r\n                            <Trash2 className=\"w-8 h-8\" />\r\n                        </div>\r\n                        <p className=\"text-sm font-medium text-muted-foreground\">\r\n                            ┬┐Est├ís seguro de que deseas eliminar esta lectura? Esta acci├│n no se puede deshacer.\r\n                        </p>\r\n                    </div>\r\n                    <div className=\"flex gap-3\">\r\n                        <button\r\n                            onClick={() => setDeleteConfirmId(null)}\r\n                            className=\"flex-1 h-12 bg-muted text-muted-foreground font-black uppercase tracking-widest text-[10px] rounded-xl hover:bg-muted/80 transition-colors\"\r\n                        >\r\n                            Cancelar\r\n                        </button>\r\n                        <button\r\n                            onClick={async () => {\r\n                                if (deleteConfirmId) {\r\n                                    await handleDelete(deleteConfirmId)\r\n                                    setDeleteConfirmId(null)\r\n                                }\r\n                            }}\r\n                            className=\"flex-1 h-12 bg-red-600 text-white font-black uppercase tracking-widest text-[10px] rounded-xl hover:bg-red-700 transition-all shadow-lg shadow-red-500/20\"\r\n                        >\r\n                            Eliminar\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </Modal>\r\n\r\n            {/* Modal de Selecci├│n de Biblia */}\r\n            <Modal\r\n                isOpen={isModalOpen}\r\n                onClose={() => { setIsModalOpen(false); setRepetitionData(null); }}\r\n                title={\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary\">\r\n                            <BookOpen className=\"w-4 h-4\" />\r\n                        </div>\r\n                        <span className=\"text-sm font-black uppercase tracking-widest\">\r\n                            {lecturas.some(l => l.tipo_lectura === activeTipo) ? 'Modificar' : 'A├▒adir'} Lectura: {activeTipo === 'introduccion' ? 'Introducci├│n' : 'Finalizaci├│n'}\r\n                        </span>\r\n                    </div>\r\n                }\r\n                size=\"md\"\r\n                keyPrefix=\"bible-selection\"\r\n            >\r\n                {!repetitionData ? (\r\n                    <div className=\"p-1\">\r\n                        <BibleSelector\r\n                            onSelect={handleSelectCita}\r\n                            disabled={isActionLoading}\r\n                        />\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"space-y-6 animate-in fade-in zoom-in duration-300 p-2\">\r\n                        <div className=\"flex flex-col items-center text-center space-y-4\">\r\n                            <div className=\"w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center text-red-600 shadow-inner\">\r\n                                <AlertCircle className=\"w-10 h-10\" />\r\n                            </div>\r\n                            <div className=\"space-y-2\">\r\n                                <h3 className=\"text-2xl font-black uppercase tracking-tighter text-red-600\">┬íCita Repetida!</h3>\r\n                                <p className=\"text-muted-foreground text-sm font-medium max-w-xs mx-auto\">\r\n                                    Esta cita ya fue le├¡da anteriormente el <span className=\"text-foreground font-bold\">{format(new Date(repetitionData.existingReading.fecha), 'PP', { locale: language === 'ca-ES' ? ca : es })}</span>.\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"p-6 bg-muted/50 rounded-[2rem] border border-border/50 text-center relative overflow-hidden group\">\r\n                            <div className=\"absolute inset-0 bg-red-500/5 opacity-0 group-hover/assigned:opacity-100 transition-opacity\" />\r\n                            <p className=\"text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground/60 mb-2 relative z-10\">Pasaje B├¡blico</p>\r\n                            <p className=\"text-3xl font-black uppercase tracking-tighter relative z-10\">\r\n                                {repetitionData.libro} {repetitionData.capInicio}:{repetitionData.versInicio}\r\n                                {repetitionData.capFin !== repetitionData.capInicio || repetitionData.versFin !== repetitionData.versInicio\r\n                                    ? ` - ${repetitionData.capFin}:${repetitionData.versFin}`\r\n                                    : ''}\r\n                            </p>\r\n                        </div>\r\n\r\n                        <div className=\"flex flex-col sm:flex-row gap-3 pt-4\">\r\n                            <button\r\n                                onClick={() => setRepetitionData(null)}\r\n                                className=\"flex-1 h-14 bg-muted text-muted-foreground font-black uppercase tracking-widest text-[10px] rounded-2xl hover:bg-muted/80 transition-colors order-2 sm:order-1\"\r\n                            >\r\n                                {t('common.cancel')}\r\n                            </button>\r\n                            <button\r\n                                onClick={handleConfirmRepetida}\r\n                                disabled={isActionLoading}\r\n                                className=\"flex-[2] h-14 bg-red-600 text-white font-black uppercase tracking-widest text-[10px] rounded-2xl hover:bg-red-700 transition-all shadow-xl shadow-red-500/20 order-1 sm:order-2 flex items-center justify-center gap-2\"\r\n                            >\r\n                                {isActionLoading ? (\r\n                                    <div className=\"w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin\" />\r\n                                ) : (\r\n                                    <>\r\n                                        <CheckCircle2 className=\"w-4 h-4\" />\r\n                                        Usar de todos modos\r\n                                    </>\r\n                                )}\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n            </Modal>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\BibleSelector.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'t' is assigned a value but never used.","line":27,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":27,"endColumn":14},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\BibleSelector.tsx:45:9\n  43 |\n  44 |     useEffect(() => {\n> 45 |         setMounted(true)\n     |         ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  46 |         return () => setMounted(false)\n  47 |     }, [])\n  48 |","line":45,"column":9,"nodeType":null,"endLine":45,"endColumn":19},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\BibleSelector.tsx:141:17\n  139 |             const max = getMaxChapters()\n  140 |             if (capituloInicio > max) {\n> 141 |                 setError(`El libro ${selectedLibroObj.nombre} solo tiene ${max} cap├¡tulos.`)\n      |                 ^^^^^^^^ Avoid calling setState() directly within an effect\n  142 |             } else if (error?.includes('cap├¡tulos')) {\n  143 |                 setError(null)\n  144 |             }","line":141,"column":17,"nodeType":null,"endLine":141,"endColumn":25},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'error' and 'getMaxChapters'. Either include them or remove the dependency array.","line":146,"column":8,"nodeType":"ArrayExpression","endLine":146,"endColumn":42,"suggestions":[{"desc":"Update the dependencies array to be: [capituloInicio, error, getMaxChapters, selectedLibroObj]","fix":{"range":[5420,5454],"text":"[capituloInicio, error, getMaxChapters, selectedLibroObj]"}}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\BibleSelector.tsx:153:17\n  151 |             const max = getMaxVerses(Number(capituloInicio))\n  152 |             if (versiculoInicio !== '' && versiculoInicio > max) {\n> 153 |                 setError(`El cap├¡tulo ${capituloInicio} de ${selectedLibroObj.nombre} solo tiene ${max} vers├¡culos.`)\n      |                 ^^^^^^^^ Avoid calling setState() directly within an effect\n  154 |             } else if (versiculoFin !== '' && versiculoFin > max) {\n  155 |                 setError(`El cap├¡tulo ${capituloInicio} de ${selectedLibroObj.nombre} solo tiene ${max} vers├¡culos.`)\n  156 |             } else if (versiculoInicio !== '' && versiculoFin !== '' && Number(versiculoFin) < Number(versiculoInicio)) {","line":153,"column":17,"nodeType":null,"endLine":153,"endColumn":25},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'error' and 'getMaxVerses'. Either include them or remove the dependency array.","line":162,"column":8,"nodeType":"ArrayExpression","endLine":162,"endColumn":73,"suggestions":[{"desc":"Update the dependencies array to be: [versiculoInicio, versiculoFin, capituloInicio, selectedLibroObj, getMaxVerses, error]","fix":{"range":[6388,6453],"text":"[versiculoInicio, versiculoFin, capituloInicio, selectedLibroObj, getMaxVerses, error]"}}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":309,"column":157,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[17054,17078],"text":"No hay resultados para &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[17054,17078],"text":"No hay resultados para &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[17054,17078],"text":"No hay resultados para &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[17054,17078],"text":"No hay resultados para &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":309,"column":171,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[17091,17092],"text":"&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[17091,17092],"text":"&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[17091,17092],"text":"&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[17091,17092],"text":"&rdquo;"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef } from 'react'\r\nimport { createPortal } from 'react-dom'\r\nimport { Search, ChevronDown, BookOpen, AlertCircle, X, ArrowLeft } from 'lucide-react'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport { getBibliaLibros } from '@/app/dashboard/lecturas/actions'\r\nimport { useI18n } from '@/lib/i18n/I18nProvider'\r\n\r\ninterface Chapter {\r\n    n: number\r\n    v: number\r\n}\r\n\r\ninterface BibleBook {\r\n    id: number\r\n    nombre: string\r\n    abreviatura: string\r\n    testamento: string\r\n    capitulos: Chapter[]\r\n}\r\n\r\ninterface BibleSelectorProps {\r\n    onSelect: (libro: string, capInicio: number, versInicio: number, capFin?: number, versFin?: number) => void\r\n    disabled?: boolean\r\n}\r\n\r\nexport default function BibleSelector({ onSelect, disabled }: BibleSelectorProps) {\r\n    const { t } = useI18n()\r\n    const [id] = useState(() => Math.random().toString(36).substring(2, 9))\r\n    const [libros, setLibros] = useState<BibleBook[]>([])\r\n    const [searchQuery, setSearchQuery] = useState('')\r\n    const [selectedLibroObj, setSelectedLibroObj] = useState<BibleBook | null>(null)\r\n    const [capituloInicio, setCapituloInicio] = useState<number | ''>('')\r\n    const [versiculoInicio, setVersiculoInicio] = useState<number | ''>('')\r\n    const [versiculoFin, setVersiculoFin] = useState<number | ''>('')\r\n    const [showDropdown, setShowDropdown] = useState(false)\r\n    const [isMobile, setIsMobile] = useState(false)\r\n    const [isMobileSearchActive, setIsMobileSearchActive] = useState(false)\r\n    const [dropdownRect, setDropdownRect] = useState<{ top: number, left: number, width: number } | null>(null)\r\n    const [mounted, setMounted] = useState(false)\r\n    const [error, setError] = useState<string | null>(null)\r\n    const inputRef = useRef<HTMLInputElement>(null)\r\n    const dropdownRef = useRef<HTMLDivElement>(null)\r\n\r\n    useEffect(() => {\r\n        setMounted(true)\r\n        return () => setMounted(false)\r\n    }, [])\r\n\r\n    useEffect(() => {\r\n        const checkMobile = () => {\r\n            setIsMobile(window.innerWidth < 768)\r\n        }\r\n        checkMobile()\r\n        window.addEventListener('resize', checkMobile)\r\n        return () => window.removeEventListener('resize', checkMobile)\r\n    }, [])\r\n\r\n    useEffect(() => {\r\n        function handleClickOutside(event: MouseEvent) {\r\n            if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node) && \r\n                inputRef.current && !inputRef.current.contains(event.target as Node)) {\r\n                setShowDropdown(false)\r\n            }\r\n        }\r\n        document.addEventListener(\"mousedown\", handleClickOutside)\r\n        return () => document.removeEventListener(\"mousedown\", handleClickOutside)\r\n    }, [])\r\n\r\n    // Posicionamiento din├ímico para el dropdown fixed\r\n    const updatePosition = () => {\r\n        if (inputRef.current) {\r\n            const rect = inputRef.current.getBoundingClientRect()\r\n            setDropdownRect({\r\n                top: rect.bottom,\r\n                left: rect.left,\r\n                width: rect.width\r\n            })\r\n        }\r\n    }\r\n\r\n    useEffect(() => {\r\n        if (showDropdown && !isMobile) {\r\n            updatePosition()\r\n            window.addEventListener('scroll', updatePosition, true)\r\n            window.addEventListener('resize', updatePosition)\r\n            return () => {\r\n                window.removeEventListener('scroll', updatePosition, true)\r\n                window.removeEventListener('resize', updatePosition)\r\n            }\r\n        }\r\n    }, [showDropdown, isMobile])\r\n\r\n    useEffect(() => {\r\n        async function loadLibros() {\r\n            const { data } = await getBibliaLibros()\r\n            if (data) {\r\n                setLibros(data)\r\n            }\r\n        }\r\n        loadLibros()\r\n    }, [])\r\n\r\n    // Scroll lock for mobile search\r\n    useEffect(() => {\r\n        if (isMobileSearchActive) {\r\n            document.body.style.overflow = 'hidden'\r\n        } else {\r\n            document.body.style.overflow = ''\r\n        }\r\n        return () => { document.body.style.overflow = '' }\r\n    }, [isMobileSearchActive])\r\n\r\n    const filteredLibros = libros.filter(libro =>\r\n        libro.nombre.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n        libro.abreviatura.toLowerCase().includes(searchQuery.toLowerCase())\r\n    )\r\n\r\n    const handleSelectLibro = (libro: BibleBook) => {\r\n        setSelectedLibroObj(libro)\r\n        setSearchQuery(libro.nombre)\r\n        setCapituloInicio('')\r\n        setVersiculoInicio('')\r\n        setVersiculoFin('')\r\n        setError(null)\r\n        setShowDropdown(false)\r\n        setIsMobileSearchActive(false)\r\n    }\r\n\r\n    const getMaxChapters = () => selectedLibroObj ? selectedLibroObj.capitulos.length : 0\r\n    const getMaxVerses = (capNum: number | '') => {\r\n        if (!selectedLibroObj || capNum === '') return 0\r\n        const cap = selectedLibroObj.capitulos.find(c => c.n === capNum)\r\n        return cap ? cap.v : 0\r\n    }\r\n\r\n    // Validaci├│n instant├ínea para cap├¡tulo\r\n    useEffect(() => {\r\n        if (selectedLibroObj && capituloInicio !== '') {\r\n            const max = getMaxChapters()\r\n            if (capituloInicio > max) {\r\n                setError(`El libro ${selectedLibroObj.nombre} solo tiene ${max} cap├¡tulos.`)\r\n            } else if (error?.includes('cap├¡tulos')) {\r\n                setError(null)\r\n            }\r\n        }\r\n    }, [capituloInicio, selectedLibroObj])\r\n\r\n    // Validaci├│n instant├ínea para vers├¡culos\r\n    useEffect(() => {\r\n        if (selectedLibroObj && capituloInicio !== '') {\r\n            const max = getMaxVerses(Number(capituloInicio))\r\n            if (versiculoInicio !== '' && versiculoInicio > max) {\r\n                setError(`El cap├¡tulo ${capituloInicio} de ${selectedLibroObj.nombre} solo tiene ${max} vers├¡culos.`)\r\n            } else if (versiculoFin !== '' && versiculoFin > max) {\r\n                setError(`El cap├¡tulo ${capituloInicio} de ${selectedLibroObj.nombre} solo tiene ${max} vers├¡culos.`)\r\n            } else if (versiculoInicio !== '' && versiculoFin !== '' && Number(versiculoFin) < Number(versiculoInicio)) {\r\n                setError(`El vers├¡culo de fin no puede ser menor al de inicio.`)\r\n            } else if (error && (error.includes('vers├¡culos') || error.includes('menor'))) {\r\n                setError(null)\r\n            }\r\n        }\r\n    }, [versiculoInicio, versiculoFin, capituloInicio, selectedLibroObj])\r\n\r\n    const handleSubmit = () => {\r\n        if (!selectedLibroObj || !capituloInicio || !versiculoInicio) {\r\n            setError(\"Por favor, selecciona un libro, cap├¡tulo y vers├¡culo.\")\r\n            return\r\n        }\r\n\r\n        // Re-validaci├│n final antes de enviar\r\n        const maxCaps = getMaxChapters()\r\n        if (capituloInicio > maxCaps) {\r\n            setError(`El libro ${selectedLibroObj.nombre} solo tiene ${maxCaps} cap├¡tulos.`)\r\n            return\r\n        }\r\n\r\n        const maxVers = getMaxVerses(Number(capituloInicio))\r\n        if (versiculoInicio > maxVers) {\r\n            setError(`El cap├¡tulo ${capituloInicio} de ${selectedLibroObj.nombre} solo tiene ${maxVers} vers├¡culos.`)\r\n            return\r\n        }\r\n\r\n        if (versiculoFin) {\r\n            if (versiculoFin > maxVers) {\r\n                setError(`El cap├¡tulo ${capituloInicio} de ${selectedLibroObj.nombre} solo tiene ${maxVers} vers├¡culos.`)\r\n                return\r\n            }\r\n            if (Number(versiculoFin) < Number(versiculoInicio)) {\r\n                setError(`El vers├¡culo de fin no puede ser menor al de inicio.`)\r\n                return\r\n            }\r\n        }\r\n\r\n        setError(null)\r\n        onSelect(\r\n            selectedLibroObj.nombre,\r\n            Number(capituloInicio),\r\n            Number(versiculoInicio),\r\n            Number(capituloInicio),\r\n            versiculoFin ? Number(versiculoFin) : undefined\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* Libro */}\r\n            <div className=\"space-y-2.5 relative\">\r\n                <label className=\"text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground/60 ml-1\">Libro de la Biblia</label>\r\n                <div className=\"relative group\">\r\n                    <div className=\"absolute inset-0 bg-primary/10 rounded-2xl blur-xl opacity-0 group-focus-within:opacity-100 transition-opacity\" />\r\n                    <div className=\"relative\">\r\n                        <BookOpen className=\"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-primary/60 group-focus-within:text-primary transition-colors\" />\r\n                        <input\r\n                            type=\"text\"\r\n                            ref={inputRef}\r\n                            value={searchQuery}\r\n                            onChange={(e) => {\r\n                                setSearchQuery(e.target.value)\r\n                                if (!isMobile) setShowDropdown(true)\r\n                            }}\r\n                            onClick={() => {\r\n                                if (isMobile) {\r\n                                    setIsMobileSearchActive(true)\r\n                                } else {\r\n                                    setShowDropdown(true)\r\n                                }\r\n                            }}\r\n                            onFocus={() => {\r\n                                if (!isMobile) setShowDropdown(true)\r\n                            }}\r\n                            placeholder=\"Buscar libro...\"\r\n                            disabled={disabled}\r\n                            className=\"w-full bg-muted/30 border border-border/50 rounded-2xl pl-12 pr-4 py-4 outline-none focus:ring-4 focus:ring-primary/10 focus:border-primary/50 transition-all text-sm md:text-base font-bold placeholder:text-muted-foreground/40 shadow-sm cursor-text md:cursor-pointer\"\r\n                        />\r\n                    </div>\r\n\r\n                    {/* Desktop Search Results - PORTAL position for reliability */}\r\n                    <AnimatePresence>\r\n                        {mounted && !isMobile && showDropdown && dropdownRect && createPortal(\r\n                            <div key={`bible-selector-portal-${id}`} className=\"fixed inset-0 z-[9998]\" onClick={() => setShowDropdown(false)}>\r\n                                <motion.div \r\n                                    key={`bible-selector-dropdown-${id}`}\r\n                                    initial={{ opacity: 0, y: -10, scale: 0.95 }}\r\n                                    animate={{ opacity: 1, y: 0, scale: 1 }}\r\n                                    exit={{ opacity: 0, y: -10, scale: 0.95 }}\r\n                                    ref={dropdownRef}\r\n                                    style={{\r\n                                        position: 'fixed',\r\n                                        top: dropdownRect.top + 8,\r\n                                        left: dropdownRect.left,\r\n                                        width: dropdownRect.width,\r\n                                    }}\r\n                                    onClick={(e) => e.stopPropagation()}\r\n                                    className=\"bg-white dark:bg-zinc-900 rounded-[2.5rem] shadow-[0_25px_60px_-15px_rgba(0,0,0,0.4)] overflow-hidden border border-gray-200 dark:border-white/10 flex flex-col min-h-[100px] max-h-[450px]\"\r\n                                >\r\n                                    <div className=\"p-4 border-b border-border/50 bg-muted/20 flex items-center justify-between shrink-0\">\r\n                                        <p className=\"text-[10px] font-black uppercase tracking-widest text-muted-foreground/60\">Resultados de b├║squeda</p>\r\n                                        <button \r\n                                            onClick={() => setShowDropdown(false)}\r\n                                            className=\"p-1.5 hover:bg-muted rounded-full transition-colors\"\r\n                                        >\r\n                                            <X className=\"w-4 h-4 text-muted-foreground\" />\r\n                                        </button>\r\n                                    </div>\r\n                                    <div className=\"overflow-y-auto p-2 no-scrollbar flex-1\">\r\n                                        {filteredLibros.length > 0 ? (\r\n                                            <div className=\"grid grid-cols-1 gap-1\">\r\n                                                {filteredLibros.map((libro, idx) => (\r\n                                                    <button\r\n                                                        key={libro.id || `libro-result-${idx}`}\r\n                                                        onClick={() => handleSelectLibro(libro)}\r\n                                                        className=\"w-full px-4 py-3.5 text-left hover:bg-primary/5 dark:hover:bg-primary/10 transition-all flex items-center justify-between group rounded-[1.5rem] relative overflow-hidden\"\r\n                                                    >\r\n                                                        <div className=\"absolute inset-0 bg-primary/0 group-hover:bg-primary/5 transition-colors\" />\r\n                                                        <div className=\"flex items-center gap-4 relative z-10\">\r\n                                                            <div className={`w-11 h-11 rounded-2xl flex items-center justify-center font-black text-xs border shadow-sm transition-all group-hover:scale-105 group-hover:rotate-3 ${\r\n                                                                libro.testamento === 'AT' \r\n                                                                    ? 'bg-amber-500/10 border-amber-500/20 text-amber-600' \r\n                                                                    : 'bg-blue-500/10 border-blue-500/20 text-blue-600'\r\n                                                            }`}>\r\n                                                                {libro.abreviatura.slice(0, 2)}\r\n                                                            </div>\r\n                                                            <div>\r\n                                                                <p className=\"font-black text-sm md:text-base group-hover:text-primary transition-colors uppercase tracking-tight\">{libro.nombre}</p>\r\n                                                                <div className=\"flex items-center gap-2 mt-0.5\">\r\n                                                                    <span className={`text-[8px] px-2 py-0.5 rounded-full font-black uppercase tracking-widest border ${\r\n                                                                        libro.testamento === 'AT' \r\n                                                                            ? 'bg-amber-500/5 border-amber-500/20 text-amber-600' \r\n                                                                            : 'bg-blue-500/5 border-blue-500/20 text-blue-600'\r\n                                                                    }`}>\r\n                                                                        {libro.testamento === 'AT' ? 'Antiguo Testamento' : 'Nuevo Testamento'}\r\n                                                                    </span>\r\n                                                                    <span className=\"text-[9px] text-muted-foreground/60 font-bold uppercase tracking-widest\">ÔÇó</span>\r\n                                                                    <p className=\"text-[10px] text-muted-foreground/60 font-bold uppercase tracking-widest italic\">\r\n                                                                        {libro.capitulos.length} Cap├¡tulos\r\n                                                                    </p>\r\n                                                                </div>\r\n                                                            </div>\r\n                                                        </div>\r\n                                                        <div className=\"w-8 h-8 rounded-xl bg-primary/0 group-hover:bg-primary/10 flex items-center justify-center transition-all relative z-10\">\r\n                                                            <ChevronDown className=\"w-4 h-4 text-muted-foreground/30 -rotate-90 group-hover:text-primary group-hover:translate-x-0.5 transition-all\" />\r\n                                                        </div>\r\n                                                    </button>\r\n                                                ))}\r\n                                            </div>\r\n                                        ) : (\r\n                                            <div className=\"p-10 text-center\">\r\n                                                <BookOpen className=\"w-12 h-12 text-muted-foreground/20 mx-auto mb-3\" />\r\n                                                <p className=\"text-xs font-black text-muted-foreground/40 uppercase tracking-widest\">No hay resultados para \"{searchQuery}\"</p>\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                    <div className=\"p-3 bg-muted/20 border-t border-border/50 text-center shrink-0\">\r\n                                        <p className=\"text-[9px] font-black text-muted-foreground/40 uppercase tracking-[0.2em]\">Sugerencia: Escribe para filtrar la lista</p>\r\n                                    </div>\r\n                                </motion.div>\r\n                            </div>,\r\n                            document.body\r\n                        )}\r\n                    </AnimatePresence>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Mobile Search Overlay */}\r\n            <AnimatePresence>\r\n                {isMobile && isMobileSearchActive && (\r\n                    <motion.div\r\n                        initial={{ opacity: 0 }}\r\n                        animate={{ opacity: 1 }}\r\n                        exit={{ opacity: 0 }}\r\n                        className=\"fixed inset-0 z-[999] bg-white dark:bg-zinc-950 flex flex-col\"\r\n                    >\r\n                        {/* Search Header */}\r\n                        <div className=\"flex items-center gap-4 p-4 border-b border-border/50\">\r\n                            <button \r\n                                onClick={() => setIsMobileSearchActive(false)}\r\n                                className=\"p-2 hover:bg-muted rounded-xl transition-colors\"\r\n                            >\r\n                                <ArrowLeft className=\"w-6 h-6\" />\r\n                            </button>\r\n                            <div className=\"flex-1 relative\">\r\n                                <Search className=\"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground\" />\r\n                                <input\r\n                                    type=\"text\"\r\n                                    autoFocus\r\n                                    value={searchQuery}\r\n                                    onChange={(e) => setSearchQuery(e.target.value)}\r\n                                    placeholder=\"Buscar libro...\"\r\n                                    className=\"w-full bg-muted/50 rounded-2xl pl-12 pr-10 py-3.5 outline-none focus:ring-2 focus:ring-primary/20 font-bold text-base\"\r\n                                />\r\n                                {searchQuery && (\r\n                                    <button \r\n                                        onClick={() => setSearchQuery('')}\r\n                                        className=\"absolute right-3 top-1/2 -translate-y-1/2 p-1 bg-muted-foreground/10 rounded-full\"\r\n                                    >\r\n                                        <X className=\"w-4 h-4\" />\r\n                                    </button>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Search Results */}\r\n                        <div className=\"flex-1 overflow-y-auto p-4 space-y-2\">\r\n                            {filteredLibros.length > 0 ? (\r\n                                filteredLibros.map((libro, idx) => (\r\n                                    <button\r\n                                        key={libro.id || `mobile-libro-result-${idx}`}\r\n                                        onClick={() => handleSelectLibro(libro)}\r\n                                        className=\"w-full p-4 text-left bg-muted/20 hover:bg-primary/5 active:bg-primary/10 rounded-2xl transition-all border border-border/10 flex items-center gap-4 group\"\r\n                                    >\r\n                                        <div className={`w-12 h-12 rounded-2xl flex items-center justify-center font-black text-sm border shadow-sm ${\r\n                                            libro.testamento === 'AT' ? 'bg-amber-500/10 border-amber-500/20 text-amber-600' : 'bg-blue-500/10 border-blue-500/20 text-blue-600'\r\n                                        }`}>\r\n                                            {libro.abreviatura.slice(0, 2)}\r\n                                        </div>\r\n                                        <div>\r\n                                            <p className=\"font-black text-base uppercase tracking-tight text-foreground\">{libro.nombre}</p>\r\n                                            <p className=\"text-[10px] text-muted-foreground font-bold uppercase tracking-widest mt-0.5\">\r\n                                                {libro.testamento === 'AT' ? 'Antiguo Testamento' : 'Nuevo Testamento'} ÔÇó {libro.capitulos.length} Cap├¡tulos\r\n                                            </p>\r\n                                        </div>\r\n                                    </button>\r\n                                ))\r\n                            ) : (\r\n                                <div className=\"p-12 text-center\">\r\n                                    <BookOpen className=\"w-16 h-16 text-muted-foreground/20 mx-auto mb-4\" />\r\n                                    <p className=\"font-bold text-muted-foreground uppercase tracking-widest\">No se encontraron libros</p>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </motion.div>\r\n                )}\r\n            </AnimatePresence>\r\n\r\n            {/* Cap├¡tulo y Vers├¡culo Inicio y Fin */}\r\n            <div className=\"space-y-4\">\r\n                <div className=\"grid grid-cols-1 xl:grid-cols-2 gap-4\">\r\n                    <div className=\"space-y-2\">\r\n                        <div className=\"flex justify-between items-end ml-1\">\r\n                            <label className=\"text-[10px] font-black uppercase tracking-widest text-muted-foreground/60\">Cap├¡tulo</label>\r\n                            {selectedLibroObj && (\r\n                                <span className=\"text-[8px] font-black text-primary uppercase\">M├íx: {getMaxChapters()}</span>\r\n                            )}\r\n                        </div>\r\n                        <input\r\n                            type=\"number\"\r\n                            min=\"1\"\r\n                            max={getMaxChapters()}\r\n                            value={capituloInicio}\r\n                            onChange={(e) => {\r\n                                setCapituloInicio(e.target.value === '' ? '' : Number(e.target.value))\r\n                                setError(null)\r\n                            }}\r\n                            placeholder=\"Ej: 1\"\r\n                            disabled={disabled || !selectedLibroObj}\r\n                            className={`w-full h-14 bg-muted/30 border rounded-2xl px-5 outline-none focus:ring-4 focus:ring-primary/10 transition-all text-sm font-black shadow-sm ${\r\n                                error && (error.includes('cap├¡tulos') || (capituloInicio !== '' && Number(capituloInicio) > getMaxChapters())) ? 'border-red-500 ring-4 ring-red-500/10' : 'border-border/50 focus:border-primary/50'\r\n                            }`}\r\n                        />\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                        <div className=\"flex justify-between items-end ml-1\">\r\n                            <label className=\"text-[10px] font-black uppercase tracking-widest text-muted-foreground/60\">Vers├¡culos (Rango)</label>\r\n                            {selectedLibroObj && capituloInicio !== '' && (\r\n                                <span className=\"text-[8px] font-black text-primary uppercase\">M├íx: {getMaxVerses(Number(capituloInicio))}</span>\r\n                            )}\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <div className=\"flex-1 relative\">\r\n                                <span className=\"absolute left-3 top-1/2 -translate-y-1/2 text-[8px] font-black text-muted-foreground/40 uppercase\">De</span>\r\n                                <input\r\n                                    type=\"number\"\r\n                                    min=\"1\"\r\n                                    max={getMaxVerses(Number(capituloInicio))}\r\n                                    value={versiculoInicio}\r\n                                    onChange={(e) => {\r\n                                        setVersiculoInicio(e.target.value === '' ? '' : Number(e.target.value))\r\n                                        setError(null)\r\n                                    }}\r\n                                    placeholder=\"Inicio\"\r\n                                    disabled={disabled || !selectedLibroObj || capituloInicio === ''}\r\n                                    className={`w-full h-14 bg-muted/30 border rounded-2xl pl-8 pr-2 outline-none focus:ring-4 focus:ring-primary/10 transition-all text-sm font-black shadow-sm ${\r\n                                        error && (error.includes('vers├¡culos') && versiculoInicio !== '' && Number(versiculoInicio) > getMaxVerses(Number(capituloInicio))) ? 'border-red-500 ring-4 ring-red-500/10' : 'border-border/50 focus:border-primary/50'\r\n                                    }`}\r\n                                />\r\n                            </div>\r\n                            <span className=\"text-muted-foreground font-black\">ÔÇö</span>\r\n                            <div className=\"flex-1 relative\">\r\n                                <span className=\"absolute left-3 top-1/2 -translate-y-1/2 text-[8px] font-black text-muted-foreground/40 uppercase\">Hasta</span>\r\n                                <input\r\n                                    type=\"number\"\r\n                                    min={Number(versiculoInicio) || 1}\r\n                                    max={getMaxVerses(Number(capituloInicio))}\r\n                                    value={versiculoFin}\r\n                                    onChange={(e) => {\r\n                                        setVersiculoFin(e.target.value === '' ? '' : Number(e.target.value))\r\n                                        setError(null)\r\n                                    }}\r\n                                    placeholder=\"Fin\"\r\n                                    disabled={disabled || !selectedLibroObj || capituloInicio === ''}\r\n                                    className={`w-full h-14 bg-muted/30 border rounded-2xl pl-10 pr-2 outline-none focus:ring-4 focus:ring-primary/10 transition-all text-sm font-black shadow-sm ${\r\n                                        error && (error.includes('vers├¡culos') && versiculoFin !== '' && Number(versiculoFin) > getMaxVerses(Number(capituloInicio))) ? 'border-red-500 ring-4 ring-red-500/10' : 'border-border/50 focus:border-primary/50'\r\n                                    }`}\r\n                                />\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Error Message */}\r\n            {error && (\r\n                <motion.div \r\n                    initial={{ opacity: 0, height: 0 }}\r\n                    animate={{ opacity: 1, height: 'auto' }}\r\n                    className=\"p-4 bg-red-500/10 border border-red-500/20 rounded-2xl flex gap-x-3 items-center text-red-600 text-xs font-bold shadow-sm\"\r\n                >\r\n                    <div className=\"p-1.5 bg-red-500/20 rounded-lg\">\r\n                        <AlertCircle className=\"w-4 h-4 shrink-0\" />\r\n                    </div>\r\n                    <p>{error}</p>\r\n                </motion.div>\r\n            )}\r\n\r\n            {/* Preview */}\r\n            <AnimatePresence>\r\n                {selectedLibroObj && capituloInicio && versiculoInicio && !error && (\r\n                    <motion.div \r\n                        initial={{ opacity: 0, y: 10 }}\r\n                        animate={{ opacity: 1, y: 0 }}\r\n                        className=\"p-5 bg-primary/5 rounded-[2rem] border border-primary/10 shadow-inner relative overflow-hidden\"\r\n                    >\r\n                        <div className=\"absolute top-0 right-0 w-24 h-24 bg-primary/5 rounded-full blur-2xl -mr-12 -mt-12\" />\r\n                        <p className=\"text-[9px] font-black text-muted-foreground/60 mb-2 uppercase tracking-[0.3em] relative z-10\">Vista previa de la cita:</p>\r\n                        <p className=\"text-2xl md:text-3xl font-black text-primary tracking-tighter uppercase italic relative z-10\">\r\n                            {selectedLibroObj.nombre} {capituloInicio}:{versiculoInicio}\r\n                            {versiculoFin && versiculoFin !== versiculoInicio && `-${versiculoFin}`}\r\n                        </p>\r\n                    </motion.div>\r\n                )}\r\n            </AnimatePresence>\r\n\r\n            {/* Submit */}\r\n            <button\r\n                onClick={handleSubmit}\r\n                disabled={disabled || !selectedLibroObj || capituloInicio === '' || versiculoInicio === '' || !!error}\r\n                className=\"w-full h-16 bg-black dark:bg-white text-white dark:text-black rounded-[2rem] font-black uppercase tracking-[0.2em] text-xs hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-20 disabled:cursor-not-allowed shadow-2xl flex items-center justify-center gap-3 mt-4\"\r\n            >\r\n                <BookOpen className=\"w-5 h-5\" />\r\n                Registrar Lectura B├¡blica\r\n            </button>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\Calendar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BookOpen' is defined but never used.","line":20,"column":96,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":104},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\Calendar.tsx:59:9\n  57 |\n  58 |     useEffect(() => {\n> 59 |         setIsDark(document.documentElement.classList.contains('dark'))\n     |         ^^^^^^^^^ Avoid calling setState() directly within an effect\n  60 |     }, [])\n  61 |\n  62 |     const [internalDate, setInternalDate] = useState(new Date())","line":59,"column":9,"nodeType":null,"endLine":59,"endColumn":18}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Calendar - IDMJI Gestor de P├║lpito\r\n * \r\n * Componente de calendario interactivo con soporte para vista de cuadr├¡cula (desktop)\r\n * y vista de lista optimizada (mobile). \r\n * \r\n * Caracter├¡sticas:\r\n * - Dise├▒o Glassmorphism premium\r\n * - Internacionalizaci├│n completa (ES/CA)\r\n * - Navegaci├│n intuitiva\r\n * - Indicadores visuales de estado y tipo de culto\r\n * \r\n * @author Antigravity AI\r\n * @date 2024-12-25\r\n */\r\n\r\n'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { ChevronLeft, ChevronRight, Calendar as CalendarIcon, AlertCircle, CheckCircle, Clock, BookOpen } from 'lucide-react'\r\nimport {\r\n    startOfMonth,\r\n    endOfMonth,\r\n    eachDayOfInterval,\r\n    format,\r\n    isSameMonth,\r\n    isSameDay,\r\n    addMonths,\r\n    subMonths,\r\n    startOfWeek,\r\n    endOfWeek,\r\n    addWeeks,\r\n    subWeeks,\r\n    addDays,\r\n    subDays,\r\n    isSameWeek\r\n} from 'date-fns'\r\nimport { es, ca } from 'date-fns/locale'\r\nimport Link from 'next/link'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\n\r\nimport { getCultoStatus } from '@/lib/utils/culto-helpers'\r\nimport { useI18n } from '@/lib/i18n/I18nProvider'\r\nimport { CalendarEvent } from '@/types/database'\r\n\r\ninterface CalendarProps {\r\n    events: CalendarEvent[]\r\n    onMonthChange?: (year: number, month: number) => void\r\n    view?: 'month' | 'week' | 'day'\r\n    selectedDate?: Date\r\n    onDateSelect?: (date: Date) => void\r\n}\r\n\r\nexport default function Calendar({ events, onMonthChange, view = 'month', selectedDate, onDateSelect }: CalendarProps) {\r\n    const { t, language } = useI18n()\r\n    const [isDark, setIsDark] = useState(false)\r\n\r\n    useEffect(() => {\r\n        setIsDark(document.documentElement.classList.contains('dark'))\r\n    }, [])\r\n\r\n    const [internalDate, setInternalDate] = useState(new Date())\r\n    const currentDate = selectedDate || internalDate\r\n    const setCurrentDate = (date: Date) => {\r\n        if (onDateSelect) onDateSelect(date)\r\n        else setInternalDate(date)\r\n    }\r\n    const locale = language === 'ca-ES' ? ca : es\r\n\r\n    const monthStart = startOfMonth(currentDate)\r\n    const monthEnd = endOfMonth(currentDate)\r\n    const calendarStart = startOfWeek(monthStart, { weekStartsOn: 1 }) // Lunes\r\n    const calendarEnd = endOfWeek(monthEnd, { weekStartsOn: 1 })\r\n\r\n    const days = eachDayOfInterval({ start: calendarStart, end: calendarEnd })\r\n\r\n    // Deduplicar eventos por fecha para asegurar que solo haya uno por d├¡a\r\n    const eventsMap = new Map()\r\n    events.forEach(e => {\r\n        if (!eventsMap.has(e.fecha)) {\r\n            eventsMap.set(e.fecha, e)\r\n        }\r\n    })\r\n\r\n    const handlePrev = () => {\r\n        let newDate: Date\r\n        if (view === 'month') newDate = subMonths(currentDate, 1)\r\n        else if (view === 'week') newDate = subWeeks(currentDate, 1)\r\n        else newDate = subDays(currentDate, 1)\r\n\r\n        const oldMonth = currentDate.getMonth()\r\n        setCurrentDate(newDate)\r\n        if (view === 'month') onMonthChange?.(newDate.getFullYear(), newDate.getMonth())\r\n        else if (newDate.getMonth() !== oldMonth) onMonthChange?.(newDate.getFullYear(), newDate.getMonth())\r\n    }\r\n\r\n    const handleNext = () => {\r\n        let newDate: Date\r\n        if (view === 'month') newDate = addMonths(currentDate, 1)\r\n        else if (view === 'week') newDate = addWeeks(currentDate, 1)\r\n        else newDate = addDays(currentDate, 1)\r\n\r\n        const oldMonth = currentDate.getMonth()\r\n        setCurrentDate(newDate)\r\n        if (view === 'month') onMonthChange?.(newDate.getFullYear(), newDate.getMonth())\r\n        else if (newDate.getMonth() !== oldMonth) onMonthChange?.(newDate.getFullYear(), newDate.getMonth())\r\n    }\r\n\r\n    const weekStart = startOfWeek(currentDate, { weekStartsOn: 1 })\r\n    const weekEnd = endOfWeek(currentDate, { weekStartsOn: 1 })\r\n    const weekDaysInterval = eachDayOfInterval({ start: weekStart, end: weekEnd })\r\n\r\n    const daysToRender = view === 'month' ? days : view === 'week' ? weekDaysInterval : [currentDate]\r\n\r\n    const isMonthActual = isSameMonth(currentDate, new Date())\r\n\r\n    const handleToday = () => {\r\n        const today = new Date()\r\n        const oldMonth = currentDate.getMonth()\r\n        const oldYear = currentDate.getFullYear()\r\n\r\n        setCurrentDate(today)\r\n        if (today.getMonth() !== oldMonth || today.getFullYear() !== oldYear) {\r\n            onMonthChange?.(today.getFullYear(), today.getMonth())\r\n        }\r\n    }\r\n\r\n    const weekDays = [\r\n        t('calendar.days.mon'),\r\n        t('calendar.days.tue'),\r\n        t('calendar.days.wed'),\r\n        t('calendar.days.thu'),\r\n        t('calendar.days.fri'),\r\n        t('calendar.days.sat'),\r\n        t('calendar.days.sun')\r\n    ]\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            {/* Header del Calendario */}\r\n            <div className=\"flex flex-col sm:flex-row items-center justify-between gap-6 px-2 mb-8\">\r\n                <div className=\"flex items-center gap-5\">\r\n                    <div className=\"p-4 bg-primary/10 rounded-3xl border border-primary/20 shadow-inner\">\r\n                        <CalendarIcon className=\"w-7 h-7 text-primary\" />\r\n                    </div>\r\n                    <div className=\"flex flex-col\">\r\n                        <h2 className=\"text-3xl font-black uppercase tracking-tighter leading-none mb-1\">\r\n                            {view === 'month' ? format(currentDate, 'MMMM yyyy', { locale }) :\r\n                                view === 'week' ? `${format(startOfWeek(currentDate, { weekStartsOn: 1 }), 'd MMM')} - ${format(endOfWeek(currentDate, { weekStartsOn: 1 }), 'd MMM, yyyy')}` :\r\n                                    format(currentDate, 'EEEE, d MMMM yyyy', { locale })}\r\n                        </h2>\r\n                        <p className=\"text-[10px] font-bold text-muted-foreground uppercase tracking-[0.2em] opacity-60\">\r\n                            {view === 'month' ? 'Vista Mensual' : view === 'week' ? 'Vista Semanal' : 'Vista Diaria'}\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-3 bg-muted/30 p-2 rounded-[2.5rem] border border-border/50 shadow-inner backdrop-blur-md\">\r\n                    <button\r\n                        onClick={handlePrev}\r\n                        className=\"p-3 hover:bg-background hover:shadow-lg rounded-2xl transition-all group active:scale-90 flex items-center gap-2\"\r\n                        title={view === 'month' ? 'Mes Anterior' : view === 'week' ? 'Semana Anterior' : 'D├¡a Anterior'}\r\n                    >\r\n                        <ChevronLeft className=\"w-6 h-6 text-primary group-hover:-translate-x-0.5 transition-transform\" />\r\n                        <span className=\"hidden lg:inline text-[10px] font-black uppercase tracking-widest text-primary/70\">Anterior</span>\r\n                    </button>\r\n\r\n                    <button\r\n                        onClick={handleToday}\r\n                        className={`px-8 py-2.5 text-[10px] font-black uppercase tracking-widest transition-all rounded-2xl border-b-2 ${isMonthActual\r\n                            ? 'bg-blue-600 text-white shadow-xl shadow-blue-500/20 border-blue-800'\r\n                            : 'hover:bg-blue-50 dark:hover:bg-blue-900/20 text-muted-foreground hover:text-blue-600 border-transparent hover:border-blue-200'\r\n                            }`}\r\n                    >\r\n                        {isMonthActual ? t('calendar.today') : 'Hoy'}\r\n                    </button>\r\n\r\n                    <button\r\n                        onClick={handleNext}\r\n                        className=\"p-3 hover:bg-background hover:shadow-lg rounded-2xl transition-all group active:scale-90 flex items-center gap-2\"\r\n                        title={view === 'month' ? 'Mes Siguiente' : view === 'week' ? 'Semana Siguiente' : 'D├¡a Siguiente'}\r\n                    >\r\n                        <span className=\"hidden lg:inline text-[10px] font-black uppercase tracking-widest text-primary/70\">Siguiente</span>\r\n                        <ChevronRight className=\"w-6 h-6 text-primary group-hover:translate-x-0.5 transition-transform\" />\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Calendar Grid (Desktop) */}\r\n            <div className=\"hidden xl:block\">\r\n                <div className={`grid ${view === 'day' ? 'grid-cols-1' : 'grid-cols-7'} gap-px bg-border/20 rounded-[2rem] overflow-hidden border border-border/50 shadow-2xl`}>\r\n                    {view !== 'day' && weekDays.map(day => (\r\n                        <div key={day} className=\"bg-muted/30 text-center text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground py-4 border-b border-border/50\">\r\n                            {day}\r\n                        </div>\r\n                    ))}\r\n\r\n                    {daysToRender.map((day, idx) => {\r\n                        const dateStr = format(day, 'yyyy-MM-dd')\r\n                        const event = eventsMap.get(dateStr)\r\n                        const isToday = isSameDay(day, new Date())\r\n                        const isCurrentMonth = isSameMonth(day, currentDate)\r\n                        const status = event ? getCultoStatus(event) : null\r\n\r\n                        // Hide days from other months in Month View\r\n                        if (view === 'month' && !isCurrentMonth) {\r\n                            return (\r\n                                <div\r\n                                    key={dateStr}\r\n                                    className=\"min-h-[220px] md:min-h-[280px] p-2 md:p-4 bg-muted/5 opacity-20 pointer-events-none border-none shadow-none\"\r\n                                />\r\n                            )\r\n                        }\r\n\r\n                        // Sync Logic: Use explicit configuration from Culto Type\r\n                        const config = event?.tipo_culto || {}\r\n                        const showIntro = config.tiene_lectura_introduccion !== false // Default to true if undefined\r\n                        const showEnsenanza = !!config.tiene_ensenanza\r\n                        const showTestimonios = !!config.tiene_testimonios\r\n                        const showFinal = config.tiene_lectura_finalizacion !== false // Default to true if undefined\r\n\r\n                        return (\r\n                            <motion.div\r\n                                key={dateStr}\r\n                                initial={{ opacity: 0 }}\r\n                                animate={{ opacity: 1 }}\r\n                                transition={{ delay: idx * 0.01 }}\r\n                                onClick={() => onDateSelect?.(day)}\r\n                                className={`\r\n                                    ${view === 'day' ? 'min-h-[400px]' : view === 'week' ? 'min-h-[300px]' : 'min-h-[220px] md:min-h-[280px]'} p-2 md:p-4 transition-all relative group/day cursor-pointer overflow-hidden flex flex-col\r\n                                    ${isCurrentMonth || view !== 'month' ? 'bg-background/40' : 'bg-muted/10 opacity-40'}\r\n                                    ${isToday ? 'ring-2 ring-inset ring-primary shadow-[inset_0_0_20px_rgba(var(--primary-rgb),0.05)]' : ''}\r\n                                    hover:bg-primary/5\r\n                                `}\r\n                            >\r\n                                <div className=\"flex items-center justify-between mb-2 md:mb-4 shrink-0\">\r\n                                    <div className=\"flex flex-col\">\r\n                                        <span className={`text-base md:text-lg font-black ${!isCurrentMonth && view === 'month' ? 'text-muted-foreground/40' : isToday ? 'text-primary' : ''}`}>\r\n                                            {format(day, 'd')}\r\n                                        </span>\r\n                                        {view === 'day' && (\r\n                                            <span className=\"text-[10px] md:text-xs font-bold text-muted-foreground uppercase tracking-widest\">\r\n                                                {format(day, 'EEEE', { locale })}\r\n                                            </span>\r\n                                        )}\r\n                                    </div>\r\n                                    {event && (\r\n                                        <div\r\n                                            className=\"w-2.5 h-2.5 md:w-3 md:h-3 rounded-full shadow-[0_0_15px_rgba(0,0,0,0.1)] border-2 border-white dark:border-slate-800 shrink-0\"\r\n                                            style={{ backgroundColor: event.tipo_culto?.color || '#888' }}\r\n                                        />\r\n                                    )}\r\n                                </div>\r\n\r\n                                {event ? (\r\n                                    <Link href={`/dashboard/cultos/${event.id}`} className=\"flex-1 min-h-0 w-full h-full\">\r\n                                        <div className={`\r\n                                            w-full h-full p-3 md:p-4 rounded-[1.5rem] md:rounded-[2rem] transition-all cursor-pointer border shadow-md flex flex-col justify-between text-center overflow-hidden\r\n                                            ${status === 'complete'\r\n                                                ? (isDark ? 'bg-emerald-900/30 border-emerald-500/40 hover:bg-emerald-900/40' : 'bg-emerald-100 border-emerald-300 hover:bg-emerald-200 shadow-lg shadow-emerald-200/20')\r\n                                                : event.es_laborable_festivo\r\n                                                    ? (isDark ? 'bg-amber-900/30 border-amber-500/40 hover:bg-amber-900/40' : 'bg-amber-100 border-amber-300 hover:bg-amber-200 shadow-lg shadow-amber-200/20')\r\n                                                    : (isDark ? 'bg-slate-800/40 border-white/5 hover:bg-slate-800/60' : 'bg-white border-gray-100 hover:bg-gray-50')\r\n                                            }\r\n                                            ${view === 'day' ? 'max-w-2xl mx-auto' : ''}\r\n                                        `}>\r\n                                            {/* Cabecera: Nombre del Culto */}\r\n                                            <div className=\"w-full\">\r\n                                                <p className={`text-[9px] md:text-[11px] font-black uppercase tracking-tight leading-tight mb-2 ${status === 'complete' ? 'text-emerald-900 dark:text-emerald-100' :\r\n                                                    event.es_laborable_festivo ? 'text-amber-900 dark:text-amber-100' : ''\r\n                                                    }`}>\r\n                                                    {event.tipo_culto?.nombre}\r\n                                                </p>\r\n\r\n                                                <div className={`\r\n                                                    mx-auto text-[7px] md:text-[8px] font-black uppercase tracking-widest px-2 py-1 rounded-full inline-flex items-center gap-1 shadow-xs border\r\n                                                    ${status === 'complete'\r\n                                                        ? 'bg-emerald-500/20 text-emerald-800 dark:text-emerald-300 border-emerald-500/30'\r\n                                                        : 'bg-amber-500/20 text-amber-800 dark:text-amber-300 border-amber-500/30'}\r\n                                                `}>\r\n                                                    {status === 'complete' ? <CheckCircle size={8} className=\"md:w-[10px] md:h-[10px]\" /> : <Clock size={8} className=\"md:w-[10px] md:h-[10px]\" />}\r\n                                                    <span>{status === 'complete' ? t('calendar.status.complete') : t('calendar.status.pending')}</span>\r\n                                                </div>\r\n                                            </div>\r\n\r\n                                            {/* Secci├│n de Asignaciones */}\r\n                                            {view !== 'day' && (\r\n                                                (showIntro && event.usuario_intro) ||\r\n                                                (showEnsenanza && event.usuario_ensenanza) ||\r\n                                                (showTestimonios && event.usuario_testimonios) ||\r\n                                                (showFinal && event.usuario_finalizacion)\r\n                                            ) && (\r\n                                                    <div className=\"w-full space-y-1 mt-2 pt-2 border-t border-black/5 dark:border-white/5\">\r\n                                                        <div className=\"space-y-0.5\">\r\n                                                            {showIntro && event.usuario_intro && (\r\n                                                                <div className=\"text-[10px] font-bold px-1 leading-snug text-left\">\r\n                                                                    <span className=\"text-muted-foreground/70\">I:</span> <span className=\"break-words\">{event.usuario_intro.nombre} {event.usuario_intro.apellidos}</span>\r\n                                                                </div>\r\n                                                            )}\r\n                                                            {showEnsenanza && event.usuario_ensenanza && (\r\n                                                                <div className=\"text-[10px] font-bold px-1 leading-snug text-left\">\r\n                                                                    <span className=\"text-muted-foreground/70\">E:</span> <span className=\"break-words\">{event.usuario_ensenanza.nombre} {event.usuario_ensenanza.apellidos}</span>\r\n                                                                </div>\r\n                                                            )}\r\n                                                            {showTestimonios && event.usuario_testimonios && (\r\n                                                                <div className=\"text-[10px] font-bold px-1 leading-snug text-left\">\r\n                                                                    <span className=\"text-muted-foreground/70\">T:</span> <span className=\"break-words\">{event.usuario_testimonios.nombre} {event.usuario_testimonios.apellidos}</span>\r\n                                                                </div>\r\n                                                            )}\r\n                                                            {showFinal && event.usuario_finalizacion && (\r\n                                                                <div className=\"text-[10px] font-bold px-1 leading-snug text-left\">\r\n                                                                    <span className=\"text-muted-foreground/70\">F:</span> <span className=\"break-words\">{event.usuario_finalizacion.nombre} {event.usuario_finalizacion.apellidos}</span>\r\n                                                                </div>\r\n                                                            )}\r\n                                                        </div>\r\n                                                    </div>\r\n                                                )}\r\n\r\n                                            {/* Pie: Hora y Festivo */}\r\n                                            <div className=\"w-full space-y-2 mt-auto pt-2 border-t border-black/5 dark:border-white/5\">\r\n                                                <div className={`flex items-center justify-center gap-1.5 text-[9px] md:text-[10px] font-bold ${status === 'complete' ? 'text-emerald-900/80 dark:text-emerald-200/80' :\r\n                                                    event.es_laborable_festivo ? 'text-amber-900/80 dark:text-amber-200/80' :\r\n                                                        'text-muted-foreground'\r\n                                                    }`}>\r\n                                                    <Clock size={10} className=\"md:w-[12px] md:h-[12px] opacity-60\" />\r\n                                                    {event.hora_inicio.slice(0, 5)}\r\n                                                </div>\r\n                                                {event.es_laborable_festivo && (\r\n                                                    <div className=\"mx-auto flex items-center justify-center gap-1 text-amber-800 dark:text-amber-200 text-[8px] md:text-[9px] font-black uppercase tracking-widest bg-amber-500/20 px-2 py-0.5 rounded-md border border-amber-600/20\">\r\n                                                        <AlertCircle size={10} />\r\n                                                        <span>{t('calendar.festivoLabel')}</span>\r\n                                                    </div>\r\n                                                )}\r\n                                            </div>\r\n\r\n                                            {view === 'day' && (\r\n                                                <div className=\"grid grid-cols-2 gap-4 pt-2 border-t border-border/50 shrink-0\">\r\n                                                    <div className=\"space-y-1\">\r\n                                                        <p className=\"text-[8px] font-black text-muted-foreground/60 uppercase tracking-widest\">Responsable</p>\r\n                                                        <p className=\"text-xs font-bold truncate\">Sin asignar</p>\r\n                                                    </div>\r\n                                                    <div className=\"space-y-1\">\r\n                                                        <p className=\"text-[8px] font-black text-muted-foreground/60 uppercase tracking-widest\">Lectura</p>\r\n                                                        <p className=\"text-xs font-bold truncate\">Pendiente</p>\r\n                                                    </div>\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    </Link>\r\n                                ) : view === 'day' ? (\r\n                                    <div className=\"h-full flex flex-col items-center justify-center text-center opacity-30\">\r\n                                        <CalendarIcon className=\"w-16 h-16 mb-4\" />\r\n                                        <p className=\"text-sm font-bold uppercase tracking-widest\">{t('calendar.noCultos')}</p>\r\n                                    </div>\r\n                                ) : null}\r\n                            </motion.div>\r\n                        )\r\n                    })}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Calendar List (Mobile/Tablet) - Vista de tarjetas premium */}\r\n            <div className=\"xl:hidden space-y-4 px-2 max-h-[60vh] overflow-y-auto no-scrollbar\">\r\n                <AnimatePresence mode=\"wait\">\r\n                    <motion.div\r\n                        key={`${view}-${currentDate.getTime()}`}\r\n                        initial={{ opacity: 0, x: 20 }}\r\n                        animate={{ opacity: 1, x: 0 }}\r\n                        exit={{ opacity: 0, x: -20 }}\r\n                        className=\"space-y-4\"\r\n                    >\r\n                        {Array.from(eventsMap.values())\r\n                            .filter(e => {\r\n                                const eventDate = new Date(e.fecha)\r\n                                if (view === 'month') return isSameMonth(eventDate, currentDate)\r\n                                if (view === 'week') return isSameWeek(eventDate, currentDate, { weekStartsOn: 1 })\r\n                                if (view === 'day') return isSameDay(eventDate, currentDate)\r\n                                return true\r\n                            })\r\n                            .sort((a, b) => new Date(a.fecha).getTime() - new Date(b.fecha).getTime())\r\n                            .map((event, idx) => {\r\n                                const status = getCultoStatus(event)\r\n                                // Sync Logic (Mobile)\r\n                                const config = event?.tipo_culto || {}\r\n                                const showIntro = config.tiene_lectura_introduccion !== false\r\n                                const showEnsenanza = !!config.tiene_ensenanza\r\n                                const showTestimonios = !!config.tiene_testimonios\r\n                                const showFinal = config.tiene_lectura_finalizacion !== false\r\n                                return (\r\n                                    <Link href={`/dashboard/cultos/${event.id}`} key={event.id}>\r\n                                        <motion.div\r\n                                            initial={{ opacity: 0, y: 10 }}\r\n                                            animate={{ opacity: 1, y: 0 }}\r\n                                            transition={{ delay: idx * 0.05 }}\r\n                                            className=\"glass rounded-[2rem] p-5 flex items-start gap-4 border border-white/20 active:scale-[0.98] transition-all shadow-xl shadow-black/5 min-h-[140px]\"\r\n                                        >\r\n                                            <div className=\"flex flex-col items-center justify-center bg-primary/10 rounded-2xl w-14 h-14 shrink-0 border border-primary/20\">\r\n                                                <span className=\"text-[9px] font-black text-primary/60 uppercase tracking-tighter leading-none mb-0.5\">\r\n                                                    {format(new Date(event.fecha), 'MMM', { locale })}\r\n                                                </span>\r\n                                                <span className=\"text-xl font-black text-primary tracking-tighter leading-none\">\r\n                                                    {format(new Date(event.fecha), 'd')}\r\n                                                </span>\r\n                                            </div>\r\n\r\n                                            <div className=\"flex-1 min-w-0\">\r\n                                                <div className=\"flex items-center justify-between gap-2 mb-2\">\r\n                                                    <h3 className=\"font-black text-sm uppercase tracking-tight leading-tight break-words flex-1\">\r\n                                                        {event.tipo_culto?.nombre}\r\n                                                    </h3>\r\n                                                    <div\r\n                                                        className=\"w-2.5 h-2.5 rounded-full shrink-0 shadow-sm\"\r\n                                                        style={{ backgroundColor: event.tipo_culto?.color || '#888' }}\r\n                                                    />\r\n                                                </div>\r\n                                                <div className=\"flex items-center flex-wrap gap-x-3 gap-y-1 mb-2\">\r\n                                                    <p className=\"text-[10px] text-muted-foreground font-bold flex items-center gap-1\">\r\n                                                        <Clock size={12} className=\"text-primary/60\" />\r\n                                                        {event.hora_inicio.slice(0, 5)}\r\n                                                        {event.es_laborable_festivo && <AlertCircle size={12} className=\"text-amber-500\" />}\r\n                                                    </p>\r\n                                                    <div className={`flex items-center gap-1 text-[9px] font-black uppercase tracking-widest ${status === 'complete' ? 'text-emerald-500' : 'text-amber-500'}`}>\r\n                                                        {status === 'complete' ? <CheckCircle size={10} /> : <Clock size={10} />}\r\n                                                        {status === 'complete' ? t('calendar.status.complete') : t('calendar.status.pending')}\r\n                                                    </div>\r\n                                                </div>\r\n                                                {/* Asignaciones en m├│vil */}\r\n                                                {((showIntro && event.usuario_intro) || (showEnsenanza && event.usuario_ensenanza) || (showTestimonios && event.usuario_testimonios) || (showFinal && event.usuario_finalizacion)) && (\r\n                                                    <div className=\"space-y-1 pt-2 border-t border-white/10 dark:border-white/5\">\r\n                                                        {showIntro && event.usuario_intro && (\r\n                                                            <div className=\"text-[10px] font-bold leading-snug\">\r\n                                                                <span className=\"text-muted-foreground/70\">I:</span> <span className=\"break-words\">{event.usuario_intro.nombre} {event.usuario_intro.apellidos}</span>\r\n                                                            </div>\r\n                                                        )}\r\n                                                        {showEnsenanza && event.usuario_ensenanza && (\r\n                                                            <div className=\"text-[10px] font-bold leading-snug\">\r\n                                                                <span className=\"text-muted-foreground/70\">E:</span> <span className=\"break-words\">{event.usuario_ensenanza.nombre} {event.usuario_ensenanza.apellidos}</span>\r\n                                                            </div>\r\n                                                        )}\r\n                                                        {showTestimonios && event.usuario_testimonios && (\r\n                                                            <div className=\"text-[10px] font-bold leading-snug\">\r\n                                                                <span className=\"text-muted-foreground/70\">T:</span> <span className=\"break-words\">{event.usuario_testimonios.nombre} {event.usuario_testimonios.apellidos}</span>\r\n                                                            </div>\r\n                                                        )}\r\n                                                        {showFinal && event.usuario_finalizacion && (\r\n                                                            <div className=\"text-[10px] font-bold leading-snug\">\r\n                                                                <span className=\"text-muted-foreground/70\">F:</span> <span className=\"break-words\">{event.usuario_finalizacion.nombre} {event.usuario_finalizacion.apellidos}</span>\r\n                                                            </div>\r\n                                                        )}\r\n                                                    </div>\r\n                                                )}\r\n                                            </div>\r\n\r\n                                            <div className=\"p-2 bg-muted/30 rounded-xl shrink-0\">\r\n                                                <ChevronRight className=\"w-4 h-4 text-muted-foreground/50\" />\r\n                                            </div>\r\n                                        </motion.div>\r\n                                    </Link>\r\n                                )\r\n                            })}\r\n\r\n                        {Array.from(eventsMap.values()).filter(e => {\r\n                            const eventDate = new Date(e.fecha)\r\n                            if (view === 'month') return isSameMonth(eventDate, currentDate)\r\n                            if (view === 'week') return isSameWeek(eventDate, currentDate, { weekStartsOn: 1 })\r\n                            if (view === 'day') return isSameDay(eventDate, currentDate)\r\n                            return true\r\n                        }).length === 0 && (\r\n                                <div className=\"text-center py-12 glass rounded-3xl border border-white/20\">\r\n                                    <CalendarIcon className=\"w-12 h-12 text-muted-foreground/20 mx-auto mb-4\" />\r\n                                    <p className=\"text-sm font-bold text-muted-foreground uppercase tracking-widest\">\r\n                                        {t('calendar.noCultos')}\r\n                                    </p>\r\n                                </div>\r\n                            )}\r\n                    </motion.div>\r\n                </AnimatePresence>\r\n            </div>\r\n\r\n            {/* Leyenda y Notas */}\r\n            <div className=\"flex flex-wrap items-center justify-center gap-6 px-4 py-6 glass rounded-[2rem] border border-white/10\">\r\n                <div className=\"flex items-center gap-2\">\r\n                    <div className=\"w-3 h-3 rounded-full bg-emerald-500 shadow-lg shadow-emerald-500/20\" />\r\n                    <span className=\"text-[10px] font-black uppercase tracking-widest opacity-70\">{t('calendar.legend.estudio')}</span>\r\n                </div>\r\n                <div className=\"flex items-center gap-2\">\r\n                    <div className=\"w-3 h-3 rounded-full bg-blue-500 shadow-lg shadow-blue-500/20\" />\r\n                    <span className=\"text-[10px] font-black uppercase tracking-widest opacity-70\">{t('calendar.legend.alabanza')}</span>\r\n                </div>\r\n                <div className=\"flex items-center gap-2\">\r\n                    <div className=\"w-3 h-3 rounded-full bg-purple-500 shadow-lg shadow-purple-500/20\" />\r\n                    <span className=\"text-[10px] font-black uppercase tracking-widest opacity-70\">{t('calendar.legend.ensenanza')}</span>\r\n                </div>\r\n                <div className=\"flex items-center gap-2 bg-amber-500/10 px-3 py-1 rounded-full\">\r\n                    <AlertCircle size={14} className=\"text-amber-500\" />\r\n                    <span className=\"text-[10px] font-black uppercase tracking-widest text-amber-600\">\r\n                        {t('calendar.laborableFestivo')}\r\n                    </span>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\HimnoCoroSelector.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'GripVertical' is defined but never used.","line":21,"column":70,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":82},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isSearching' is assigned a value but never used.","line":171,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":171,"endColumn":23},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Math.random` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\HimnoCoroSelector.tsx:296:21\n  294 |\n  295 |             const newItem: PlanHimnoCoro = {\n> 296 |                 id: Math.random().toString(), // Temp ID\n      |                     ^^^^^^^^^^^^^ Cannot call impure function\n  297 |                 culto_id: 'temp',\n  298 |                 tipo,\n  299 |                 item_id: item.id,","line":296,"column":21,"nodeType":null,"endLine":296,"endColumn":34}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * HimnoCoroSelector - IDMJI Gestor de P├║lpito\r\n * \r\n * Componente para seleccionar y organizar himnos y coros en cultos o calculadora de tiempo.\r\n * \r\n * Caracter├¡sticas:\r\n * - B├║squeda en tiempo real de himnos y coros\r\n * - Ordenamiento autom├ítico: primero himnos, luego coros\r\n * - Reorganizaci├│n con botones de flechas (arriba/abajo)\r\n * - Drag-and-drop premium para reorganizaci├│n visual\r\n * - Modo calculadora (sin cultoId) y modo culto (con cultoId)\r\n * - Guardado de listas en localStorage (calculadora)\r\n * \r\n * @author Antigravity AI\r\n * @date 2024-12-25\r\n */\r\n\r\n'use client'\r\n\r\nimport { useState, useEffect, useMemo } from 'react'\r\nimport { Search, Plus, Trash2, Music, Clock, ChevronUp, ChevronDown, GripVertical } from 'lucide-react'\r\nimport { useDebounce } from '@/hooks/use-debounce'\r\nimport { searchHimnos, searchCoros, addHimnoCoro, removeHimnoCoro, getHimnosCorosByCulto, updateHimnosCorosOrder } from '@/app/dashboard/himnos/actions'\r\nimport { Himno, Coro, PlanHimnoCoro } from '@/types/database'\r\nimport { toast } from 'sonner'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport {\r\n    DndContext,\r\n    closestCenter,\r\n    KeyboardSensor,\r\n    PointerSensor,\r\n    useSensor,\r\n    useSensors,\r\n    DragEndEvent,\r\n} from '@dnd-kit/core'\r\nimport {\r\n    arrayMove,\r\n    SortableContext,\r\n    sortableKeyboardCoordinates,\r\n    useSortable,\r\n    verticalListSortingStrategy,\r\n} from '@dnd-kit/sortable'\r\nimport { CSS } from '@dnd-kit/utilities'\r\n\r\ninterface HimnoCoroSelectorProps {\r\n    cultoId?: string // Now optional for calculator mode\r\n    maxHimnos?: number\r\n    maxCoros?: number\r\n    className?: string\r\n}\r\n\r\n/**\r\n * Componente sortable individual para cada item\r\n */\r\nfunction SortableItem({ item, onRemove, onMoveUp, onMoveDown, isFirst, isLast }: {\r\n    item: PlanHimnoCoro\r\n    onRemove: (id: string) => void\r\n    onMoveUp: (id: string) => void\r\n    onMoveDown: (id: string) => void\r\n    isFirst: boolean\r\n    isLast: boolean\r\n}) {\r\n    const {\r\n        setNodeRef,\r\n        transform,\r\n        transition,\r\n        isDragging,\r\n    } = useSortable({ id: item.id })\r\n\r\n    const style = {\r\n        transform: CSS.Transform.toString(transform),\r\n        transition,\r\n        opacity: isDragging ? 0.5 : 1,\r\n        zIndex: isDragging ? 50 : 1,\r\n    }\r\n\r\n    const data = item.tipo === 'himno' ? item.himno : item.coro\r\n\r\n    const formatDuration = (seconds: number) => {\r\n        const mins = Math.floor(seconds / 60)\r\n        const secs = seconds % 60\r\n        return `${mins}:${secs.toString().padStart(2, '0')}`\r\n    }\r\n\r\n    return (\r\n        <motion.div\r\n            ref={setNodeRef}\r\n            style={style}\r\n            layout\r\n            initial={{ opacity: 0, scale: 0.95 }}\r\n            animate={{ opacity: isDragging ? 0.5 : 1, scale: 1 }}\r\n            exit={{ opacity: 0, scale: 0.95 }}\r\n            className={`flex items-center justify-between p-3 md:p-4 bg-muted/30 dark:bg-white/5 border border-border/50 dark:border-white/10 rounded-2xl shadow-sm transition-all group ${\r\n                isDragging ? 'ring-2 ring-primary bg-background shadow-xl' : ''\r\n            }`}\r\n        >\r\n            <div className=\"flex items-center gap-3 md:gap-4 flex-1 min-w-0\">\r\n                <div className={`w-10 h-10 md:w-11 md:h-11 rounded-xl md:rounded-2xl flex items-center justify-center font-black text-xs md:text-sm shadow-inner shrink-0 ${item.tipo === 'himno'\r\n                    ? 'bg-blue-500 text-white'\r\n                    : 'bg-purple-500 text-white'\r\n                    }`}>\r\n                    {item.tipo === 'himno' ? 'H' : 'C'}\r\n                </div>\r\n                <div className=\"flex-1 min-w-0\">\r\n                    <p className=\"font-black text-xs md:text-sm uppercase tracking-tight leading-tight text-foreground break-words whitespace-normal\">\r\n                        #{data?.numero} <span className=\"text-muted-foreground mx-1\">|</span> {data?.titulo}\r\n                    </p>\r\n                    <div className=\"flex items-center gap-3 mt-2\">\r\n                        <span className={`text-[8px] md:text-[9px] uppercase font-black px-2.5 py-1 rounded-full tracking-wider border shadow-sm ${\r\n                            item.tipo === 'himno' \r\n                                ? 'bg-blue-500/10 border-blue-500/20 text-blue-600' \r\n                                : 'bg-purple-500/10 border-purple-500/20 text-purple-600'\r\n                        }`}>\r\n                            {item.tipo === 'himno' ? 'Himno' : 'Coro'}\r\n                        </span>\r\n                        <div className=\"flex items-center gap-1.5 text-[9px] md:text-[10px] text-muted-foreground/60 font-black uppercase tracking-widest\">\r\n                            <Clock className=\"w-3 h-3 opacity-50\" />\r\n                            {formatDuration(data?.duracion_segundos || 0)}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Control Buttons */}\r\n            <div className=\"flex items-center gap-0.5 md:gap-1 shrink-0 ml-2\">\r\n                <button\r\n                    onClick={() => onMoveUp(item.id)}\r\n                    disabled={isFirst}\r\n                    className={`p-1.5 md:p-2 rounded-lg transition-all ${\r\n                        isFirst\r\n                            ? 'opacity-20 cursor-not-allowed'\r\n                            : 'text-primary hover:bg-primary/10 active:scale-90'\r\n                    }`}\r\n                >\r\n                    <ChevronUp className=\"w-4 h-4\" />\r\n                </button>\r\n\r\n                <button\r\n                    onClick={() => onMoveDown(item.id)}\r\n                    disabled={isLast}\r\n                    className={`p-1.5 md:p-2 rounded-lg transition-all ${\r\n                        isLast\r\n                            ? 'opacity-20 cursor-not-allowed'\r\n                            : 'text-primary hover:bg-primary/10 active:scale-90'\r\n                    }`}\r\n                >\r\n                    <ChevronDown className=\"w-4 h-4\" />\r\n                </button>\r\n\r\n                <button\r\n                    onClick={() => onRemove(item.id)}\r\n                    className=\"p-1.5 md:p-2 text-red-500 hover:bg-red-500/10 rounded-lg transition-all\"\r\n                >\r\n                    <Trash2 className=\"w-4 h-4\" />\r\n                </button>\r\n            </div>\r\n        </motion.div>\r\n    )\r\n}\r\n\r\nexport default function HimnoCoroSelector({\r\n    cultoId,\r\n    maxHimnos = 3,\r\n    maxCoros = 3,\r\n    className\r\n}: HimnoCoroSelectorProps) {\r\n    const [tipo, setTipo] = useState<'himno' | 'coro'>('himno')\r\n    const [query, setQuery] = useState('')\r\n    const [results, setResults] = useState<(Himno | Coro)[]>([])\r\n    const [selected, setSelected] = useState<PlanHimnoCoro[]>([])\r\n    const [isSearching, setIsSearching] = useState(false)\r\n    const [savedLists, setSavedLists] = useState<{ id: string, name: string, items: PlanHimnoCoro[] }[]>([])\r\n    const [isSaveModalOpen, setIsSaveModalOpen] = useState(false)\r\n    const [listName, setListName] = useState('')\r\n\r\n    const debouncedQuery = useDebounce(query, 300)\r\n\r\n    // Configurar sensores para drag-and-drop\r\n    const sensors = useSensors(\r\n        useSensor(PointerSensor),\r\n        useSensor(KeyboardSensor, {\r\n            coordinateGetter: sortableKeyboardCoordinates,\r\n        })\r\n    )\r\n\r\n    // Ordenar selected: primero himnos, luego coros, manteniendo el orden dentro de cada tipo\r\n    const sortedSelected = useMemo(() => {\r\n        const himnos = selected.filter(s => s.tipo === 'himno').sort((a, b) => a.orden - b.orden)\r\n        const coros = selected.filter(s => s.tipo === 'coro').sort((a, b) => a.orden - b.orden)\r\n        return [...himnos, ...coros]\r\n    }, [selected])\r\n\r\n    // Cargar himnos/coros ya seleccionados si hay cultoId o de localStorage para calculadora\r\n    useEffect(() => {\r\n        async function loadData() {\r\n            if (cultoId) {\r\n                const { data } = await getHimnosCorosByCulto(cultoId)\r\n                if (data) {\r\n                    // Asegurar que el orden est├® correcto: primero himnos, luego coros\r\n                    const himnos = data.filter(s => s.tipo === 'himno').sort((a, b) => a.orden - b.orden)\r\n                    const coros = data.filter(s => s.tipo === 'coro').sort((a, b) => a.orden - b.orden)\r\n                    setSelected([...himnos, ...coros])\r\n                }\r\n            } else {\r\n                // Cargar listas guardadas de localStorage\r\n                const saved = localStorage.getItem('idmji_saved_lists')\r\n                if (saved) setSavedLists(JSON.parse(saved))\r\n\r\n                // Cargar sesi├│n actual de calculadora\r\n                const current = localStorage.getItem('idmji_calc_session')\r\n                if (current) {\r\n                    const parsed = JSON.parse(current)\r\n                    // Asegurar ordenamiento\r\n                    const himnos = parsed.filter((s: PlanHimnoCoro) => s.tipo === 'himno').sort((a: PlanHimnoCoro, b: PlanHimnoCoro) => a.orden - b.orden)\r\n                    const coros = parsed.filter((s: PlanHimnoCoro) => s.tipo === 'coro').sort((a: PlanHimnoCoro, b: PlanHimnoCoro) => a.orden - b.orden)\r\n                    setSelected([...himnos, ...coros])\r\n                }\r\n            }\r\n        }\r\n        loadData()\r\n    }, [cultoId])\r\n\r\n    // Guardar sesi├│n actual en cada cambio (modo calculadora)\r\n    useEffect(() => {\r\n        if (!cultoId) {\r\n            localStorage.setItem('idmji_calc_session', JSON.stringify(sortedSelected))\r\n        }\r\n    }, [sortedSelected, cultoId])\r\n\r\n    // Buscar himnos/coros\r\n    useEffect(() => {\r\n        async function search() {\r\n            if (debouncedQuery.length < 1) {\r\n                setResults([])\r\n                return\r\n            }\r\n\r\n            setIsSearching(true)\r\n            const searchFn = tipo === 'himno' ? searchHimnos : searchCoros\r\n            const { data } = await searchFn(debouncedQuery)\r\n            setResults(data || [])\r\n            setIsSearching(false)\r\n        }\r\n        search()\r\n    }, [debouncedQuery, tipo])\r\n\r\n    const himnosSelected = sortedSelected.filter(s => s.tipo === 'himno')\r\n    const corosSelected = sortedSelected.filter(s => s.tipo === 'coro')\r\n\r\n    const canAddHimno = himnosSelected.length < maxHimnos\r\n    const canAddCoro = corosSelected.length < maxCoros\r\n\r\n    const handleAdd = async (item: Himno | Coro) => {\r\n        // Validaci├│n de duplicados\r\n        if (sortedSelected.some(s => s.item_id === item.id && s.tipo === tipo)) {\r\n            toast.error(`Este ${tipo} ya est├í en la lista`)\r\n            return\r\n        }\r\n\r\n        if (tipo === 'himno' && !canAddHimno) {\r\n            toast.error(`M├íximo ${maxHimnos} himnos permitidos`)\r\n            return\r\n        }\r\n        if (tipo === 'coro' && !canAddCoro) {\r\n            toast.error(`M├íximo ${maxCoros} coros permitidos`)\r\n            return\r\n        }\r\n\r\n        if (cultoId) {\r\n            // Modo Real: Guardar en DB\r\n            // Calcular el orden: si es himno, va despu├®s del ├║ltimo himno; si es coro, va despu├®s del ├║ltimo coro\r\n            const lastOfType = sortedSelected.filter(s => s.tipo === tipo)\r\n            const orden = lastOfType.length > 0 ? Math.max(...lastOfType.map(s => s.orden)) + 1 : 1\r\n\r\n            const result = await addHimnoCoro(cultoId, tipo, item.id, orden)\r\n\r\n            if (result.error) {\r\n                toast.error(result.error)\r\n            } else {\r\n                toast.success(`${tipo === 'himno' ? 'Himno' : 'Coro'} a├▒adido`)\r\n                const { data } = await getHimnosCorosByCulto(cultoId)\r\n                if (data) {\r\n                    const himnos = data.filter(s => s.tipo === 'himno').sort((a, b) => a.orden - b.orden)\r\n                    const coros = data.filter(s => s.tipo === 'coro').sort((a, b) => a.orden - b.orden)\r\n                    setSelected([...himnos, ...coros])\r\n                }\r\n                setQuery('')\r\n                setResults([])\r\n            }\r\n        } else {\r\n            // Modo Calculadora: Estado Local\r\n            const lastOfType = sortedSelected.filter(s => s.tipo === tipo)\r\n            const orden = lastOfType.length > 0 ? Math.max(...lastOfType.map(s => s.orden)) + 1 : 1\r\n\r\n            const newItem: PlanHimnoCoro = {\r\n                id: Math.random().toString(), // Temp ID\r\n                culto_id: 'temp',\r\n                tipo,\r\n                item_id: item.id,\r\n                orden,\r\n                [tipo === 'himno' ? 'himno' : 'coro']: item\r\n            }\r\n            setSelected([...sortedSelected, newItem])\r\n            setQuery('')\r\n            setResults([])\r\n            toast.success('A├▒adido a la lista temporal')\r\n        }\r\n    }\r\n\r\n    const handleRemove = async (planId: string) => {\r\n        if (cultoId) {\r\n            await removeHimnoCoro(planId, cultoId)\r\n            const { data } = await getHimnosCorosByCulto(cultoId)\r\n            if (data) {\r\n                const himnos = data.filter(s => s.tipo === 'himno').sort((a, b) => a.orden - b.orden)\r\n                const coros = data.filter(s => s.tipo === 'coro').sort((a, b) => a.orden - b.orden)\r\n                setSelected([...himnos, ...coros])\r\n            }\r\n        } else {\r\n            setSelected(sortedSelected.filter(s => s.id !== planId))\r\n        }\r\n        toast.success(cultoId ? 'Eliminado del culto' : 'Eliminado de la lista')\r\n    }\r\n\r\n    const handleMoveUp = async (id: string) => {\r\n        const index = sortedSelected.findIndex(item => item.id === id)\r\n        if (index <= 0) return\r\n\r\n        const newSelected = arrayMove(sortedSelected, index, index - 1)\r\n        await updateOrder(newSelected)\r\n    }\r\n\r\n    const handleMoveDown = async (id: string) => {\r\n        const index = sortedSelected.findIndex(item => item.id === id)\r\n        if (index < 0 || index >= sortedSelected.length - 1) return\r\n\r\n        const newSelected = arrayMove(sortedSelected, index, index + 1)\r\n        await updateOrder(newSelected)\r\n    }\r\n\r\n    const handleDragEnd = async (event: DragEndEvent) => {\r\n        const { active, over } = event\r\n\r\n        if (over && active.id !== over.id) {\r\n            const oldIndex = sortedSelected.findIndex(item => item.id === active.id)\r\n            const newIndex = sortedSelected.findIndex(item => item.id === over.id)\r\n\r\n            const newSelected = arrayMove(sortedSelected, oldIndex, newIndex)\r\n            await updateOrder(newSelected)\r\n        }\r\n    }\r\n\r\n    const updateOrder = async (newOrder: PlanHimnoCoro[]) => {\r\n        // Actualizar los valores de orden\r\n        const updated = newOrder.map((item, index) => ({\r\n            ...item,\r\n            orden: index + 1\r\n        }))\r\n\r\n        setSelected(updated)\r\n\r\n        if (cultoId) {\r\n            // Actualizar en la base de datos\r\n            const updates = updated.map(item => ({\r\n                id: item.id,\r\n                orden: item.orden\r\n            }))\r\n\r\n            const result = await updateHimnosCorosOrder(cultoId, updates)\r\n            if (result.error) {\r\n                toast.error('Error al actualizar el orden')\r\n                // Recargar desde la base de datos\r\n                const { data } = await getHimnosCorosByCulto(cultoId)\r\n                if (data) {\r\n                    const himnos = data.filter(s => s.tipo === 'himno').sort((a, b) => a.orden - b.orden)\r\n                    const coros = data.filter(s => s.tipo === 'coro').sort((a, b) => a.orden - b.orden)\r\n                    setSelected([...himnos, ...coros])\r\n                }\r\n            } else {\r\n                toast.success('Orden actualizado')\r\n            }\r\n        } else {\r\n            // Guardar en localStorage\r\n            localStorage.setItem('idmji_calc_session', JSON.stringify(updated))\r\n        }\r\n    }\r\n\r\n    const handleSaveList = () => {\r\n        if (sortedSelected.length === 0) {\r\n            toast.error('La lista est├í vac├¡a')\r\n            return\r\n        }\r\n        if (savedLists.length >= 2) {\r\n            toast.error('L├¡mite de 2 listas alcanzado. Borra una para guardar otra.')\r\n            return\r\n        }\r\n        setIsSaveModalOpen(true)\r\n    }\r\n\r\n    const confirmSaveList = () => {\r\n        if (!listName.trim()) {\r\n            toast.error('Ponle un nombre a la lista')\r\n            return\r\n        }\r\n        const newList = {\r\n            id: Date.now().toString(),\r\n            name: listName,\r\n            items: [...sortedSelected]\r\n        }\r\n        const updated = [...savedLists, newList]\r\n        setSavedLists(updated)\r\n        localStorage.setItem('idmji_saved_lists', JSON.stringify(updated))\r\n        setListName('')\r\n        setIsSaveModalOpen(false)\r\n        toast.success('Lista guardada correctamente')\r\n    }\r\n\r\n    const loadList = (list: typeof savedLists[0]) => {\r\n        const himnos = list.items.filter(s => s.tipo === 'himno').sort((a, b) => a.orden - b.orden)\r\n        const coros = list.items.filter(s => s.tipo === 'coro').sort((a, b) => a.orden - b.orden)\r\n        setSelected([...himnos, ...coros])\r\n        toast.success(`Lista \"${list.name}\" cargada`)\r\n    }\r\n\r\n    const deleteSavedList = (id: string) => {\r\n        const updated = savedLists.filter(l => l.id !== id)\r\n        setSavedLists(updated)\r\n        localStorage.setItem('idmji_saved_lists', JSON.stringify(updated))\r\n        toast.success('Lista eliminada')\r\n    }\r\n\r\n    const clearCalculator = () => {\r\n        setSelected([])\r\n        toast.success('Calculadora vaciada')\r\n    }\r\n\r\n    const formatDuration = (seconds: number) => {\r\n        const mins = Math.floor(seconds / 60)\r\n        const secs = seconds % 60\r\n        return `${mins}:${secs.toString().padStart(2, '0')}`\r\n    }\r\n\r\n    const durationHimnos = himnosSelected.reduce((acc, curr) => acc + (curr.himno?.duracion_segundos || 0), 0)\r\n    const durationCoros = corosSelected.reduce((acc, curr) => acc + (curr.coro?.duracion_segundos || 0), 0)\r\n    const totalDuration = durationHimnos + durationCoros\r\n\r\n    return (\r\n        <div className={`space-y-3 md:space-y-5 ${className} overflow-hidden w-full`}>\r\n            {/* Tipo Selector */}\r\n            <div className=\"flex bg-gray-100 dark:bg-zinc-800 p-1.5 rounded-2xl w-full border border-gray-200 dark:border-zinc-700\">\r\n                <button\r\n                    onClick={() => setTipo('himno')}\r\n                    className={`flex-1 px-4 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all ${tipo === 'himno'\r\n                        ? 'bg-blue-600 text-white shadow-xl'\r\n                        : 'text-gray-600 dark:text-zinc-400 hover:bg-gray-200 dark:hover:bg-zinc-700'\r\n                        }`}\r\n                >\r\n                    Himnos ({himnosSelected.length}/{maxHimnos})\r\n                </button>\r\n                <button\r\n                    onClick={() => setTipo('coro')}\r\n                    className={`flex-1 px-4 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all ${tipo === 'coro'\r\n                        ? 'bg-blue-600 text-white shadow-xl'\r\n                        : 'text-gray-600 dark:text-zinc-400 hover:bg-gray-200 dark:hover:bg-zinc-700'\r\n                        }`}\r\n                >\r\n                    Coros ({corosSelected.length}/{maxCoros})\r\n                </button>\r\n            </div>\r\n\r\n            {/* Total Time Badge - Stacked for sidebar */}\r\n            <div className=\"grid grid-cols-3 gap-2 text-[8px] font-black uppercase tracking-wider\">\r\n                <div className=\"flex flex-col items-center justify-center gap-1 bg-blue-500/10 dark:bg-blue-900/40 text-blue-600 dark:text-blue-300 py-2.5 px-1 rounded-2xl border border-blue-500/20 dark:border-blue-400/20\">\r\n                    <span className=\"opacity-60\">Himnos</span>\r\n                    <span className=\"text-sm\">{formatDuration(durationHimnos)}</span>\r\n                </div>\r\n                <div className=\"flex flex-col items-center justify-center gap-1 bg-purple-500/10 dark:bg-purple-900/40 text-purple-600 dark:text-purple-300 py-2.5 px-1 rounded-2xl border border-purple-500/20 dark:border-purple-400/20\">\r\n                    <span className=\"opacity-60\">Coros</span>\r\n                    <span className=\"text-sm\">{formatDuration(durationCoros)}</span>\r\n                </div>\r\n                <div className=\"flex flex-col items-center justify-center gap-1 bg-emerald-500/10 dark:bg-emerald-900/40 text-emerald-600 dark:text-emerald-300 py-2.5 px-1 rounded-2xl border border-emerald-500/20 dark:border-emerald-400/20\">\r\n                    <span className=\"opacity-60\">Total</span>\r\n                    <span className=\"text-sm font-black\">{formatDuration(totalDuration)}</span>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"relative group\">\r\n                <div className=\"absolute inset-0 bg-primary/20 rounded-2xl blur-xl opacity-0 group-focus-within:opacity-100 transition-opacity\" />\r\n                <div className=\"relative bg-card border border-border rounded-2xl flex items-center px-5 h-14 shadow-sm focus-within:border-primary/50 transition-all\">\r\n                    <Search className=\"w-5 h-5 text-muted-foreground mr-4\" />\r\n                    <input\r\n                        type=\"text\"\r\n                        value={query}\r\n                        onChange={(e) => setQuery(e.target.value)}\r\n                        placeholder={`Buscar ${tipo === 'himno' ? 'por n├║mero o t├¡tulo' : 'en el cat├ílogo'}...`}\r\n                        className=\"w-full bg-transparent border-none outline-none text-sm font-black uppercase tracking-widest placeholder:text-muted-foreground text-foreground\"\r\n                        disabled={tipo === 'himno' ? !canAddHimno : !canAddCoro}\r\n                    />\r\n                </div>\r\n            </div>\r\n\r\n            {/* Live Results */}\r\n            <AnimatePresence>\r\n                {results.length > 0 && (\r\n                    <motion.div\r\n                        initial={{ opacity: 0, y: -10 }}\r\n                        animate={{ opacity: 1, y: 0 }}\r\n                        exit={{ opacity: 0, y: -10 }}\r\n                        className=\"space-y-1 bg-muted/30 dark:bg-white/5 p-2 rounded-2xl border border-border/50 dark:border-white/10 max-h-60 overflow-y-auto no-scrollbar\"\r\n                    >\r\n                        {results.map((item, idx) => (\r\n                            <div\r\n                                key={item.id || `himno-coro-result-${idx}`}\r\n                                className=\"flex items-center justify-between p-4 bg-card rounded-xl hover:bg-blue-500/10 transition-all group cursor-pointer border border-border/50 shadow-sm\"\r\n                                onClick={() => handleAdd(item)}\r\n                            >\r\n                                <div className=\"flex-1\">\r\n                                    <p className=\"font-black text-xs uppercase tracking-widest leading-none text-foreground group-hover:text-[#4A90E2] transition-colors\">\r\n                                        <span className=\"text-primary font-black mr-3 transition-colors group-hover:text-[#4A90E2]\">#{item.numero}</span>\r\n                                        {item.titulo}\r\n                                    </p>\r\n                                    {item.duracion_segundos && (\r\n                                        <div className=\"flex items-center gap-1.5 text-[9px] text-muted-foreground font-black uppercase tracking-widest mt-2 group-hover:text-[#4A90E2]/80 transition-colors\">\r\n                                            <Clock className=\"w-3 h-3\" />\r\n                                            {formatDuration(item.duracion_segundos)}\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                                <div className=\"w-8 h-8 flex items-center justify-center rounded-lg bg-blue-600 text-white group-hover:scale-110 transition-all shrink-0 ml-4 shadow-md\">\r\n                                    <Plus className=\"w-4 h-4\" />\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </motion.div>\r\n                )}\r\n            </AnimatePresence>\r\n\r\n            {/* List Persistence Actions */}\r\n            {!cultoId && (\r\n                <div className=\"grid grid-cols-2 gap-3 pt-2\">\r\n                    <button\r\n                        onClick={handleSaveList}\r\n                        className=\"flex items-center justify-center gap-2 py-3 rounded-2xl bg-blue-600 hover:bg-blue-700 text-white font-black text-[10px] uppercase tracking-widest shadow-lg shadow-blue-500/20 transition-all hover:-translate-y-0.5\"\r\n                    >\r\n                        Guardar Lista\r\n                    </button>\r\n                    <button\r\n                        onClick={clearCalculator}\r\n                        className=\"flex items-center justify-center gap-2 py-3 rounded-2xl bg-red-500/10 text-red-500 dark:text-red-400 font-black text-[10px] uppercase tracking-widest border border-red-500/20 hover:bg-red-500 hover:text-white transition-all\"\r\n                    >\r\n                        Limpiar Todo\r\n                    </button>\r\n                </div>\r\n            )}\r\n\r\n            {/* Saved Lists Storage */}\r\n            {!cultoId && savedLists.length > 0 && (\r\n                <div className=\"space-y-3 pt-4 border-t border-border/50\">\r\n                    <h3 className=\"text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground pl-1\">\r\n                        Mis Listas Guardadas ({savedLists.length}/2)\r\n                    </h3>\r\n                    <div className=\"grid grid-cols-1 gap-2\">\r\n                        {savedLists.map((list, idx) => (\r\n                            <div key={list.id || `saved-list-${idx}`} className=\"flex items-center justify-between p-3 bg-muted/30 dark:bg-white/5 rounded-2xl border border-border/50 dark:border-white/10 shadow-sm group hover:bg-muted/50 dark:hover:bg-white/10 transition-all cursor-pointer\">\r\n                                <div className=\"flex-1\" onClick={() => loadList(list)}>\r\n                                    <p className=\"text-xs font-black uppercase tracking-tight text-foreground truncate\">\r\n                                        {list.name}\r\n                                    </p>\r\n                                    <p className=\"text-[9px] font-bold text-muted-foreground uppercase\">{list.items.length} elementos</p>\r\n                                </div>\r\n                                <button\r\n                                    onClick={() => deleteSavedList(list.id)}\r\n                                    className=\"p-2 text-red-500 hover:bg-red-500/10 rounded-xl transition-all\"\r\n                                >\r\n                                    <Trash2 className=\"w-4 h-4\" />\r\n                                </button>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* Selected Playlist */}\r\n            <div className=\"space-y-3 pt-2\">\r\n                <h3 className=\"text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground pl-1\">\r\n                    {cultoId ? 'Himnos y Coros del Culto' : 'Elementos en la calculadora'}\r\n                </h3>\r\n\r\n                <AnimatePresence mode='popLayout'>\r\n                    {sortedSelected.length === 0 && (\r\n                        <motion.div\r\n                            initial={{ opacity: 0 }}\r\n                            animate={{ opacity: 1 }}\r\n                            className=\"p-8 border-2 border-dashed border-border/50 rounded-2xl text-center text-muted-foreground bg-muted/5\"\r\n                        >\r\n                            <Music className=\"w-8 h-8 mx-auto mb-2 opacity-20\" />\r\n                            <p className=\"text-xs font-medium\">No hay canciones seleccionadas</p>\r\n                        </motion.div>\r\n                    )}\r\n\r\n                    <DndContext\r\n                        sensors={sensors}\r\n                        collisionDetection={closestCenter}\r\n                        onDragEnd={handleDragEnd}\r\n                    >\r\n                        <SortableContext\r\n                            items={sortedSelected.map((item, idx) => item.id || `selected-${idx}`)}\r\n                            strategy={verticalListSortingStrategy}\r\n                        >\r\n                            <div className=\"space-y-2\">\r\n                                {sortedSelected.map((item, index) => (\r\n                                    <SortableItem\r\n                                        key={item.id || `selected-item-${index}`}\r\n                                        item={item}\r\n                                        onRemove={handleRemove}\r\n                                        onMoveUp={handleMoveUp}\r\n                                        onMoveDown={handleMoveDown}\r\n                                        isFirst={index === 0}\r\n                                        isLast={index === sortedSelected.length - 1}\r\n                                    />\r\n                                ))}\r\n                            </div>\r\n                        </SortableContext>\r\n                    </DndContext>\r\n                </AnimatePresence>\r\n            </div>\r\n\r\n            {/* Save Modal */}\r\n            <AnimatePresence>\r\n                {isSaveModalOpen && (\r\n                    <div className=\"fixed inset-0 z-[100] flex items-center justify-center p-4\">\r\n                        <motion.div\r\n                            initial={{ opacity: 0 }}\r\n                            animate={{ opacity: 1 }}\r\n                            exit={{ opacity: 0 }}\r\n                            className=\"absolute inset-0 bg-black/70 backdrop-blur-xl\"\r\n                            onClick={() => setIsSaveModalOpen(false)}\r\n                        />\r\n                        <motion.div\r\n                            initial={{ scale: 0.9, opacity: 0 }}\r\n                            animate={{ scale: 1, opacity: 1 }}\r\n                            exit={{ scale: 0.9, opacity: 0 }}\r\n                            className=\"relative w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl bg-white dark:bg-[#18181b] border border-gray-200 dark:border-zinc-700\"\r\n                        >\r\n                            <h2 className=\"text-2xl font-black tracking-tighter text-gray-900 dark:text-white mb-2 uppercase italic text-center\">Guardar Lista</h2>\r\n                            <p className=\"text-[10px] font-black text-gray-500 dark:text-zinc-400 text-center mb-8 uppercase tracking-[0.2em]\">Elige un nombre para tu selecci├│n</p>\r\n\r\n                            <div className=\"relative mb-8\">\r\n                                <input\r\n                                    type=\"text\"\r\n                                    value={listName}\r\n                                    onChange={(e) => setListName(e.target.value)}\r\n                                    placeholder=\"Nombre de la lista...\"\r\n                                    className=\"w-full h-14 bg-gray-100 dark:bg-zinc-800 rounded-2xl px-6 font-black uppercase text-xs tracking-widest border border-gray-200 dark:border-zinc-600 focus:border-blue-500 outline-none text-gray-900 dark:text-white placeholder:text-gray-400 dark:placeholder:text-zinc-500\"\r\n                                    autoFocus\r\n                                />\r\n                            </div>\r\n\r\n                            <div className=\"grid grid-cols-2 gap-4\">\r\n                                <button\r\n                                    onClick={() => setIsSaveModalOpen(false)}\r\n                                    className=\"h-12 rounded-2xl font-black text-[10px] uppercase tracking-widest bg-gray-100 dark:bg-zinc-800 border border-gray-200 dark:border-zinc-600 text-gray-700 dark:text-zinc-300 hover:bg-gray-200 dark:hover:bg-zinc-700 transition-all\"\r\n                                >\r\n                                    Cancelar\r\n                                </button>\r\n                                <button\r\n                                    onClick={confirmSaveList}\r\n                                    className=\"h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-xl shadow-blue-500/30 hover:scale-[1.02] active:scale-[0.98] transition-all\"\r\n                                >\r\n                                    Confirmar\r\n                                </button>\r\n                            </div>\r\n                        </motion.div>\r\n                    </div>\r\n                )}\r\n            </AnimatePresence>\r\n        </div >\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\InstallPrompt.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ArrowUp' is defined but never used.","line":16,"column":30,"nodeType":null,"messageId":"unusedVar","endLine":16,"endColumn":37},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":46,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1729,1732],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1729,1732],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":148,"column":37,"nodeType":"JSXOpeningElement","endLine":156,"endColumn":39}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * InstallPrompt - IDMJI Gestor de P├║lpito\r\n * \r\n * Componente mejorado para invitar al usuario a instalar la PWA.\r\n * - iOS: Muestra prompt simplificado con instrucciones manuales\r\n * - Android: Usa beforeinstallprompt nativo con re-prompt despu├®s de 7 d├¡as\r\n * \r\n * @author Antigravity AI\r\n * @date 2024-12-28\r\n */\r\n\r\n'use client'\r\n\r\nimport { useState, useEffect, useMemo, useCallback } from 'react'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport { Download, X, Share, ArrowUp } from 'lucide-react'\r\nimport { Button } from './ui/Button'\r\nimport { useTheme } from '@/lib/theme/ThemeProvider'\r\n\r\ninterface BeforeInstallPromptEvent extends Event {\r\n    prompt: () => Promise<void>;\r\n    userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>;\r\n}\r\n\r\nconst PROMPT_DISMISS_KEY = 'pwa_prompt_dismissed_at'\r\nconst PROMPT_INSTALLED_KEY = 'pwa_installed'\r\nconst REPROMPT_DAYS = 7\r\n\r\nexport function InstallPrompt() {\r\n    const [showPrompt, setShowPrompt] = useState(false)\r\n    const [showIOSInstructions, setShowIOSInstructions] = useState(false)\r\n    const [deferredPrompt, setDeferredPrompt] = useState<BeforeInstallPromptEvent | null>(null)\r\n    const { isDark } = useTheme()\r\n\r\n    const platform = useMemo(() => {\r\n        if (typeof window === 'undefined') return null\r\n        const userAgent = window.navigator.userAgent.toLowerCase()\r\n        if (/iphone|ipad|ipod/.test(userAgent)) return 'ios'\r\n        if (/android/.test(userAgent)) return 'android'\r\n        return 'other'\r\n    }, [])\r\n\r\n    const isStandalone = useMemo(() => {\r\n        if (typeof window === 'undefined') return false\r\n        return window.matchMedia('(display-mode: standalone)').matches ||\r\n            (window.navigator as any).standalone === true\r\n    }, [])\r\n\r\n    const shouldShowPrompt = useCallback(() => {\r\n        if (typeof window === 'undefined') return false\r\n        if (isStandalone) return false\r\n\r\n        // Si ya instal├│, no mostrar\r\n        const installed = localStorage.getItem(PROMPT_INSTALLED_KEY)\r\n        if (installed === 'true') return false\r\n\r\n        // Verificar si cerr├│ el prompt recientemente\r\n        const dismissedAt = localStorage.getItem(PROMPT_DISMISS_KEY)\r\n        if (dismissedAt) {\r\n            const dismissDate = new Date(parseInt(dismissedAt))\r\n            const daysSince = (Date.now() - dismissDate.getTime()) / (1000 * 60 * 60 * 24)\r\n            if (daysSince < REPROMPT_DAYS) return false\r\n        }\r\n\r\n        return true\r\n    }, [isStandalone])\r\n\r\n    useEffect(() => {\r\n        if (!shouldShowPrompt()) return\r\n\r\n        const handleBeforeInstallPrompt = (e: Event) => {\r\n            e.preventDefault()\r\n            setDeferredPrompt(e as BeforeInstallPromptEvent)\r\n            setShowPrompt(true)\r\n        }\r\n\r\n        window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt)\r\n\r\n        // Para iOS, mostrar despu├®s de 2 segundos\r\n        if (platform === 'ios') {\r\n            const timer = setTimeout(() => setShowPrompt(true), 2000)\r\n            return () => {\r\n                clearTimeout(timer)\r\n                window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt)\r\n            }\r\n        }\r\n\r\n        return () => window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt)\r\n    }, [platform, shouldShowPrompt])\r\n\r\n    const handleInstall = async () => {\r\n        if (!deferredPrompt) return\r\n\r\n        try {\r\n            await deferredPrompt.prompt()\r\n            const { outcome } = await deferredPrompt.userChoice\r\n\r\n            if (outcome === 'accepted') {\r\n                localStorage.setItem(PROMPT_INSTALLED_KEY, 'true')\r\n                setShowPrompt(false)\r\n            }\r\n        } catch (error) {\r\n            console.error('Error durante instalaci├│n:', error)\r\n        }\r\n\r\n        setDeferredPrompt(null)\r\n    }\r\n\r\n    const closePrompt = () => {\r\n        setShowPrompt(false)\r\n        setShowIOSInstructions(false)\r\n        localStorage.setItem(PROMPT_DISMISS_KEY, Date.now().toString())\r\n    }\r\n\r\n    const handleIOSConfirm = () => {\r\n        setShowIOSInstructions(true)\r\n    }\r\n\r\n    if (!showPrompt) return null\r\n\r\n    return (\r\n        <AnimatePresence>\r\n            <motion.div\r\n                initial={{ y: 100, opacity: 0 }}\r\n                animate={{ y: 0, opacity: 1 }}\r\n                exit={{ y: 100, opacity: 0 }}\r\n                className=\"fixed bottom-4 left-3 right-3 z-[9999] md:left-auto md:right-6 md:w-[380px]\"\r\n            >\r\n                <div className={`relative overflow-hidden rounded-2xl border shadow-2xl ${isDark\r\n                    ? 'bg-slate-900 border-slate-700'\r\n                    : 'bg-white border-slate-200'\r\n                    }`}>\r\n                    {/* Close button */}\r\n                    <button\r\n                        onClick={closePrompt}\r\n                        className={`absolute top-3 right-3 p-1.5 rounded-full transition-all z-10 ${isDark ? 'hover:bg-slate-800 text-slate-400' : 'hover:bg-slate-100 text-slate-400'\r\n                            }`}\r\n                    >\r\n                        <X size={18} />\r\n                    </button>\r\n\r\n                    {!showIOSInstructions ? (\r\n                        // Prompt principal simplificado\r\n                        <div className=\"p-5\">\r\n                            <div className=\"flex items-start gap-4\">\r\n                                <div className={`w-14 h-14 rounded-xl flex items-center justify-center shrink-0 ${isDark ? 'bg-blue-500/20' : 'bg-blue-50'\r\n                                    }`}>\r\n                                    <img\r\n                                        src=\"/icons/icon-192x192.png\"\r\n                                        alt=\"IDMJI\"\r\n                                        className=\"w-10 h-10 rounded-lg\"\r\n                                        onError={(e) => {\r\n                                            // Fallback si no existe el icono\r\n                                            (e.target as HTMLImageElement).src = '/logo.jpg'\r\n                                        }}\r\n                                    />\r\n                                </div>\r\n                                <div className=\"flex-1 min-w-0 pr-6\">\r\n                                    <h4 className={`font-bold text-base ${isDark ? 'text-white' : 'text-slate-900'\r\n                                        }`}>\r\n                                        ┬┐Instalar IDMJI Sabadell?\r\n                                    </h4>\r\n                                    <p className={`text-sm mt-1 ${isDark ? 'text-slate-400' : 'text-slate-500'\r\n                                        }`}>\r\n                                        Acceso r├ípido desde tu pantalla de inicio\r\n                                    </p>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"flex gap-3 mt-5\">\r\n                                <Button\r\n                                    onClick={closePrompt}\r\n                                    variant=\"outline\"\r\n                                    className={`flex-1 h-11 rounded-xl font-medium ${isDark\r\n                                        ? 'border-slate-700 text-slate-300 hover:bg-slate-800'\r\n                                        : 'border-slate-200 text-slate-600 hover:bg-slate-50'\r\n                                        }`}\r\n                                >\r\n                                    Cancelar\r\n                                </Button>\r\n                                <Button\r\n                                    onClick={platform === 'ios' ? handleIOSConfirm : handleInstall}\r\n                                    className=\"flex-1 h-11 rounded-xl font-medium bg-blue-600 hover:bg-blue-700 text-white\"\r\n                                >\r\n                                    <Download className=\"w-4 h-4 mr-2\" />\r\n                                    Instalar\r\n                                </Button>\r\n                            </div>\r\n                        </div>\r\n                    ) : (\r\n                        // Instrucciones iOS\r\n                        <div className=\"p-5\">\r\n                            <h4 className={`font-bold text-base text-center mb-4 ${isDark ? 'text-white' : 'text-slate-900'\r\n                                }`}>\r\n                                Pasos para instalar en iPhone\r\n                            </h4>\r\n\r\n                            <div className=\"space-y-4\">\r\n                                <div className=\"flex items-center gap-4\">\r\n                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold ${isDark ? 'bg-blue-500/20 text-blue-400' : 'bg-blue-100 text-blue-600'\r\n                                        }`}>\r\n                                        1\r\n                                    </div>\r\n                                    <div className=\"flex-1\">\r\n                                        <p className={`text-sm ${isDark ? 'text-slate-300' : 'text-slate-700'}`}>\r\n                                            Pulsa el bot├│n <strong>Compartir</strong>\r\n                                        </p>\r\n                                        <div className={`inline-flex items-center gap-1 mt-1 px-2 py-1 rounded text-xs ${isDark ? 'bg-slate-800 text-slate-400' : 'bg-slate-100 text-slate-500'\r\n                                            }`}>\r\n                                            <Share className=\"w-3 h-3\" />\r\n                                            en la barra del navegador\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <div className=\"flex items-center gap-4\">\r\n                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold ${isDark ? 'bg-blue-500/20 text-blue-400' : 'bg-blue-100 text-blue-600'\r\n                                        }`}>\r\n                                        2\r\n                                    </div>\r\n                                    <div className=\"flex-1\">\r\n                                        <p className={`text-sm ${isDark ? 'text-slate-300' : 'text-slate-700'}`}>\r\n                                            Selecciona <strong>&quot;A├▒adir a pantalla de inicio&quot;</strong>\r\n                                        </p>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <div className=\"flex items-center gap-4\">\r\n                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold ${isDark ? 'bg-blue-500/20 text-blue-400' : 'bg-blue-100 text-blue-600'\r\n                                        }`}>\r\n                                        3\r\n                                    </div>\r\n                                    <div className=\"flex-1\">\r\n                                        <p className={`text-sm ${isDark ? 'text-slate-300' : 'text-slate-700'}`}>\r\n                                            Pulsa <strong>&quot;A├▒adir&quot;</strong> en la esquina superior derecha\r\n                                        </p>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n\r\n                            <Button\r\n                                onClick={closePrompt}\r\n                                className=\"w-full mt-5 h-11 rounded-xl font-medium bg-blue-600 hover:bg-blue-700 text-white\"\r\n                            >\r\n                                Entendido\r\n                            </Button>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </motion.div>\r\n        </AnimatePresence>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\NotificationToggle.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\PWARegister.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\PushNotificationToggle.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\TestNotificationButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\UserSelector.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AnimatePresence' is defined but never used.","line":21,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":33},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'setIsEditing'. Either include it or remove the dependency array.","line":68,"column":8,"nodeType":"ArrayExpression","endLine":68,"endColumn":24,"suggestions":[{"desc":"Update the dependencies array to be: [selectedUserId, setIsEditing]","fix":{"range":[2408,2424],"text":"[selectedUserId, setIsEditing]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'showResults'. Either include it or remove the dependency array.","line":99,"column":8,"nodeType":"ArrayExpression","endLine":99,"endColumn":24,"suggestions":[{"desc":"Update the dependencies array to be: [debouncedQuery, showResults]","fix":{"range":[3658,3674],"text":"[debouncedQuery, showResults]"}}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":224,"column":61,"nodeType":"JSXOpeningElement","endLine":224,"endColumn":148},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":259,"column":79,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[13627,13708],"text":"\r\n                                            No se encontr├│ ning├║n hermano con &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[13627,13708],"text":"\r\n                                            No se encontr├│ ning├║n hermano con &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[13627,13708],"text":"\r\n                                            No se encontr├│ ning├║n hermano con &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[13627,13708],"text":"\r\n                                            No se encontr├│ ning├║n hermano con &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":259,"column":87,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[13715,13758],"text":"&quot;\r\n                                        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[13715,13758],"text":"&ldquo;\r\n                                        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[13715,13758],"text":"&#34;\r\n                                        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[13715,13758],"text":"&rdquo;\r\n                                        "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * UserSelector - IDMJI Gestor de P├║lpito\r\n * \r\n * Componente de b├║squeda y selecci├│n de hermanos para asignaciones.\r\n * Filtra autom├íticamente por usuarios con acceso al p├║lpito.\r\n * Usa Portals para garantizar que los resultados sean siempre visibles.\r\n * \r\n * @author Antigravity AI\r\n * @date 2024-12-25\r\n */\r\n\r\n'use client'\r\n\r\nimport { useState, useEffect, useRef } from 'react'\r\nimport { createPortal } from 'react-dom'\r\nimport { Search, X, User, Check, Loader2, ChevronDown } from 'lucide-react'\r\nimport { useDebounce } from '@/hooks/use-debounce'\r\nimport { searchProfiles } from '@/app/dashboard/cultos/[id]/actions'\r\nimport { Profile } from '@/types/database'\r\nimport { useI18n } from '@/lib/i18n/I18nProvider'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\n\r\ninterface UserSelectorProps {\r\n    selectedUserId: string | null\r\n    onSelect: (userId: string | null) => void\r\n    disabled?: boolean\r\n    isEditing?: boolean\r\n    onEditChange?: (isEditing: boolean) => void\r\n}\r\n\r\nexport default function UserSelector({ \r\n    selectedUserId, \r\n    onSelect, \r\n    disabled, \r\n    isEditing: externalIsEditing, \r\n    onEditChange \r\n}: UserSelectorProps) {\r\n    const { t } = useI18n()\r\n    const [id] = useState(() => Math.random().toString(36).substring(2, 9))\r\n    const [query, setQuery] = useState('')\r\n    const [results, setResults] = useState<Profile[]>([])\r\n    const [isSearching, setIsSearching] = useState(false)\r\n    const [showResults, setShowResults] = useState(false)\r\n    const [internalIsEditing, setInternalIsEditing] = useState(false)\r\n    const containerRef = useRef<HTMLDivElement>(null)\r\n    const [dropdownRect, setDropdownRect] = useState<{ top: number, left: number, width: number } | null>(null)\r\n    const [mounted, setMounted] = useState(false)\r\n\r\n    useEffect(() => {\r\n        setMounted(true)\r\n        return () => setMounted(false)\r\n    }, [])\r\n\r\n    // Sync with external editing state if provided\r\n    const isEditing = externalIsEditing !== undefined ? externalIsEditing : internalIsEditing\r\n    const setIsEditing = (val: boolean) => {\r\n        if (onEditChange) onEditChange(val)\r\n        else setInternalIsEditing(val)\r\n    }\r\n\r\n    const debouncedQuery = useDebounce(query, 300)\r\n\r\n    // Reset editing state when selectedUserId changes to null\r\n    useEffect(() => {\r\n        if (!selectedUserId) {\r\n            setIsEditing(true)\r\n        }\r\n    }, [selectedUserId])\r\n\r\n    useEffect(() => {\r\n        const handleClickOutside = (event: MouseEvent) => {\r\n            if (containerRef.current && !containerRef.current.contains(event.target as Node)) {\r\n                // Si el portal est├í abierto, tambi├®n necesitamos verificar si el clic fue dentro del portal\r\n                // Pero como es fixed y est├í en el body, es m├ís complejo.\r\n                // Usamos un timeout peque├▒o para permitir clics en los botones de resultados\r\n            }\r\n        }\r\n        document.addEventListener('mousedown', handleClickOutside)\r\n        return () => document.removeEventListener('mousedown', handleClickOutside)\r\n    }, [])\r\n\r\n    useEffect(() => {\r\n        async function search() {\r\n            setIsSearching(true)\r\n            try {\r\n                const { data } = await searchProfiles(debouncedQuery)\r\n                setResults(data as Profile[] || [])\r\n                if (showResults || debouncedQuery.length > 0) {\r\n                    setShowResults(true)\r\n                }\r\n            } catch (error) {\r\n                console.error('Error searching profiles:', error)\r\n            } finally {\r\n                setIsSearching(false)\r\n            }\r\n        }\r\n\r\n        search()\r\n    }, [debouncedQuery])\r\n\r\n    // Posicionamiento din├ímico para el dropdown fixed\r\n    const updatePosition = () => {\r\n        if (containerRef.current) {\r\n            const rect = containerRef.current.getBoundingClientRect()\r\n            setDropdownRect({\r\n                top: rect.bottom,\r\n                left: rect.left,\r\n                width: rect.width\r\n            })\r\n        }\r\n    }\r\n\r\n    useEffect(() => {\r\n        if (showResults) {\r\n            updatePosition()\r\n            window.addEventListener('scroll', updatePosition, true)\r\n            window.addEventListener('resize', updatePosition)\r\n            return () => {\r\n                window.removeEventListener('scroll', updatePosition, true)\r\n                window.removeEventListener('resize', updatePosition)\r\n            }\r\n        }\r\n    }, [showResults])\r\n\r\n    const handleSelect = (user: Profile) => {\r\n        onSelect(user.id)\r\n        setQuery('')\r\n        setShowResults(false)\r\n        setIsEditing(false)\r\n    }\r\n\r\n    const handleClear = () => {\r\n        onSelect(null)\r\n        setQuery('')\r\n        setShowResults(false)\r\n        setIsEditing(true)\r\n    }\r\n\r\n    // If we have a selected user and we're NOT editing, we don't show the search bar\r\n    if (selectedUserId && !isEditing && !disabled) {\r\n        return null\r\n    }\r\n\r\n    return (\r\n        <div className=\"relative\" ref={containerRef}>\r\n            <div className=\"relative group\">\r\n                <div className={`absolute left-4 top-1/2 -translate-y-1/2 transition-colors ${isSearching ? 'text-primary' : 'text-muted-foreground group-focus-within:text-primary'}`}>\r\n                    {isSearching ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <Search className=\"w-4 h-4\" />}\r\n                </div>\r\n                <input\r\n                    type=\"text\"\r\n                    value={query}\r\n                    onChange={(e) => setQuery(e.target.value)}\r\n                    onFocus={() => {\r\n                        setShowResults(true)\r\n                        updatePosition()\r\n                        // Trigger immediate search if results are empty\r\n                        if (results.length === 0) {\r\n                            searchProfiles('').then(({ data }) => setResults(data as Profile[] || []))\r\n                        }\r\n                    }}\r\n                    placeholder={t('hermanos.searchPlaceholder')}\r\n                    disabled={disabled}\r\n                    className=\"w-full bg-muted/30 border border-border/50 rounded-2xl pl-12 pr-12 py-3.5 outline-none focus:ring-4 focus:ring-primary/10 focus:border-primary/50 transition-all disabled:opacity-50 font-medium text-sm placeholder:text-muted-foreground/60 shadow-inner\"\r\n                />\r\n                {query && (\r\n                    <button\r\n                        onClick={() => setQuery('')}\r\n                        className=\"absolute right-4 top-1/2 -translate-y-1/2 p-1.5 hover:bg-muted rounded-xl transition-colors text-muted-foreground hover:text-foreground\"\r\n                    >\r\n                        <X className=\"w-4 h-4\" />\r\n                    </button>\r\n                )}\r\n            </div>\r\n\r\n            {/* Dropdown de Resultados con PORTAL */}\r\n            {mounted && showResults && dropdownRect && createPortal(\r\n                <div key={`user-selector-portal-${id}`} className=\"fixed inset-0 z-[9998]\" onClick={() => setShowResults(false)}>\r\n                    <motion.div\r\n                        key={`user-selector-dropdown-${id}`}\r\n                        initial={{ opacity: 0, y: 10, scale: 0.95 }}\r\n                        animate={{ opacity: 1, y: 0, scale: 1 }}\r\n                        exit={{ opacity: 0, y: 10, scale: 0.95 }}\r\n                        style={{\r\n                            position: 'fixed',\r\n                            top: dropdownRect.top + 8,\r\n                            left: dropdownRect.left,\r\n                            width: dropdownRect.width,\r\n                        }}\r\n                        onClick={(e) => e.stopPropagation()}\r\n                        className=\"bg-white dark:bg-zinc-900 rounded-[2.5rem] shadow-[0_25px_60px_-15px_rgba(0,0,0,0.4)] border border-gray-200 dark:border-white/10 max-h-[450px] overflow-hidden flex flex-col pointer-events-auto\"\r\n                    >\r\n                        <div className=\"p-4 border-b border-border/50 bg-muted/20 flex items-center justify-between shrink-0\">\r\n                            <p className=\"text-[10px] font-black uppercase tracking-widest text-muted-foreground/60\">\r\n                                {query ? 'Resultados de b├║squeda' : 'Hermanos sugeridos'}\r\n                            </p>\r\n                            <button \r\n                                onClick={() => setShowResults(false)}\r\n                                className=\"p-1.5 hover:bg-muted rounded-full transition-colors text-muted-foreground\"\r\n                            >\r\n                                <X className=\"w-4 h-4\" />\r\n                            </button>\r\n                        </div>\r\n                        <div className=\"overflow-y-auto no-scrollbar p-2 flex-1\">\r\n                            {results.length > 0 ? (\r\n                                <div className=\"grid grid-cols-1 gap-1\">\r\n                                    {results.map((user, idx) => {\r\n                                        const isSelected = selectedUserId === user.id\r\n                                        return (\r\n                                            <button\r\n                                                key={user.id || `user-result-${idx}`}\r\n                                                onClick={() => handleSelect(user)}\r\n                                                className={`\r\n                                                    w-full px-4 py-3.5 text-left transition-all rounded-[1.5rem] flex items-center justify-between group/item relative overflow-hidden\r\n                                                    ${isSelected ? 'bg-primary text-white shadow-lg shadow-primary/20' : 'hover:bg-primary/5 text-foreground'}\r\n                                                `}\r\n                                            >\r\n                                                <div className=\"flex items-center gap-4 relative z-10\">\r\n                                                    {/* Avatar o Iniciales */}\r\n                                                    <div className={`w-11 h-11 rounded-2xl shrink-0 flex items-center justify-center font-black text-xs border shadow-sm transition-all group-hover/item:scale-105 group-hover/item:rotate-3 ${\r\n                                                        isSelected ? 'bg-white/20 border-white/20' : 'bg-primary/5 border-primary/10 text-primary'\r\n                                                    }`}>\r\n                                                        {user.avatar_url ? (\r\n                                                            <img src={user.avatar_url} alt=\"\" className=\"w-full h-full object-cover rounded-2xl\" />\r\n                                                        ) : (\r\n                                                            <span className=\"uppercase\">{user.nombre?.[0]}{user.apellidos?.[0]}</span>\r\n                                                        )}\r\n                                                    </div>\r\n\r\n                                                    <div className=\"flex-1 min-w-0\">\r\n                                                        <p className=\"font-black text-sm md:text-base truncate uppercase tracking-tight\">\r\n                                                            {user.nombre} {user.apellidos}\r\n                                                        </p>\r\n                                                        <div className=\"flex items-center gap-2 mt-0.5\">\r\n                                                            <p className={`text-[10px] uppercase font-black tracking-widest ${isSelected ? 'text-white/60' : 'text-emerald-500'}`}>\r\n                                                                {isSelected ? 'Seleccionado' : 'Disponible para el p├║lpito'}\r\n                                                            </p>\r\n                                                        </div>\r\n                                                    </div>\r\n                                                </div>\r\n\r\n                                                <div className={`w-8 h-8 rounded-xl flex items-center justify-center transition-all relative z-10 ${isSelected ? 'bg-white/20' : 'bg-primary/0 group-hover/item:bg-primary/10'}`}>\r\n                                                    {isSelected ? <Check className=\"w-4 h-4 text-white\" strokeWidth={3} /> : <ChevronDown className=\"w-4 h-4 text-muted-foreground/30 -rotate-90 group-hover/item:text-primary group-hover/item:translate-x-0.5 transition-all\" />}\r\n                                                </div>\r\n                                            </button>\r\n                                        )\r\n                                    })}\r\n                                </div>\r\n                            ) : (\r\n                                !isSearching && (\r\n                                    <div className=\"p-12 text-center\">\r\n                                        <div className=\"w-16 h-16 bg-muted/20 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n                                            <User className=\"w-8 h-8 text-muted-foreground/30\" />\r\n                                        </div>\r\n                                        <p className=\"text-sm font-black text-foreground uppercase tracking-widest mb-1\">\r\n                                            Sin resultados\r\n                                        </p>\r\n                                        <p className=\"text-[10px] text-muted-foreground font-bold uppercase tracking-wider\">\r\n                                            No se encontr├│ ning├║n hermano con \"{query}\"\r\n                                        </p>\r\n                                    </div>\r\n                                )\r\n                            )}\r\n                        </div>\r\n                        <div className=\"p-3 bg-muted/20 border-t border-border/50 text-center shrink-0\">\r\n                            <p className=\"text-[9px] font-black text-muted-foreground/40 uppercase tracking-[0.2em]\">Selecciona un hermano para asignar</p>\r\n                        </div>\r\n                    </motion.div>\r\n                </div>,\r\n                document.body\r\n            )}\r\n\r\n            {/* Botones de acci├│n en modo edici├│n */}\r\n            <div className=\"flex items-center gap-3\">\r\n                {selectedUserId && isEditing && !disabled && (\r\n                    <motion.button\r\n                        initial={{ opacity: 0 }}\r\n                        animate={{ opacity: 1 }}\r\n                        onClick={handleClear}\r\n                        className=\"mt-3 px-4 py-2 text-[10px] font-black uppercase tracking-[0.2em] text-red-500 hover:text-red-400 hover:bg-red-500/5 rounded-xl transition-all inline-flex items-center gap-2 border border-transparent hover:border-red-500/10\"\r\n                    >\r\n                        <X className=\"w-3 h-3\" strokeWidth={3} />\r\n                        {t('hermanos.removeAssignment')}\r\n                    </motion.button>\r\n                )}\r\n                \r\n                {selectedUserId && isEditing && !disabled && (\r\n                    <motion.button\r\n                        initial={{ opacity: 0 }}\r\n                        animate={{ opacity: 1 }}\r\n                        onClick={() => setIsEditing(false)}\r\n                        className=\"mt-3 px-4 py-2 text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground hover:text-foreground hover:bg-muted rounded-xl transition-all inline-flex items-center gap-2\"\r\n                    >\r\n                        Cancelar\r\n                    </motion.button>\r\n                )}\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\ui\\AnimatedToast.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\ui\\Button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\ui\\Card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\ui\\Dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used.","line":6,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport * as React from 'react'\r\nimport { createPortal } from 'react-dom'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport { X } from 'lucide-react'\r\nimport { cn } from '@/lib/utils'\r\n\r\ninterface DialogProps {\r\n    open: boolean\r\n    onOpenChange: (open: boolean) => void\r\n    children: React.ReactNode\r\n}\r\n\r\nexport function Dialog({ open, onOpenChange, children }: DialogProps) {\r\n    const [mounted, setMounted] = React.useState(false)\r\n\r\n    React.useEffect(() => {\r\n        setMounted(true)\r\n    }, [])\r\n\r\n    React.useEffect(() => {\r\n        if (open) {\r\n            const originalOverflow = document.body.style.overflow\r\n            \r\n            if (originalOverflow !== 'hidden') {\r\n            document.body.style.overflow = 'hidden'\r\n        }\r\n            \r\n        return () => {\r\n                if (originalOverflow !== 'hidden') {\r\n                    document.body.style.overflow = originalOverflow\r\n                }\r\n            }\r\n        }\r\n    }, [open])\r\n\r\n    if (!mounted) return null\r\n\r\n    return createPortal(\r\n        <AnimatePresence>\r\n            {open && (\r\n                <div className=\"fixed inset-0 z-[999] flex items-center justify-center p-4 sm:p-6\">\r\n                    <DialogOverlay onClick={() => onOpenChange(false)} />\r\n                    <motion.div\r\n                        initial={{ opacity: 0, scale: 0.95, y: 10 }}\r\n                        animate={{ opacity: 1, scale: 1, y: 0 }}\r\n                        exit={{ opacity: 0, scale: 0.95, y: 10 }}\r\n                        transition={{ duration: 0.2, ease: \"easeOut\" }}\r\n                        className=\"w-full max-w-lg z-[1000] relative\"\r\n                    >\r\n                        {children}\r\n                    </motion.div>\r\n                </div>\r\n            )}\r\n        </AnimatePresence>,\r\n        document.body\r\n    )\r\n}\r\n\r\nfunction DialogOverlay({ onClick }: { onClick: () => void }) {\r\n    return (\r\n        <motion.div\r\n            initial={{ opacity: 0 }}\r\n            animate={{ opacity: 1 }}\r\n            exit={{ opacity: 0 }}\r\n            className=\"fixed inset-0 z-[998] bg-black/60 backdrop-blur-sm\"\r\n            onClick={onClick}\r\n        />\r\n    )\r\n}\r\n\r\nexport function DialogContent({ className, children }: { className?: string, children: React.ReactNode }) {\r\n    return (\r\n        <div className={cn(\"relative w-full bg-background border border-border shadow-lg rounded-xl overflow-hidden\", className)}>\r\n            {children}\r\n        </div>\r\n    )\r\n}\r\n\r\nexport function DialogHeader({ className, children }: { className?: string, children: React.ReactNode }) {\r\n    return (\r\n        <div className={cn(\"flex flex-col space-y-1.5 text-center sm:text-left p-6\", className)}>\r\n            {children}\r\n        </div>\r\n    )\r\n}\r\n\r\nexport function DialogFooter({ className, children }: { className?: string, children: React.ReactNode }) {\r\n    return (\r\n        <div className={cn(\"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2 p-6 pt-0 gap-2\", className)}>\r\n            {children}\r\n        </div>\r\n    )\r\n}\r\n\r\nexport function DialogTitle({ className, children }: { className?: string, children: React.ReactNode }) {\r\n    return (\r\n        <h2 className={cn(\"text-lg font-semibold leading-none tracking-tight\", className)}>\r\n            {children}\r\n        </h2>\r\n    )\r\n}\r\n\r\nexport function DialogDescription({ className, children }: { className?: string, children: React.ReactNode }) {\r\n    return (\r\n        <p className={cn(\"text-sm text-muted-foreground\", className)}>\r\n            {children}\r\n        </p>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\ui\\Input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\ui\\Modal.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\ui\\Modal.tsx:20:9\n  18 |\n  19 |     useEffect(() => {\n> 20 |         setMounted(true)\n     |         ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  21 |         // Prevent body scroll when modal is open\n  22 |         if (isOpen) {\n  23 |             document.body.style.overflow = 'hidden'","line":20,"column":9,"nodeType":null,"endLine":20,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { type ReactNode, useEffect, useState } from 'react'\r\nimport { createPortal } from 'react-dom'\r\nimport { X } from 'lucide-react'\r\nimport { cn } from '@/lib/utils'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\n\r\ninterface ModalProps {\r\n    isOpen: boolean\r\n    onClose: () => void\r\n    title?: ReactNode\r\n    children: ReactNode\r\n    size?: 'sm' | 'md' | 'lg' | 'xl'\r\n    keyPrefix?: string\r\n}\r\n\r\nexport function Modal({ isOpen, onClose, title, children, size = 'md', keyPrefix = 'modal' }: ModalProps) {\r\n    const [mounted, setMounted] = useState(false)\r\n\r\n    useEffect(() => {\r\n        setMounted(true)\r\n        // Prevent body scroll when modal is open\r\n        if (isOpen) {\r\n            document.body.style.overflow = 'hidden'\r\n        } else {\r\n            document.body.style.overflow = 'unset'\r\n        }\r\n        return () => { document.body.style.overflow = 'unset' }\r\n    }, [isOpen])\r\n\r\n    if (!mounted) return null\r\n\r\n    const sizes = {\r\n        sm: 'max-w-md',\r\n        md: 'max-w-2xl',\r\n        lg: 'max-w-4xl',\r\n        xl: 'max-w-6xl',\r\n    }\r\n\r\n    return createPortal(\r\n        <AnimatePresence>\r\n            {isOpen && (\r\n                <div key={`${keyPrefix}-container`}>\r\n                    {/* Overlay */}\r\n                    <motion.div\r\n                        key={`${keyPrefix}-overlay`}\r\n                        initial={{ opacity: 0 }}\r\n                        animate={{ opacity: 1 }}\r\n                        exit={{ opacity: 0 }}\r\n                        onClick={onClose}\r\n                        className=\"fixed inset-0 bg-black/60 backdrop-blur-sm z-[110]\"\r\n                    />\r\n\r\n                    {/* Modal */}\r\n                    <div className=\"fixed inset-0 z-[120] flex items-center justify-center p-4 pointer-events-none\">\r\n                        <motion.div\r\n                            key={`${keyPrefix}-content`}\r\n                            initial={{ opacity: 0, scale: 0.95, y: 20 }}\r\n                            animate={{ opacity: 1, scale: 1, y: 0 }}\r\n                            exit={{ opacity: 0, scale: 0.95, y: 20 }}\r\n                            className={cn('glass w-full rounded-3xl p-6 relative pointer-events-auto shadow-2xl', sizes[size])}\r\n                        >\r\n                            {/* Close Button */}\r\n                            <button\r\n                                onClick={onClose}\r\n                                className=\"absolute top-6 right-6 p-2 hover:bg-muted rounded-xl transition-colors\"\r\n                            >\r\n                                <X className=\"w-5 h-5\" />\r\n                            </button>\r\n\r\n                            {/* Title */}\r\n                            {title && (\r\n                                <div className=\"text-2xl font-bold mb-6 pr-10\">{title}</div>\r\n                            )}\r\n\r\n                            {/* Content */}\r\n                            <div className=\"max-h-[70vh] overflow-y-auto\">\r\n                                {children}\r\n                            </div>\r\n                        </motion.div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </AnimatePresence>,\r\n        document.body\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\ui\\label.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\ui\\select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\ui\\skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\ui\\slider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\ui\\sonner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\components\\ui\\switch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\hooks\\use-debounce.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\hooks\\usePushNotifications.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\lib\\constants.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\lib\\errors.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":40,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1002,1005],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1002,1005],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Utilidades para manejo de errores\r\n */\r\n\r\nexport class AppError extends Error {\r\n    constructor(\r\n        message: string,\r\n        public code?: string,\r\n        public statusCode?: number\r\n    ) {\r\n        super(message)\r\n        this.name = 'AppError'\r\n    }\r\n}\r\n\r\nexport class ValidationError extends AppError {\r\n    constructor(message: string, public field?: string) {\r\n        super(message, 'VALIDATION_ERROR', 400)\r\n        this.name = 'ValidationError'\r\n    }\r\n}\r\n\r\nexport class AuthError extends AppError {\r\n    constructor(message: string = 'No autorizado') {\r\n        super(message, 'AUTH_ERROR', 401)\r\n        this.name = 'AuthError'\r\n    }\r\n}\r\n\r\nexport class NotFoundError extends AppError {\r\n    constructor(resource: string = 'Recurso') {\r\n        super(`${resource} no encontrado`, 'NOT_FOUND', 404)\r\n        this.name = 'NotFoundError'\r\n    }\r\n}\r\n\r\n/**\r\n * Maneja errores de Supabase y los convierte en errores de aplicaci├│n\r\n */\r\nexport function handleSupabaseError(error: any): AppError {\r\n    if (error.code === 'PGRST116') {\r\n        return new NotFoundError()\r\n    }\r\n\r\n    if (error.code === '23505') {\r\n        return new ValidationError('Este registro ya existe')\r\n    }\r\n\r\n    if (error.code === '23503') {\r\n        return new ValidationError('Referencia inv├ílida')\r\n    }\r\n\r\n    return new AppError(error.message || 'Error en la base de datos', error.code)\r\n}\r\n\r\n/**\r\n * Formatea un error para mostrarlo al usuario\r\n */\r\nexport function formatError(error: unknown): string {\r\n    if (error instanceof AppError) {\r\n        return error.message\r\n    }\r\n\r\n    if (error instanceof Error) {\r\n        return error.message\r\n    }\r\n\r\n    return 'Ha ocurrido un error inesperado'\r\n}\r\n\r\n/**\r\n * Logger simple para desarrollo\r\n */\r\nexport const logger = {\r\n    error: (message: string, error?: unknown) => {\r\n        if (process.env.NODE_ENV === 'development') {\r\n            console.error(`[ERROR] ${message}`, error)\r\n        }\r\n    },\r\n\r\n    warn: (message: string, data?: unknown) => {\r\n        if (process.env.NODE_ENV === 'development') {\r\n            console.warn(`[WARN] ${message}`, data)\r\n        }\r\n    },\r\n\r\n    info: (message: string, data?: unknown) => {\r\n        if (process.env.NODE_ENV === 'development') {\r\n            console.log(`[INFO] ${message}`, data)\r\n        }\r\n    },\r\n\r\n    debug: (message: string, data?: unknown) => {\r\n        if (process.env.NODE_ENV === 'development') {\r\n            console.debug(`[DEBUG] ${message}`, data)\r\n        }\r\n    },\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\lib\\helpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\lib\\i18n\\I18nProvider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\lib\\i18n\\translations.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\lib\\supabase\\client.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\lib\\supabase\\middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\lib\\supabase\\server.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\lib\\theme\\ThemeProvider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\lib\\utils\\canvasUtils.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'reject' is defined but never used.","line":84,"column":34,"nodeType":null,"messageId":"unusedVar","endLine":84,"endColumn":40}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const createImage = (url: string): Promise<HTMLImageElement> =>\r\n    new Promise((resolve, reject) => {\r\n        const image = new Image()\r\n        image.addEventListener('load', () => resolve(image))\r\n        image.addEventListener('error', (error) => reject(error))\r\n        image.setAttribute('crossOrigin', 'anonymous')\r\n        image.src = url\r\n    })\r\n\r\nexport function getRadianAngle(degreeValue: number) {\r\n    return (degreeValue * Math.PI) / 180\r\n}\r\n\r\n/**\r\n * Returns the new bounding area of a rotated rectangle.\r\n */\r\nexport function rotateSize(width: number, height: number, rotation: number) {\r\n    const rotRad = getRadianAngle(rotation)\r\n\r\n    return {\r\n        width:\r\n            Math.abs(Math.cos(rotRad) * width) + Math.abs(Math.sin(rotRad) * height),\r\n        height:\r\n            Math.abs(Math.sin(rotRad) * width) + Math.abs(Math.cos(rotRad) * height),\r\n    }\r\n}\r\n\r\n/**\r\n * This function was adapted from the one in the Readme of https://github.com/DominicTobias/react-image-crop\r\n */\r\nexport async function getCroppedImg(\r\n    imageSrc: string,\r\n    pixelCrop: { x: number; y: number; width: number; height: number },\r\n    rotation = 0,\r\n    flip = { horizontal: false, vertical: false }\r\n): Promise<Blob | null> {\r\n    const image = await createImage(imageSrc)\r\n    const canvas = document.createElement('canvas')\r\n    const ctx = canvas.getContext('2d')\r\n\r\n    if (!ctx) {\r\n        return null\r\n    }\r\n\r\n    const rotRad = getRadianAngle(rotation)\r\n\r\n    // calculate bounding box of the rotated image\r\n    const { width: bBoxWidth, height: bBoxHeight } = rotateSize(\r\n        image.width,\r\n        image.height,\r\n        rotation\r\n    )\r\n\r\n    // set canvas size to match the bounding box\r\n    canvas.width = bBoxWidth\r\n    canvas.height = bBoxHeight\r\n\r\n    // translate canvas context to a central location to allow rotating and flipping around the center\r\n    ctx.translate(bBoxWidth / 2, bBoxHeight / 2)\r\n    ctx.rotate(rotRad)\r\n    ctx.scale(flip.horizontal ? -1 : 1, flip.vertical ? -1 : 1)\r\n    ctx.translate(-image.width / 2, -image.height / 2)\r\n\r\n    // draw rotated image\r\n    ctx.drawImage(image, 0, 0)\r\n\r\n    // croppedAreaPixels values are bounding box relative\r\n    // extract the cropped image using these values\r\n    const data = ctx.getImageData(\r\n        pixelCrop.x,\r\n        pixelCrop.y,\r\n        pixelCrop.width,\r\n        pixelCrop.height\r\n    )\r\n\r\n    // set canvas width to final desired crop size - this will clear existing context\r\n    canvas.width = pixelCrop.width\r\n    canvas.height = pixelCrop.height\r\n\r\n    // paste generated rotate image at the top left corner\r\n    ctx.putImageData(data, 0, 0)\r\n\r\n    // As Blob\r\n    return new Promise((resolve, reject) => {\r\n        canvas.toBlob((file) => {\r\n            resolve(file)\r\n        }, 'image/jpeg')\r\n    })\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\lib\\utils\\culto-helpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\lib\\validations.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\jebol\\Desktop\\APP IDMJI\\web\\src\\types\\database.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
